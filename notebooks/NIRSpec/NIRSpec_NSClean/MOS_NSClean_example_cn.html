
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>使用 NSClean 清理 NIRSpec MOS 产品中的残余 1/f 噪声 &#8212; STScI JDAT Notebooks 中文版</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css?v=b44a18d9" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRSpec/NIRSpec_NSClean/MOS_NSClean_example_cn';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="使用 NSClean 清理 NIRSpec BOTS 产品中的残余 1/f 噪声" href="BOTS_NSClean_example_cn.html" />
    <link rel="prev" title="使用 NSClean 清理 NIRSpec IFU 产品中的残余 1/f 噪声" href="IFU_NSClean_example_cn.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks 中文版 - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks 中文版 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">介绍</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">主页</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install_cn.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow_cn.html">笔记本开发工作流程</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">开发</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks_cn.html">提交笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements_cn.html">需求文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks_cn.html">Jupyter 笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files_cn.html">数据文件</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub 指南</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup_cn.html">GitHub 设置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow_cn.html">GitHub 工作流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr_cn.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">跨仪器通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example_cn.html">ASDF 示例</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation_cn.html">复杂的二维背景</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3_cn.html">复合模型光谱拟合</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query_cn.html">MAST 查询</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina_cn.html">Imviz RGB图像</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift_cn.html">Specviz 简单示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS_cn.html">提高纯平行数据集的WCS精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/stpsf_examples/stpsf_examples_cn.html">STPSF 示例</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis_cn.html">MRS Mstar - 数据分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc_cn.html">LMC中的IFU YSOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1_cn.html">LRS 光谱提取</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example_cn.html">点源光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry_cn.html">扩展孔径光度测量</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry_cn.html">交叉滤光片 PSF 匹配</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example_cn.html">PSF 光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction_cn.html">NIRCam 光晕去除</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction_cn.html">WFSS 光谱 - 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra_cn.html">WFSS 光谱 - 合并和归一化 1D 光谱</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template_cn.html">WFSS 光谱 - 相关性模版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map_cn.html">WFSS 光谱 - 发射线图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup_cn.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3_cn.html">运行图像处理管道并创建源目录</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2_cn.html">运行 spec2 管道</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit_cn.html">IFU立方体拟合</a></li>




<li class="toctree-l1"><a class="reference internal" href="../cube_fitting/cube_fitting_cn.html">IFU Cube 建模</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifu_optimal/ifu_optimal_cn.html">IFU 光谱提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static_cn.html">MOS 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mos_spectroscopy_advanced/MOSspec_advanced_cn.html">星系外场的MOS光谱</a></li>

<li class="toctree-l1"><a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST_cn.html">BOTS 时间序列观测</a></li>








<li class="toctree-l1"><a class="reference internal" href="../galaxy_redshift/redshift_fitting_cn.html">红移和模板拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="FS_NSClean_example_cn.html">FS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="IFU_NSClean_example_cn.html">IFU 数据生成 （NSClean）</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">MOS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="BOTS_NSClean_example_cn.html">BOTS 数据生成 （NSClean）</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRSpec/NIRSpec_NSClean/MOS_NSClean_example_cn.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>使用 NSClean 清理 NIRSpec MOS 产品中的残余 1/f 噪声</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook">Notebook 目标</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">目录</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">1. 介绍 <a name="introduction"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">2. 导入库 <a name="imports"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">3. 下载数据 <a name="data"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spec2pipeline-nsclean">4. 运行 <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> 而不进行 NSClean（原始数据） <a name="nsclean_skipped"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nsclean-1-f">5. 使用 NSClean 清理 1/f 噪声（默认管道掩膜） <a name="nsclean_default"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">5.1 验证掩膜（默认管道掩膜） <a name="verify_default_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">5.2 比较原始数据与清理后的数据（默认管道掩模） <a name="nsclean_default_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">6. 使用 NSClean（替代掩膜）清理 1/f 噪声 <a name="nsclean_alternate"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">6.1 验证掩模（备用掩模） <a name="verify_alternate_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">6.2 原始数据与清理数据的比较（备用掩模） <a name="nsclean_alternate_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">7. 使用 NSClean 清理 1/f 噪声（手动修改的掩模） <a name="nsclean_modified"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">7.1 验证掩模（手动修改的掩模） <a name="verify_modified_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">7.2 原始数据与清理数据（手动修改的掩模）比较 <a name="nsclean_modified_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">8. 结论 <a name="conclusion"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">关于笔记本 <a name="about"></a></a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a name="top"></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="nsclean-nirspec-mos-1-f">
<h1>使用 NSClean 清理 NIRSpec MOS 产品中的残余 1/f 噪声<a class="headerlink" href="#nsclean-nirspec-mos-1-f" title="Link to this heading">#</a></h1>
<hr style="border:1px solid black">
<section id="notebook">
<h2>Notebook 目标<a class="headerlink" href="#notebook" title="Link to this heading">#</a></h2>
<p>本 Notebook 的目标是通过去除残余的 1/f 噪声来生成清理后的 MOS (<em>_rate.fits</em>) 文件。这些清理后的文件将作为第 3 级 (<code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code>) 管道的输入。</p>
</section>
<section id="id1">
<h2>目录<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<ul>
<li><ol class="arabic simple">
<li><p><a class="reference internal" href="#introduction"><span class="xref myst">介绍</span></a></p></li>
</ol>
</li>
<li><ol class="arabic simple" start="2">
<li><p><a class="reference internal" href="#imports"><span class="xref myst">导入库</span></a></p></li>
</ol>
</li>
<li><ol class="arabic simple" start="3">
<li><p><a class="reference internal" href="#data"><span class="xref myst">下载数据</span></a></p></li>
</ol>
</li>
<li><ol class="arabic simple" start="4">
<li><p><a class="reference internal" href="#nsclean_skipped"><span class="xref myst">在不使用 NSClean 的情况下运行 <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code>（原始数据）</span></a></p></li>
</ol>
</li>
<li><ol class="arabic simple" start="5">
<li><p><a class="reference internal" href="#nsclean_default"><span class="xref myst">使用 NSClean 清理 1/f 噪声（默认管道掩模）</span></a></p></li>
</ol>
<ul class="simple">
<li><p>5.1 <a class="reference internal" href="#verify_default_mask"><span class="xref myst">验证掩模（默认管道掩模）</span></a></p></li>
<li><p>5.2 <a class="reference internal" href="#nsclean_default_compare"><span class="xref myst">比较原始数据与清理数据（默认管道掩模）</span></a></p></li>
</ul>
</li>
<li><ol class="arabic simple" start="6">
<li><p><a class="reference internal" href="#nsclean_alternate"><span class="xref myst">使用 NSClean 清理 1/f 噪声（替代掩模）</span></a></p></li>
</ol>
<ul class="simple">
<li><p>6.1 <a class="reference internal" href="#verify_alternate_mask"><span class="xref myst">验证掩模（替代掩模）</span></a></p></li>
<li><p>6.2 <a class="reference internal" href="#nsclean_alternate_compare"><span class="xref myst">比较原始数据与清理数据（替代掩模）</span></a></p></li>
</ul>
</li>
<li><ol class="arabic simple" start="7">
<li><p><a class="reference internal" href="#nsclean_modified"><span class="xref myst">使用 NSClean 清理 1/f 噪声（手动修改的掩模）</span></a></p></li>
</ol>
<ul class="simple">
<li><p>7.1 <a class="reference internal" href="#verify_modified_mask"><span class="xref myst">验证掩模（手动修改的掩模）</span></a></p></li>
<li><p>7.2 <a class="reference internal" href="#nsclean_modified_compare"><span class="xref myst">比较原始数据与清理数据（手动修改的掩模）</span></a></p></li>
</ul>
</li>
<li><ol class="arabic simple" start="8">
<li><p><a class="reference internal" href="#conclusion"><span class="xref myst">结论</span></a></p></li>
</ol>
</li>
<li><p><a class="reference internal" href="#about"><span class="xref myst">关于 Notebook</span></a></p></li>
</ul>
</section>
<section id="id2">
<h2>1. 介绍 <a name="introduction"></a><a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>JWST NIRSpec 仪器具有一些观察者在规划观测和解释数据时应注意的特性和特点。其中一个显著特征是在提取的 1-D 光谱中出现负值和/或多余的通量，通常伴随不规则的波长依赖性起伏。这种伪影的原因是相关噪声，称为 <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-near-infrared-spectrograph/nirspec-instrument-features-and-caveats#NIRSpecInstrumentFeaturesandCaveats-1/fnoise">1/f 噪声</a>，源于低水平的探测器热不稳定性，在 2-D 计数率图像中表现为垂直条带，特别是在 NRS2 探测器的曝光中。虽然 IRS2 读出模式减少了这种效应，但并未完全消除。</p>
<p>为了应对这一问题，JWST 科学校准管道在 <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> 中集成了由 Bernard Rauscher 开发的外部包，称为 <a class="reference external" href="https://webb.nasa.gov/content/forScientists/publications.html#NSClean">NSClean</a>，并在 <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/nsclean/main.html">NSCleanStep</a> 下使用。该算法利用探测器的暗区在傅里叶空间中拟合背景模型。它需要一个输入掩模来识别探测器的所有暗区。这个掩模越全面，背景拟合效果越好。</p>
<p>在本 Notebook 中，我们将使用集成到管道中的 NSClean 算法，利用默认参数动态生成的掩模来去除 1/f 噪声。在某些情况下，这个掩模可能不够完整或过于严格，无法实现最佳的噪声去除。为了解决这个问题，我们演示了如何手动修改默认掩模，以及如何通过调整 <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/nsclean/arguments.html">NSCleanStep 参数</a> 创建替代掩模。如有需要，请参阅 <a class="reference external" href="https://iopscience.iop.org/article/10.1088/1538-3873/ad1b36/pdf">NSClean 文档</a>，获取有关手动创建自定义掩模的一些建议。</p>
<p>本 Notebook 使用来自 CEERS 项目的 MOS 观测数据，光栅/滤光片为 G395M/F290LP，作为 <a class="reference external" href="https://www.stsci.edu/jwst/science-execution/approved-programs/dd-ers/program-1345">JWST 早期发布科学计划 ERS-1345</a> 的第 61 次观测示例。</p>
</section>
<section id="id3">
<h2>2. 导入库 <a name="imports"></a><a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black"><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---------- 设置CRDS环境变量 ----------</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  <span class="c1"># 导入操作系统模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">jwst</span>  <span class="c1"># 导入JWST模块</span>

<span class="c1"># 设置CRDS上下文为指定的.pmap文件</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_CONTEXT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;jwst_1210.pmap&#39;</span>

<span class="c1"># 设置CRDS缓存路径为用户主目录下的crds_cache文件夹</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/crds_cache&#39;</span>

<span class="c1"># 设置CRDS服务器的URL</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_SERVER_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;https://jwst-crds.stsci.edu&#39;</span>

<span class="c1"># 打印CRDS缓存位置</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CRDS cache location: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CRDS_PATH&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># 打印JWST校准管道的版本</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;JWST Calibration Pipeline Version=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jwst</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>

<span class="c1"># 打印当前操作的CRDS上下文（注释掉的代码）</span>
<span class="c1"># print(&quot;Current Operational CRDS Context = {}&quot;.format(crds.get_default_context()))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ------ General Imports ------</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># 导入NumPy库，用于数值计算</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tt</span>  <span class="c1"># 导入时间库，用于时间相关操作</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>  <span class="c1"># 导入日志库，用于记录日志信息</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>  <span class="c1"># 导入警告库，用于处理警告信息</span>

<span class="c1"># ------ JWST Calibration Pipeline Imports ------</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.pipeline.calwebb_spec2</span><span class="w"> </span><span class="kn">import</span> <span class="n">Spec2Pipeline</span>  <span class="c1"># 从JWST管道导入Spec2Pipeline类，用于光谱数据处理</span>

<span class="c1"># ------ Plotting/Stats Imports ------</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>  <span class="c1"># 导入Matplotlib库中的pyplot模块，用于绘图</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>  <span class="c1"># 从Astropy库导入fits模块，用于处理FITS文件格式</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_jwst_file</span><span class="p">,</span> <span class="n">plot_dark_data</span><span class="p">,</span> <span class="n">plot_cleaned_data</span><span class="p">,</span> <span class="n">plot_spectra</span>  <span class="c1"># 从utils模块导入自定义函数</span>

<span class="c1"># Hide all log and warning messages.  # 隐藏所有日志和警告信息</span>

<span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>  <span class="c1"># 禁用错误级别的日志信息</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>  <span class="c1"># 忽略运行时警告</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h2>3. 下载数据 <a name="data"></a><a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>输入数据来自于CEERS项目的MOS观测，使用了光栅/滤光片G395H/F290LP。该数据集是<a class="reference external" href="https://www.stsci.edu/jwst/science-execution/approved-programs/dd-ers/program-1345">JWST早期发布科学计划 ERS-1345</a>的一部分，具体为观测61。它包含3次积分（3个抖动点；3-SHUTTER-SLITLET），每次积分有9个组。此笔记本将以第三次抖动曝光（00003）作为示例。然而，需要注意的是，在进行<code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code>之前，所有曝光必须首先通过<code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code>进行处理。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义下载目录</span>
<span class="n">mast_products_dir</span> <span class="o">=</span> <span class="s2">&quot;./mast_products/&quot;</span>

<span class="c1"># 检查目录是否存在</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mast_products_dir</span><span class="p">):</span>
    
    <span class="c1"># 如果目录不存在，则创建该目录</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mast_products_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 该笔记本专注于第三次抖动曝光。</span>

<span class="n">obs_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;jw01345061001_07101_00003&quot;</span><span class="p">]</span>  <span class="c1"># 观测ID列表</span>

<span class="n">detectors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># 两个探测器 NRS1 和 NRS2。</span>

<span class="c1"># 指定计数率产品</span>

<span class="n">rate_names</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化计数率文件名列表</span>

<span class="k">for</span> <span class="n">obs_id</span> <span class="ow">in</span> <span class="n">obs_ids</span><span class="p">:</span>  <span class="c1"># 遍历每个观测ID</span>

    <span class="k">for</span> <span class="n">detector</span> <span class="ow">in</span> <span class="n">detectors</span><span class="p">:</span>  <span class="c1"># 遍历每个探测器</span>

        <span class="n">rate_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">_nrs</span><span class="si">{</span><span class="n">detector</span><span class="si">}</span><span class="s2">_rate.fits&quot;</span><span class="p">)</span>  <span class="c1"># 生成并添加计数率文件名</span>

<span class="c1"># 下载所有的FITS文件和相关的MSA文件。</span>

<span class="n">msa_names</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化MSA文件名列表</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">rate_names</span><span class="p">:</span>  <span class="c1"># 遍历每个计数率文件名</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印正在下载的文件名</span>

    <span class="n">get_jwst_file</span><span class="p">(</span>  <span class="c1"># 调用函数下载FITS文件</span>

        <span class="n">name</span><span class="p">,</span>  <span class="c1"># 文件名</span>
        <span class="n">mast_api_token</span><span class="o">=</span><span class="s2">&quot;75f915f251544013bb127b7f6f6edc80&quot;</span><span class="p">,</span>  <span class="c1"># MAST API令牌</span>
        <span class="n">save_directory</span><span class="o">=</span><span class="n">mast_products_dir</span><span class="p">,</span>  <span class="c1"># 保存目录</span>
    <span class="p">)</span>

    <span class="c1"># 从下载的文件头中检索MSA文件名。</span>

    <span class="n">msa_name</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getval</span><span class="p">(</span><span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;MSAMETFL&quot;</span><span class="p">)</span>  <span class="c1"># 获取MSA文件名</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">msa_name</span><span class="p">):</span>  <span class="c1"># 如果MSA文件不存在</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">msa_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印正在下载的MSA文件名</span>

        <span class="n">get_jwst_file</span><span class="p">(</span>  <span class="c1"># 调用函数下载MSA文件</span>

            <span class="n">msa_name</span><span class="p">,</span>  <span class="c1"># MSA文件名</span>
            <span class="n">mast_api_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># 不使用API令牌</span>
            <span class="n">save_directory</span><span class="o">=</span><span class="n">mast_products_dir</span><span class="p">,</span>  <span class="c1"># 保存目录</span>
        <span class="p">)</span>

    <span class="n">msa_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msa_name</span><span class="p">)</span>  <span class="c1"># 将MSA文件名添加到列表中</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="spec2pipeline-nsclean">
<h2>4. 运行 <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> 而不进行 NSClean（原始数据） <a name="nsclean_skipped"></a><a class="headerlink" href="#spec2pipeline-nsclean" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>下面的单元格执行 <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code>，在处理过程中明确跳过 NSClean 步骤。生成的二级产品将作为参考点，展示在未去除 1/f 噪声的情况下，计数率图像和最终提取的光谱的外观。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置用于运行管道的目录，跳过NSClean处理</span>
<span class="n">stage2_nsclean_skipped_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_skipped/&quot;</span>

<span class="c1"># 检查目录是否存在</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_skipped_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stage2_nsclean_skipped_dir</span><span class="p">)</span>  <span class="c1"># 如果目录不存在，则创建该目录</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 原始数据（未应用NSClean）。</span>

<span class="c1"># 预计运行时间：1-2分钟。</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rate_names</span><span class="p">:</span>  <span class="c1"># 遍历每个速率名称</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>  <span class="c1"># 打印正在处理的文件名</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>  <span class="c1"># 检查文件名中是否包含&quot;nrs1&quot;</span>

        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;80&quot;</span>  <span class="c1"># 如果包含，设置slit_name为&quot;80&quot;</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;11&quot;</span>  <span class="c1"># 否则，设置slit_name为&quot;11&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>  <span class="c1"># 调用Spec2Pipeline进行数据处理</span>

        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>  <span class="c1"># 输入文件路径</span>

        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 设置保存结果为True</span>

        <span class="n">steps</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;slit_name&quot;</span><span class="p">:</span> <span class="n">slit_name</span><span class="p">}},</span>  <span class="c1"># 指定处理步骤，跳过nsclean</span>

        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_skipped_dir</span><span class="p">,</span>  <span class="c1"># 输出目录</span>

    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;cal.fits&quot;</span><span class="p">)</span>  <span class="c1"># 打印保存的cal.fits文件名</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1d.fits&quot;</span><span class="p">)</span>  <span class="c1"># 打印保存的x1d.fits文件名</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>  <span class="c1"># 打印运行时间（分钟）</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="nsclean-1-f">
<h2>5. 使用 NSClean 清理 1/f 噪声（默认管道掩膜） <a name="nsclean_default"></a><a class="headerlink" href="#nsclean-1-f" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>如果在 <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> 的 <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/nsclean/index.html">NSClean 步骤</a> 中未提供用户自定义的掩膜文件，管道将基于默认参数生成一个掩膜。该掩膜将识别任何未被照亮的像素。也就是说，掩膜必须包含 True 和 False 值，其中 True 表示该像素是黑暗的，False 表示该像素是被照亮的（不是黑暗的）。</p>
<p>默认情况下，管道将以下探测器区域标记为被照亮的非黑暗区域（False）：</p>
<ul class="simple">
<li><p>被指定为此 MOS 观测的开放狭缝的像素。</p></li>
<li><p>从失败开启的 MSA 快门中产生的轨迹。</p></li>
<li><p>5-σ 异常值（默认值）。</p></li>
<li><p>在速率数据中设置为 NaN 的任何像素。</p></li>
</ul>
<p>要调整掩膜中的异常值检测，可以尝试修改 <code class="docutils literal notranslate"><span class="pre">n_sigma</span></code> 参数（将在下一节中探讨）。较高的值将识别更少的异常值，而较低的值将识别更多的异常值。</p>
<p>默认生成的掩膜将在下面保存和分析。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置用于运行NSClean的目录，使用默认参数。</span>

<span class="n">stage2_nsclean_default_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_default/&quot;</span>  <span class="c1"># 定义默认目录路径</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_default_dir</span><span class="p">):</span>  <span class="c1"># 检查目录是否存在</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stage2_nsclean_default_dir</span><span class="p">)</span>  <span class="c1"># 如果目录不存在，则创建该目录。</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1/f 噪声清理数据（默认 NSClean 流水线掩膜）。</span>

<span class="c1"># 估计运行时间：6分钟。</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rate_names</span><span class="p">:</span>  <span class="c1"># 遍历速率名称列表</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>  <span class="c1"># 打印正在处理的文件名</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>  <span class="c1"># 检查文件名中是否包含 &quot;nrs1&quot;</span>

        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;80&quot;</span>  <span class="c1"># 如果包含，设置缝隙名称为 &quot;80&quot;</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;11&quot;</span>  <span class="c1"># 否则，设置缝隙名称为 &quot;11&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>  <span class="c1"># 调用 Spec2Pipeline 处理数据</span>

        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>  <span class="c1"># 输入文件路径</span>

        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 保存结果设置为 True</span>

        <span class="n">steps</span><span class="o">=</span><span class="p">{</span>  <span class="c1"># 处理步骤配置</span>

            <span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;save_mask&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>  <span class="c1"># NSClean 步骤配置</span>

            <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;slit_name&quot;</span><span class="p">:</span> <span class="n">slit_name</span><span class="p">},</span>  <span class="c1"># 提取 2D 数据时使用的缝隙名称</span>

        <span class="p">},</span>

        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_default_dir</span><span class="p">,</span>  <span class="c1"># 输出目录</span>

    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;mask.fits&quot;</span><span class="p">)</span>  <span class="c1"># 打印保存的掩膜文件名</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;nsclean.fits&quot;</span><span class="p">)</span>  <span class="c1"># 打印保存的清理后的文件名</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;cal.fits&quot;</span><span class="p">)</span>  <span class="c1"># 打印保存的校准文件名</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1d.fits&quot;</span><span class="p">)</span>  <span class="c1"># 打印保存的一维数据文件名</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>  <span class="c1"># 打印运行时间</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning">
<p><b>警告：</b></p>
<p>在某些情况下，NSClean步骤可能无法找到背景噪声的拟合。如果掩模中没有足够的暗数据（标记为True），则可能会发生这种失败。特别是，掩模中的每一列（除了前4列和最后4列）必须包含一些标记为True的像素。背景拟合过程会逐列考虑，因此如果某一列没有数据可供拟合，它将会崩溃。如果发生失败，请检查下面图像中的掩模，确保每一列至少有一些True值。</p>
</div><section id="id5">
<h3>5.1 验证掩膜（默认管道掩膜） <a name="verify_default_mask"></a><a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>检查掩膜与速率数据，以确保它仅保留探测器的暗区。</p>
<p>请注意，仍然存在一些被照亮的区域，主要是由于瞬态伪影，例如宇宙射线和雪球。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 绘制带有被遮挡区域的速率数据。</span>

<span class="c1"># 从管道中构建的即时掩膜列表。</span>
<span class="n">nsclean_default_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_mask.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS1掩膜文件路径</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_mask.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS2掩膜文件路径</span>
<span class="p">]</span>

<span class="c1"># 绘制每个相关的速率数据集和掩膜文件。</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">nsclean_default_masks</span><span class="p">):</span>  <span class="c1"># 遍历速率文件和掩膜文件的组合</span>
    <span class="n">plot_dark_data</span><span class="p">(</span><span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># 调用绘图函数，传入速率文件、掩膜文件、布局和缩放参数</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h3>5.2 比较原始数据与清理后的数据（默认管道掩模） <a name="nsclean_default_compare"></a><a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>现在我们可以将清理后的数据（使用默认管道掩模）与原始速率文件进行比较，并验证1/f噪声是否已被降低。</p>
<p>在许多情况下，清理过程会向速率文件引入新的伪影。这些伪影应仔细检查，并与噪声降低的好处进行权衡。如果瞬态伪影，如雪球，干扰了清理过程，手动编辑掩模以将这些区域从背景拟合中排除可能是有益的。为此，可以尝试改变异常值检测阈值或直接编辑掩模数组中的特定像素（将在接下来的几个部分中探讨）。否则，请参考<a class="reference external" href="https://iopscience.iop.org/article/10.1088/1538-3873/ad1b36/pdf">NSClean文档</a>以获取有关手动编辑的其他建议。</p>
<p>请注意，在下面的图像中，有一些散布的值与原始速率文件存在较大的相对差异（在下面的相对差异图像中显示）。这些是清理过程的伪影。</p>
<p>还有更广泛的低水平残余背景效应（在右侧的相对差异图像中显示，散布的异常值通过σ裁剪识别，并被掩模隐藏）。这些包括我们试图去除的背景模式：在色散方向上的1/f噪声变化以及全帧数据顶部和底部的画框效应。然而，清理过程中可能还会因过拟合暗数据而引入低水平伪影。</p>
<p>仔细检查这两幅残余图像，以了解清理过程对数据的影响。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 绘制原始数据和清理后的数据，以及残差图。</span>

<span class="c1"># 定义清理后的默认掩膜文件路径</span>
<span class="n">cleaned_default_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_nsclean.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS1清理后的文件路径</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_nsclean.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS2清理后的文件路径</span>
<span class="p">]</span>

<span class="c1"># 遍历每一组关联的rateint数据和清理后的文件</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">cleaned_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">cleaned_default_masks</span><span class="p">):</span>
    <span class="c1"># 绘制清理后的数据</span>
    <span class="n">plot_cleaned_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span>  <span class="c1"># 原始数据文件路径</span>
        <span class="n">cleaned_file</span><span class="p">,</span>                    <span class="c1"># 清理后的数据文件路径</span>
        <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span>                <span class="c1"># 布局方式为列</span>
        <span class="n">scale</span><span class="o">=</span><span class="mi">9</span>                          <span class="c1"># 缩放比例设置为9</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 绘制 NRS2 中 x=1000, y=600 附近的重度掩蔽区域</span>

<span class="c1"># 掩蔽过程可能引入一些高频噪声，这些噪声在光谱轨迹上表现为垂直条纹</span>

<span class="n">rate_file</span> <span class="o">=</span> <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># NRS2 文件路径</span>
<span class="n">original_rate_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rate_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">550</span><span class="p">:</span><span class="mi">651</span><span class="p">,</span> <span class="mi">800</span><span class="p">:</span><span class="mi">1401</span><span class="p">]</span>  <span class="c1"># 原始数据，裁剪区域</span>
<span class="n">cleaned_rate_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cleaned_default_masks</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">550</span><span class="p">:</span><span class="mi">651</span><span class="p">,</span> <span class="mi">800</span><span class="p">:</span><span class="mi">1401</span><span class="p">]</span>  <span class="c1"># 清理后的数据，裁剪区域</span>

<span class="c1"># 为了绘图可视化处理 NaN 值</span>
<span class="n">original_rate_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">original_rate_data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 将原始数据中的 NaN 替换为 0</span>
<span class="n">cleaned_rate_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cleaned_rate_data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 将清理后的数据中的 NaN 替换为 0</span>

<span class="c1"># 设置颜色映射的最小值和最大值</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">cleaned_rate_data</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 清理后数据的 5 百分位</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">cleaned_rate_data</span><span class="p">,</span> <span class="mi">100</span><span class="o">-</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># 清理后数据的 91 百分位</span>

<span class="c1"># 原始数据与清理数据的对比图</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># 创建 1 行 2 列的子图</span>

<span class="c1"># 绘制原始数据</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">original_rate_data</span><span class="p">,</span>  <span class="c1"># 原始数据</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>  <span class="c1"># 颜色映射</span>
        <span class="n">aspect</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># 纵横比</span>
        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>  <span class="c1"># 原点位置</span>
        <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">),</span>  <span class="c1"># 颜色范围</span>
    <span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># 关联的子图</span>
    <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># 颜色条与子图的间距</span>
    <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>  <span class="c1"># 颜色条缩放</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DN/s&quot;</span><span class="p">,</span>  <span class="c1"># 颜色条标签</span>
<span class="p">)</span>

<span class="c1"># 绘制清理后的数据</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">cleaned_rate_data</span><span class="p">,</span>  <span class="c1"># 清理后的数据</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>  <span class="c1"># 颜色映射</span>
        <span class="n">aspect</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># 纵横比</span>
        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>  <span class="c1"># 原点位置</span>
        <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">),</span>  <span class="c1"># 颜色范围</span>
    <span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># 关联的子图</span>
    <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># 颜色条与子图的间距</span>
    <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>  <span class="c1"># 颜色条缩放</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DN/s&quot;</span><span class="p">,</span>  <span class="c1"># 颜色条标签</span>
<span class="p">)</span>

<span class="c1"># 设置子图的标题、刻度值、x轴标签和y轴标签</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Original Rate Data (NRS2)&quot;</span><span class="p">,</span> <span class="s2">&quot;Cleaned Rate Data (NRS2)&quot;</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Pixel Column&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Pixel Row&quot;</span><span class="p">)</span>  <span class="c1"># 设置标题和轴标签</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="mi">700</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="mi">1300</span><span class="p">,</span> <span class="mi">1400</span><span class="p">])</span>  <span class="c1"># 设置 x 轴刻度标签</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="mi">475</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">525</span><span class="p">,</span> <span class="mi">575</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">625</span><span class="p">,</span> <span class="mi">650</span><span class="p">])</span>  <span class="c1"># 设置 y 轴刻度标签</span>
</pre></div>
</div>
</div>
</div>
<p>比较从清理后的数据中提取的光谱与从原始速率文件中提取的光谱。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1D 提取的光谱。</span>

<span class="c1"># 定义跳过清理的光谱文件列表</span>
<span class="n">x1d_nsclean_skipped</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_skipped_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_x1d.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS1光谱文件路径</span>
    <span class="n">stage2_nsclean_skipped_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_x1d.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS2光谱文件路径</span>
<span class="p">]</span>

<span class="c1"># 定义默认清理的光谱文件列表</span>
<span class="n">x1d_nsclean_default</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_x1d.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS1光谱文件路径</span>
    <span class="n">stage2_nsclean_default_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_x1d.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS2光谱文件路径</span>
<span class="p">]</span>

<span class="c1"># 感兴趣的波长区域。</span>

<span class="c1"># 遍历跳过清理和默认清理的光谱文件</span>
<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_default</span><span class="p">):</span>
    <span class="n">plot_spectra</span><span class="p">([</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span> <span class="n">scale_percent</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># 绘制光谱，缩放百分比为9</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>注意：</b></p>
<ul class="simple">
<li><p>在NRS1的80号狭缝和NRS2的11号狭缝中，整体连续体水平已因清理过程而略有改变。</p></li>
<li><p>在NRS2的11号狭缝中，原始光谱中的一些负通量已被修正。然而，默认掩膜中的过度掩膜引入了高频噪声，特别是在4.5 - 5.0微米之间影响了11号狭缝。这导致从清理后的数据提取的光谱与原始原始数据（如上所示）相比，出现了明显的下降。</p></li>
</ul>
</div></section>
</section>
<section id="id7">
<h2>6. 使用 NSClean（替代掩膜）清理 1/f 噪声 <a name="nsclean_alternate"></a><a class="headerlink" href="#id7" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>对于这个数据集，请注意，由于重叠的光栅区域，探测器的某些区域被严重掩膜。例如，查看上面 NRS2 的清理速率数据，在 x=1000，y=600 附近。</p>
<p>在这个区域，清理过程引入了一些高频噪声，表现为光谱轨迹上的垂直条纹。光栅 11 是从这个区域提取的，与原始速率数据（上面）相比，从清理后的数据中提取的光谱显示出明显的下降。</p>
<p>还要注意，对于 MOS 数据，探测器上可能存在几个未被光栅边界框掩膜的照明区域。对于 M 光栅，零级光谱可能出现在探测器上，并且不易定位。对于长通滤光片，仍然有一些光线穿过光栅边界框的红色截止。</p>
<p>在这种情况下，使用替代算法构建掩膜可能是有益的。在这里，我们不使用光栅边界框，而是迭代地掩膜任何超过背景 1 个标准差的数据。这在光谱轨迹之间留下了更多的暗数据，并改善了问题区域的背景拟合。</p>
<p>然而，请注意，过度清理可能会影响光谱的连续性水平，如果掩膜中包含的照明数据过多或过少。再次强调，生成的掩膜和输出光谱应仔细检查，以权衡清理的好处与对光谱的影响。</p>
<p>要调整此掩膜中的照明检测，请尝试修改下面的 <code class="docutils literal notranslate"><span class="pre">n_sigma</span></code> 参数。较高的值将识别较少的照明，较低的值将识别更多的照明。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置用于运行NSClean的目录，使用替代参数。</span>

<span class="n">stage2_nsclean_alternate_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_alternate/&quot;</span>  <span class="c1"># 定义替代参数的目录路径</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_alternate_dir</span><span class="p">):</span>  <span class="c1"># 检查目录是否存在</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span>  <span class="c1"># 如果目录不存在，则创建该目录</span>

        <span class="n">stage2_nsclean_alternate_dir</span>  <span class="c1"># 使用定义的路径创建目录</span>

    <span class="p">)</span>  <span class="c1"># 创建目录，如果不存在。</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1/f 噪声清理后的数据（备用 NSClean 管道掩膜）。</span>

<span class="c1"># 估计运行时间：7分钟。</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

<span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rate_names</span><span class="p">):</span>  <span class="c1"># 遍历 rate_names 列表，获取索引和文件名</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>  <span class="c1"># 打印正在处理的文件名</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>  <span class="c1"># 判断文件名中是否包含 &quot;nrs1&quot;</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;80&quot;</span>  <span class="c1"># 如果包含，设置光谱条带名称为 &quot;80&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;11&quot;</span>  <span class="c1"># 否则，设置光谱条带名称为 &quot;11&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>  <span class="c1"># 调用 Spec2Pipeline 的 call 方法</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>  <span class="c1"># 输入文件路径</span>
        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 保存结果</span>
        <span class="n">steps</span><span class="o">=</span><span class="p">{</span>  <span class="c1"># 处理步骤</span>
            <span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># NSClean 步骤</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># 不跳过此步骤</span>
                <span class="s2">&quot;save_mask&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># 保存掩膜</span>
                <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># 保存结果</span>
                <span class="s2">&quot;n_sigma&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># 设置 sigma 值</span>
                <span class="s2">&quot;mask_spectral_regions&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># 不掩膜光谱区域</span>
            <span class="p">},</span>
            <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;slit_name&quot;</span><span class="p">:</span> <span class="n">slit_name</span><span class="p">},</span>  <span class="c1"># 提取 2D 数据，使用指定的光谱条带名称</span>
        <span class="p">},</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_alternate_dir</span><span class="p">,</span>  <span class="c1"># 输出目录</span>
    <span class="p">)</span>

    <span class="c1"># 打印保存的文件名</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;mask.fits&quot;</span><span class="p">)</span>  <span class="c1"># 保存的掩膜文件</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;nsclean.fits&quot;</span><span class="p">)</span>  <span class="c1"># 保存的清理后的文件</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;cal.fits&quot;</span><span class="p">)</span>  <span class="c1"># 保存的校准文件</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1d.fits&quot;</span><span class="p">)</span>  <span class="c1"># 保存的 1D 文件</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>  <span class="c1"># 打印运行时间</span>
</pre></div>
</div>
</div>
</div>
<section id="id8">
<h3>6.1 验证掩模（备用掩模） <a name="verify_alternate_mask"></a><a class="headerlink" href="#id8" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>检查掩模与速率数据，以确保它仅保留探测器的暗区。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 绘制带有屏蔽区域的速率数据。</span>

<span class="c1"># 从管道中构建的即时掩膜列表。</span>
<span class="n">nsclean_alternate_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_mask.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS1掩膜文件路径</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_mask.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS2掩膜文件路径</span>
<span class="p">]</span>

<span class="c1"># 绘制每个相关的速率数据集和掩膜文件。</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">nsclean_alternate_masks</span><span class="p">):</span>  <span class="c1"># 遍历速率文件和掩膜文件</span>
    <span class="n">plot_dark_data</span><span class="p">(</span><span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># 调用绘图函数</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id9">
<h3>6.2 原始数据与清理数据的比较（备用掩模） <a name="nsclean_alternate_compare"></a><a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black"><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 绘制原始数据和清理后的数据，以及残差图。</span>

<span class="c1"># 定义清理后的备用掩膜文件路径列表</span>
<span class="n">cleaned_alternate_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_nsclean.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS1清理后的文件路径</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_nsclean.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS2清理后的文件路径</span>
<span class="p">]</span>

<span class="c1"># 遍历每一组速率数据文件和清理后的文件</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">cleaned_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">cleaned_alternate_masks</span><span class="p">):</span>
    <span class="c1"># 绘制清理后的数据</span>
    <span class="n">plot_cleaned_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span>  <span class="c1"># 原始速率数据文件路径</span>
        <span class="n">cleaned_file</span><span class="p">,</span>                    <span class="c1"># 清理后的数据文件路径</span>
        <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span>                <span class="c1"># 布局设置为列</span>
        <span class="n">scale</span><span class="o">=</span><span class="mi">9</span>                          <span class="c1"># 缩放因子设置为9</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>比较从清理后的数据中提取的光谱与从原始速率文件中提取的光谱。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义包含清理后的X1D数据文件路径的列表</span>
<span class="n">x1d_nsclean_alternate</span> <span class="o">=</span> <span class="p">[</span>

    <span class="c1"># 添加NRS1的清理后X1D数据文件路径</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_x1d.fits&quot;</span><span class="p">,</span>

    <span class="c1"># 添加NRS2的清理后X1D数据文件路径</span>
    <span class="n">stage2_nsclean_alternate_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_x1d.fits&quot;</span><span class="p">,</span>

<span class="p">]</span>

<span class="c1"># 遍历原始数据和清理后的数据，进行光谱绘制</span>
<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_alternate</span><span class="p">):</span>

    <span class="c1"># 绘制原始和清理后的光谱，设置缩放百分比为9%</span>
    <span class="n">plot_spectra</span><span class="p">([</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span> <span class="n">scale_percent</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>注意：</b></p>
<ul class="simple">
<li><p>在NRS1的80号光缝和NRS2的11号光缝中，整体连续体水平因清理过程（类似于默认掩蔽）而略有改变。</p></li>
<li><p>在NRS2的11号光缝中，原始光谱中的一些负通量已被修正。默认掩蔽引入的高频噪声影响了11号光缝在4.5 - 5.0微米之间的表现（导致光谱中出现负峰），而替代掩蔽改善了这一情况。</p></li>
</ul>
</div></section>
</section>
<section id="id10">
<h2>7. 使用 NSClean 清理 1/f 噪声（手动修改的掩模） <a name="nsclean_modified"></a><a class="headerlink" href="#id10" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>在某些情况下，可能需要手动生成掩模。在这里，我们介绍 <strong>一种</strong> 手动修改掩模的方法（在 NRS2 中编辑 x=1000, y=600 附近的过度掩模区域，以包含更多背景；排除 NRS1 中的一些大雪球），从管道的默认掩模输出开始。值得注意的是，使用这种方法修改的掩模不一定会优于之前的两种选项。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置用于运行 NSClean 的目录，并使用用户提供的掩膜。</span>

<span class="n">stage2_nsclean_modified_dir</span> <span class="o">=</span> <span class="s2">&quot;./stage2_nsclean_modified/&quot;</span>  <span class="c1"># 定义修改后的 NSClean 目录路径</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">):</span>  <span class="c1"># 检查目录是否存在</span>

    <span class="c1"># 如果目录不存在，则创建该目录。</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">)</span>  <span class="c1"># 创建目录</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 手动修改某些掩膜区域。</span>

<span class="c1"># 特别是修改NRS2中x=1000, y=600附近的区域。</span>

<span class="c1"># 定义一个列表来存储修改后的掩膜路径。</span>

<span class="n">nsclean_modified_masks</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 遍历原始掩膜列表。</span>

<span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">nsclean_default_masks</span><span class="p">:</span>

    <span class="c1"># 新的掩膜文件名。</span>

    <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_modified.fits&quot;</span>

    <span class="c1"># 打开FITS文件。</span>

    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>

        <span class="c1"># 从科学扩展中提取掩膜数据。</span>

        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;SCI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 复制数据。</span>

        <span class="k">if</span> <span class="s2">&quot;nrs2&quot;</span> <span class="ow">in</span> <span class="n">mask</span><span class="p">:</span>

            <span class="c1"># 步骤1：将默认掩膜区域设置回True。</span>

            <span class="n">mask_data</span><span class="p">[</span><span class="mi">550</span><span class="p">:</span><span class="mi">651</span><span class="p">,</span> <span class="p">:</span><span class="mi">1300</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># 步骤2：手动重新定义掩膜区域。</span>

            <span class="n">mask_data</span><span class="p">[</span><span class="mi">550</span><span class="p">:</span><span class="mi">575</span><span class="p">,</span> <span class="p">:</span><span class="mi">1300</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># NRS2中的拥挤区域。</span>

            <span class="n">mask_data</span><span class="p">[</span><span class="mi">590</span><span class="p">:</span><span class="mi">615</span><span class="p">,</span> <span class="mi">150</span><span class="p">:</span><span class="mi">1720</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">mask_data</span><span class="p">[</span><span class="mi">622</span><span class="p">:</span><span class="mi">647</span><span class="p">,</span> <span class="mi">100</span><span class="p">:</span><span class="mi">1620</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">mask_data</span><span class="p">[</span><span class="mi">50</span><span class="p">:</span><span class="mi">130</span><span class="p">,</span> <span class="mi">780</span><span class="p">:</span><span class="mi">850</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 雪球区域</span>

            <span class="n">mask_data</span><span class="p">[</span><span class="mi">110</span><span class="p">:</span><span class="mi">140</span><span class="p">,</span> <span class="mi">920</span><span class="p">:</span><span class="mi">945</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">mask_data</span><span class="p">[</span><span class="mi">820</span><span class="p">:</span><span class="mi">940</span><span class="p">,</span> <span class="mi">2000</span><span class="p">:</span><span class="mi">2040</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">mask_data</span><span class="p">[</span><span class="mi">1650</span><span class="p">:</span><span class="mi">1700</span><span class="p">,</span> <span class="mi">1900</span><span class="p">:</span><span class="mi">1960</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">mask_data</span><span class="p">[</span><span class="mi">1800</span><span class="p">:</span><span class="mi">1900</span><span class="p">,</span> <span class="mi">330</span><span class="p">:</span><span class="mi">410</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># 更新科学扩展中的数据。</span>

        <span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;SCI&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">mask_data</span>

        <span class="c1"># 保存修改后的FITS文件</span>

        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

        <span class="n">hdul_modified</span> <span class="o">=</span> <span class="n">hdul</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 复制hdul。</span>

        <span class="n">hdul_modified</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 写入修改后的文件，覆盖同名文件。</span>

        <span class="n">nsclean_modified_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>  <span class="c1"># 将修改后的路径添加到列表中。</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved modified mask as: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印保存的文件路径。</span>
</pre></div>
</div>
</div>
</div>
<section id="id11">
<h3>7.1 验证掩模（手动修改的掩模） <a name="verify_modified_mask"></a><a class="headerlink" href="#id11" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black">
<p>检查掩模与速率数据，以确保它仅保留探测器的暗区。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 绘制带有屏蔽区域的速率数据。</span>

<span class="c1"># 修改后的掩膜列表，用于数据处理管道。</span>
<span class="n">nsclean_modified_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_mask_modified.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS1的修改掩膜文件路径</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_mask_modified.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS2的修改掩膜文件路径</span>
<span class="p">]</span>

<span class="c1"># 遍历每个相关的速率数据文件和掩膜文件进行绘图。</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">nsclean_modified_masks</span><span class="p">):</span>
    <span class="n">plot_dark_data</span><span class="p">(</span><span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">mask_file</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># 绘制速率数据，使用指定的掩膜文件和布局</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>注意：</b> 在修改NRS2的默认掩膜时，我们选择了一个区域进行解掩膜，然后以不同的方式重新掩膜。然而，这个过程不小心导致了一些之前被掩膜的NaN值（在NRS2的暗数据图中看到的白色像素）被解掩膜。因此，在修改掩膜时应谨慎。此外，尽管我们掩膜了各种雪球，但根据我们提取的狭缝，1D提取光谱可能不会观察到差异。</p>
</div><hr style="border:1px solid black"><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1/f 噪声清理数据（用户提供的掩膜）。</span>

<span class="c1"># 估计运行时间：5分钟。</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

<span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rate_names</span><span class="p">):</span>  <span class="c1"># 遍历速率名称列表</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>  <span class="c1"># 打印正在处理的文件名</span>

    <span class="k">if</span> <span class="s2">&quot;nrs1&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>  <span class="c1"># 判断文件名中是否包含&quot;nrs1&quot;</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;80&quot;</span>  <span class="c1"># 如果包含，设置光谱缝名称为&quot;80&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slit_name</span> <span class="o">=</span> <span class="s2">&quot;11&quot;</span>  <span class="c1"># 否则，设置光谱缝名称为&quot;11&quot;</span>

    <span class="n">Spec2Pipeline</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>  <span class="c1"># 调用Spec2Pipeline进行数据处理</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>  <span class="c1"># 输入文件路径</span>
        <span class="n">save_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 保存结果</span>
        <span class="n">steps</span><span class="o">=</span><span class="p">{</span>  <span class="c1"># 处理步骤</span>
            <span class="s2">&quot;nsclean&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># 噪声清理步骤</span>
                <span class="s2">&quot;skip&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># 不跳过此步骤</span>
                <span class="s2">&quot;save_mask&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># 保存掩膜</span>
                <span class="s2">&quot;save_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># 保存结果</span>
                <span class="s2">&quot;user_mask&quot;</span><span class="p">:</span> <span class="n">nsclean_modified_masks</span><span class="p">[</span><span class="n">indx</span><span class="p">],</span>  <span class="c1"># 使用用户提供的掩膜</span>
            <span class="p">},</span>
            <span class="s2">&quot;extract_2d&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;slit_name&quot;</span><span class="p">:</span> <span class="n">slit_name</span><span class="p">},</span>  <span class="c1"># 提取2D数据，使用指定的光谱缝名称</span>
        <span class="p">},</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">stage2_nsclean_modified_dir</span><span class="p">,</span>  <span class="c1"># 输出目录</span>
    <span class="p">)</span>

    <span class="c1"># 打印保存的文件名</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;mask.fits&quot;</span><span class="p">)</span>  <span class="c1"># 保存的掩膜文件</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;nsclean.fits&quot;</span><span class="p">)</span>  <span class="c1"># 保存的噪声清理结果文件</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;cal.fits&quot;</span><span class="p">)</span>  <span class="c1"># 保存的校准文件</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;x1d.fits&quot;</span><span class="p">)</span>  <span class="c1"># 保存的1D提取文件</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run time: &quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="s2">&quot; min&quot;</span><span class="p">)</span>  <span class="c1"># 打印运行时间</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id12">
<h3>7.2 原始数据与清理数据（手动修改的掩模）比较 <a name="nsclean_modified_compare"></a><a class="headerlink" href="#id12" title="Link to this heading">#</a></h3>
<hr style="border:1px solid black"><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 绘制原始数据和清理后的数据，以及残差图。</span>

<span class="c1"># 定义清理后的文件路径列表</span>
<span class="n">cleaned_modified_masks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_nsclean.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS1清理后的文件路径</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_nsclean.fits&quot;</span><span class="p">,</span>  <span class="c1"># NRS2清理后的文件路径</span>
<span class="p">]</span>

<span class="c1"># 遍历每个关联的rateint数据和清理后的文件</span>
<span class="k">for</span> <span class="n">rate_file</span><span class="p">,</span> <span class="n">cleaned_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rate_names</span><span class="p">,</span> <span class="n">cleaned_modified_masks</span><span class="p">):</span>
    <span class="c1"># 绘制清理后的数据</span>
    <span class="n">plot_cleaned_data</span><span class="p">(</span>
        <span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_file</span><span class="p">,</span>  <span class="c1"># 原始数据文件路径</span>
        <span class="n">cleaned_file</span><span class="p">,</span>                    <span class="c1"># 清理后的数据文件路径</span>
        <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span>                <span class="c1"># 布局方式为列</span>
        <span class="n">scale</span><span class="o">=</span><span class="mi">9</span>                          <span class="c1"># 缩放比例设置为9</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>比较从清理后的数据中提取的光谱与从原始速率文件中提取的光谱。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义修改后的 x1d_nsclean 文件路径列表</span>
<span class="n">x1d_nsclean_modified</span> <span class="o">=</span> <span class="p">[</span>

    <span class="c1"># 添加第一个文件的路径</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs1_x1d.fits&quot;</span><span class="p">,</span>

    <span class="c1"># 添加第二个文件的路径</span>
    <span class="n">stage2_nsclean_modified_dir</span> <span class="o">+</span> <span class="s2">&quot;jw01345061001_07101_00003_nrs2_x1d.fits&quot;</span><span class="p">,</span>

<span class="p">]</span>

<span class="c1"># 感兴趣的波长区域</span>

<span class="c1"># 遍历原始和清理后的光谱文件</span>
<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x1d_nsclean_skipped</span><span class="p">,</span> <span class="n">x1d_nsclean_modified</span><span class="p">):</span>

    <span class="c1"># 绘制原始和清理后的光谱，缩放百分比设置为9%</span>
    <span class="n">plot_spectra</span><span class="p">([</span><span class="n">original</span><span class="p">,</span> <span class="n">cleaned</span><span class="p">],</span> <span class="n">scale_percent</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>注意事项:</b></p>
<ul class="simple">
<li><p>在NRS1的狭缝80上，整体连续谱水平因清理过程而略有改变（类似于默认掩模和替代掩模）。</p></li>
<li><p>在NRS2的狭缝11上，由于使用手动修改的掩模进行清理过程，4-4.55微米之间的通量有所下降。原始光谱中（在更短和更长波长处）的一些负通量已被修正。</p></li>
</ul>
</div></section>
</section>
<section id="id13">
<h2>8. 结论 <a name="conclusion"></a><a class="headerlink" href="#id13" title="Link to this heading">#</a></h2>
<hr style="border:1px solid black">
<p>下面的最终图表展示了计数率图像和相应的1D提取光谱并排比较不同的清理方法：原始图像（未应用NSClean）、清理后的计数率图像（使用默认的管道掩模）、清理后的计数率图像（使用替代的管道掩模），以及最后，清理后的计数率图像（使用手动修改的掩模）。</p>
<p>请注意，本笔记本中呈现的结果可能会因不同的数据集而有所不同（例如，不同亮度、空间范围等的目标）。鼓励用户使用不同的掩模方法探索NSClean，以确定最佳结果。</p>
<p>清理算法的输出现在已准备好进行进一步处理。由上述<code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code>运行生成的(<em>_cal.fits</em>)文件可用作<code class="docutils literal notranslate"><span class="pre">Spec3Pipeline</span></code>的输入，以生成最终的组合光谱。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 未清理数据 vs. 清理数据（默认掩膜） vs. 清理数据（备用掩膜）速率数据</span>

<span class="c1"># 读取原始速率数据</span>
<span class="n">original_rate_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mast_products_dir</span> <span class="o">+</span> <span class="n">rate_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">rate_name</span> <span class="ow">in</span> <span class="n">rate_names</span>  <span class="c1"># 从文件中打开并提取数据</span>
<span class="p">]</span>

<span class="c1"># 读取清理后的默认掩膜速率数据</span>
<span class="n">cleaned_rate_default_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cleaned_default_mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 从清理后的默认掩膜文件中打开并提取数据</span>
    <span class="k">for</span> <span class="n">cleaned_default_mask</span> <span class="ow">in</span> <span class="n">cleaned_default_masks</span>
<span class="p">]</span>

<span class="c1"># 读取清理后的备用掩膜速率数据</span>
<span class="n">cleaned_rate_alternate_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cleaned_alternate_mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 从清理后的备用掩膜文件中打开并提取数据</span>
    <span class="k">for</span> <span class="n">cleaned_alternate_mask</span> <span class="ow">in</span> <span class="n">cleaned_alternate_masks</span>
<span class="p">]</span>

<span class="c1"># 读取清理后的手动修改掩膜速率数据</span>
<span class="n">cleaned_rate_modified_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cleaned_modified_mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 从清理后的手动修改掩膜文件中打开并提取数据</span>
    <span class="k">for</span> <span class="n">cleaned_modified_mask</span> <span class="ow">in</span> <span class="n">cleaned_modified_masks</span>
<span class="p">]</span>

<span class="c1"># 为可视化绘图准备数据</span>
<span class="k">for</span> <span class="n">data_list</span> <span class="ow">in</span> <span class="p">[</span>
    <span class="n">original_rate_data</span><span class="p">,</span>  <span class="c1"># 原始速率数据</span>
    <span class="n">cleaned_rate_default_data</span><span class="p">,</span>  <span class="c1"># 清理后的默认掩膜速率数据</span>
    <span class="n">cleaned_rate_alternate_data</span><span class="p">,</span>  <span class="c1"># 清理后的备用掩膜速率数据</span>
    <span class="n">cleaned_rate_modified_data</span><span class="p">,</span>  <span class="c1"># 清理后的手动修改掩膜速率数据</span>
<span class="p">]:</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 将NaN值替换为0</span>

<span class="c1"># 原始数据与清理数据（使用默认掩膜）进行比较</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>  <span class="c1"># 创建子图</span>

<span class="c1"># 设置y轴标题并绘制数据</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Original Rate Data&quot;</span><span class="p">,</span>  <span class="c1"># 原始速率数据标题</span>
    <span class="s2">&quot;Cleaned Rate Data (Default Mask)&quot;</span><span class="p">,</span>  <span class="c1"># 清理后的默认掩膜速率数据标题</span>
    <span class="s2">&quot;Cleaned Rate Data (Alternate Mask)&quot;</span><span class="p">,</span>  <span class="c1"># 清理后的备用掩膜速率数据标题</span>
    <span class="s2">&quot;Cleaned Rate Data (Hand-Modified Mask)&quot;</span><span class="p">,</span>  <span class="c1"># 清理后的手动修改掩膜速率数据标题</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
    <span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">original_rate_data</span><span class="p">,</span>  <span class="c1"># 原始速率数据</span>
            <span class="n">cleaned_rate_default_data</span><span class="p">,</span>  <span class="c1"># 清理后的默认掩膜速率数据</span>
            <span class="n">cleaned_rate_alternate_data</span><span class="p">,</span>  <span class="c1"># 清理后的备用掩膜速率数据</span>
            <span class="n">cleaned_rate_modified_data</span><span class="p">,</span>  <span class="c1"># 清理后的手动修改掩膜速率数据</span>
        <span class="p">],</span>
        <span class="n">titles</span><span class="p">,</span>  <span class="c1"># 标题列表</span>
    <span class="p">)</span>
<span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_list</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># 获取当前子图</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;NRS1&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;NRS2&quot;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>  <span class="c1"># 设置标题</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1e-2</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">))</span>  <span class="c1"># 绘制图像</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DN/s&quot;</span><span class="p">)</span>  <span class="c1"># 添加颜色条</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel Column&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Pixel Row&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图布局</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 最终比较</span>

<span class="c1"># 绘制第一组光谱数据</span>
<span class="n">plot_spectra</span><span class="p">(</span>

    <span class="p">[</span>
        <span class="n">x1d_nsclean_skipped</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># 跳过的清理数据的第一组光谱</span>
        <span class="n">x1d_nsclean_default</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># 默认清理数据的第一组光谱</span>
        <span class="n">x1d_nsclean_alternate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="c1"># 替代清理数据的第一组光谱</span>
        <span class="n">x1d_nsclean_modified</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># 修改后的清理数据的第一组光谱</span>
    <span class="p">],</span>

    <span class="n">scale_percent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># 设置缩放百分比为4%</span>
<span class="p">)</span>

<span class="c1"># 绘制第二组光谱数据</span>
<span class="n">plot_spectra</span><span class="p">(</span>

    <span class="p">[</span>
        <span class="n">x1d_nsclean_skipped</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># 跳过的清理数据的第二组光谱</span>
        <span class="n">x1d_nsclean_default</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># 默认清理数据的第二组光谱</span>
        <span class="n">x1d_nsclean_alternate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># 替代清理数据的第二组光谱</span>
        <span class="n">x1d_nsclean_modified</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># 修改后的清理数据的第二组光谱</span>
    <span class="p">],</span>

    <span class="n">scale_percent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># 设置缩放百分比为4%</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-info">
<p><b>最终说明：</b></p>
<ul class="simple">
<li><p>默认掩膜引入的NRS2高频噪声影响了在4.55微米附近的11号狭缝的1D提取光谱，但使用替代掩膜后该噪声不再出现（手动修改的掩膜略有改善），显著改善了11号狭缝的光谱。</p></li>
<li><p>11号狭缝的负通量（在短波长和长波长处）已通过任一掩膜进行了修正。然而，手动修改的掩膜似乎降低了11号狭缝在4-4.55微米之间的光谱连续性水平。在这种情况下，替代掩膜（基于剪辑的）算法优于对每个MSA快门阻塞整个科学区域。</p></li>
</ul>
</div></section>
<section id="id14">
<h2>关于笔记本 <a name="about"></a><a class="headerlink" href="#id14" title="Link to this heading">#</a></h2>
<p><strong>作者：</strong> Melanie Clarke, Kayli Glidic; NIRSpec仪器团队</p>
<p><strong>更新时间：</strong> 2024年2月29日。</p>
<hr style="border:0.5px solid black">
<p><a class="reference internal" href="#top"><span class="xref myst">页面顶部</span></a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRSpec/NIRSpec_NSClean"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="IFU_NSClean_example_cn.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">使用 NSClean 清理 NIRSpec IFU 产品中的残余 1/f 噪声</p>
      </div>
    </a>
    <a class="right-next"
       href="BOTS_NSClean_example_cn.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">使用 NSClean 清理 NIRSpec BOTS 产品中的残余 1/f 噪声</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook">Notebook 目标</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">目录</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">1. 介绍 <a name="introduction"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">2. 导入库 <a name="imports"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">3. 下载数据 <a name="data"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spec2pipeline-nsclean">4. 运行 <code class="docutils literal notranslate"><span class="pre">Spec2Pipeline</span></code> 而不进行 NSClean（原始数据） <a name="nsclean_skipped"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nsclean-1-f">5. 使用 NSClean 清理 1/f 噪声（默认管道掩膜） <a name="nsclean_default"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">5.1 验证掩膜（默认管道掩膜） <a name="verify_default_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">5.2 比较原始数据与清理后的数据（默认管道掩模） <a name="nsclean_default_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">6. 使用 NSClean（替代掩膜）清理 1/f 噪声 <a name="nsclean_alternate"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">6.1 验证掩模（备用掩模） <a name="verify_alternate_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">6.2 原始数据与清理数据的比较（备用掩模） <a name="nsclean_alternate_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">7. 使用 NSClean 清理 1/f 噪声（手动修改的掩模） <a name="nsclean_modified"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">7.1 验证掩模（手动修改的掩模） <a name="verify_modified_mask"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">7.2 原始数据与清理数据（手动修改的掩模）比较 <a name="nsclean_modified_compare"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">8. 结论 <a name="conclusion"></a></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">关于笔记本 <a name="about"></a></a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>