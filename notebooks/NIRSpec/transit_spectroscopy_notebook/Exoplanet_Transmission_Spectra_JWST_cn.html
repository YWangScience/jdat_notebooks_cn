
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>BOTS 时间序列观测 &#8212; STScI JDAT Notebooks 中文版</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css?v=b44a18d9" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST_cn';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="红移和模板拟合" href="../galaxy_redshift/redshift_fitting_cn.html" />
    <link rel="prev" title="星系外场的MOS光谱" href="../mos_spectroscopy_advanced/MOSspec_advanced_cn.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro_cn.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks 中文版 - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks 中文版 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro_cn.html">
                    <no title>
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index_cn.html">主页</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install_cn.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow_cn.html">笔记本开发工作流程</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">开发</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks_cn.html">提交笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements_cn.html">需求文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks_cn.html">Jupyter 笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files_cn.html">数据文件</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub 指南</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup_cn.html">GitHub 设置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow_cn.html">GitHub 工作流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr_cn.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">跨仪器通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example_cn.html">ASDF 示例</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation_cn.html">复杂的二维背景</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3_cn.html">复合模型光谱拟合</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query_cn.html">MAST 查询</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina_cn.html">Imviz RGB图像</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift_cn.html">Specviz 简单示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS_cn.html">提高纯平行数据集的WCS精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/stpsf_examples/stpsf_examples_cn.html">STPSF 示例</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis_cn.html">MRS Mstar - 数据分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc_cn.html">LMC中的IFU YSOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1_cn.html">LRS 光谱提取</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example_cn.html">点源光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry_cn.html">扩展孔径光度测量</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry_cn.html">交叉滤光片 PSF 匹配</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example_cn.html">PSF 光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction_cn.html">NIRCam 光晕去除</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction_cn.html">WFSS 光谱 - 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra_cn.html">WFSS 光谱 - 合并和归一化 1D 光谱</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template_cn.html">WFSS 光谱 - 相关性模版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map_cn.html">WFSS 光谱 - 发射线图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup_cn.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3_cn.html">运行图像处理管道并创建源目录</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2_cn.html">运行 spec2 管道</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit_cn.html">IFU立方体拟合</a></li>




<li class="toctree-l1"><a class="reference internal" href="../cube_fitting/cube_fitting_cn.html">IFU Cube 建模</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifu_optimal/ifu_optimal_cn.html">IFU 光谱提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static_cn.html">MOS 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mos_spectroscopy_advanced/MOSspec_advanced_cn.html">星系外场的MOS光谱</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">BOTS 时间序列观测</a></li>








<li class="toctree-l1"><a class="reference internal" href="../galaxy_redshift/redshift_fitting_cn.html">红移和模板拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/FS_NSClean_example_cn.html">FS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/IFU_NSClean_example_cn.html">IFU 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/MOS_NSClean_example_cn.html">MOS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/BOTS_NSClean_example_cn.html">BOTS 数据生成 （NSClean）</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST_cn.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>BOTS 时间序列观测</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">BOTS 时间序列观测</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">引言</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">加载包</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">设置参数</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#nirspec">下载和加载NIRSpec数据</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">可视化二维光谱数据</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#d1d">从2D图像数组中提取1D光谱</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">可视化一维光谱数据</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">计算轨道相位及用于绘图目的的单独细网模型</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">处理探测器上的系统漂移</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">创建用于去趋势的向量数组。</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">过境和边缘暗化模型函数</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">现在定义过境模型函数</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">现在定义生成过境光曲线的函数并将其与数据进行比较</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#fit">FIT过渡光曲线</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">设置待拟合的波长</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">循环遍历波长区间，拟合每个光曲线</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">注意：此步骤需要相当长的时间来完成（约20分钟，每个波长区间几分钟）</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">绘制测量的系外行星传输光谱与注入光谱对比</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="bots">
<h1>BOTS 时间序列观测<a class="headerlink" href="#bots" title="Link to this heading">#</a></h1>
<p><strong>用例：</strong> 明亮天体时间序列；提取系外行星光谱。<br></p>
<p><strong>数据：</strong> 来自地面观测活动的 JWST 模拟 NIRSpec 数据；GJ436b 光谱来自 Goyal 等人 (2018)。<br></p>
<p><strong>工具：</strong> scikit, lmfit, scipy, matplotlib, astropy, pandas。<br></p>
<p><strong>跨仪器：</strong> . <br></p>
<p><strong>文档：</strong> 本笔记本是 STScI 更大 <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">后处理数据分析工具生态系统</a> 的一部分。<br></p>
<p><strong>作者：</strong> David K. Sing (dsing&#64;jhu.edu)<br></p>
<p><strong>最后更新：</strong> 2020年7月2日</p>
<section id="id1">
<h2>引言<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>本笔记本使用在地面观测活动中获取的时间序列 JWST NIRSpec 数据，演示如何从时间序列观测中提取系外行星光谱。</p>
<p>这些数据源自 ISIM-CV3，即 JWST 综合科学仪器模块 (ISIM) 的低温真空测试活动，该活动于 2015-2016 年冬季在戈达德太空飞行中心进行（Kimble 等人，2016）。数据可以在 https://www.cosmos.esa.int/web/jwst-nirspec/test-data 找到，G. Giardino, S. Birkmann, P. Ferruit, B. Dorner, B. Rauscher 对数据的详细和深刻的报告可以在此处找到：ftp://ftp.cosmos.esa.int/jwstlib/ReleasedCV3dataTimeSeries/CV3_TimeSeries_PRM.tgz</p>
<p>该 NIRSpec 时间序列数据集在像素级别注入了过境光曲线，紧密模拟了过境系外行星的明亮天体时间序列 (BOTS) 观测。在这种情况下，选择了来自</p>
<p><strong><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018MNRAS.474.5158G/">Goyal 等人 (2018)</a></strong></p>
<p>的系外行星网格中的 GJ436b 光谱（太阳金属丰度下的清晰大气）。使用实际的 NIRSpec 数据集，可以更准确地模拟探测器的噪声特性、抖动以及从时间序列观测中提取系外行星光谱的影响。</p>
<p>总体而言，本笔记本的目的是处理这些时间序列观测，以：</p>
<ol class="arabic simple">
<li><p>从 2D 光谱图像中提取 1D 光谱。</p></li>
<li><p>定义一个时间序列模型，以拟合波长依赖的过境光曲线。</p></li>
<li><p>拟合 1D 光谱的每个时间序列波长区间，测量所需的量 <span class="math notranslate nohighlight">\(R_{pl}(\lambda)/R_{star}\)</span>。</p></li>
<li><p>生成可与模型进行比较的测量透射光谱。</p></li>
</ol>
<p>该示例输出每个光谱区间的拟合光曲线及其拟合统计信息。</p>
</section>
<section id="id2">
<h2>加载包<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>本笔记本使用的包（matplotlib、astropy、scipy、glob、lmfit、pickle、os、sklearn）均可通过pip以标准方式安装。</p>
<p>从ExoTiC-ISM中提取了几种计算边缘变暗（limb-darkening）和过境模型的例程（__ <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020JOSS....5.2281L/">Laginja &amp; Wakeford 2020</a>__；https://github.com/hrwakeford/ExoTiC-ISM），并进行了稍微的调整。用于边缘变暗计算的完整恒星模型集也可以从ExoTiC-ISM下载，因为本笔记本仅下载并加载了用于生成边缘变暗的单个恒星模型。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># 导入NumPy库，用于数值计算</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>  <span class="c1"># 导入Matplotlib库，用于绘图</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ticker</span>  <span class="c1"># 导入Matplotlib的ticker模块，用于控制坐标轴刻度</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backends.backend_pdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PdfPages</span>  <span class="c1"># 导入PdfPages，用于将图形保存为PDF文件</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">download_file</span>  <span class="c1"># 从Astropy库导入下载文件的功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>  <span class="c1"># 从Astropy库导入Table类，用于处理表格数据</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span><span class="p">,</span> <span class="n">ascii</span>  <span class="c1"># 导入FITS和ASCII文件的读写功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">custom_model</span>  <span class="c1"># 导入自定义模型功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.fitting</span><span class="w"> </span><span class="kn">import</span> <span class="n">LevMarLSQFitter</span>  <span class="c1"># 导入Levenberg-Marquardt最小二乘拟合器</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">splev</span><span class="p">,</span> <span class="n">splrep</span>  <span class="c1"># 导入SciPy库中的插值功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">readsav</span>  <span class="c1"># 导入读取SAV文件的功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>  <span class="c1"># 导入SciPy库中的统计功能</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>  <span class="c1"># 导入glob模块，用于文件路径匹配</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">lmfit</span>  <span class="c1"># 导入lmfit库，用于非线性最小二乘拟合</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>  <span class="c1"># 导入pickle模块，用于对象序列化和反序列化</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">mkdir</span>  <span class="c1"># 从os模块导入路径操作和创建目录的功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>  <span class="c1"># 导入线性回归模型</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>  <span class="c1"># 导入Pandas库，用于数据处理和分析</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  <span class="c1"># 导入os模块，用于操作系统相关功能</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>  <span class="c1"># 导入shutil模块，用于文件和目录的高级操作</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h2>设置参数<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>拟合的参数包括存放数据和边缘变暗（limb darkening）恒星模型的目录，以及行星和恒星的属性。这里输入的恒星和行星值（以GJ436为模型）与用于模拟注入过境的值相同。请注意，用于注入过境的4500K恒星模型比GJ436A更热。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SETUP  ----------------------------------------------</span>

<span class="c1"># 设置目录</span>

<span class="n">save_directory</span> <span class="o">=</span> <span class="s1">&#39;./notebookrun2/&#39;</span>          <span class="c1"># 本地目录，用于保存文件</span>

<span class="n">data_directory</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>                       <span class="c1"># 本地数据目录，用于处理fits文件（如果需要）</span>

<span class="c1"># 设置探测器属性和红噪声测量时间尺度</span>

<span class="n">gain</span> <span class="o">=</span> <span class="mf">1.0</span>   <span class="c1"># 2D光谱已转换为计数，探测器增益为1.0</span>

<span class="n">binmeasure</span> <span class="o">=</span> <span class="mi">256</span>   <span class="c1"># 测量红噪声的分箱技术，选择评估sigma_r的箱大小</span>

<span class="n">number_of_images</span> <span class="o">=</span> <span class="mi">8192</span>  <span class="c1"># 数据集中图像的数量</span>

<span class="c1"># 设置行星属性</span>

<span class="n">grating</span> <span class="o">=</span> <span class="s1">&#39;NIRSpecPrism&#39;</span>  <span class="c1"># 使用的光栅类型</span>

<span class="n">ld_model</span> <span class="o">=</span> <span class="s1">&#39;3D&#39;</span>      <span class="c1"># 选择3D/1D恒星模型（过境是用3D模型注入的）</span>

<span class="c1"># 设置恒星属性以进行光晕变暗计算</span>

<span class="n">Teff</span> <span class="o">=</span> <span class="mi">4500</span>           <span class="c1"># 有效温度（K）</span>

<span class="n">logg</span> <span class="o">=</span> <span class="mf">4.5</span>            <span class="c1"># 表面重力</span>

<span class="n">M_H</span> <span class="o">=</span> <span class="mf">0.0</span>            <span class="c1"># 恒星金属丰度 log_10[M/H]</span>

<span class="n">Rstar</span> <span class="o">=</span> <span class="mf">0.455</span>          <span class="c1"># 行星半径（以太阳半径为单位）</span>

<span class="c1"># 设置过境参数（可以从NASA系外行星档案中获取）</span>

<span class="n">t0</span> <span class="o">=</span> <span class="mf">2454865.084034</span>              <span class="c1"># 最低交点的BJD时间</span>

<span class="n">per</span> <span class="o">=</span> <span class="mf">2.64389803</span>                  <span class="c1"># 轨道周期（天）BJD_TDB</span>

<span class="n">rp</span> <span class="o">=</span> <span class="mf">0.0804</span>                      <span class="c1"># 行星半径（以恒星半径为单位）</span>

<span class="n">a_Rs</span> <span class="o">=</span> <span class="mf">14.54</span>                       <span class="c1"># 半长轴（输入a/Rstar，因此单位为恒星半径）</span>

<span class="n">inc</span> <span class="o">=</span> <span class="mf">86.858</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">360</span><span class="p">)</span>      <span class="c1"># 轨道倾角（从度转换为弧度）</span>

<span class="n">ecc</span> <span class="o">=</span> <span class="mf">0.0</span>                         <span class="c1"># 离心率</span>

<span class="n">omega</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">360</span><span class="p">)</span>         <span class="c1"># 近日点经度（从度转换为弧度）</span>

<span class="c1"># 计算恒星密度（g/cm^3），基于a/Rs</span>

<span class="n">rho_star</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">6.67259E-8</span><span class="o">*</span><span class="p">(</span><span class="n">per</span><span class="o">*</span><span class="mi">86400</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a_Rs</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>     <span class="c1"># 从a/Rs计算恒星密度</span>

<span class="c1"># a_Rs=(rho_star*6.67259E-8*per_sec*per_sec/(3*np.pi))**(1/3)  # 从恒星密度计算a/Rs（g/cm^3）</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 创建本地目录</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_directory</span><span class="p">):</span>  <span class="c1"># 检查保存目录是否存在</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">save_directory</span><span class="p">)</span>              <span class="c1"># 如果不存在，则创建一个新的目录以保存输出</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;3DGrid&#39;</span><span class="p">):</span>  <span class="c1"># 检查3DGrid目录是否存在</span>
    <span class="n">mkdir</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;3DGrid&#39;</span><span class="p">)</span>             <span class="c1"># 如果不存在，则创建新的3DGrid目录以保存数据</span>

<span class="n">limb_dark_directory</span> <span class="o">=</span> <span class="n">save_directory</span>  <span class="c1"># 指向包含3DGrid/目录的光晕暗化目录</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="nirspec">
<h1>下载和加载NIRSpec数据<a class="headerlink" href="#nirspec" title="Link to this heading">#</a></h1>
<p>FITS图像被加载，包含图像日期和科学光谱的信息被保存。</p>
<p>一个默认的通量偏移值BZERO也从头文件中提取，并从每个科学帧中减去。</p>
<p>读取2^13个FITS文件的速度较慢。为了加快速度，我们创建了一个pickle文件，用于首次加载FITS图像时。这个1GB的pickle文件会被加载，而不是读取FITS文件（如果找到的话）。</p>
<p>另外，FITS文件可以在这里下载：</p>
<p>https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/Archive.Trace_SLIT_A_1600_SRAD-PRM-PS-6007102143_37803_JLAB88_injected.tar.gz。图像位于一个tar.gz归档文件中，需要解压缩，并在上面的SETUP单元中设置data_directory变量为该目录。</p>
<p>下面的单元将下载1GB的JWST数据pickle文件，以及其他几个所需的文件。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 下载1GB NIRSpec数据</span>

<span class="n">fn_jw</span> <span class="o">=</span> <span class="n">save_directory</span> <span class="o">+</span> <span class="s1">&#39;jwst_data.pickle&#39;</span>  <span class="c1"># 定义JWST数据文件的路径</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">):</span>  <span class="c1"># 检查文件是否已存在</span>

    <span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/jwst_data.pickle&#39;</span><span class="p">)</span>  <span class="c1"># 下载JWST数据文件</span>

    <span class="n">dest</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">save_directory</span> <span class="o">+</span> <span class="s1">&#39;jwst_data.pickle&#39;</span><span class="p">)</span>  <span class="c1"># 移动文件到指定的保存目录</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;JWST Data Download Complete&#39;</span><span class="p">)</span>  <span class="c1"># 打印下载完成的消息</span>

<span class="c1"># 下载进一步需要的文件，并移动到本地目录以便于重复访问</span>

<span class="n">fn_sens</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/NIRSpec.prism.sensitivity.sav&#39;</span><span class="p">)</span>  <span class="c1"># 下载灵敏度文件</span>

<span class="n">dest</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn_sens</span><span class="p">,</span> <span class="n">save_directory</span> <span class="o">+</span> <span class="s1">&#39;NIRSpec.prism.sensitivity.sav&#39;</span><span class="p">)</span>  <span class="c1"># 移动灵敏度文件到保存目录</span>

<span class="n">fn_ld</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/3DGrid/mmu_t45g45m00v05.flx&#39;</span><span class="p">)</span>  <span class="c1"># 下载3D网格文件</span>

<span class="n">destld</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn_ld</span><span class="p">,</span> <span class="n">save_directory</span> <span class="o">+</span> <span class="s1">&#39;3DGrid/mmu_t45g45m00v05.flx&#39;</span><span class="p">)</span>  <span class="c1"># 移动3D网格文件到保存目录</span>
</pre></div>
</div>
</div>
</div>
<p>加载Pickle文件数据。或者，数据也可以从原始的FITS文件中读取。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">):</span>  <span class="c1"># 检查JWST数据文件是否存在</span>

    <span class="n">dbfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>  <span class="c1"># 以二进制模式打开文件进行读取</span>

    <span class="n">jwst_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>  <span class="c1"># 从pickle文件加载JWST数据</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading JWST data from Pickle File&#39;</span><span class="p">)</span>  <span class="c1"># 打印加载数据的提示信息</span>

    <span class="n">bjd</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;bjd&#39;</span><span class="p">]</span>  <span class="c1"># 提取BJD时间数据</span>

    <span class="n">wsdata_all</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;wsdata_all&#39;</span><span class="p">]</span>  <span class="c1"># 提取波长数据</span>

    <span class="n">shx</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;shx&#39;</span><span class="p">]</span>  <span class="c1"># 提取X方向的偏移数据</span>

    <span class="n">shy</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;shy&#39;</span><span class="p">]</span>  <span class="c1"># 提取Y方向的偏移数据</span>

    <span class="n">common_mode</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;common_mode&#39;</span><span class="p">]</span>  <span class="c1"># 提取公共模式数据</span>

    <span class="n">all_spec</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;all_spec&#39;</span><span class="p">]</span>  <span class="c1"># 提取所有光谱数据</span>

    <span class="n">exposure_length</span> <span class="o">=</span> <span class="n">jwst_data</span><span class="p">[</span><span class="s1">&#39;exposure_length&#39;</span><span class="p">]</span>  <span class="c1"># 提取曝光时间数据</span>

    <span class="n">dbfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭文件</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>  <span class="c1"># 打印完成的提示信息</span>

<span class="k">elif</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn_jw</span><span class="p">):</span>  <span class="c1"># 如果JWST数据文件不存在</span>

    <span class="c1"># 加载所有的fits图像</span>

    <span class="c1"># 为BJD时间和白光曲线总计数创建数组</span>

    <span class="nb">list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">data_directory</span> <span class="o">+</span> <span class="s2">&quot;*.fits&quot;</span><span class="p">)</span>  <span class="c1"># 获取所有fits文件的列表</span>

    <span class="n">index_of_images</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">number_of_images</span><span class="p">)</span>  <span class="c1"># 创建图像索引数组</span>

    <span class="n">bjd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_images</span><span class="p">))</span>  <span class="c1"># 初始化BJD数组</span>

    <span class="n">exposure_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_images</span><span class="p">))</span>  <span class="c1"># 初始化曝光时间数组</span>

    <span class="n">all_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">number_of_images</span><span class="p">))</span>  <span class="c1"># 初始化光谱数组</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_of_images</span><span class="p">:</span>  <span class="c1"># 遍历每个图像索引</span>

        <span class="n">img</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># 获取当前图像文件名</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># 打印当前图像文件名</span>

        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># 打开当前fits图像</span>

        <span class="c1"># hdul.info()  # 可选：打印图像信息</span>

        <span class="n">bjd_image</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BJD_TDB&#39;</span><span class="p">]</span>  <span class="c1"># 从头文件中提取BJD时间</span>

        <span class="n">BZERO</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BZERO&#39;</span><span class="p">]</span>  <span class="c1"># 提取flux值偏移量</span>

        <span class="n">bjd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bjd_image</span>  <span class="c1"># 将BJD时间存入数组</span>

        <span class="n">expleng</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;INTTIME&#39;</span><span class="p">]</span>  <span class="c1"># 提取单次MULTIACCUM的总曝光时间（秒）</span>

        <span class="n">exposure_length</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">expleng</span> <span class="o">/</span> <span class="mf">86400.</span>  <span class="c1"># 将曝光时间转换为天并存入数组</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">bjd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 打印当前BJD时间</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 提取图像数据</span>

        <span class="c1"># total counts in image</span>

        <span class="c1"># total_counts[i]=gain*np.sum(data[11:18,170:200]-BZERO)  # 计算在特定区域的总计数（注释掉）</span>

        <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">BZERO</span><span class="p">)</span>  <span class="c1"># 将所有光谱数据加载到数组中并减去flux值偏移量</span>

        <span class="n">hdul</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭当前图像文件</span>

    <span class="c1"># 对数据进行排序</span>

    <span class="n">srt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">bjd</span><span class="p">)</span>  <span class="c1"># 获取排序索引</span>

    <span class="n">bjd</span> <span class="o">=</span> <span class="n">bjd</span><span class="p">[</span><span class="n">srt</span><span class="p">]</span>  <span class="c1"># 根据索引排序BJD时间</span>

    <span class="c1"># total_counts=total_counts[srt]  # （注释掉）根据索引排序总计数</span>

    <span class="n">exposure_length</span> <span class="o">=</span> <span class="n">exposure_length</span><span class="p">[</span><span class="n">srt</span><span class="p">]</span>  <span class="c1"># 根据索引排序曝光时间</span>

    <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">srt</span><span class="p">]</span>  <span class="c1"># 根据索引排序所有光谱数据</span>

    <span class="c1"># 获取数据的波长</span>

    <span class="n">file_wave</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/JWST_NIRSpec_wavelength_microns.txt&#39;</span><span class="p">)</span>  <span class="c1"># 下载波长数据文件</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_wave</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>  <span class="c1"># 打开波长数据文件</span>

    <span class="n">wsdata_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># 从文件中读取波长数据</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wsdata size :&#39;</span><span class="p">,</span> <span class="n">wsdata_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># 打印波长数据的大小</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data wavelength Loaded :&#39;</span><span class="p">,</span> <span class="n">wsdata_all</span><span class="p">)</span>  <span class="c1"># 打印加载的波长数据</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;wsdata new size :&#39;</span><span class="p">,</span> <span class="n">wsdata_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># 打印新的波长数据大小</span>

    <span class="c1"># 读取去趋势参数</span>

    <span class="c1"># 参数的均值必须为0.0以便正确归一化</span>

    <span class="c1"># 理想情况下参数的标准差应为1.0</span>

    <span class="n">file_xy</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/JWST_NIRSpec_Xposs_Yposs_CM_detrending.txt&#39;</span><span class="p">)</span>  <span class="c1"># 下载去趋势参数文件</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_xy</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>  <span class="c1"># 打开去趋势参数文件</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>  <span class="c1"># 从文件中读取去趋势参数数据</span>

    <span class="n">shx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># 提取X方向偏移数据</span>

    <span class="n">shy</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># 提取Y方向偏移数据</span>

    <span class="n">common_mode</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># 提取公共模式数据</span>

    <span class="c1"># 将数据存储到pickle文件中</span>

    <span class="n">jwst_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bjd&#39;</span><span class="p">:</span> <span class="n">bjd</span><span class="p">,</span> <span class="s1">&#39;wsdata_all&#39;</span><span class="p">:</span> <span class="n">wsdata_all</span><span class="p">,</span> <span class="s1">&#39;shx&#39;</span><span class="p">:</span> <span class="n">shx</span><span class="p">,</span> <span class="s1">&#39;shy&#39;</span><span class="p">:</span> <span class="n">shy</span><span class="p">,</span> <span class="s1">&#39;common_mode&#39;</span><span class="p">:</span> <span class="n">common_mode</span><span class="p">,</span> <span class="s1">&#39;all_spec&#39;</span><span class="p">:</span> <span class="n">all_spec</span><span class="p">,</span> <span class="s1">&#39;exposure_length&#39;</span><span class="p">:</span> <span class="n">exposure_length</span><span class="p">}</span>  <span class="c1"># 创建数据字典</span>

    <span class="n">dbfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;jwst_data.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span>  <span class="c1"># 以二进制模式打开pickle文件进行追加</span>

    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">jwst_data</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>  <span class="c1"># 将数据字典写入pickle文件</span>

    <span class="n">dbfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭pickle文件</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id4">
<h1>可视化二维光谱数据<a class="headerlink" href="#id4" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expnum</span> <span class="o">=</span> <span class="mi">2</span>                                           <span class="c1"># 选择要查看的曝光编号</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>           <span class="c1"># 设置图形尺寸</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>                   <span class="c1"># 设置分辨率</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>                   <span class="c1"># 设置保存图像的分辨率</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.aspect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>                     <span class="c1"># 设置长宽比（CCD非常长！）</span>

<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">magma</span>                               <span class="c1"># 使用magma色图</span>

<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>                            <span class="c1"># 设置无效值的颜色为黑色</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;magma&#39;</span>                   <span class="c1"># 设置图像的色图为magma</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.interpolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>         <span class="c1"># 设置图像插值方式为无</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>               <span class="c1"># 设置图像原点在下方</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;monospace&quot;</span>            <span class="c1"># 设置字体为等宽字体</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.monospace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DejaVu Sans Mono&#39;</span>  <span class="c1"># 设置等宽字体为DejaVu Sans Mono</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">expnum</span><span class="p">]</span>                          <span class="c1"># 获取指定曝光编号的图像数据</span>

<span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">img</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>                            <span class="c1"># 找到图像中小于等于0的值</span>

<span class="n">img</span><span class="p">[</span><span class="n">zeros</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-10</span>                                    <span class="c1"># 将小于等于0的值设为一个小数以避免对数计算错误</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>                             <span class="c1"># 创建子图</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>                <span class="c1"># 绘制图像，使用对数尺度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x-pixel&#39;</span><span class="p">)</span>                                 <span class="c1"># 设置x轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y-pixel&#39;</span><span class="p">)</span>                                 <span class="c1"># 设置y轴标签</span>

<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>   <span class="c1"># 设置y轴主刻度间隔为5</span>

<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>    <span class="c1"># 设置y轴次刻度间隔为1</span>

<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>   <span class="c1"># 设置x轴主刻度间隔为50</span>

<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>    <span class="c1"># 设置x轴次刻度间隔为10</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;2D NIRSpec Image of Exposure &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expnum</span><span class="p">))</span>  <span class="c1"># 设置图像标题</span>

<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Log$_</span><span class="si">{10}</span><span class="s1">$ Electron counts&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">)</span>  <span class="c1"># 添加颜色条，标记为对数电子计数</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>                                           <span class="c1"># 显示图像</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="d1d">
<h1>从2D图像数组中提取1D光谱<a class="headerlink" href="#d1d" title="Link to this heading">#</a></h1>
<p>理想情况下，从2D图像中提取1D光谱应使用沿拟合轨迹的最佳光圈提取，使用与IRAF/apall等效的例程。此功能在astro-py中尚不可用。</p>
<p>已经应用了几个处理步骤。这里的2D光谱已经进行了平场校正，并且通过从每列未照明像素中减去中位数计数率，去除了每个像素的1/f噪声（有关1/f噪声的更多信息，请参见 <strong><a class="reference internal" href="#ftp://ftp.cosmos.esa.int/jwstlib/ReleasedCV3dataTimeSeries/CV3_TimeSeries_PRM.tgz"><span class="xref myst">Giardino et al.</span></a></strong>）。每个2D图像在X和Y方向上也进行了对齐，以确保每个像素对应相同的波长。由于CV3测试对光通量稳定性没有要求，因此LED的~1%光通量变化也已被去除。</p>
<p>对于光谱提取，此处的示例简单地使用了一个简单的求和框。8192个2D光谱已预加载到一个numpy数组中。光谱在像素Y=16处达到峰值。对于每一列，光圈总和是在Y轴像素11到18之间进行的，这包含了大部分光谱计数。更宽的光圈会增加更多计数，但也会引入更多噪声。</p>
<p><strong>此处未进行进一步清理步骤</strong></p>
<ol class="arabic simple">
<li><p>理想情况下，因各种原因被标记为坏的像素应进行清理。</p></li>
<li><p>应识别并去除宇宙射线。</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_spec</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># 查看 all_spec 数组的形状</span>

<span class="n">y_lower</span> <span class="o">=</span> <span class="mi">11</span>  <span class="c1"># 下提取孔径的像素行数</span>

<span class="n">y_upper</span> <span class="o">=</span> <span class="mi">18</span>  <span class="c1"># 上提取孔径的像素行数</span>

<span class="n">all_spec_1D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_spec</span><span class="p">[</span><span class="n">y_lower</span><span class="p">:</span><span class="n">y_upper</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 在 Y 轴上对像素 11 到 18 进行求和</span>

<span class="c1"># 绘图设置</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>  <span class="c1"># 设置图形的尺寸</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># 设置分辨率</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># 设置保存图形的分辨率</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.aspect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># 设置图像的长宽比（CCD 很长！）</span>

<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">magma</span>  <span class="c1"># 设置颜色映射为 magma</span>

<span class="n">plt</span><span class="o">.</span><span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>  <span class="c1"># 设置无效值的颜色为黑色，透明度为 1</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;magma&#39;</span>  <span class="c1"># 设置图像的颜色映射</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.interpolation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>  <span class="c1"># 设置图像插值方式为无</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>  <span class="c1"># 设置图像原点在下方</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;monospace&quot;</span>  <span class="c1"># 设置字体为等宽字体</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.monospace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DejaVu Sans Mono&#39;</span>  <span class="c1"># 设置等宽字体的具体类型</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">all_spec</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">expnum</span><span class="p">]</span>  <span class="c1"># 获取特定曝光编号的图像数据</span>

<span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">img</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 找到图像中小于等于零的值的索引</span>

<span class="n">img</span><span class="p">[</span><span class="n">zeros</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-10</span>  <span class="c1"># 将零或负值设置为一个小数，以便在对数尺度上绘图</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># 创建一个图形和一组子图</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 绘制图像，使用对数尺度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x-pixel&#39;</span><span class="p">)</span>  <span class="c1"># 设置 x 轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y-pixel&#39;</span><span class="p">)</span>  <span class="c1"># 设置 y 轴标签</span>

<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>  <span class="c1"># 设置 y 轴主刻度间隔为 5</span>

<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># 设置 y 轴次刻度间隔为 1</span>

<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>  <span class="c1"># 设置 x 轴主刻度间隔为 50</span>

<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>  <span class="c1"># 设置 x 轴次刻度间隔为 10</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y_lower</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>  <span class="c1"># 绘制下提取孔径的虚线</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y_upper</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>  <span class="c1"># 绘制上提取孔径的虚线</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;2D NIRSpec Image of Exposure &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expnum</span><span class="p">))</span>  <span class="c1"># 设置图形标题</span>

<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Log$_</span><span class="si">{10}</span><span class="s1">$ Electron counts&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">)</span>  <span class="c1"># 添加颜色条，标注为对数电子计数</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id5">
<h1>可视化一维光谱数据<a class="headerlink" href="#id5" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># 创建一个子图</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">,</span> <span class="n">all_spec_1D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 在数据上绘制过渡模型</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为波长</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (e-)&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为通量</span>

<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># 设置x轴主刻度间隔为0.5</span>

<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>  <span class="c1"># 设置x轴次刻度间隔为0.1</span>

<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;H$_2$O&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>  <span class="c1"># 在图中添加&#39;H2O&#39;注释，位置为(3.0, 42000)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;CO$_2$&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>  <span class="c1"># 在图中添加&#39;CO2&#39;注释，位置为(4.2, 42000)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>
</pre></div>
</div>
</div>
</div>
<p>CV3测试观察了一盏灯，其点扩散函数（PSF）与JWST将拥有的相似，并且在大约1.5到4.5 <span class="math notranslate nohighlight">\(\mu\)</span>m的范围内有显著的计数。</p>
<p>低温测试舱的窗口上积累了CO<span class="math notranslate nohighlight">\(_2\)</span>和H<span class="math notranslate nohighlight">\(_2\)</span>O冰，这可以在二维光谱中看到作为光谱吸收特征。</p>
<section id="id6">
<h2>计算轨道相位及用于绘图目的的单独细网模型<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 计算轨道相位</span>

<span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">bjd</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">per</span><span class="p">)</span>  <span class="c1"># 计算相位，单位为天，相对于T0历元</span>

<span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">number_of_images</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 将当前相位调整为0.0</span>

<span class="n">t_fine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bjd</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bjd</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># 生成用于计算光曲线的时间点，共1000个点</span>

<span class="n">phase_fine</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_fine</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">per</span><span class="p">)</span>  <span class="c1"># 计算相位，单位为天，相对于T0历元</span>

<span class="n">phase_fine</span> <span class="o">=</span> <span class="n">phase_fine</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">number_of_images</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 将当前相位调整为0.0</span>

<span class="c1"># 计算b0，表示光度变化的幅度</span>
<span class="n">b0</span> <span class="o">=</span> <span class="n">a_Rs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span> <span class="o">-</span> <span class="n">rp</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>  <span class="c1"># 选择在首次接触和第四次接触之间的索引</span>

<span class="n">outtransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span> <span class="o">-</span> <span class="n">rp</span> <span class="o">&gt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>  <span class="c1"># 选择在过境之外的索引</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id7">
<h1>处理探测器上的系统漂移<a class="headerlink" href="#id7" title="Link to this heading">#</a></h1>
<p>CV3测试通过引入较大的空间抖动和漂移来评估仪器的稳定性。这导致光谱在2D探测器上的X,Y位置发生显著移动。虽然这种大规模的位移已经被移除，从而对齐了光谱，但像素内和像素间的灵敏度引入了通量变化，这些变化需要被去除。CV3测试中的抖动超过了30毫弧秒（mas），这大约是JWST稳定性要求的4倍。因此，在轨道上，这些探测器效应预计会显著减小，但仍然会存在，并需要在时间序列观测中进行建模和去除。</p>
<p>这里的探测器X,Y位置是通过对2D图像进行交叉相关测量得到的（首先沿一个维度压缩光谱），并保存在数组<span class="math notranslate nohighlight">\(shx\)</span>和<span class="math notranslate nohighlight">\(shy\)</span>中。这些去趋势向量理想情况下应该使用每次积分的光谱提取中的轨迹位置值进行测量，因为这也可以准确测量光谱在探测器上如何在每次积分中发生空间变化。</p>
<p>探测器的位移原始幅度接近0.2像素，尽管这些向量已经进行了初步归一化。为了去趋势，这些数组的均值应该为0，标准差为1.0。</p>
<p>在CV3数据中，还可以看到与LED灯相关的残余颜色依赖趋势，这可以通过缩放原始共模灯趋势部分去除，该趋势是使用CV3白光曲线测量的。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shx_tmp</span> <span class="o">=</span> <span class="n">shx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shx</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0E0</span>       <span class="c1"># 将shx的均值调整为0.0</span>
<span class="n">shx_detrend</span> <span class="o">=</span> <span class="n">shx_tmp</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">shx_tmp</span><span class="p">)</span>     <span class="c1"># 将shx的标准差调整为1.0</span>

<span class="n">shy_tmp</span> <span class="o">=</span> <span class="n">shy</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shy</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0E0</span>       <span class="c1"># 将shy的均值调整为0.0</span>
<span class="n">shy_detrend</span> <span class="o">=</span> <span class="n">shy_tmp</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">shy_tmp</span><span class="p">)</span>     <span class="c1"># 将shy的标准差调整为1.0</span>

<span class="n">cm</span> <span class="o">=</span> <span class="n">common_mode</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">common_mode</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0E0</span>  <span class="c1"># 将common_mode的均值调整为0.0</span>
<span class="n">cm_detrend</span> <span class="o">=</span> <span class="n">cm</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>                  <span class="c1"># 将common_mode的标准差调整为1.0</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>                     <span class="c1"># 创建一个子图</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shx_detrend</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;X-possition&#39;</span><span class="p">)</span>    <span class="c1"># 绘制X位置的去趋势数据</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shy_detrend</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Y-possition&#39;</span><span class="p">)</span>    <span class="c1"># 绘制Y位置的去趋势数据</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Image Sequence Number&#39;</span><span class="p">)</span>           <span class="c1"># 设置X轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Detector Possition&#39;</span><span class="p">)</span>      <span class="c1"># 设置Y轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Time-series Detrending Vectors&#39;</span><span class="p">)</span>   <span class="c1"># 设置图表标题</span>

<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>  <span class="c1"># 设置X轴主刻度间隔为1000</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>   <span class="c1"># 设置X轴次刻度间隔为100</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>   <span class="c1"># 设置Y轴主刻度间隔为0.5</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>    <span class="c1"># 设置Y轴次刻度间隔为0.1</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>                                   <span class="c1"># 显示图例</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>                                     <span class="c1"># 显示图表</span>
</pre></div>
</div>
</div>
</div>
<section id="id8">
<h2>创建用于去趋势的向量数组。<a class="headerlink" href="#id8" title="Link to this heading">#</a></h2>
<p>来自Sing等人（2019年）的研究：系统误差通常通过参数化的确定性模型来去除，其中非过境光度趋势与多个外部参数（或光学状态向量，<span class="math notranslate nohighlight">\(X\)</span>）相关。这些参数描述了在观测过程中，仪器或其他外部因素随时间的变化，并为每个光学状态参数拟合一个系数<span class="math notranslate nohighlight">\(p_n\)</span>，以建模并去除（或去趋势）光度光曲线。</p>
<p>在包含系统趋势时，随时间变化的通用参数化模型的通量测量<span class="math notranslate nohighlight">\(f(t)\)</span>可以建模为理论过境模型<span class="math notranslate nohighlight">\(T(t,\theta)\)</span>（依赖于过境参数<span class="math notranslate nohighlight">\(\theta\)</span>）、从恒星检测到的总基线通量<span class="math notranslate nohighlight">\(F_0\)</span>以及系统误差模型<span class="math notranslate nohighlight">\(S(x)\)</span>的组合，给出如下公式：</p>
<div class="math notranslate nohighlight">
\[f(t) = T(t,\theta) \times F_0 \times S(x)\]</div>
<p>我们将使用线性模型来处理仪器的系统效应。</p>
<div class="math notranslate nohighlight">
\[S(x) = p_1 x + p_2 y + p_3 x^2 + p_4 y^2 + p_5 x y + p_6 cm + p_7 \phi\]</div>
<p>其中<span class="math notranslate nohighlight">\(cm\)</span>是共模趋势，而<span class="math notranslate nohighlight">\(\phi\)</span>是线性时间趋势，有助于去除H<span class="math notranslate nohighlight">\(_2\)</span>O光谱特征中变化的H<span class="math notranslate nohighlight">\(_2\)</span>O冰。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shx</span> <span class="o">=</span> <span class="n">shx_detrend</span>  <span class="c1"># 将去趋势后的shx赋值给shx</span>

<span class="n">shy</span> <span class="o">=</span> <span class="n">shy_detrend</span>  <span class="c1"># 将去趋势后的shy赋值给shy</span>

<span class="n">common_mode</span> <span class="o">=</span> <span class="n">cm_detrend</span>  <span class="c1"># 将去趋势后的公共模式赋值给common_mode</span>

<span class="c1"># 创建一个去趋势数组，不包含线性时间趋势</span>
<span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shx</span><span class="p">,</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shx</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shy</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shx</span><span class="o">*</span><span class="n">shy</span><span class="p">,</span> <span class="n">common_mode</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number_of_images</span><span class="p">)])</span>  
<span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>  <span class="c1"># 转置数组XX</span>

<span class="c1"># 创建一个去趋势数组，包含线性时间趋势</span>
<span class="n">XXX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shx</span><span class="p">,</span> <span class="n">shy</span><span class="p">,</span> <span class="n">shx</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shy</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">shx</span><span class="o">*</span><span class="n">shy</span><span class="p">,</span> <span class="n">common_mode</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number_of_images</span><span class="p">)])</span>  
<span class="n">XXX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">XXX</span><span class="p">)</span>  <span class="c1"># 转置数组XXX</span>
</pre></div>
</div>
</div>
</div>
<p><strong>线性回归</strong>可以用来快速确定参数 <span class="math notranslate nohighlight">\(p_n\)</span>，使用的是非过境数据。</p>
<p>在这里，我们选择数据的一个波长区间（像素 170 到 200）来制作时间序列。选择非过境点，并对 <span class="math notranslate nohighlight">\(S(x)\)</span> 进行线性回归，以确定光学状态参数 <span class="math notranslate nohighlight">\(p_n\)</span>。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pix1</span> <span class="o">=</span> <span class="mi">170</span>       <span class="c1"># 波长区间下限</span>

<span class="n">pix2</span> <span class="o">=</span> <span class="mi">200</span>       <span class="c1"># 波长区间上限</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_spec_1D</span><span class="p">[</span><span class="n">pix1</span><span class="p">:</span><span class="n">pix2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># 在选定波长区间内的总通量</span>

<span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>           <span class="c1"># 默认标记大小</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>           <span class="c1"># 图形尺寸</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># 创建子图</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">,</span> <span class="n">all_spec_1D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 绘制波长区间的光谱</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">:</span><span class="n">pix2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">all_spec_1D</span><span class="p">[</span><span class="n">pix1</span><span class="p">:</span><span class="n">pix2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># 填充波长区间下方的区域</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (e-)&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;1D Extracted Spectrum&#39;</span><span class="p">)</span>  <span class="c1"># 设置图形标题</span>

<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># 设置x轴主刻度</span>

<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>  <span class="c1"># 设置x轴次刻度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;H$_2$O&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>  <span class="c1"># 注释H2O的位置</span>

<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;CO$_2$&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span> <span class="mi">42000</span><span class="p">))</span>  <span class="c1"># 注释CO2的位置</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># 创建新的子图</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Barycentric Julian Date (days)&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time-series Transit Light Curve  $\lambda=$[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>  <span class="c1"># 设置图形标题</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  <span class="c1"># 显示图例</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>

<span class="n">regressor</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>  <span class="c1"># 创建线性回归模型</span>

<span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">XX</span><span class="p">[</span><span class="n">outtransit</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]))</span>  <span class="c1"># 拟合模型</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Linear Regression Coefficients:&#39;</span><span class="p">)</span>  <span class="c1"># 打印线性回归系数的提示</span>

<span class="nb">print</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>  <span class="c1"># 打印线性回归系数</span>
</pre></div>
</div>
</div>
</div>
<p>系数的数量级约为 ~10<span class="math notranslate nohighlight">\(^{-4}\)</span>，因此趋势的幅度在 100 的 ppm 级别。</p>
<p>可视化拟合结果</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yfit</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>                         <span class="c1"># 在整个时间序列上进行拟合预测</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]</span>           <span class="c1"># 设置图形的尺寸</span>

<span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>           <span class="c1"># 获取默认的标记大小并平方</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图，显示数据点</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">yfit</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$S(x)$ Regression fit &#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>  <span class="c1"># 绘制回归拟合曲线</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Barycentric Julian Date (days)&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为“日心朱利安日期（天）”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为“相对通量”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time-series Transit Light Curve  $\lambda=$[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>  <span class="c1"># 设置图表标题，包含波长信息</span>

<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>  <span class="c1"># 设置x轴主刻度为0.01的间隔</span>

<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>  <span class="c1"># 设置x轴次刻度为0.005的间隔</span>

<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.002</span><span class="p">))</span>  <span class="c1"># 设置y轴主刻度为0.002的间隔</span>

<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.001</span><span class="p">))</span>  <span class="c1"># 设置y轴次刻度为0.001的间隔</span>

<span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>  <span class="c1"># 计算归一化的y值</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yplot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.999</span><span class="p">,</span> <span class="n">yplot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.001</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>  <span class="c1"># 在左下角显示图例</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id9">
<h1>过境和边缘暗化模型函数<a class="headerlink" href="#id9" title="Link to this heading">#</a></h1>
<p>定义用于拟合例程的函数。</p>
<p>这些函数将接受过境和系统参数，并创建我们的完整过境光曲线模型。</p>
<p><span class="math notranslate nohighlight">\(model = T(t,\theta)\times F_0 \times S(x)\)</span></p>
<p>通过返回残差与数据进行比较。</p>
<p><span class="math notranslate nohighlight">\(y = f(t)\)</span></p>
<p>残差为：</p>
<p><span class="math notranslate nohighlight">\((y-model)/(\sigma_y)\)</span></p>
<p>为了计算过境模型，我们使用 <strong><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2002ApJ...580L.171M/abstract">Mandel and Agol (2002)</a></strong>，该模型由 H. Wakeford 用 Python 编写 (<strong><a class="reference external" href="https://github.com/hrwakeford/ExoTiC-ISM">ExoTiC-ISM</a></strong>)。</p>
<p>为了计算恒星的边缘暗化，我们使用 Sing 等人（2010）的方法，该方法利用恒星模型并拟合非线性边缘暗化系数，由 H. Wakeford 用 Python 编写的模块 (<strong><a class="reference external" href="https://github.com/hrwakeford/ExoTiC-ISM">ExoTiC-ISM</a></strong>)。</p>
<p>首先，根据系统参数 <span class="math notranslate nohighlight">\(a/R_{star}\)</span>、倾角的余弦 <span class="math notranslate nohighlight">\(cos(i)\)</span> 和轨道相位 <span class="math notranslate nohighlight">\(\phi\)</span> 计算新的轨道。</p>
<p>输入参数包括每个相位的行星-恒星中心之间的轨道距离 <span class="math notranslate nohighlight">\(b\)</span>、边缘暗化参数 (<span class="math notranslate nohighlight">\(c_1,c_2,c_3,c_4\)</span>) 和行星与恒星半径比 <span class="math notranslate nohighlight">\(R_p/R_{star}\)</span>。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_model</span>
<span class="k">def</span><span class="w"> </span><span class="nf">nonlinear_limb_darkening</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">c1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">c3</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    定义具有四个参数c0, c1, c2, c3的非线性边缘变暗模型。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">c0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">*</span>
                   <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="nd">@custom_model</span>
<span class="k">def</span><span class="w"> </span><span class="nf">quadratic_limb_darkening</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">aLD</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">bLD</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    定义具有参数aLD和bLD的二次边缘变暗模型。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">aLD</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">bLD</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="k">def</span><span class="w"> </span><span class="nf">limb_dark_fit</span><span class="p">(</span><span class="n">grating</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">,</span> <span class="n">M_H</span><span class="p">,</span> <span class="n">Teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">,</span> <span class="n">dirsen</span><span class="p">,</span> <span class="n">ld_model</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    计算给定波长区间的恒星边缘变暗系数。</span>

<span class="sd">    当前支持：</span>
<span class="sd">    HST STIS G750L, G750M, G430L光栅</span>
<span class="sd">    HST WFC3 UVIS/G280, IR/G102, IR/G141光栅</span>

<span class="sd">    使用1D模型 - Kurucz (?)</span>
<span class="sd">    程序来自Sing等人（2010, A&amp;A, 510, A21）。</span>
<span class="sd">    使用Magic等人（2015, A&amp;A, 573, 90）的3D边缘变暗。</span>
<span class="sd">    使用光子通量对（lambda*dlamba）进行求和。</span>
<span class="sd">    :param grating: 字符串; 要使用的光栅（&#39;G430L&#39;,&#39;G750L&#39;,&#39;G750M&#39;, &#39;G280&#39;, &#39;G102&#39;, &#39;G141&#39;）</span>
<span class="sd">    :param wsdata: 数组; 数据波长解决方案</span>
<span class="sd">    :param M_H: 浮点数; 恒星金属丰度</span>
<span class="sd">    :param Teff: 浮点数; 恒星有效温度（K）</span>
<span class="sd">    :param logg: 浮点数; 恒星重力</span>
<span class="sd">    :param dirsen: 字符串; 主边缘变暗目录的路径</span>
<span class="sd">    :param ld_model: 字符串; &#39;1D&#39;或&#39;3D&#39;，在边缘变暗模型之间进行选择；默认是1D</span>
<span class="sd">    :return: uLD: 浮点数; 线性边缘变暗系数</span>
<span class="sd">    aLD, bLD: 浮点数; 二次边缘变暗系数</span>
<span class="sd">    cp1, cp2, cp3, cp4: 浮点数; 三参数边缘变暗系数</span>
<span class="sd">    c1, c2, c3, c4: 浮点数; 非线性边缘变暗系数</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;您正在使用&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ld_model</span><span class="p">),</span> <span class="s1">&#39;边缘变暗模型。&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>
        <span class="n">direc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;Kurucz&#39;</span><span class="p">)</span>  <span class="c1"># 设置目录为Kurucz</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;当前输入的目录:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">dirsen</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">direc</span><span class="p">)</span>

        <span class="c1"># 选择金属丰度</span>
        <span class="n">M_H_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">M_H_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">])</span>
        <span class="n">optM</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">M_H</span> <span class="o">-</span> <span class="n">M_H_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>  <span class="c1"># 找到与输入金属丰度最接近的索引</span>
        <span class="n">MH_ind</span> <span class="o">=</span> <span class="n">M_H_Grid_load</span><span class="p">[</span><span class="n">optM</span><span class="p">]</span>  <span class="c1"># 获取对应的加载索引</span>

        <span class="c1"># 确定使用哪个模型，通过输入的金属丰度M_H来确定所需的文件名</span>
        <span class="n">direc</span> <span class="o">=</span> <span class="s1">&#39;Kurucz&#39;</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="s1">&#39;kuruczlist.sav&#39;</span>
        <span class="n">sav1</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="n">file_list</span><span class="p">))</span>  <span class="c1"># 读取文件列表</span>
        <span class="n">model</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sav1</span><span class="p">[</span><span class="s1">&#39;li&#39;</span><span class="p">][</span><span class="n">MH_ind</span><span class="p">])</span>  <span class="c1"># 将字节对象转换为字符串</span>

        <span class="c1"># 选择Teff并随后选择logg</span>
        <span class="n">Teff_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3500</span><span class="p">,</span> <span class="mi">3750</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">4250</span><span class="p">,</span> <span class="mi">4500</span><span class="p">,</span> <span class="mi">4750</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5250</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span> <span class="mi">5750</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">6250</span><span class="p">,</span> <span class="mi">6500</span><span class="p">])</span>
        <span class="n">optT</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Teff</span> <span class="o">-</span> <span class="n">Teff_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>  <span class="c1"># 找到与输入Teff最接近的索引</span>

        <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
        <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>  <span class="c1"># 找到与输入logg最接近的索引</span>

        <span class="c1"># 根据logg选择Teff的加载索引</span>
        <span class="k">if</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">==</span> <span class="mf">4.0</span><span class="p">:</span>
            <span class="n">Teff_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">138</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">==</span> <span class="mf">4.5</span><span class="p">:</span>
            <span class="n">Teff_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">9</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">139</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">==</span> <span class="mf">5.0</span><span class="p">:</span>
            <span class="n">Teff_Grid_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">140</span><span class="p">])</span>

        <span class="c1"># 在模型文件中找到所需Teff的部分，索引T_ind告诉我们这一点。</span>
        <span class="n">T_ind</span> <span class="o">=</span> <span class="n">Teff_Grid_load</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span>
        <span class="n">header_rows</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># 每个部分忽略的行数</span>
        <span class="n">data_rows</span> <span class="o">=</span> <span class="mi">1221</span>  <span class="c1"># 读取的数据行数</span>
        <span class="n">line_skip_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">header_rows</span> <span class="o">+</span> <span class="n">T_ind</span> <span class="o">*</span> <span class="n">data_rows</span>  <span class="c1"># 计算需要跳过的行数</span>
        <span class="n">line_skip_header</span> <span class="o">=</span> <span class="n">T_ind</span> <span class="o">*</span> <span class="p">(</span><span class="n">data_rows</span> <span class="o">+</span> <span class="n">header_rows</span><span class="p">)</span>  <span class="c1"># 计算跳过的头部行数</span>

        <span class="c1"># 读取头部信息，以便获取实际的Teff、logg和M_H信息。</span>
        <span class="n">headerinfo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="n">direc</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">skiprows</span><span class="o">=</span><span class="n">line_skip_header</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Teff_model</span> <span class="o">=</span> <span class="n">headerinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取模型Teff</span>
        <span class="n">logg_model</span> <span class="o">=</span> <span class="n">headerinfo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取模型logg</span>
        <span class="n">MH_model</span> <span class="o">=</span> <span class="n">headerinfo</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取模型M_H</span>
        <span class="n">MH_model</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">MH_model</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 转换为浮点数</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">与您的输入最接近的值:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Teff: &#39;</span><span class="p">,</span> <span class="n">Teff_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;M_H: &#39;</span><span class="p">,</span> <span class="n">MH_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;log(g): &#39;</span><span class="p">,</span> <span class="n">logg_model</span><span class="p">)</span>

        <span class="c1"># 读取数据; 数据是一个pandas对象。</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="n">direc</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">skiprows</span><span class="o">=</span><span class="n">line_skip_data</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">data_rows</span><span class="p">)</span>

        <span class="c1"># 解包数据</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># 导入波长数据</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="p">(</span><span class="n">ws</span> <span class="o">*</span> <span class="n">ws</span><span class="p">)</span>  <span class="c1"># 计算f0</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f1</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f2</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f3</span>
        <span class="n">f4</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f4</span>
        <span class="n">f5</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f5</span>
        <span class="n">f6</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f6</span>
        <span class="n">f7</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f7</span>
        <span class="n">f8</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f8</span>
        <span class="n">f9</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f9</span>
        <span class="n">f10</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f10</span>
        <span class="n">f11</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f11</span>
        <span class="n">f12</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f12</span>
        <span class="n">f13</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f13</span>
        <span class="n">f14</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f14</span>
        <span class="n">f15</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f15</span>
        <span class="n">f16</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">/</span> <span class="mf">100000.</span>  <span class="c1"># 计算f16</span>

        <span class="c1"># 将它们合并为一个大的数组</span>
        <span class="n">fcalc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span><span class="p">,</span> <span class="n">f5</span><span class="p">,</span> <span class="n">f6</span><span class="p">,</span> <span class="n">f7</span><span class="p">,</span> <span class="n">f8</span><span class="p">,</span> <span class="n">f9</span><span class="p">,</span> <span class="n">f10</span><span class="p">,</span> <span class="n">f11</span><span class="p">,</span> <span class="n">f12</span><span class="p">,</span> <span class="n">f13</span><span class="p">,</span> <span class="n">f14</span><span class="p">,</span> <span class="n">f15</span><span class="p">,</span> <span class="n">f16</span><span class="p">])</span>
        <span class="n">phot1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fcalc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 初始化phot1数组</span>

        <span class="c1"># 定义mu</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.000</span><span class="p">,</span> <span class="mf">.900</span><span class="p">,</span> <span class="mf">.800</span><span class="p">,</span> <span class="mf">.700</span><span class="p">,</span> <span class="mf">.600</span><span class="p">,</span> <span class="mf">.500</span><span class="p">,</span> <span class="mf">.400</span><span class="p">,</span> <span class="mf">.300</span><span class="p">,</span> <span class="mf">.250</span><span class="p">,</span> <span class="mf">.200</span><span class="p">,</span> <span class="mf">.150</span><span class="p">,</span> <span class="mf">.125</span><span class="p">,</span> <span class="mf">.100</span><span class="p">,</span> <span class="mf">.075</span><span class="p">,</span> <span class="mf">.050</span><span class="p">,</span> <span class="mf">.025</span><span class="p">,</span> <span class="mf">.010</span><span class="p">])</span>

        <span class="c1"># 传递给函数主体的参数有：ws, fcalc, phot1, mu</span>

    <span class="k">elif</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
        <span class="n">direc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;3DGrid&#39;</span><span class="p">)</span>  <span class="c1"># 设置目录为3DGrid</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;当前输入的目录:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">dirsen</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">direc</span><span class="p">)</span>

        <span class="c1"># 选择金属丰度</span>
        <span class="n">M_H_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>  <span class="c1"># 3D模型中可用的金属丰度值</span>
        <span class="n">M_H_Grid_load</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;30&#39;</span><span class="p">,</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;00&#39;</span><span class="p">]</span>  <span class="c1"># 对应于各个可用M_H值的标识符</span>
        <span class="n">optM</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">M_H</span> <span class="o">-</span> <span class="n">M_H_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>  <span class="c1"># 找到与输入M_H最接近的索引</span>

        <span class="c1"># 选择Teff</span>
        <span class="n">Teff_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">4500</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span> <span class="mi">5777</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">6500</span><span class="p">,</span> <span class="mi">7000</span><span class="p">])</span>  <span class="c1"># 3D模型中可用的Teff值</span>
        <span class="n">optT</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Teff</span> <span class="o">-</span> <span class="n">Teff_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>  <span class="c1"># 找到与输入Teff最接近的索引</span>

        <span class="c1"># 根据Teff选择logg。如果对于一个Teff给出了多个logg可能性，选择与用户输入最接近的。</span>
        <span class="k">if</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4500</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5500</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5777</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.4</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6500</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">logg</span> <span class="o">-</span> <span class="n">logg_Grid</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7000</span><span class="p">:</span>
            <span class="n">logg_Grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.5</span><span class="p">])</span>
            <span class="n">optG</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># 选择Teff和Log g。Mtxt, Ttxt和Gtxt将作为字符串组合以加载正确的文件。</span>
        <span class="n">Mtxt</span> <span class="o">=</span> <span class="n">M_H_Grid_load</span><span class="p">[</span><span class="n">optM</span><span class="p">]</span>
        <span class="n">Ttxt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:2.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># 格式化Teff</span>
        <span class="k">if</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5777</span><span class="p">:</span>
            <span class="n">Ttxt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:4.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">])</span>  <span class="c1"># 特殊处理Teff</span>
        <span class="n">Gtxt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:2.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 格式化logg</span>

        <span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;mmu_t&#39;</span> <span class="o">+</span> <span class="n">Ttxt</span> <span class="o">+</span> <span class="s1">&#39;g&#39;</span> <span class="o">+</span> <span class="n">Gtxt</span> <span class="o">+</span> <span class="s1">&#39;m&#39;</span> <span class="o">+</span> <span class="n">Mtxt</span> <span class="o">+</span> <span class="s1">&#39;v05.flx&#39;</span>  <span class="c1"># 生成文件名</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;文件名:&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

        <span class="c1"># 从IDL .sav文件中读取数据</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">direc</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>  <span class="c1"># 读取IDL .sav文件</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;mmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 读取波长</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;mmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flx</span>  <span class="c1"># 读取通量</span>
        <span class="n">Teff_model</span> <span class="o">=</span> <span class="n">Teff_Grid</span><span class="p">[</span><span class="n">optT</span><span class="p">]</span>  <span class="c1"># 获取模型Teff</span>
        <span class="n">logg_model</span> <span class="o">=</span> <span class="n">logg_Grid</span><span class="p">[</span><span class="n">optG</span><span class="p">]</span>  <span class="c1"># 获取模型logg</span>
        <span class="n">MH_model</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">M_H_Grid</span><span class="p">[</span><span class="n">optM</span><span class="p">])</span>  <span class="c1"># 获取模型M_H</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">与您的输入最接近的值:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Teff  : &#39;</span><span class="p">,</span> <span class="n">Teff_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;M_H   : &#39;</span><span class="p">,</span> <span class="n">MH_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;log(g): &#39;</span><span class="p">,</span> <span class="n">logg_model</span><span class="p">)</span>

        <span class="c1"># 解包flux数据</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">f3</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">f4</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">f5</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">f6</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">f7</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">f8</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">f9</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">f10</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>

        <span class="c1"># 将它们合并为一个大的数组</span>
        <span class="n">fcalc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span><span class="p">,</span> <span class="n">f5</span><span class="p">,</span> <span class="n">f6</span><span class="p">,</span> <span class="n">f7</span><span class="p">,</span> <span class="n">f8</span><span class="p">,</span> <span class="n">f9</span><span class="p">,</span> <span class="n">f10</span><span class="p">])</span>
        <span class="n">phot1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fcalc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 初始化phot1数组</span>

        <span class="c1"># 从网格中获取Mu</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;mmd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mu</span>  <span class="c1"># 读取mu</span>

        <span class="c1"># 传递给函数主体的参数有：ws, fcalc, phot1, mu</span>

    <span class="c1"># 加载响应函数并插值到kurucz模型网格上</span>

    <span class="c1"># 对于STIS</span>
    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G430L&#39;</span><span class="p">:</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G430L.STIS.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># 读取灵敏度文件</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>  <span class="c1"># 获取波长灵敏度</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>  <span class="c1"># 获取灵敏度</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># 设置波长间隔</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G750M&#39;</span><span class="p">:</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G750M.STIS.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># 读取灵敏度文件</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>  <span class="c1"># 获取波长灵敏度</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>  <span class="c1"># 获取灵敏度</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mf">0.554</span>  <span class="c1"># 设置波长间隔</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G750L&#39;</span><span class="p">:</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G750L.STIS.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># 读取灵敏度文件</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>  <span class="c1"># 获取波长灵敏度</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>  <span class="c1"># 获取灵敏度</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mf">4.882</span>  <span class="c1"># 设置波长间隔</span>

    <span class="c1"># 对于WFC3</span>
    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G141&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G141.WFC3.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># 读取灵敏度文件</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>  <span class="c1"># 获取波长灵敏度</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>  <span class="c1"># 获取灵敏度</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 设置波长间隔</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G102&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G141.WFC3.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># 读取灵敏度文件</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>  <span class="c1"># 获取波长灵敏度</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>  <span class="c1"># 获取灵敏度</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 设置波长间隔</span>

    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;G280&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;G280.WFC3.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># 读取灵敏度文件</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>  <span class="c1"># 获取波长灵敏度</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>  <span class="c1"># 获取灵敏度</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 设置波长间隔</span>

    <span class="c1"># 对于JWST</span>
    <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s1">&#39;NIRSpecPrism&#39;</span><span class="p">:</span>  <span class="c1"># http://www.stsci.edu/hst/acs/analysis/reference_files/synphot_tables.html</span>
        <span class="n">sav</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirsen</span><span class="p">,</span> <span class="s1">&#39;NIRSpec.prism.sensitivity.sav&#39;</span><span class="p">))</span>  <span class="c1"># 读取灵敏度文件</span>
        <span class="n">wssens</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;wssens&#39;</span><span class="p">]</span>  <span class="c1"># 获取波长灵敏度</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sav</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span>  <span class="c1"># 获取灵敏度</span>
        <span class="n">wdel</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># 设置波长间隔</span>

    <span class="n">widek</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wsdata</span><span class="p">))</span>  <span class="c1"># 创建宽度数组</span>
    <span class="n">wsHST</span> <span class="o">=</span> <span class="n">wssens</span>  <span class="c1"># 赋值波长灵敏度</span>
    <span class="n">wsHST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsHST</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">,</span> <span class="n">wsHST</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">]),</span>
                            <span class="n">wsHST</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsHST</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsHST</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">,</span>
                                      <span class="n">wsHST</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsHST</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">])))</span>  <span class="c1"># 扩展波长灵敏度数组</span>

    <span class="n">respoutHST</span> <span class="o">=</span> <span class="n">sensitivity</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sensitivity</span><span class="p">)</span>  <span class="c1"># 归一化灵敏度</span>
    <span class="n">respoutHST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">respoutHST</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>  <span class="c1"># 在灵敏度前后添加零</span>
    <span class="n">inter_resp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wsHST</span><span class="p">,</span> <span class="n">respoutHST</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 插值灵敏度</span>
    <span class="n">respout</span> <span class="o">=</span> <span class="n">inter_resp</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>  <span class="c1"># 将灵敏度插值到模型波长网格上</span>

    <span class="n">wsdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">wdel</span><span class="p">]),</span> <span class="n">wsdata</span><span class="p">,</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wsdata</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">wdel</span> <span class="o">+</span> <span class="n">wdel</span><span class="p">])))</span>  <span class="c1"># 扩展数据波长数组</span>
    <span class="n">respwavebin</span> <span class="o">=</span> <span class="n">wsdata</span> <span class="o">/</span> <span class="n">wsdata</span> <span class="o">*</span> <span class="mf">0.0</span>  <span class="c1"># 初始化响应波长数组</span>
    <span class="n">widek</span> <span class="o">=</span> <span class="n">widek</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># 需要添加两个索引以补偿用两个零填充</span>
    <span class="n">respwavebin</span><span class="p">[</span><span class="n">widek</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># 设置响应波长数组的值</span>
    <span class="n">data_resp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">wsdata</span><span class="p">,</span> <span class="n">respwavebin</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 插值数据</span>
    <span class="n">reswavebinout</span> <span class="o">=</span> <span class="n">data_resp</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>  <span class="c1"># 将数据插值到模型波长网格上</span>

    <span class="c1"># 对光谱进行积分以生成合成光度点。</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fcalc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># 遍历不同角度的光谱</span>
        <span class="n">fcal</span> <span class="o">=</span> <span class="n">fcalc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># 获取当前光谱</span>
        <span class="n">Tot</span> <span class="o">=</span> <span class="n">int_tabulated</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">ws</span> <span class="o">*</span> <span class="n">respout</span> <span class="o">*</span> <span class="n">reswavebinout</span><span class="p">)</span>  <span class="c1"># 计算总积分</span>
        <span class="n">phot1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_tabulated</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">ws</span> <span class="o">*</span> <span class="n">respout</span> <span class="o">*</span> <span class="n">reswavebinout</span> <span class="o">*</span> <span class="n">fcal</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">/</span> <span class="n">Tot</span>  <span class="c1"># 计算光度</span>

    <span class="k">if</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;1D&#39;</span><span class="p">:</span>
        <span class="n">yall</span> <span class="o">=</span> <span class="n">phot1</span> <span class="o">/</span> <span class="n">phot1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 归一化光度</span>
    <span class="k">elif</span> <span class="n">ld_model</span> <span class="o">==</span> <span class="s1">&#39;3D&#39;</span><span class="p">:</span>
        <span class="n">yall</span> <span class="o">=</span> <span class="n">phot1</span> <span class="o">/</span> <span class="n">phot1</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>  <span class="c1"># 归一化光度</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># 获取波长</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">yall</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># 获取光度</span>

    <span class="c1"># 开始拟合不同的模型</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>  <span class="c1"># 创建拟合器</span>

    <span class="c1"># 拟合四参数非线性边缘变暗模型并获取拟合变量c1, c2, c3, c4。</span>
    <span class="n">corot_4_param</span> <span class="o">=</span> <span class="n">nonlinear_limb_darkening</span><span class="p">()</span>  <span class="c1"># 创建模型</span>
    <span class="n">corot_4_param</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">corot_4_param</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># 拟合模型</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span> <span class="o">=</span> <span class="n">corot_4_param</span><span class="o">.</span><span class="n">parameters</span>  <span class="c1"># 获取拟合参数</span>

    <span class="c1"># 拟合三参数非线性边缘变暗模型并获取拟合变量cp2, cp3, cp4（cp1 = 0）。</span>
    <span class="n">corot_3_param</span> <span class="o">=</span> <span class="n">nonlinear_limb_darkening</span><span class="p">()</span>  <span class="c1"># 创建模型</span>
    <span class="n">corot_3_param</span><span class="o">.</span><span class="n">c0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 3参数模型的c0固定为0.0</span>
    <span class="n">corot_3_param</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">corot_3_param</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># 拟合模型</span>
    <span class="n">cp1</span><span class="p">,</span> <span class="n">cp2</span><span class="p">,</span> <span class="n">cp3</span><span class="p">,</span> <span class="n">cp4</span> <span class="o">=</span> <span class="n">corot_3_param</span><span class="o">.</span><span class="n">parameters</span>  <span class="c1"># 获取拟合参数</span>

    <span class="c1"># 拟合二次边缘变暗模型并获取拟合参数aLD和bLD。</span>
    <span class="n">quadratic</span> <span class="o">=</span> <span class="n">quadratic_limb_darkening</span><span class="p">()</span>  <span class="c1"># 创建模型</span>
    <span class="n">quadratic</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">quadratic</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># 拟合模型</span>
    <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span> <span class="o">=</span> <span class="n">quadratic</span><span class="o">.</span><span class="n">parameters</span>  <span class="c1"># 获取拟合参数</span>

    <span class="c1"># 拟合线性边缘变暗模型并获取拟合变量uLD。</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">nonlinear_limb_darkening</span><span class="p">()</span>  <span class="c1"># 创建模型</span>
    <span class="n">linear</span><span class="o">.</span><span class="n">c0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 固定c0</span>
    <span class="n">linear</span><span class="o">.</span><span class="n">c2</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 固定c2</span>
    <span class="n">linear</span><span class="o">.</span><span class="n">c3</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 固定c3</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># 拟合模型</span>
    <span class="n">uLD</span> <span class="o">=</span> <span class="n">linear</span><span class="o">.</span><span class="n">c1</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 获取拟合参数</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">边缘变暗参数:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;4param </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3param </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cp2</span><span class="p">,</span> <span class="n">cp3</span><span class="p">,</span> <span class="n">cp4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quad </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Linear </span><span class="se">\t</span><span class="si">{:0.8f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uLD</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">uLD</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">cp1</span><span class="p">,</span> <span class="n">cp2</span><span class="p">,</span> <span class="n">cp3</span><span class="p">,</span> <span class="n">cp4</span><span class="p">,</span> <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span>

<span class="k">def</span><span class="w"> </span><span class="nf">int_tabulated</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">Xsegments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># 计算X的段数</span>

    <span class="c1"># 将向量按升序排序。</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># 获取排序索引</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>  <span class="c1"># 排序X</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>  <span class="c1"># 排序F</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">Xsegments</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 确保段数是4的倍数</span>
        <span class="n">Xsegments</span> <span class="o">=</span> <span class="n">Xsegments</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">Xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># 获取X的最小值</span>
    <span class="n">Xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># 获取X的最大值</span>

    <span class="c1"># 统一步长。</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xmax</span> <span class="o">+</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">Xmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">Xsegments</span>  <span class="c1"># 计算步长</span>
    <span class="c1"># 在Xgrid上计算插值。</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Xsegments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">Xmin</span><span class="p">,</span> <span class="n">splrep</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">F</span><span class="p">))</span>  <span class="c1"># 计算插值</span>

    <span class="c1"># 使用5点牛顿-科特斯公式计算积分。</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span>  <span class="c1"># 计算索引</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="mf">7.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">+</span> <span class="mf">32.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mf">12.0</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">45.0</span><span class="p">)</span>  <span class="c1"># 返回积分结果</span>
</pre></div>
</div>
</div>
</div>
<section id="id10">
<h2>现在定义过境模型函数<a class="headerlink" href="#id10" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">occultnl</span><span class="p">(</span><span class="n">rl</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MANDEL &amp; AGOL (2002) transit model.</span>
<span class="sd">    </span>
<span class="sd">    :param rl: float, transit depth (Rp/R*)</span>
<span class="sd">    :param c1: float, limb darkening parameter 1</span>
<span class="sd">    :param c2: float, limb darkening parameter 2</span>
<span class="sd">    :param c3: float, limb darkening parameter 3</span>
<span class="sd">    :param c4: float, limb darkening parameter 4</span>
<span class="sd">    :param b0: impact parameter in stellar radii</span>
<span class="sd">    :return: mulimb0: limb-darkened transit model, mulimbf: lightcurves for each component that you put in the model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mulimb0</span> <span class="o">=</span> <span class="n">occultuniform</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">rl</span><span class="p">)</span>  <span class="c1"># 计算均匀源的光曲线</span>
    <span class="n">bt0</span> <span class="o">=</span> <span class="n">b0</span>  <span class="c1"># 保存初始的影响参数</span>
    <span class="n">fac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mulimb0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># 计算光度因子的最大绝对值</span>

    <span class="k">if</span> <span class="n">fac</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fac</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># 如果fac为0，设置一个小的正数以避免除零错误</span>

    <span class="n">omega</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c3</span> <span class="o">-</span> <span class="n">c4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">c1</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">c3</span> <span class="o">/</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">c4</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1"># 计算权重因子</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span>  <span class="c1"># 获取影响参数数组的长度</span>
    <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mulimb0</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 找到光度因子不等于1的索引</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># 如果没有找到，设置为-1</span>

    <span class="n">mulimb</span> <span class="o">=</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span>  <span class="c1"># 获取对应的光度因子</span>
    <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="n">nb</span><span class="p">))</span>  <span class="c1"># 初始化光曲线数组</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">1.</span>  <span class="c1"># 设置第一个组件的光度</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">0.8</span>  <span class="c1"># 设置第二个组件的光度</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span>  <span class="c1"># 设置第三个组件的光度</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">7</span>  <span class="c1"># 设置第四个组件的光度</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mulimbf</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># 设置第五个组件的光度</span>

    <span class="n">nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 初始化迭代次数</span>
    <span class="n">dmumax</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># 初始化最大变化量</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">dmumax</span> <span class="o">&gt;</span> <span class="n">fac</span> <span class="o">*</span> <span class="mf">1.e-3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;=</span> <span class="mi">131072</span><span class="p">):</span>  <span class="c1"># 迭代直到满足收敛条件</span>
        <span class="n">mulimbp</span> <span class="o">=</span> <span class="n">mulimb</span>  <span class="c1"># 保存当前光度因子</span>
        <span class="n">nr</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># 每次迭代翻倍</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">nr</span>  <span class="c1"># 计算时间步长</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 生成时间数组</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span>  <span class="c1"># 计算中间时间</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># 计算正弦值</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>  <span class="c1"># 计算信号强度</span>

        <span class="c1"># 计算不同光度因子的中间值</span>
        <span class="n">mulimbhalf</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">mulimb1</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">mulimb3half</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">mulimb2</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nr</span><span class="p">):</span>  <span class="c1"># 遍历每个时间步</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">occultuniform</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rl</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 计算当前光度因子</span>
            <span class="n">sig1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>  <span class="c1"># 计算前一个时间步的信号强度</span>
            <span class="n">sig2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>  <span class="c1"># 计算当前时间步的信号强度</span>

            <span class="c1"># 更新光度因子</span>
            <span class="n">mulimbhalf</span> <span class="o">=</span> <span class="n">mulimbhalf</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">mulimb1</span> <span class="o">=</span> <span class="n">mulimb1</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">mulimb3half</span> <span class="o">=</span> <span class="n">mulimb3half</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">5</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">mulimb2</span> <span class="o">=</span> <span class="n">mulimb2</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">sig2</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">/</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="c1"># 计算新的光度因子</span>
        <span class="n">mulimb</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c3</span> <span class="o">-</span> <span class="n">c4</span><span class="p">)</span> <span class="o">*</span> <span class="n">mulimb0</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="o">+</span> 
                   <span class="n">c1</span> <span class="o">*</span> <span class="n">mulimbhalf</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> 
                   <span class="n">c2</span> <span class="o">*</span> <span class="n">mulimb1</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> 
                   <span class="n">c3</span> <span class="o">*</span> <span class="n">mulimb3half</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> 
                   <span class="n">c4</span> <span class="o">*</span> <span class="n">mulimb2</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">/</span> <span class="n">omega</span>

        <span class="n">ix1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mulimb</span> <span class="o">+</span> <span class="n">mulimbp</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 找到光度因子不为零的索引</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ix1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ix1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># 如果没有找到，设置为-1</span>

        <span class="c1"># 计算最大变化量</span>
        <span class="n">dmumax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb</span><span class="p">)[</span><span class="n">ix1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimbp</span><span class="p">)[</span><span class="n">ix1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb</span><span class="p">)[</span><span class="n">ix1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimbp</span><span class="p">)[</span><span class="n">ix1</span><span class="p">]))</span>

    <span class="c1"># 更新光度曲线</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb0</span><span class="p">)[</span><span class="n">indx</span><span class="p">]</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimbhalf</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb1</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb3half</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">mulimbf</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb2</span> <span class="o">*</span> <span class="n">dt</span>

    <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">mulimb0</span><span class="p">)[</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb</span>  <span class="c1"># 更新光度因子</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">bt0</span>  <span class="c1"># 恢复初始影响参数</span>

    <span class="k">return</span> <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span>  <span class="c1"># 返回光度因子和光曲线</span>

<span class="k">def</span><span class="w"> </span><span class="nf">occultuniform</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the lightcurve for occultation of a uniform source without microlensing (Mandel &amp; Agol 2002).</span>
<span class="sd">    </span>
<span class="sd">    :param b0: array; impact parameter in units of stellar radii</span>
<span class="sd">    :param w: array; occulting star size in units of stellar radius</span>
<span class="sd">    :return: muo1: float; fraction of flux at each b0 for a uniform source</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-3</span><span class="p">:</span>  <span class="c1"># 如果w接近0.5，设置为0.5</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="n">nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">b0</span><span class="p">))</span>  <span class="c1"># 获取影响参数数组的长度</span>
    <span class="n">muo1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>  <span class="c1"># 初始化光度因子数组</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="p">):</span>  <span class="c1"># 遍历每个影响参数</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">b0</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># 获取当前影响参数</span>

        <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">:</span>  <span class="c1"># 如果影响参数大于等于1+w</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># 光度因子为1</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># 如果w大于等于1且影响参数小于等于w-1</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># 光度因子为0</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="ow">and</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">w</span><span class="p">:</span>  <span class="c1"># 如果影响参数在[|1-w|, 1+w]之间</span>
            <span class="n">kap1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)))</span>  <span class="c1"># 计算角度</span>
            <span class="n">kap0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">w</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)))</span>  <span class="c1"># 计算角度</span>
            <span class="n">lambdae</span> <span class="o">=</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">kap0</span> <span class="o">+</span> <span class="n">kap1</span>  <span class="c1"># 计算光度因子</span>
            <span class="n">lambdae</span> <span class="o">=</span> <span class="p">(</span><span class="n">lambdae</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># 归一化</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lambdae</span>  <span class="c1"># 更新光度因子</span>

        <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w</span><span class="p">:</span>  <span class="c1"># 如果影响参数小于等于1-w</span>
            <span class="n">muo1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># 更新光度因子</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="n">muo1</span>  <span class="c1"># 返回光度因子数组</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id11">
<h2>现在定义生成过境光曲线的函数并将其与数据进行比较<a class="headerlink" href="#id11" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 函数用于调用和计算模型</span>

<span class="k">def</span><span class="w"> </span><span class="nf">residual</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">):</span>
    
    <span class="c1"># 计算新的轨道</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># 选择在第一次和第四次接触之间的索引</span>
    <span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>

    <span class="c1"># 创建光曲线模型，初始所有值设为1.0</span>
    <span class="n">light_curve</span> <span class="o">=</span> <span class="n">b0</span> <span class="o">/</span> <span class="n">b0</span>

    <span class="c1"># 计算光度减弱，使用Madel和Agol的方法</span>
    <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">[</span><span class="n">intransit</span><span class="p">])</span>  

    <span class="c1"># 在过境期间更新光曲线</span>
    <span class="n">light_curve</span><span class="p">[</span><span class="n">intransit</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb0</span>

    <span class="c1"># 计算模型：过境模型是基线通量 X 过境模型 X 系统模型</span>
    <span class="n">model</span> <span class="o">=</span> <span class="p">(</span><span class="n">light_curve</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;Fslope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">phase</span> <span class="o">+</span> 
                                               <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xsh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shx</span> <span class="o">+</span> 
                                               <span class="n">p</span><span class="p">[</span><span class="s1">&#39;x2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shx</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> 
                                               <span class="n">p</span><span class="p">[</span><span class="s1">&#39;ysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shy</span> <span class="o">+</span> 
                                               <span class="n">p</span><span class="p">[</span><span class="s1">&#39;y2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shy</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> 
                                               <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">shy</span> <span class="o">*</span> <span class="n">shx</span> <span class="o">+</span> 
                                               <span class="n">p</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">common_mode</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> 

    <span class="c1"># 计算当前的卡方值</span>
    <span class="n">chi2now</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># 计算残差的标准差</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">model</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># 打印当前的rprs值、卡方值和散射值</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rprs: &quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;current chi^2=&quot;</span><span class="p">,</span> <span class="n">chi2now</span><span class="p">,</span> <span class="s1">&#39; scatter &#39;</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 返回标准化的残差</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">model</span><span class="p">)</span> <span class="o">/</span> <span class="n">err</span>

    <span class="c1"># return np.sum((y-model)**2/err**2)  # 这行代码被注释掉了</span>
</pre></div>
</div>
</div>
</div>
<p>一个函数也被定义为返回仅仅是过境模型 <span class="math notranslate nohighlight">\(T(t,\theta)\)</span>。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">model_fine</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>  <span class="c1"># 创建用于绘图目的的精细网格的过境模型</span>

    <span class="c1"># 计算b0，表示行星相对于恒星的距离</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase_fine</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase_fine</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># 使用occultnl函数计算模型的光度，mulimb0和mulimbf分别表示不同的光度</span>
    <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">)</span>  <span class="c1"># Madel 和 Agol</span>

    <span class="c1"># 将模型光度赋值给model_fine</span>
    <span class="n">model_fine</span> <span class="o">=</span> <span class="n">mulimb0</span>

    <span class="k">return</span> <span class="n">model_fine</span>  <span class="c1"># 返回计算得到的过境模型</span>
</pre></div>
</div>
</div>
</div>
<p>现在在示例光曲线中添加一个过境模型。在这里，我们已经计算了边缘变暗系数（limb darkening coefficients），然后在过境光曲线中使用它们。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wave1</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">]</span>  <span class="c1"># 从wsdata_all中提取第pix1个像素的波长值，赋值给wave1</span>

<span class="n">wave2</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">]</span>  <span class="c1"># 从wsdata_all中提取第pix2个像素的波长值，赋值给wave2</span>

<span class="n">bin_wave_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">wsdata_all</span> <span class="o">&gt;</span> <span class="n">wave1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wsdata_all</span> <span class="o">&lt;=</span> <span class="n">wave2</span><span class="p">))</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>  <span class="c1"># 找到wsdata_all中在wave1和wave2之间的波长索引</span>

<span class="n">wsdata</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">bin_wave_index</span><span class="p">]</span><span class="o">*</span><span class="mf">1E4</span>  <span class="c1"># 选择波长区间内的值并将单位从微米转换为埃（angstroms）</span>

<span class="n">_uLD</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">_cp1</span><span class="p">,</span> <span class="n">_cp2</span><span class="p">,</span> <span class="n">_cp3</span><span class="p">,</span> <span class="n">_cp4</span><span class="p">,</span> <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span> <span class="o">=</span> <span class="n">limb_dark_fit</span><span class="p">(</span><span class="n">grating</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">,</span> <span class="n">M_H</span><span class="p">,</span> <span class="n">Teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">,</span> <span class="n">limb_dark_directory</span><span class="p">,</span> <span class="n">ld_model</span><span class="p">)</span>  
<span class="c1"># 调用limb_dark_fit函数进行光度暗化拟合，返回多个参数</span>
</pre></div>
</div>
</div>
</div>
<p>现在运行过境模型。</p>
<p>过境参数，例如倾角（inclination）和 <span class="math notranslate nohighlight">\(a/R_{star}\)</span>，已在笔记本的开头设置。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 运行过境模型</span>

<span class="n">rl</span> <span class="o">=</span> <span class="mf">0.0825</span>     <span class="c1"># 行星与恒星半径比</span>

<span class="c1"># 计算接触点的投影参数 b0</span>
<span class="n">b0</span> <span class="o">=</span> <span class="n">a_Rs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># 选择在第一次和第四次接触之间的索引</span>
<span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span><span class="o">-</span><span class="n">rl</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>  

<span class="c1"># 使用 Mandel &amp; Agol 的非线性暗化过境模型</span>
<span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">rl</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">)</span>  

<span class="c1"># 计算模型</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">mulimb0</span> <span class="o">*</span> <span class="n">yfit</span> 

<span class="c1"># 绘图设置</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]</span>           <span class="c1"># 图形尺寸</span>
<span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>           <span class="c1"># 默认标记大小</span>

<span class="c1"># 创建图形</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 创建网格布局</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">)</span>

<span class="c1"># 添加第一个子图</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>

<span class="c1"># 绘制数据散点图</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ 数据&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># 绘制模型拟合曲线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$S(x)$ 回归拟合 &#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>

<span class="c1"># 设置 x 轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>

<span class="c1"># 设置 y 轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;相对通量&#39;</span><span class="p">)</span>

<span class="c1"># 设置图形标题</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;时间序列过境光曲线  $\lambda=$[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">wsdata_all</span><span class="p">[</span><span class="n">pix2</span><span class="p">])</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>

<span class="c1"># 设置 x 轴主刻度和次刻度</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>

<span class="c1"># 设置 y 轴主刻度和次刻度</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.002</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.001</span><span class="p">))</span>

<span class="c1"># 计算标准化的 y 值</span>
<span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>

<span class="c1"># 设置 y 轴范围</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yplot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.999</span><span class="p">,</span> <span class="n">yplot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.001</span><span class="p">)</span>

<span class="c1"># 设置 x 轴范围</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>

<span class="c1"># 添加图例</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># 将 ax1 添加到图形中</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>

<span class="c1"># 残差图</span>

<span class="c1"># 添加第二个子图</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>

<span class="c1"># 绘制残差散点图</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$f(t)$ 数据&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span><span class="o">*</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="c1"># 计算并绘制残差的统计信息</span>
<span class="n">wsb</span><span class="p">,</span> <span class="n">wsb_bin_edges</span><span class="p">,</span> <span class="n">binnumber</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="mf">1E6</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">wsb_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">wsb</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

<span class="c1"># 设置 x 轴和 y 轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;日心朱利安日期 (天)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;残差 (ppm)&#39;</span><span class="p">)</span>

<span class="c1"># 设置 x 轴主刻度和次刻度</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>

<span class="c1"># 计算标准化的 y 值</span>
<span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>

<span class="c1"># 设置 x 轴范围</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>

<span class="c1"># 将 ax2 添加到图形中</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>

<span class="c1"># 显示图形</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 打印卡方值</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Chi^2 = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

<span class="c1"># 打印残差标准差</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;残差标准差 : &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span><span class="o">-</span><span class="n">model</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39; ppm&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;256 Bin 标准差  :&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">wsb</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; ppm&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>请注意，模型的过境深度与数据相比略显过深。行星半径需要更小，参数 <span class="math notranslate nohighlight">\(rl\)</span> 更接近 0.08。作为练习，您可以重新运行上述单元，将行星半径更改为 <span class="math notranslate nohighlight">\(rl\)</span>=0.0805，并将 <span class="math notranslate nohighlight">\(\chi^2\)</span> 值与之前的默认值进行比较（在 <span class="math notranslate nohighlight">\(rl\)</span> = 0.0825 时，<span class="math notranslate nohighlight">\(\chi^2\)</span>=9265.4）。</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="fit">
<h1>FIT过渡光曲线<a class="headerlink" href="#fit" title="Link to this heading">#</a></h1>
<p>现在我们可以对每个光曲线进行拟合，通过最小二乘法优化拟合参数。在这里，使用Levenberg-Marquardt拟合来寻找<span class="math notranslate nohighlight">\(\chi^2\)</span>最小值，并使用lmfit包（https://lmfit.github.io/lmfit-py/fitting.html）估计不确定性。</p>
<p>实际上，首先我们会拟合白光光曲线，该光曲线是对整个1D光谱中所有波长的总和。这可以用来拟合系统参数，例如倾角和过渡时间，然后光谱通道被固定为这些值，因为它们与波长无关。然而，CV3数据需要去除灯光的整体变化，这使得我们无法使用这些数据进行白光光曲线分析。在这里，我们继续对光谱光曲线的光谱箱进行拟合。</p>
<p>步骤如下：</p>
<ol class="arabic simple">
<li><p>选择波长箱</p></li>
<li><p>从恒星模型中计算每个箱的光晕暗化系数。</p></li>
<li><p>在过渡外数据上进行初始线性回归，以开始系统拟合参数，这大大加快了拟合速度，因为这些参数接近其全局最小值。</p></li>
<li><p>开始拟合，并在最小化过程中输出一些统计信息。</p></li>
<li><p>一旦找到最佳拟合，将显示多个统计信息。</p></li>
<li><p>最后，生成几个图表并将其存储为PDF，然后开始下一个箱。</p></li>
</ol>
<p>这些步骤对每个光谱箱进行。</p>
<p>在这个例子中，行星半径被设置为在拟合中变化，同时基线通量和仪器系统参数也会变化。</p>
<section id="id12">
<h2>设置待拟合的波长<a class="headerlink" href="#id12" title="Link to this heading">#</a></h2>
<p>光谱必须在波长上进行分箱，以获得足够的计数，以达到所需的约100 ppm水平。</p>
<p>光谱在大约像素100到400之间有显著的计数，我们从像素 <span class="math notranslate nohighlight">\(k0\)</span> 开始，并以 <span class="math notranslate nohighlight">\(wk\)</span> 像素进行分箱。</p>
<p>还定义了几个数组。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k0</span> <span class="o">=</span> <span class="mi">113</span>  <span class="c1"># 起始波长索引</span>
<span class="n">kend</span> <span class="o">=</span> <span class="mi">392</span>  <span class="c1"># 结束波长索引</span>
<span class="n">wk</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># 每个bin的宽度</span>

<span class="c1"># 计算bin的数量</span>
<span class="n">number_of_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">kend</span> <span class="o">-</span> <span class="n">k0</span><span class="p">)</span> <span class="o">/</span> <span class="n">wk</span><span class="p">)</span>

<span class="c1"># 初始化各个数组</span>
<span class="n">wsd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>  <span class="c1"># 存储波长数据</span>
<span class="n">werr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>  <span class="c1"># 存储波长误差</span>
<span class="n">rprs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>  <span class="c1"># 存储半径比</span>
<span class="n">rerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>  <span class="c1"># 存储半径比误差</span>
<span class="n">sig_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>  <span class="c1"># 存储半径信号</span>
<span class="n">sig_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>  <span class="c1"># 存储波长信号</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>  <span class="c1"># 存储beta参数</span>
<span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>  <span class="c1"># 存储深度</span>
<span class="n">depth_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_of_bins</span><span class="p">))</span>  <span class="c1"># 存储深度误差</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id13">
<h2>循环遍历波长区间，拟合每个光曲线<a class="headerlink" href="#id13" title="Link to this heading">#</a></h2>
<section id="id14">
<h3>注意：此步骤需要相当长的时间来完成（约20分钟，每个波长区间几分钟）<a class="headerlink" href="#id14" title="Link to this heading">#</a></h3>
<p>每个波长区间都将拟合过渡+系统误差模型。各种输出，包括图表，将被保存。</p>
<p>可以跳到下一个单元以加载预先计算的结果。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="n">k0</span>   <span class="c1"># 设置起始波长</span>

<span class="c1"># --------------------------------------------------------------------------</span>

<span class="c1"># 循环遍历波长区间并为每个区间进行拟合</span>

<span class="k">for</span> <span class="nb">bin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_of_bins</span><span class="p">):</span>

    <span class="c1"># 选择波长区间</span>

    <span class="n">wave1</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>  <span class="c1"># 当前波长区间的下限</span>

    <span class="n">wave2</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">wk</span><span class="p">]</span>  <span class="c1"># 当前波长区间的上限</span>

    <span class="c1"># 选择波长区间的索引</span>

    <span class="n">bin_wave_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">wsdata_all</span> <span class="o">&gt;</span> <span class="n">wave1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wsdata_all</span> <span class="o">&lt;=</span> <span class="n">wave2</span><span class="p">))</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>  <span class="c1"># 获取在当前波长区间内的索引</span>

    <span class="c1"># 制作光曲线区间</span>

    <span class="n">wave_bin_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_spec_1D</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="n">wk</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 对波长像素进行求和</span>

    <span class="n">wave_bin_counts_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wave_bin_counts</span><span class="p">)</span>  <span class="c1"># 采用光子噪声作为误差</span>

    <span class="c1"># 计算边缘暗化</span>

    <span class="n">wsdata</span> <span class="o">=</span> <span class="n">wsdata_all</span><span class="p">[</span><span class="n">bin_wave_index</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1E4</span>  <span class="c1"># 选择波长区间的值（从微米转换为埃）</span>

    <span class="n">_uLD</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">_cp1</span><span class="p">,</span> <span class="n">_cp2</span><span class="p">,</span> <span class="n">_cp3</span><span class="p">,</span> <span class="n">_cp4</span><span class="p">,</span> <span class="n">aLD</span><span class="p">,</span> <span class="n">bLD</span> <span class="o">=</span> <span class="n">limb_dark_fit</span><span class="p">(</span><span class="n">grating</span><span class="p">,</span> <span class="n">wsdata</span><span class="p">,</span> <span class="n">M_H</span><span class="p">,</span> <span class="n">Teff</span><span class="p">,</span> <span class="n">logg</span><span class="p">,</span> <span class="n">limb_dark_directory</span><span class="p">,</span> <span class="n">ld_model</span><span class="p">)</span>  <span class="c1"># 进行边缘暗化拟合</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">c1 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c1</span><span class="p">))</span>  <span class="c1"># 打印边缘暗化系数c1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c2 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c2</span><span class="p">))</span>  <span class="c1"># 打印边缘暗化系数c2</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c3 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c3</span><span class="p">))</span>  <span class="c1"># 打印边缘暗化系数c3</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c4 = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c4</span><span class="p">))</span>  <span class="c1"># 打印边缘暗化系数c4</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># u   = [c1,c2,c3,c4]  # 边缘暗化系数</span>
    <span class="c1"># u = [aLD, bLD]</span>

    <span class="c1"># 制作初始模型</span>

    <span class="c1"># 设置LMFIT</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">bjd</span>  <span class="c1"># X数据</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">wave_bin_counts</span>  <span class="c1"># Y数据</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">wave_bin_counts_err</span>  <span class="c1"># Y误差</span>

    <span class="c1"># 在无过境数据上执行快速线性回归以获得准确的起始探测器拟合值</span>

    <span class="k">if</span> <span class="n">wave1</span> <span class="o">&gt;</span> <span class="mf">2.7</span> <span class="ow">and</span> <span class="n">wave1</span> <span class="o">&lt;</span> <span class="mf">3.45</span><span class="p">:</span>  <span class="c1"># 根据波长选择不同的回归器</span>
        <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">XXX</span><span class="p">[</span><span class="n">outtransit</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]))</span>  <span class="c1"># 拟合无过境数据</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">XX</span><span class="p">[</span><span class="n">outtransit</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]))</span>  <span class="c1"># 拟合无过境数据</span>

    <span class="c1"># 创建LMFIT参数集 https://lmfit.github.io/lmfit-py/parameters.html</span>

    <span class="c1"># class Parameter(name, value=None, vary=True, min=- inf, max=inf, expr=None, brute_step=None, user_data=None)¶</span>

    <span class="c1"># 设置vary=0以固定</span>

    <span class="c1"># 设置vary=1以进行拟合</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">Parameters</span><span class="p">()</span>  <span class="c1"># 存储L-M拟合参数的对象</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;cosinc&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inc</span><span class="p">),</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 倾角，固定cos(倾角)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;rho_star&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">rho_star</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 恒星密度</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">a_Rs</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># a/Rstar</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;rprs&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">rp</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 行星与恒星半径比</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 过境T0</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;f0&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">]),</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 基线通量</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ecc&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ecc</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 偏心率</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;omega&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">omega</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 近日点参数</span>

    <span class="c1"># 在水特征中开启线性斜率以考虑在低温测试期间窗户上H2O冰的变化</span>

    <span class="k">if</span> <span class="n">wave1</span> <span class="o">&gt;</span> <span class="mf">2.7</span> <span class="ow">and</span> <span class="n">wave1</span> <span class="o">&lt;</span> <span class="mf">3.45</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Fslope&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 轨道相位</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Fslope&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vary</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 轨道相位</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;xsh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 探测器X偏移去趋势</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ysh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 探测器Y偏移去趋势</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;x2sh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 探测器X^2偏移去趋势</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;y2sh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 探测器Y^2偏移去趋势</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;xysh&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 探测器XY去趋势</span>

    <span class="n">p</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;comm&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">regressor</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">vary</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 共模去趋势</span>

    <span class="c1"># 执行最小化 https://lmfit.github.io/lmfit-py/fitting.html</span>

    <span class="c1"># 创建最小化器</span>

    <span class="c1"># mini = lmfit.Minimizer(residual, p, nan_policy=&#39;omit&#39;,fcn_args=(phase,x,y,err)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fitting Bin&#39;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">,</span> <span class="s1">&#39; Wavelength =&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1E4</span><span class="p">,</span> <span class="s1">&#39;  Range= [&#39;</span><span class="p">,</span> <span class="n">wave1</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">wave2</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>  <span class="c1"># 打印当前拟合的波长区间</span>

    <span class="c1"># 使用Levenberg-Marquardt求解</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">))</span>  <span class="c1"># 最小化残差</span>

    <span class="c1"># result = mini.minimize(method=&#39;emcee&#39;)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Re-Fitting Bin&#39;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">,</span> <span class="s1">&#39; Wavelength =&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1E4</span><span class="p">,</span> <span class="s1">&#39;  Range= [&#39;</span><span class="p">,</span> <span class="n">wave1</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">wave2</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>  <span class="c1"># 打印重新拟合的波长区间</span>
    <span class="c1"># --------------------------------------------------------------------------</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;redchi&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">redchi</span><span class="p">)</span>  <span class="c1"># 打印红卡方</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chi2&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">chisqr</span><span class="p">)</span>  <span class="c1"># 打印卡方</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nfree&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">nfree</span><span class="p">)</span>  <span class="c1"># 打印自由度</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bic&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">bic</span><span class="p">)</span>  <span class="c1"># 打印贝叶斯信息准则</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;aic&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">aic</span><span class="p">)</span>  <span class="c1"># 打印赤池信息准则</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L-M FIT Variable&quot;</span><span class="p">)</span>  <span class="c1"># 打印L-M拟合变量</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">lmfit</span><span class="o">.</span><span class="n">fit_report</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>  <span class="c1"># 打印拟合报告</span>

    <span class="n">text_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_directory</span> <span class="o">+</span> <span class="s1">&#39;JWST_NIRSpec_Prism_fit_light_curve_bin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_statistics.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>  <span class="c1"># 打开文件以保存统计信息</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">redchi &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">redchi</span><span class="p">))</span>  <span class="c1"># 写入红卡方</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">chi2   &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">chisqr</span><span class="p">))</span>  <span class="c1"># 写入卡方</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">nfree  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">nfree</span><span class="p">))</span>  <span class="c1"># 写入自由度</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">bic    &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">bic</span><span class="p">))</span>  <span class="c1"># 写入贝叶斯信息准则</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">aic    &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">aic</span><span class="p">))</span>  <span class="c1"># 写入赤池信息准则</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lmfit</span><span class="o">.</span><span class="n">fit_report</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>  <span class="c1"># 写入拟合报告</span>
    <span class="c1"># file-output.py</span>

    <span class="c1"># 更新最佳拟合参数</span>

    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rho_star&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rho_star&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新恒星密度</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新cos(倾角)</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新行星与恒星半径比</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新过境T0</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新基线通量</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;Fslope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Fslope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新斜率</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xsh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xsh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新X偏移</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;ysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新Y偏移</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;x2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新X^2偏移</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;y2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y2sh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新Y^2偏移</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;xysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;xysh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新XY偏移</span>
    <span class="n">p</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;comm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新共模偏移</span>

    <span class="c1"># 更新拟合光谱数组</span>

    <span class="n">wsd</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wsdata</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1E4</span>  <span class="c1"># 更新波长中心</span>
    <span class="n">werr</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wsdata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">wsdata</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="mf">2E4</span>  <span class="c1"># 更新波长半宽</span>
    <span class="n">rprs</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 更新行星与恒星半径比</span>
    <span class="n">rerr</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>  <span class="c1"># 更新行星与恒星半径比的误差</span>

    <span class="c1"># 计算最佳拟合模型</span>

    <span class="n">final_model</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">result</span><span class="o">.</span><span class="n">residual</span> <span class="o">*</span> <span class="n">err</span>  <span class="c1"># 计算最终模型</span>
    <span class="n">final_model_fine</span> <span class="o">=</span> <span class="n">model_fine</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># 计算细化模型</span>

    <span class="c1"># 更多统计信息</span>

    <span class="n">resid</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">final_model</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 计算残差</span>
    <span class="n">residppm</span> <span class="o">=</span> <span class="mf">1E6</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">final_model</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 计算残差的ppm</span>
    <span class="n">residerr</span> <span class="o">=</span> <span class="n">err</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 计算残差误差</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">final_model</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1E6</span>  <span class="c1"># 计算残差的标准差</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Residual standard deviation  (ppm) : &quot;</span><span class="p">,</span> <span class="mf">1E6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">final_model</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>  <span class="c1"># 打印残差标准差</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Photon noise                 (ppm) : &quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1E6</span><span class="p">)</span>  <span class="c1"># 打印光子噪声</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Photon noise performance       (%) : &quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1E6</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># 打印光子噪声性能</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Residual standard deviation  (ppm) : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">final_model</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)))</span>  <span class="c1"># 写入残差标准差</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Photon noise                 (ppm) : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1E6</span><span class="p">))</span>  <span class="c1"># 写入光子噪声</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Photon noise performance       (%) : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1E6</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>  <span class="c1"># 写入光子噪声性能</span>

    <span class="c1"># 使用分箱技术测量红噪声</span>

    <span class="n">sig0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>  <span class="c1"># 计算残差的标准差</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="n">number_of_images</span> <span class="o">/</span> <span class="n">binmeasure</span>  <span class="c1"># 计算分箱数</span>
    <span class="n">wsb</span><span class="p">,</span> <span class="n">wsb_bin_edges</span><span class="p">,</span> <span class="n">binnumber</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>  <span class="c1"># 进行分箱统计</span>
    <span class="n">sig_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">wsb</span><span class="p">)</span>  <span class="c1"># 计算分箱后的标准差</span>
    <span class="n">sigrednoise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig_binned</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">sig0</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">binmeasure</span><span class="p">)</span>  <span class="c1"># 计算红噪声</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sigrednoise</span><span class="p">):</span>  <span class="c1"># 如果没有检测到红噪声，则设置为零</span>
        <span class="n">sigrednoise</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">sigwhite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig0</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">sigrednoise</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 计算白噪声</span>
    <span class="n">sigrednoise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig_binned</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">sigwhite</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">binmeasure</span><span class="p">)</span>  <span class="c1"># 重新计算红噪声</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sigrednoise</span><span class="p">):</span>  <span class="c1"># 如果没有检测到红噪声，则设置为零</span>
        <span class="n">sigrednoise</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">beta</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig0</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">binmeasure</span> <span class="o">*</span> <span class="n">sigrednoise</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sig0</span>  <span class="c1"># 计算红噪声膨胀因子</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;White noise                  (ppm) : &quot;</span><span class="p">,</span> <span class="mf">1E6</span> <span class="o">*</span> <span class="n">sigwhite</span><span class="p">)</span>  <span class="c1"># 打印白噪声</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Red noise                    (ppm) : &quot;</span><span class="p">,</span> <span class="mf">1E6</span> <span class="o">*</span> <span class="n">sigrednoise</span><span class="p">)</span>  <span class="c1"># 打印红噪声</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transit depth measured error (ppm) : &quot;</span><span class="p">,</span> <span class="mf">2E6</span> <span class="o">*</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>  <span class="c1"># 打印过境深度测量误差</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">White noise                  (ppm) : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span> <span class="o">*</span> <span class="n">sigwhite</span><span class="p">))</span>  <span class="c1"># 写入白噪声</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Red noise                    (ppm) : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mf">1E6</span> <span class="o">*</span> <span class="n">sigrednoise</span><span class="p">))</span>  <span class="c1"># 写入红噪声</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Transit depth measured error (ppm) : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mf">2E6</span> <span class="o">*</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span><span class="p">))</span>  <span class="c1"># 写入过境深度测量误差</span>
    <span class="n">text_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭文件</span>

    <span class="n">depth</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E6</span> <span class="o">*</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># 计算过境深度</span>
    <span class="n">depth_err</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2E6</span> <span class="o">*</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stderr</span>  <span class="c1"># 计算过境深度误差</span>

    <span class="n">sig_r</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigrednoise</span> <span class="o">*</span> <span class="mf">1E6</span>  <span class="c1"># 更新红噪声</span>
    <span class="n">sig_w</span><span class="p">[</span><span class="nb">bin</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigwhite</span> <span class="o">*</span> <span class="mf">1E6</span>  <span class="c1"># 更新白噪声</span>
    <span class="c1"># --------------------------------------------------------------------------</span>

    <span class="c1"># ---------------------------------------------------------</span>

    <span class="c1"># 将拟合光谱写入ascii文件</span>

    <span class="n">ascii_data</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">wsd</span><span class="p">,</span> <span class="n">werr</span><span class="p">,</span> <span class="n">rprs</span><span class="p">,</span> <span class="n">rerr</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_err</span><span class="p">,</span> <span class="n">sig_w</span><span class="p">,</span> <span class="n">sig_r</span><span class="p">,</span> <span class="n">beta</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Wavelength Center (um)&#39;</span><span class="p">,</span> <span class="s1">&#39;Wavelength half-width (um)&#39;</span><span class="p">,</span> <span class="s1">&#39;Rp/Rs&#39;</span><span class="p">,</span> <span class="s1">&#39;Rp/Rs 1-sigma error&#39;</span><span class="p">,</span> <span class="s1">&#39;Transit Depth (ppm)&#39;</span><span class="p">,</span> <span class="s1">&#39;Transit Depth error&#39;</span><span class="p">,</span> <span class="s1">&#39;Sigma_white (ppm)&#39;</span><span class="p">,</span> <span class="s1">&#39;Sigma_red (ppm)&#39;</span><span class="p">,</span> <span class="s1">&#39;Beta Rednoise Inflation factor&#39;</span><span class="p">])</span>  <span class="c1"># 创建表格数据</span>

    <span class="n">ascii</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ascii_data</span><span class="p">,</span> <span class="n">save_directory</span> <span class="o">+</span> <span class="s1">&#39;JWST_NIRSpec_Prism_fit_transmission_spectra.csv&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 写入CSV文件</span>

    <span class="c1"># ---------------------------------------------------------</span>

    <span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>  <span class="c1"># 默认标记大小</span>

    <span class="c1"># 绘制数据模型</span>

    <span class="c1"># 绘图</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]</span>  <span class="c1"># 设置图形尺寸</span>

    <span class="n">msize</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;lines.markersize&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.</span>  <span class="c1"># 默认标记大小</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 创建图形</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.00</span><span class="p">)</span>  <span class="c1"># 创建网格规格</span>

    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>  <span class="c1"># 添加子图</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">final_model</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># 在数据上叠加过境模型</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>  <span class="c1"># 隐藏X轴标签</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>  <span class="c1"># 设置Y轴标签</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time-series Transit Light Curve  $\lambda=$[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">wave1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">wave2</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;] $\mu$m&#39;</span><span class="p">)</span>  <span class="c1"># 设置标题</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>  <span class="c1"># 设置X轴主刻度</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>  <span class="c1"># 设置X轴次刻度</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.002</span><span class="p">))</span>  <span class="c1"># 设置Y轴主刻度</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.001</span><span class="p">))</span>  <span class="c1"># 设置Y轴次刻度</span>
    <span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>  <span class="c1"># 归一化Y数据</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">yplot</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.999</span><span class="p">,</span> <span class="n">yplot</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1.001</span><span class="p">)</span>  <span class="c1"># 设置Y轴范围</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># 设置X轴范围</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span>  <span class="c1"># 添加子图</span>

    <span class="c1"># 残差</span>

    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>  <span class="c1"># 添加残差子图</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">residppm</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 绘制残差散点图</span>
    <span class="n">wsb</span><span class="p">,</span> <span class="n">wsb_bin_edges</span><span class="p">,</span> <span class="n">binnumber</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">bjd</span><span class="p">,</span> <span class="n">residppm</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>  <span class="c1"># 进行分箱统计</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">wsb_bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">wsb</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>  <span class="c1"># 绘制分箱后的残差</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Barycentric Julian Date (days)&#39;</span><span class="p">)</span>  <span class="c1"># 设置X轴标签</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residual (ppm)&#39;</span><span class="p">)</span>  <span class="c1"># 设置Y轴标签</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 绘制零线</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="n">sigma</span><span class="p">,</span> <span class="n">sigma</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># 绘制标准差上限</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="o">-</span><span class="n">sigma</span><span class="p">,</span> <span class="o">-</span><span class="n">sigma</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># 绘制标准差下限</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>  <span class="c1"># 设置X轴主刻度</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.005</span><span class="p">))</span>  <span class="c1"># 设置X轴次刻度</span>
    <span class="n">yplot</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">outtransit</span><span class="p">])</span>  <span class="c1"># 归一化Y数据</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bjd</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">bjd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># 设置X轴范围</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>  <span class="c1"># 添加子图</span>

    <span class="c1"># 保存</span>

    <span class="n">pp</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">save_directory</span> <span class="o">+</span> <span class="s1">&#39;JWST_NIRSpec_Prism_fit_light_curve_bin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_lightcurve.pdf&#39;</span><span class="p">)</span>  <span class="c1"># 创建PDF文件</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>  <span class="c1"># 保存图形为PDF</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭PDF文件</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清空当前图形</span>

    <span class="c1"># 绘制系统校正后的光曲线</span>

    <span class="n">b0</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;a_Rs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;cosinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 计算b0</span>
    <span class="n">intransit</span> <span class="o">=</span> <span class="p">(</span><span class="n">b0</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mf">1.0E0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>  <span class="c1"># 找到过境点</span>

    <span class="n">light_curve</span> <span class="o">=</span> <span class="n">b0</span> <span class="o">/</span> <span class="n">b0</span>  <span class="c1"># 初始化光曲线</span>
    <span class="n">mulimb0</span><span class="p">,</span> <span class="n">mulimbf</span> <span class="o">=</span> <span class="n">occultnl</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;rprs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">,</span> <span class="n">b0</span><span class="p">[</span><span class="n">intransit</span><span class="p">])</span>  <span class="c1"># 计算边缘暗化</span>

    <span class="n">light_curve</span><span class="p">[</span><span class="n">intransit</span><span class="p">]</span> <span class="o">=</span> <span class="n">mulimb0</span>  <span class="c1"># 更新过境点的光曲线</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># 创建新的图形</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">light_curve</span> <span class="o">+</span> <span class="n">resid</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">msize</span> <span class="o">*</span> <span class="mf">0.75</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>  <span class="c1"># 绘制光曲线</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;BJD&#39;</span><span class="p">)</span>  <span class="c1"># 设置X轴标签</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Flux&#39;</span><span class="p">)</span>  <span class="c1"># 设置Y轴标签</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">light_curve</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># 在数据上叠加光曲线</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">save_directory</span> <span class="o">+</span> <span class="s1">&#39;JWST_NIRSpec_Prism_fit_light_curve_bin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_corrected.pdf&#39;</span><span class="p">)</span>  <span class="c1"># 创建PDF文件</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>  <span class="c1"># 保存图形为PDF</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># 关闭PDF文件</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清空当前图形</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>  <span class="c1"># 关闭所有图形</span>

    <span class="c1"># --------------------------------------------------------------------------</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="n">wk</span>  <span class="c1"># 步进到下一个波长区间</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;** 现在可以查看输出PDF文件在 &#39;</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">)</span>  <span class="c1"># 打印输出目录</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id15">
<h1>绘制测量的系外行星传输光谱与注入光谱对比<a class="headerlink" href="#id15" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --------------------------------------------------------------------------</span>

<span class="c1"># 加载注入的传输光谱以与恢复值进行比较</span>

<span class="c1"># 下载注入的光谱数据</span>
<span class="n">fn_tm</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/transit_spectroscopy_notebook/trans-iso_GJ-0436_0669.0_+0.0_0.56_0001_0.00_model.NIRSpec_PRISM.txt&#39;</span><span class="p">)</span>

<span class="c1"># 移动下载的文件到指定的保存目录</span>
<span class="n">destld</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fn_tm</span><span class="p">,</span> <span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;trans-iso_GJ-0436_0669.0_+0.0_0.56_0001_0.00_model.NIRSpec_PRISM.txt&#39;</span><span class="p">)</span>        

<span class="c1"># 打开保存的光谱文件</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;trans-iso_GJ-0436_0669.0_+0.0_0.56_0001_0.00_model.NIRSpec_PRISM.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="c1"># 从文件中读取数据</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;   &#39;</span><span class="p">)</span>

<span class="c1"># 提取波长和光谱数据</span>
<span class="n">model_ws</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># 波长</span>
<span class="n">model_spec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># 光谱强度</span>

<span class="c1"># 读取拟合的过境深度数据</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">save_directory</span><span class="o">+</span><span class="s1">&#39;JWST_NIRSpec_Prism_fit_transmission_spectra.csv&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">)</span>

<span class="c1"># 提取相关数据列</span>
<span class="n">wsd</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Wavelength Center (um)&#39;</span><span class="p">]</span>  <span class="c1"># 波长中心</span>
<span class="n">werr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Wavelength half-width (um)&#39;</span><span class="p">]</span>  <span class="c1"># 波长半宽</span>
<span class="n">rprs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Rp/Rs&#39;</span><span class="p">]</span>  <span class="c1"># 行星半径与恒星半径之比</span>
<span class="n">rerr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Rp/Rs 1-sigma error&#39;</span><span class="p">]</span>  <span class="c1"># 行星半径与恒星半径之比的1σ误差</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Beta Rednoise Inflation factor&#39;</span><span class="p">]</span>  <span class="c1"># 红噪声膨胀因子</span>

<span class="c1"># 绘图</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1"># 创建子图</span>

<span class="c1"># 绘制注入的光谱</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">model_spec</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Injected Spectra&#39;</span><span class="p">)</span>  <span class="c1"># 在数据上叠加过境模型</span>

<span class="c1"># 绘制带误差条的恢复光谱（考虑红噪声）</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wsd</span><span class="p">,</span> <span class="n">rprs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">werr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">rerr</span><span class="o">*</span><span class="n">rprs</span><span class="o">*</span><span class="mf">1E6</span><span class="o">*</span><span class="n">beta</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Recovered Spectra with $\sigma_r$&#39;</span><span class="p">)</span>

<span class="c1"># 绘制不考虑红噪声的恢复光谱</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wsd</span><span class="p">,</span> <span class="n">rprs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">werr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">rerr</span><span class="o">*</span><span class="n">rprs</span><span class="o">*</span><span class="mf">1E6</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recovered Spectra&#39;</span><span class="p">)</span>

<span class="c1"># 设置坐标轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Wavelength ($\mu$m)&#39;</span><span class="p">)</span>  <span class="c1"># 波长</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Transit Depth ($R_p/R_s$)$^2$ (ppm)&#39;</span><span class="p">)</span>  <span class="c1"># 过境深度</span>

<span class="c1"># 设置y轴主刻度和次刻度</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>  <span class="c1"># 主刻度每200</span>
<span class="n">axs</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>  <span class="c1"># 次刻度每100</span>

<span class="c1"># 设置x轴主刻度和次刻度</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># 主刻度每0.5</span>
<span class="n">axs</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>  <span class="c1"># 次刻度每0.1</span>

<span class="c1"># 添加注释文本</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">3.3</span><span class="p">,</span> <span class="mi">6850</span><span class="p">,</span> <span class="s1">&#39;CH$_4$&#39;</span><span class="p">)</span>  <span class="c1"># CH4注释</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">4.25</span><span class="p">,</span> <span class="mi">6700</span><span class="p">,</span> <span class="s1">&#39;CO&#39;</span><span class="p">)</span>  <span class="c1"># CO注释</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">2.3</span><span class="p">,</span> <span class="mi">6750</span><span class="p">,</span> <span class="s1">&#39;CH$_4$&#39;</span><span class="p">)</span>  <span class="c1"># CH4注释</span>
<span class="n">axs</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">2.75</span><span class="p">,</span> <span class="mi">6550</span><span class="p">,</span> <span class="s1">&#39;H$_2$O&#39;</span><span class="p">)</span>  <span class="c1"># H2O注释</span>

<span class="c1"># 设置y轴和x轴的显示范围</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">5700</span><span class="p">,</span> <span class="mi">7000</span><span class="p">)</span>  <span class="c1"># y轴范围</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">5.25</span><span class="p">)</span>  <span class="c1"># x轴范围</span>

<span class="c1"># 显示图例</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>    

<span class="c1"># 显示图形</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 清空当前图形</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>总体而言，注入的过境深度在光谱中得到了很好的恢复，H<span class="math notranslate nohighlight">\(_2\)</span>O 和 CH<span class="math notranslate nohighlight">\(_4\)</span> 等特征易于被检测到。在 3.5 <span class="math notranslate nohighlight">\(\mu\)</span>m 以上的波长数据点存在一些偏移，这可能是由于在 CV3 测试期间，低温窗口上积累的冰导致 CO<span class="math notranslate nohighlight">\(_2\)</span> 或 H<span class="math notranslate nohighlight">\(_2\)</span>O 吸收特征的变化。这些波长显示出一些与时间相关的噪声 (<span class="math notranslate nohighlight">\(\sigma_r\)</span>) 增加，这里已进行了测量，图中的误差也显示了包含该误差的过境深度。</p>
<p>来自地面测试的精度非常令人鼓舞，最佳测量的 bin（发生在光谱中计数率高且干净的部分）在仅 2 小时的数据中达到了近光子极限的过境深度，测量精度约为 30 ppm，并且时间相关噪声 (<span class="math notranslate nohighlight">\(\sigma_r\)</span>) 最小。</p>
<p>为了获得更稳健的误差估计，实际上这里执行的最小二乘法将被 MCMC 例程替代。此外，使用实际的过境数据，过境拟合参数（例如 <span class="math notranslate nohighlight">\(i\)</span>、<span class="math notranslate nohighlight">\(a/R_{star}\)</span>、T<span class="math notranslate nohighlight">\(_0\)</span>）也必须首先进行拟合，因为它们可能会与文献中高精度过境光曲线的估计值有所不同，而 JWST 将提供这些数据。</p>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRSpec/transit_spectroscopy_notebook"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../mos_spectroscopy_advanced/MOSspec_advanced_cn.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">星系外场的MOS光谱</p>
      </div>
    </a>
    <a class="right-next"
       href="../galaxy_redshift/redshift_fitting_cn.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">红移和模板拟合</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">BOTS 时间序列观测</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">引言</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">加载包</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">设置参数</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#nirspec">下载和加载NIRSpec数据</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">可视化二维光谱数据</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#d1d">从2D图像数组中提取1D光谱</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">可视化一维光谱数据</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">计算轨道相位及用于绘图目的的单独细网模型</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">处理探测器上的系统漂移</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">创建用于去趋势的向量数组。</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">过境和边缘暗化模型函数</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">现在定义过境模型函数</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">现在定义生成过境光曲线的函数并将其与数据进行比较</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#fit">FIT过渡光曲线</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">设置待拟合的波长</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">循环遍历波长区间，拟合每个光曲线</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">注意：此步骤需要相当长的时间来完成（约20分钟，每个波长区间几分钟）</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">绘制测量的系外行星传输光谱与注入光谱对比</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>