
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>IFU Cube Fitting &#8212; STScI JDAT Notebooks 中文版</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css?v=b44a18d9" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks 中文版 - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks 中文版 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">主页</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install_cn.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow_cn.html">笔记本开发工作流程</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">开发</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks_cn.html">提交笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements_cn.html">需求文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks_cn.html">Jupyter 笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files_cn.html">数据文件</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub 指南</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup_cn.html">GitHub 设置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow_cn.html">GitHub 工作流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr_cn.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">跨仪器通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example_cn.html">ASDF 示例</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation_cn.html">复杂的二维背景</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3_cn.html">复合模型光谱拟合</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query_cn.html">MAST 查询</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina_cn.html">Imviz RGB图像</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift_cn.html">Specviz 简单示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS_cn.html">提高纯平行数据集的WCS精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/stpsf_examples/stpsf_examples_cn.html">STPSF 示例</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis_cn.html">MRS Mstar - 数据分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc_cn.html">LMC中的IFU YSOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1_cn.html">LRS 光谱提取</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example_cn.html">点源光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry_cn.html">扩展孔径光度测量</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry_cn.html">交叉滤光片 PSF 匹配</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example_cn.html">PSF 光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction_cn.html">NIRCam 光晕去除</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction_cn.html">WFSS 光谱 - 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra_cn.html">WFSS 光谱 - 合并和归一化 1D 光谱</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template_cn.html">WFSS 光谱 - 相关性模版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map_cn.html">WFSS 光谱 - 发射线图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup_cn.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3_cn.html">运行图像处理管道并创建源目录</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2_cn.html">运行 spec2 管道</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="NGC4151_FeII_ContinuumFit_cn.html">IFU立方体拟合</a></li>




<li class="toctree-l1"><a class="reference internal" href="../cube_fitting/cube_fitting_cn.html">IFU Cube 建模</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ifu_optimal/ifu_optimal_cn.html">IFU 光谱提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static_cn.html">MOS 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mos_spectroscopy_advanced/MOSspec_advanced_cn.html">星系外场的MOS光谱</a></li>

<li class="toctree-l1"><a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST_cn.html">BOTS 时间序列观测</a></li>








<li class="toctree-l1"><a class="reference internal" href="../galaxy_redshift/redshift_fitting_cn.html">红移和模板拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/FS_NSClean_example_cn.html">FS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/IFU_NSClean_example_cn.html">IFU 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/MOS_NSClean_example_cn.html">MOS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_NSClean/BOTS_NSClean_example_cn.html">BOTS 数据生成 （NSClean）</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>IFU Cube Fitting</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">IFU Cube Fitting</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cubeviz-visualization">Cubeviz Visualization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#video">Video:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-your-spectral-regions">Defining your Spectral Regions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-notes">Some Notes:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-subset-spectrum-in-cubeviz-spectrum-viewer">Extract Subset Spectrum in Cubeviz Spectrum Viewer</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-the-continuum-at-the-spectral-region-location">Fit the Continuum at the Spectral Region Location</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-api-instead">Use the API instead</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pulling-other-data">Pulling other data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#alternative-way-to-do-continuum-subtraction-using-numpy">Alternative way to do continuum subtraction using numpy</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-your-multiple-component-gaussian-model">Fitting your multiple component Gaussian Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">Exercise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-what-we-need-from-cubeviz">Extract what we need from Cubeviz</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="ifu-cube-fitting">
<h1>IFU Cube Fitting<a class="headerlink" href="#ifu-cube-fitting" title="Link to this heading">#</a></h1>
<p>使用场景</p>
<p>应用方向：AGN（活动星系核）的连续谱和发射线建模；波长范围 1.47-1.87 微米。
数据：NIFS （双子座望远镜上的近红外积分场光谱仪）；观测目标：NGC 4151。
工具：specutils、jdaviz/cubeviz、astropy、matplotlib、bottleneck。
跨仪器兼容性：NIRSpec；潜在适用于 MIRI。
文档：本笔记本是 STScI JWST 后管道数据分析工具生态系统的一部分，可直接从 JDAT Notebook Github 目录 下载。</p>
<p>⸻</p>
<p>简介</p>
<p>本笔记本使用 NGC 4151 活动星系核 的 3D IFU 数据立方示例（Storchi-Bergmann et al. 2009, MNRAS, V 394, pp. 1148-1166）。该数据集是在 双子座天文台（Gemini） 采用 近红外积分场光谱仪（NIFS） 观测的 自适应光学（AO）H 波段（1.47-1.87 µm） 数据集。NIFS 是一种与 JWST NIRSpec 结构相似的 图像切片式 IFU 仪器。</p>
<p>本笔记本执行了一些基础的光谱分析任务：
•	使用 jdaviz/cubeviz 检查数据集并提取 1D 光谱。
•	在靠近 1.644 µm 的 [Fe II] 发射线 附近进行 连续谱拟合 并将其扣除。
•	由于 H I Brackett 12 原子氢发射线（紧邻 [Fe II] 发射线）会对 [Fe II] 流出物产生污染，因此对其进行 拟合并去除。
•	生成的数据子立方包括：
•	连续谱模型
•	扣除连续谱后的 [Fe II] 纯发射线
•	这些处理后的数据集将作为 后续笔记本分析的起点。</p>
<p>注意：本笔记本的默认分析目标是 1.6440 µm 的 [Fe II] 发射线，但可以调整波长范围，以适用于任何感兴趣的发射线的连续谱拟合与扣除。</p>
<p>⸻</p>
<p>导入相关工具包
•	time —— 计算代码运行时间
•	numpy —— 数组处理和数学计算
•	matplotlib.pyplot —— 绘制图像和光谱
•	astropy.io —— 读取和写入 FITS 立方数据与图像
•	astropy.modeling —— 光谱曲线建模
•	astropy.utils.data —— 访问数据文件
•	specutils.fitting —— 光谱数据拟合
•	specutils Spectrum1D —— 用于建模发射线
•	jdaviz —— 在笔记本中使用 cubeviz 进行 IFU 数据分析</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load important packages</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.functional_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gaussian1D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">download_file</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">specutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Spectrum1D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jdaviz</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cubeviz</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">specutils.manipulation</span><span class="w"> </span><span class="kn">import</span> <span class="n">extract_region</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">specutils.spectra</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpectralRegion</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">regions</span><span class="w"> </span><span class="kn">import</span> <span class="n">PixCoord</span><span class="p">,</span> <span class="n">CirclePixelRegion</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">glue.core.roi</span><span class="w"> </span><span class="kn">import</span> <span class="n">XRangeROI</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">jdaviz</span>
<span class="nb">print</span><span class="p">(</span><span class="n">jdaviz</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.1.1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load and configure matplotlib</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;figure.max_open_warning&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save and Load Objects Using Pickle (needed to get the parameter file at the end)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>


<span class="k">def</span><span class="w"> </span><span class="nf">save_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_obj</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crval3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14766.4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 该代码单元用于访问 IFU（Integral Field Unit）数据立方（datacube）文件，</span>
<span class="c1"># 从 FITS 文件头信息中定义波长网格，并绘制简单的 1 维光谱（即对 IFU 数据进行光谱求和）。</span>

<span class="c1"># 导入必要的库</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">download_file</span>

<span class="c1"># 读取一个感兴趣的 3D IFU 数据立方文件以及其 FITS 头信息。</span>
<span class="c1"># 这里的数据文件是 JWST 观测的 NGC 4151 星系的 H 波段 IFU 立方数据。</span>
<span class="n">cube_file</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/IFU_cube_continuum_fit/NGC4151_Hband.fits&#39;</span>

<span class="c1"># 下载数据文件，并启用缓存以避免重复下载</span>
<span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">cube_file</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 使用 astropy.io.fits 读取 FITS 数据立方体</span>
<span class="n">cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>  <span class="c1"># 获取数据立方体（3D 数据）</span>
<span class="n">header_cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>  <span class="c1"># 获取 FITS 头信息</span>

<span class="c1"># 获取数据立方体的维度信息</span>
<span class="n">nz</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># nz 代表波长维度的切片数，ny 和 nx 代表空间维度（图像的高度和宽度）</span>

<span class="c1"># 从 FITS 头信息中提取波长轴的关键字：</span>
<span class="c1"># CDELT3: 每个通道的波长间隔（单位为 Ångström）</span>
<span class="c1"># CRVAL3: 波长轴的零点（起始波长，单位为 Ångström）</span>
<span class="n">crdelt3</span> <span class="o">=</span> <span class="n">header_cube</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>  <span class="c1"># 读取波长步长（通道间隔）</span>
<span class="n">crval3</span> <span class="o">=</span> <span class="n">header_cube</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>  <span class="c1"># 读取波长起始值</span>

<span class="c1"># 根据 FITS 头信息定义波长网格：</span>
<span class="c1"># 使用 numpy.arange 生成从 0 到 nz-1 的整数索引，并计算每个波长通道的实际波长。</span>
<span class="c1"># 最后将波长单位从 Ångström 转换为微米（um）。</span>
<span class="n">wave</span> <span class="o">=</span> <span class="p">((</span><span class="n">crdelt3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nz</span><span class="p">))</span> <span class="o">+</span> <span class="n">crval3</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10000.0</span>  <span class="c1"># 转换单位 Ångström → 微米（1 Å = 0.0001 µm）</span>

<span class="c1"># 定义活动星系核（AGN）的红移值</span>
<span class="n">redshift</span> <span class="o">=</span> <span class="mf">0.00332</span>  <span class="c1"># NGC 4151 的已知红移</span>

<span class="c1"># 选定感兴趣的发射线：</span>
<span class="c1"># 这里选择 [Fe II] 1.644 μm（即 1.64400 微米）发射线，</span>
<span class="c1"># 并考虑红移效应，即计算观测到的波长</span>
<span class="n">emission_line</span> <span class="o">=</span> <span class="mf">1.64400</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">redshift</span><span class="p">)</span>  <span class="c1"># 计算红移后波长（单位：微米）</span>

<span class="c1"># 找到最接近该发射线的波长索引：</span>
<span class="c1"># np.abs(wave - emission_line) 计算波长数组中所有元素与发射线波长的差值，</span>
<span class="c1"># np.argmin() 找到该差值最小的索引，即最接近该发射线的位置。</span>
<span class="n">emission_line_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wave</span> <span class="o">-</span> <span class="n">emission_line</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

<span class="c1"># 计算整个 IFU 数据立方的总光谱：</span>
<span class="c1"># 对数据立方体在空间维度（y 和 x）上进行求和，得到 1 维光谱。</span>
<span class="n">flux1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># 对每个波长通道的所有像素求和，得到总光谱</span>

<span class="c1"># 绘制 1 维光谱</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Summed 1D Spectrum&#39;</span><span class="p">)</span>  <span class="c1"># 绘制波长 vs. 总光谱</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">emission_line</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Emission Line (</span><span class="si">{</span><span class="n">emission_line</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> um)&#39;</span><span class="p">)</span>  <span class="c1"># 标出发射线位置</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (µm)&#39;</span><span class="p">)</span>  <span class="c1"># x 轴标签：波长（微米）</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux&#39;</span><span class="p">)</span>  <span class="c1"># y 轴标签：光通量</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  <span class="c1"># 显示图例</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图像</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../../_images/50bed13a2435ea20865980f479c726b5477a4ee8721f9ce7aaa93f46f70f9569.png"><img alt="../../../_images/50bed13a2435ea20865980f479c726b5477a4ee8721f9ce7aaa93f46f70f9569.png" src="../../../_images/50bed13a2435ea20865980f479c726b5477a4ee8721f9ce7aaa93f46f70f9569.png" style="width: 598px; height: 432px;" />
</a>
</div>
</div>
<p>我们观察到，累加后的 1D 光谱在光谱两端表现出明显的噪声波动（“ratty”）。这一 1D 光谱数据数组超出了仪器的标称可用数据范围。因此，我们将忽略这些质量较差的光谱区域，并专注于活动星系核（AGN）的光通量分析。</p>
<p>我们感兴趣的 [Fe II] 发射特征是一个位于 1.65 微米短波端 的明亮而强烈的发射线。需要注意的是，H I Brackett 12 发射线位于 [Fe II] 线的蓝侧，对其造成一定的污染。</p>
<p>我们可以利用光谱图窗口来读取感兴趣的波长值，以便定义分析所需的光谱范围（可参考光谱图右下角的波长/光通量网格数据）。</p>
<p>特别说明：在此数据集中，[Fe II] 发射线 红侧（长波方向） 的一部分光谱区域提供了一个较为干净的连续谱测量。然而，在 [Fe II] 和 H I Brackett 12 发射线的蓝侧（短波方向），存在其他的发射和吸收特征，使得明确识别连续谱变得非常困难。因此，相比于采用包含整个发射线的更大波长范围，在红侧区域进行简单的线性拟合 会更加准确。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This cell defines the wavelength regions of interest: around the emission line, and the location</span>
<span class="c1"># where you want to fit and remove the continuum very accurately.  Make a plot that shows the regions.</span>

<span class="c1"># Here we select a region that includes the emission line</span>
<span class="c1"># wavelength plus a small range of continuum around it.  </span>
<span class="c1"># Determine these limits by investigating the flux in the above plot.  Read</span>
<span class="c1"># the wavelength values off of the plot information at the lower right.</span>

<span class="n">wave_emission_limit1</span> <span class="o">=</span> <span class="mf">1.630</span>
<span class="n">wave_emission_limit2</span> <span class="o">=</span> <span class="mf">1.665</span>

<span class="c1"># Here we define a spectral range where we will use the</span>
<span class="c1"># flux to generate a continuum model.  The flux shape in this</span>
<span class="c1"># AGN is quite linear around the redward emission, so we will use only a </span>
<span class="c1"># short segment of the spectrum on the red side of the emission </span>
<span class="c1"># feature.</span>
<span class="c1"># We again determine these values by investigating the wavelengths in the</span>
<span class="c1"># above plot window.</span>

<span class="n">continuum_limit1</span> <span class="o">=</span> <span class="mf">1.656</span>
<span class="n">continuum_limit2</span> <span class="o">=</span> <span class="mf">1.673</span>
  
<span class="c1"># Define the wavelength region around the emission - indices</span>
<span class="n">wavemin</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wave</span><span class="o">-</span><span class="n">wave_emission_limit1</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
<span class="n">wavemax</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wave</span><span class="o">-</span><span class="n">wave_emission_limit2</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

<span class="c1"># Define the wavelength region used to fit the continuum flux level  - indices.</span>
<span class="n">continuummin</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wave</span><span class="o">-</span><span class="n">continuum_limit1</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
<span class="n">continuummax</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wave</span><span class="o">-</span><span class="n">continuum_limit2</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

<span class="c1"># Show the region used for the emission line and continuum fit.  Alter the wavelengths </span>
<span class="c1"># above if this doesn&#39;t look good.  </span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">flux1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="p">[</span><span class="n">wavemin</span><span class="p">:</span><span class="n">wavemax</span><span class="p">],</span> <span class="n">flux1</span><span class="p">[</span><span class="n">wavemin</span><span class="p">:</span><span class="n">wavemax</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wave</span><span class="p">[</span><span class="n">continuummin</span><span class="p">:</span><span class="n">continuummax</span><span class="p">],</span> <span class="n">flux1</span><span class="p">[</span><span class="n">continuummin</span><span class="p">:</span><span class="n">continuummax</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;wavelength (um)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../../_images/4bbf22ef9f3352acb038e0613a43f4675620843c580f3fdf169e248b8e2a71f2.png"><img alt="../../../_images/4bbf22ef9f3352acb038e0613a43f4675620843c580f3fdf169e248b8e2a71f2.png" src="../../../_images/4bbf22ef9f3352acb038e0613a43f4675620843c580f3fdf169e248b8e2a71f2.png" style="width: 598px; height: 432px;" />
</a>
</div>
</div>
<section id="cubeviz-visualization">
<h2>Cubeviz Visualization<a class="headerlink" href="#cubeviz-visualization" title="Link to this heading">#</a></h2>
<p>You can also visualize images inside a Jupyter notebook using <a class="reference external" href="https://jdaviz.readthedocs.io/en/latest/cubeviz/index.html">Cubeviz</a></p>
</section>
<section id="video">
<h2>Video:<a class="headerlink" href="#video" title="Link to this heading">#</a></h2>
<p>This Cubeviz Demo is from the official JWST Observer YouTube channel. It shows an example of how to use Cubeviz for a specific science case (not this notebook’s science case).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vid</span> <span class="o">=</span> <span class="n">YouTubeVideo</span><span class="p">(</span><span class="s2">&quot;ayb6OkmZUwU&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">vid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cubeviz</span> <span class="o">=</span> <span class="n">Cubeviz</span><span class="p">()</span>
<span class="n">cubeviz</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here, we load the data into the Cubeviz app.</span>
<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">cubeviz</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>A video is shown below illustrating the procedure.  The following steps are applied:</p>
<p>When you load your cube, you will see a collapsed spectrum of all the spaxels in the spectral viewer at the bottom.</p>
<p>If you draw a region (circle or square) in the flux viewer, you will see a collapsed spectrum of that particular region in the spectral viewer, too. For this example, we want to first define a circular region at the central position of the bright AGN flux, which is at approximately the cube center position.<br>
<a class="reference internal" href="../../../_images/cubeviz_select_subset.png"><img alt="Select a circular subset on the AGN in the center of the image." src="../../../_images/cubeviz_select_subset.png" style="width: 500px;" /></a></p>
<p>Now, use the flux viewer and again use the ‘define circular region of interest’ icon to make spectra at two positions associated with the outflow emission in [Fe II].  The redshifted outflow is at approximate x position = 12, y position = 36.  This will be ‘Subset 2’ and will show up in green in the display. The blueshifted outflow is at approximately x position = 48, y position = 24 in pixel index units.  This will be ‘Subset 3’ and will show up in blue in the display. <em>Hint: the coordinates of the cursor are reported at the top of the tool</em><br>
<a class="reference internal" href="../../../_images/cubeviz_select_subset_outflow.png"><img alt="Select a circular subset on each side of the AGN to look at the outflow." src="../../../_images/cubeviz_select_subset_outflow.png" style="width: 500px;" /></a></p>
</section>
<section id="defining-your-spectral-regions">
<h2>Defining your Spectral Regions<a class="headerlink" href="#defining-your-spectral-regions" title="Link to this heading">#</a></h2>
<p>Next, you will want to define the wavelengths of interest in your spectral viewer for both your line and continuum analysis.  To do this, you will similarly click the ‘define region of interest’ icon in your spectral viewer and drag a box over the wavelengths you desire. The line emission (‘Subset 4’ ) should span approximately 1.630 - 1.665 um, and the continuum emission (‘Subset 5’) should span approximately 1.656 - 1.673 um.<br>
<a class="reference internal" href="../../../_images/cubeviz_select_spectral_subset.png"><img alt="Select a spectral subset on the emission feature and one on the continuum." src="../../../_images/cubeviz_select_spectral_subset.png" style="width: 500px;" /></a><br>
<em>Hint: subsets can be modified in the Subset Tools plugin</em></p>
<section id="some-notes">
<h3>Some Notes:<a class="headerlink" href="#some-notes" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>If your cell window requires you to scroll to see the different displays in cubeviz, you can toggle the scroll window in the main menu of the notebook: Cell -&gt; Current Outputs -&gt; Toggle Scrolling</p></li>
<li><p>To better visualize the cube, you can change the display options in the Plot Option plugin.</p></li>
</ul>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="extract-subset-spectrum-in-cubeviz-spectrum-viewer">
<h1>Extract Subset Spectrum in Cubeviz Spectrum Viewer<a class="headerlink" href="#extract-subset-spectrum-in-cubeviz-spectrum-viewer" title="Link to this heading">#</a></h1>
<p>Retrieve the spectra of the user-defined regions from the Spectrum Viewer as a Spectrum1D object. First, we create the regions from the API in case the notebook is not run interactively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create spatial regions</span>
<span class="n">spatial_regions</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">get_interactive_regions</span><span class="p">()</span>

<span class="k">if</span> <span class="s1">&#39;Subset 1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spatial_regions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">agn_region</span> <span class="o">=</span> <span class="n">CirclePixelRegion</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">PixCoord</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">29</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">29</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">cubeviz</span><span class="o">.</span><span class="n">load_regions</span><span class="p">(</span><span class="n">agn_region</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;Subset 2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spatial_regions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">redshifted_outflow</span> <span class="o">=</span> <span class="n">CirclePixelRegion</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">PixCoord</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">36</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">cubeviz</span><span class="o">.</span><span class="n">load_regions</span><span class="p">(</span><span class="n">redshifted_outflow</span><span class="p">)</span>
<span class="k">if</span> <span class="s1">&#39;Subset 3&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spatial_regions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">blueshifted_outflow</span> <span class="o">=</span> <span class="n">CirclePixelRegion</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">PixCoord</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">24</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">cubeviz</span><span class="o">.</span><span class="n">load_regions</span><span class="p">(</span><span class="n">blueshifted_outflow</span><span class="p">)</span>

<span class="n">spatial_regions</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">get_interactive_regions</span><span class="p">()</span>
<span class="n">spatial_regions</span>
</pre></div>
</div>
</div>
</div>
<p>By default, the spectra have been extracted with the <code class="docutils literal notranslate"><span class="pre">sum</span></code> function and default options in the spectral extraction plugin. For the purpose of this notebook, we would like to have spectra extracted with the <code class="docutils literal notranslate"><span class="pre">mean</span></code> function instead. We can do that from the interface like in the screenshot here below or running the following cells. <br>
<a class="reference internal" href="notebooks/NIRSpec/IFU_cube_continuum_fit/cubeviz_spectral_extraction_plugin.png"><img alt="Open the spectral extraction plugin, select a spatial subset, and the extraction function mean." src="notebooks/NIRSpec/IFU_cube_continuum_fit/cubeviz_spectral_extraction_plugin.png" style="width: 500px;" /></a><br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spec_ext</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;Spectral Extraction&#39;</span><span class="p">]</span>
<span class="n">spec_ext</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="s1">&#39;Mean&#39;</span>

<span class="n">spec_ext</span><span class="o">.</span><span class="n">aperture</span> <span class="o">=</span> <span class="s1">&#39;Subset 1&#39;</span>
<span class="n">spec_ext</span><span class="o">.</span><span class="n">add_results</span> <span class="o">=</span> <span class="s1">&#39;Spectrum (Subset 1, mean)&#39;</span>
<span class="n">spec_ext</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>

<span class="n">spec_ext</span><span class="o">.</span><span class="n">aperture</span> <span class="o">=</span> <span class="s1">&#39;Subset 2&#39;</span>
<span class="n">spec_ext</span><span class="o">.</span><span class="n">add_results</span> <span class="o">=</span> <span class="s1">&#39;Spectrum (Subset 2, mean)&#39;</span>
<span class="n">spec_ext</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>

<span class="n">spec_ext</span><span class="o">.</span><span class="n">aperture</span> <span class="o">=</span> <span class="s1">&#39;Subset 3&#39;</span>
<span class="n">spec_ext</span><span class="o">.</span><span class="n">add_results</span> <span class="o">=</span> <span class="s1">&#39;Spectrum (Subset 3, mean)&#39;</span>
<span class="n">spec_ext</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract spectra corresponding to the colored regions in cubeviz</span>
<span class="n">spectrum1</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;Spectrum (Subset 1, mean)&quot;</span><span class="p">)</span> <span class="c1"># AGN Center</span>
<span class="n">spectrum2</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;Spectrum (Subset 2, mean)&quot;</span><span class="p">)</span> <span class="c1"># Red shifted component</span>
<span class="n">spectrum3</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;Spectrum (Subset 3, mean)&quot;</span><span class="p">)</span> <span class="c1"># Blue shifted component</span>
<span class="n">spectrum1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract the line region defined in the spectral viewer</span>
<span class="n">regions</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">specviz</span><span class="o">.</span><span class="n">get_spectral_regions</span><span class="p">()</span>
        
<span class="k">if</span> <span class="s2">&quot;Subset 4&quot;</span> <span class="ow">in</span> <span class="n">regions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">line_region</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="s2">&quot;Subset 4&quot;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">line_region</span> <span class="o">=</span> <span class="n">SpectralRegion</span><span class="p">(</span><span class="mf">1.630</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="mf">1.665</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">)</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get_viewer</span><span class="p">(</span><span class="s1">&#39;spectrum-viewer&#39;</span><span class="p">)</span>
    <span class="n">sv</span><span class="o">.</span><span class="n">toolbar_active_subset</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sv</span><span class="o">.</span><span class="n">apply_roi</span><span class="p">(</span><span class="n">XRangeROI</span><span class="p">(</span><span class="mi">16300</span><span class="p">,</span> <span class="mi">16650</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract the continuum region defined in the spectral viewer</span>
<span class="k">if</span> <span class="s2">&quot;Subset 5&quot;</span> <span class="ow">in</span> <span class="n">regions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">continuum_region</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="s2">&quot;Subset 5&quot;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">continuum_region</span> <span class="o">=</span> <span class="n">SpectralRegion</span><span class="p">(</span><span class="mf">1.656</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="mf">1.673</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">)</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get_viewer</span><span class="p">(</span><span class="s1">&#39;spectrum-viewer&#39;</span><span class="p">)</span>
    <span class="n">sv</span><span class="o">.</span><span class="n">toolbar_active_subset</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sv</span><span class="o">.</span><span class="n">apply_roi</span><span class="p">(</span><span class="n">XRangeROI</span><span class="p">(</span><span class="mi">16560</span><span class="p">,</span> <span class="mi">16730</span><span class="p">))</span>

<span class="n">regions</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">specviz</span><span class="o">.</span><span class="n">get_spectral_regions</span><span class="p">()</span>
<span class="n">regions</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply the spectral region</span>
<span class="c1"># (creates new collapsed spectra if user did not in jdaviz)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">spectrum1</span><span class="p">:</span>
    <span class="n">flux_agn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,</span> <span class="p">(</span><span class="n">ny</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">:(</span><span class="n">ny</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">:(</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">tmpspec</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">flux</span><span class="o">=</span><span class="n">flux_agn</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">),</span> <span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">)</span> 
    <span class="n">spec_agn</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">tmpspec</span><span class="p">,</span> <span class="n">line_region</span><span class="p">)</span>
    <span class="n">spec_agn_continuum</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">tmpspec</span><span class="p">,</span> <span class="n">continuum_region</span><span class="p">)</span>    
<span class="k">else</span><span class="p">:</span> 
    <span class="n">spec_agn</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spectrum1</span><span class="p">,</span> <span class="n">line_region</span><span class="p">)</span>
    <span class="n">spec_agn_continuum</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spectrum1</span><span class="p">,</span> <span class="n">continuum_region</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">spectrum2</span><span class="p">:</span>
    <span class="n">flux_feii_red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,</span> <span class="p">(</span><span class="mi">36</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">:(</span><span class="mi">36</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">:(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">tmpspec</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">flux</span><span class="o">=</span><span class="n">flux_feii_red</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">),</span> <span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">)</span> 
    <span class="n">spec_feii_red</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">tmpspec</span><span class="p">,</span> <span class="n">line_region</span><span class="p">)</span>
    <span class="n">spec_feii_red_continuum</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">tmpspec</span><span class="p">,</span> <span class="n">continuum_region</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>    
    <span class="n">spec_feii_red</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spectrum2</span><span class="p">,</span> <span class="n">line_region</span><span class="p">)</span>
    <span class="n">spec_feii_red_continuum</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spectrum2</span><span class="p">,</span> <span class="n">continuum_region</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">spectrum3</span><span class="p">:</span>
    <span class="n">flux_feii_blue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cube</span><span class="p">[:,</span> <span class="p">(</span><span class="mi">28</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">:(</span><span class="mi">28</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">:(</span><span class="mi">50</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">tmpspec</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">flux</span><span class="o">=</span><span class="n">flux_feii_blue</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">),</span> <span class="n">spectral_axis</span><span class="o">=</span><span class="n">wave</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">)</span> 
    <span class="n">spec_feii_blue</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">tmpspec</span><span class="p">,</span> <span class="n">line_region</span><span class="p">)</span>
    <span class="n">spec_feii_blue_continuum</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">tmpspec</span><span class="p">,</span> <span class="n">continuum_region</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>     
    <span class="n">spec_feii_blue</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spectrum3</span><span class="p">,</span> <span class="n">line_region</span><span class="p">)</span>
    <span class="n">spec_feii_blue_continuum</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spectrum3</span><span class="p">,</span> <span class="n">continuum_region</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize new subsets</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec_agn</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec_agn</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Spectrum subset 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize new subsets</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec_feii_blue</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec_feii_blue</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec_feii_red</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec_feii_red</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Spectra subset 2 and 3&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="fit-the-continuum-at-the-spectral-region-location">
<h2>Fit the Continuum at the Spectral Region Location<a class="headerlink" href="#fit-the-continuum-at-the-spectral-region-location" title="Link to this heading">#</a></h2>
<p>Open up Model Fitting Plugin. There are a number of fields to fill in and drop down menus to select from.  It is important to keep in mind that the Data menu will provide only spectra to model, while the Spectral Region menu will provide only spectral region subsets to choose.  In other words, you can fit the spectra in specific spectral regions.  If no spectral region is selected, the entire wavelength array will be fit by the mode. <br /></p>
<p>We will first fit an individual spectrum to test if our fitting parameters are good, then we will switch to fitting the full cube. </br>
<strong>Single spectrum</strong>
Select Data: Spectrum Subset 1 (mean) <br>
Select Spectral Region: Subset 5<br>
Model: Linear1D<br>
ModelID: L<br>
Click “Add component”<br>
Model Parameters: Leave Default<br>
Model Equation Editor: L<br>
Model Label: LinFitCont<br>
Click “Fit model”, which fits the collapsed spectrum.<br>
View the fit in the spectral viewer and confirm you are happy with it. <br></p>
<p><strong>Full cube</strong>
Toggle “Cube fit” at the top.</br></p>
<p>Change the name to LinFitCont_cube and click again “Fit model”.<br></p>
<a class="reference internal image-reference" href="../../../_images/cubeviz_model_fitting.png"><img alt="Model fitting can be set up in the plugin." src="../../../_images/cubeviz_model_fitting.png" style="width: 700px;" />
</a>
<p>The fitted cube can be accessed in the data dropdown of the 2D viewers.</p>
<section id="use-the-api-instead">
<h3>Use the API instead<a class="headerlink" href="#use-the-api-instead" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">get_models</span><span class="p">()</span>

<span class="k">if</span> <span class="s1">&#39;LinFitCont&#39;</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">singlemodel</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;LinFitCont&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Open model fitting plugin</span>
    <span class="n">plugin_mf</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;Model Fitting&#39;</span><span class="p">]</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">open_in_tray</span><span class="p">()</span>
    <span class="c1"># Input the appropriate datasets</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;Spectrum (sum)&#39;</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">spectral_subset</span> <span class="o">=</span> <span class="s1">&#39;Subset 5&#39;</span>
    <span class="c1"># Input model component</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">create_model_component</span><span class="p">(</span><span class="n">model_component</span><span class="o">=</span><span class="s1">&#39;Linear1D&#39;</span><span class="p">,</span>
                                     <span class="n">model_component_label</span><span class="o">=</span><span class="s1">&#39;L1&#39;</span><span class="p">)</span>
    <span class="c1"># Model equation gets populated automatically</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">equation</span> <span class="o">=</span> <span class="s1">&#39;L1&#39;</span>    
    <span class="c1"># After we run this, we go to the GUI and check that the fit makes sense</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">add_results</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;LinFitCont&#39;</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">cube_fit</span> <span class="o">=</span> <span class="kc">False</span>    
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">calculate_fit</span><span class="p">()</span>

<span class="k">if</span> <span class="s1">&#39;LinFitCont_cube (30, 30)&#39;</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">cubemodel</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;LinFitCont_cube&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Open model fitting plugin</span>
    <span class="n">plugin_mf</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;Model Fitting&#39;</span><span class="p">]</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">open_in_tray</span><span class="p">()</span>
    <span class="c1"># Set the fitting to cube</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">cube_fit</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Input the appropriate datasets</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;contents[SCI]&#39;</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">spectral_subset</span> <span class="o">=</span> <span class="s1">&#39;Subset 5&#39;</span>
    <span class="c1"># Input model component</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">create_model_component</span><span class="p">(</span><span class="n">model_component</span><span class="o">=</span><span class="s1">&#39;Linear1D&#39;</span><span class="p">,</span>
                                     <span class="n">model_component_label</span><span class="o">=</span><span class="s1">&#39;L2&#39;</span><span class="p">)</span>
    <span class="c1"># Model equation gets populated automatically</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">equation</span> <span class="o">=</span> <span class="s1">&#39;L2&#39;</span>    
    <span class="c1"># After we run this, we go to the GUI and check that the fit makes sense</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">add_results</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;LinFitCont_cube&#39;</span>
    <span class="n">plugin_mf</span><span class="o">.</span><span class="n">calculate_fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">get_models</span><span class="p">()</span>
<span class="c1">#models</span>
<span class="n">models</span><span class="p">[</span><span class="s1">&#39;LinFitCont_cube (30, 30)&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="pulling-other-data">
<h2>Pulling other data<a class="headerlink" href="#pulling-other-data" title="Link to this heading">#</a></h2>
<p>Note, in cubeviz, you can either return the collapsed spectra as we did above by using the <code class="docutils literal notranslate"><span class="pre">function</span></code>
keyword argument along with (optionally) a <code class="docutils literal notranslate"><span class="pre">spatial_subset</span></code>, or return the entire data cube by omitting
these keywords as below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># List available data</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cubeviz</span><span class="o">.</span><span class="n">data_labels</span><span class="p">)</span>

<span class="c1"># Get full original cube out</span>
<span class="n">scidata</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;contents[SCI]&quot;</span><span class="p">)</span>
<span class="n">scidata</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract SCI cube and continuum model from Cubeviz above and make a continuum subtracted cube</span>
<span class="k">if</span> <span class="s1">&#39;LinFitCont_cube&#39;</span> <span class="ow">in</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">data_collection</span><span class="p">:</span>
    <span class="n">cont_psf_cube</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;LinFitCont_cube&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Check shape of the objects&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">scidata</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cont_psf_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># Obtain continuum subtracted cube</span>
    <span class="n">sci_contsub</span> <span class="o">=</span> <span class="n">scidata</span><span class="o">-</span><span class="n">cont_psf_cube</span>
    <span class="c1"># Save to file</span>
    <span class="c1"># sci_contsub.write(&#39;NGC4151_Hband_ContinuumSubtract.fits&#39;, format=&#39;wcs1d-fits&#39;, overwrite=True)</span>
    <span class="c1"># cont_psf_cube.write(&#39;NGC4151_Hband_ContinuumPSF.fits&#39;, format=&#39;wcs1d-fits&#39;, overwrite=True)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Developer Note</strong>:<br></p>
<ul class="simple">
<li><p>I hit a traceback if I try to save the cubes to file, because they do not have a proper header</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Look at the continuum subtracted cube in Cubeviz</span>
<span class="k">if</span> <span class="n">sci_contsub</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">cubeviz2</span> <span class="o">=</span> <span class="n">Cubeviz</span><span class="p">()</span>
        <span class="n">cubeviz2</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">sci_contsub</span><span class="p">,</span> <span class="n">data_label</span><span class="o">=</span><span class="s1">&#39;Continuum Subtracted&#39;</span><span class="p">)</span>
        <span class="n">cubeviz2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="alternative-way-to-do-continuum-subtraction-using-numpy">
<h3>Alternative way to do continuum subtraction using numpy<a class="headerlink" href="#alternative-way-to-do-continuum-subtraction-using-numpy" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-read in original IFU cube for manipulation</span>
<span class="n">cube_file</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/IFU_cube_continuum_fit/NGC4151_Hband.fits&#39;</span>
<span class="n">newfn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">cube_file</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">newheader_cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">cube_file</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">sci_contsub_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">])</span>
<span class="n">cont_psf_cube_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">flux1</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>      
        <span class="n">cont_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">wave</span><span class="p">[</span><span class="n">continuummin</span><span class="p">:</span><span class="n">continuummax</span><span class="p">],</span> <span class="n">flux1</span><span class="p">[</span><span class="n">continuummin</span><span class="p">:</span><span class="n">continuummax</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fitval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">cont_fit</span><span class="p">)</span>
        <span class="n">continuum</span> <span class="o">=</span> <span class="n">fitval</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>        
        <span class="n">sci_contsub_np</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">flux1</span> <span class="o">-</span> <span class="n">continuum</span>
        <span class="n">cont_psf_cube_np</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">continuum</span> 

<span class="nb">print</span><span class="p">(</span><span class="n">sci_contsub_np</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="k">del</span> <span class="n">newheader_cube</span><span class="p">[</span><span class="s1">&#39;MODE&#39;</span><span class="p">]</span>
<span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;NGC4151_Hband_ContinuumSubtract_numpy.fits&#39;</span><span class="p">,</span> <span class="n">sci_contsub_np</span><span class="p">,</span> <span class="n">newheader_cube</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;NGC4151_Hband_ContinuumPSF_numpy.fits&#39;</span><span class="p">,</span> <span class="n">cont_psf_cube_np</span><span class="p">,</span> <span class="n">newheader_cube</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Continuum subtracted cube saved. PSF continuum cube saved.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Developer Note</strong>:</p>
<ul class="simple">
<li><p>the new created file cannot be open in Cubeviz</p></li>
</ul>
</section>
</section>
<section id="fitting-your-multiple-component-gaussian-model">
<h2>Fitting your multiple component Gaussian Model<a class="headerlink" href="#fitting-your-multiple-component-gaussian-model" title="Link to this heading">#</a></h2>
<p>Now we want to investigate an initial fit to the Br 12 emission feature, which is a pesky contaminant nearby in wavelength to our target [Fe II] emission.  The Br 12 is centrally compact and arises only from the nucleus of the AGN, not from the outflow.  Make a plot of the fit results.<br /></p>
<p>First, select the wavelength region of interest following a similar procedure as performed at the top.  There is no option to set the spectral regions to a user input, so we recommend zooming in and drawing by eye.  The line emission (‘Subset 1’ ) should again span approximately 1.630 - 1.665 um.<br>
<a class="reference internal" href="../../../_images/cubeviz2_subset.png"><img alt="Select a spectral subset on the 3-line emission feature around 1.54 microns." src="../../../_images/cubeviz2_subset.png" style="width: 500px;" /></a><br></p>
<p>For this example, we recommend setting up a 3 component gaussian model with the following inputs<br />
Open up Model Fitting Plugin. There are a number of fields to fill in and drop down menus to select from.  It is important to keep in mind that the Data menu will provide only spectra to model, while the Spectral Region menu will provide only spectral region subsets to choose.  In other words, you can fit the spectra in specific spectral regions.  If no spectral region is selected, the entire wavelength array will be fit by the mode. <br /></p>
<p>Data: Spectrum (sum)<br />
Spectral region: Subset 1<br />
Model: Three different Gaussians with ModelID’s set to G1, G2, and G3<br />
Model Parameters: <br />
G1: stdev=8, mean=16410<br />
G2: stdev=7, mean=16480<br />
G3: stdev=50, mean=16460<br />
You can turn on the ‘Fixed’ option if you need to, but these numbers should provide a good starting guess for the fit.<br />
Model Equation Editor: G1+G2+g3<br />
Model Label: GaussAll<br />
<br />
Hit Fit, which fits the collapsed spectrum.<br />
<a class="reference internal" href="../../../_images/cubeviz2_modelfit1.png"><img alt="Prepare the fit parameters with 3 Gaussian curves and fit the collapsed spectrum." src="../../../_images/cubeviz2_modelfit1.png" style="width: 500px;" /></a><br>
View the fit in the spectral viewer and confirm you are happy with it.  Modify if necessary. <br />
Then remove the ‘Fixed’ options, toggle Cube Fit, change the name to GaussAll_cube, and run again.<br />
<a class="reference internal" href="../../../_images/cubeviz2_modelfit2.png"><img alt="Prepare the fit parameters with 3 Gaussian curves and fit the collapsed spectrum." src="../../../_images/cubeviz2_modelfit2.png" style="width: 500px;" /></a><br></p>
<p>This will again create two models that can now be accessed within the Data Dropdown menus:<br />
A 1D linear fit of the lines in the collapsed cube.<br />
A 3D linear fit of the lines for each spaxel in the cube.<br /></p>
<p>Wow, that multi-component fit looks great.  Good deal.</p>
<p>Now we’re going to use the continuum psf cube from a prior cell  with the Brackett model created in the above cell to create a full 3-D model of the central emission that isn’t caused by the outflow [Fe II].</p>
<p><strong>Developer Note</strong>:<br></p>
<ul class="simple">
<li><p>the fit to the full cube gets stuck and never ends</p></li>
</ul>
<section id="exercise">
<h3>Exercise<a class="headerlink" href="#exercise" title="Link to this heading">#</a></h3>
<p>Now you can try to adapt the code shown above to run the model fitting from the API!</p>
<p><em>Hint:</em><br>
<code class="docutils literal notranslate"><span class="pre">plugin_mf.create_model_component(model_component='Gaussian1D',</span> <span class="pre">model_component_label='G1')</span></code><br>
<code class="docutils literal notranslate"><span class="pre">plugin_mf.set_model_component('G1',</span> <span class="pre">'mean',</span> <span class="pre">value=16410)</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Your code</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="extract-what-we-need-from-cubeviz">
<h3>Extract what we need from Cubeviz<a class="headerlink" href="#extract-what-we-need-from-cubeviz" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract the spectral regions defined in the spectral viewer</span>
<span class="n">regions</span> <span class="o">=</span> <span class="n">cubeviz2</span><span class="o">.</span><span class="n">specviz</span><span class="o">.</span><span class="n">get_spectral_regions</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>

<span class="k">if</span> <span class="s2">&quot;Subset 1&quot;</span> <span class="ow">in</span> <span class="n">regions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">line_region</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="s2">&quot;Subset 1&quot;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">line_region</span> <span class="o">=</span> <span class="n">SpectralRegion</span><span class="p">(</span><span class="mf">1.630</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="mf">1.665</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># List available data</span>
<span class="n">alldata</span> <span class="o">=</span> <span class="n">cubeviz2</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">data_collection</span>
<span class="nb">print</span><span class="p">(</span><span class="n">alldata</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="c1"># List spectra available in spectrum-viewer</span>
<span class="n">spec</span> <span class="o">=</span> <span class="n">cubeviz2</span><span class="o">.</span><span class="n">specviz</span><span class="o">.</span><span class="n">get_spectra</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Developer note</strong>: currently there is no way to use the spectral extraction plugin on a created model cube. The 1D model should be calculated on the ‘mean’ extracted spectrum if the ‘mean’ model is desired.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get gauss model spectrum and model cube</span>
<span class="n">spec_ext2</span> <span class="o">=</span> <span class="n">cubeviz2</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">&#39;Spectral Extraction&#39;</span><span class="p">]</span>
<span class="n">spec_ext2</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="s1">&#39;Mean&#39;</span>
<span class="n">spec_ext2</span><span class="o">.</span><span class="n">aperture</span> <span class="o">=</span> <span class="s1">&#39;Entire Cube&#39;</span>
<span class="n">spec_ext2</span><span class="o">.</span><span class="n">add_results</span> <span class="o">=</span> <span class="s1">&#39;Spectrum entire (mean)&#39;</span>
<span class="n">spec_ext2</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>

<span class="c1"># This is used only as spectral axis for the models afterwards</span>
<span class="n">all_spec</span> <span class="o">=</span> <span class="n">cubeviz2</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Spectrum entire (mean)&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="s1">&#39;GaussAll&#39;</span> <span class="ow">in</span> <span class="n">alldata</span><span class="p">:</span>
    <span class="n">gauss_spec</span> <span class="o">=</span> <span class="n">cubeviz2</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;GaussAll&#39;</span><span class="p">)</span> <span class="c1"># AGN Center Model Spec. This is &#39;sum&#39;, not &#39;mean&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model spectrum 1D available&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gauss_spec</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">gauss_spec</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No GaussAll model created&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>

<span class="k">if</span> <span class="s1">&#39;GaussAll_cube&#39;</span> <span class="ow">in</span> <span class="n">alldata</span><span class="p">:</span>
    <span class="n">gauss_cube</span> <span class="o">=</span> <span class="n">cubeviz2</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;GaussAll_cube&#39;</span><span class="p">)</span> <span class="c1"># AGN Center Model Cube</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">cubeviz2</span><span class="o">.</span><span class="n">get_model_parameters</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model spectrum 3D available&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">gauss_cube</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">params</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No GaussAll_cube model created&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Check to see if user used Cubeviz (above), and, if not, read in premade data</span>
<span class="k">if</span> <span class="n">gauss_cube</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
    <span class="c1"># Get both the model cube and the continuum cube not created with Cubeviz</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/IFU_cube_continuum_fit/gauss_model_cube.fits&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">tgauss_cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">gauss_cube</span> <span class="o">=</span> <span class="n">tgauss_cube</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape of downloaded model cube: &#39;</span><span class="p">,</span> <span class="n">gauss_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">fn_continuum</span> <span class="o">=</span> <span class="s1">&#39;NGC4151_Hband_ContinuumPSF_numpy.fits&#39;</span>
    <span class="n">continuum_cube</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn_continuum</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">newfull_header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fn_continuum</span><span class="p">)</span>
    <span class="n">continuum_data</span> <span class="o">=</span> <span class="n">continuum_cube</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape of downloaded continuum cube: &#39;</span><span class="p">,</span> <span class="n">continuum_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape of created model cube: &#39;</span><span class="p">,</span> <span class="n">gauss_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">continuum_data</span> <span class="o">=</span> <span class="n">sci</span> <span class="c1"># Created in Cubeviz1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape of created continuum cube: &#39;</span><span class="p">,</span> <span class="n">continuum_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
<span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/IFU_cube_continuum_fit/gauss_params.pkl&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">load_obj</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Keys of downloaded model parameters: &#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Keys of created model parameters: &#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="nb">print</span><span class="p">()</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">all_spec</span><span class="p">:</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/IFU_cube_continuum_fit/all_spec.fits&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">all_spec</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape of downloaded continuum subtracted spectrum: &#39;</span><span class="p">,</span> <span class="n">all_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape of created continuum subtracted spectrum: &#39;</span><span class="p">,</span> <span class="n">all_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>

<span class="k">if</span> <span class="n">gauss_spec</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/IFU_cube_continuum_fit/gauss_spec.fits&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">gauss_spec</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape of downloaded model spectrum: &#39;</span><span class="p">,</span> <span class="n">gauss_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape of created model spectrum: &#39;</span><span class="p">,</span> <span class="n">gauss_spec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Overwrite gauss model with only 2 of the components of interest</span>
<span class="k">if</span> <span class="s1">&#39;GaussAll_cube&#39;</span> <span class="ow">in</span> <span class="n">alldata</span><span class="p">:</span>
    <span class="n">gauss_cube_2component</span> <span class="o">=</span> <span class="n">gauss_cube</span><span class="o">.</span><span class="n">flux</span> <span class="o">*</span> <span class="mf">0.</span>
    <span class="n">model_label</span> <span class="o">=</span> <span class="s2">&quot;GaussAll_cube&quot;</span>
    <span class="n">specunit</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">ampunit</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">gauss_cube_2component</span> <span class="o">=</span> <span class="n">gauss_cube</span> <span class="o">*</span> <span class="mf">0.</span>
    <span class="n">model_label</span> <span class="o">=</span> <span class="s2">&quot;GaussAll_3d&quot;</span>
    <span class="n">specunit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Angstrom</span>
    <span class="n">ampunit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">gauss_cube_2component</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="n">gauss_cube_2component</span><span class="o">.</span><span class="n">shape</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">amp1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">model_label</span><span class="p">][</span><span class="s1">&#39;amplitude_0&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">amp2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">model_label</span><span class="p">][</span><span class="s1">&#39;amplitude_2&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">model_label</span><span class="p">][</span><span class="s1">&#39;mean_0&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mf">1E10</span> <span class="c1"># Original model was in meters</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">model_label</span><span class="p">][</span><span class="s1">&#39;mean_2&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mf">1E10</span>
        <span class="n">stdev1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">model_label</span><span class="p">][</span><span class="s1">&#39;stddev_0&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mf">1E10</span>
        <span class="n">stdev2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">model_label</span><span class="p">][</span><span class="s1">&#39;stddev_2&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mf">1E10</span>
        <span class="n">g1</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">amp1</span><span class="o">*</span><span class="n">ampunit</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">specunit</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="n">stdev1</span><span class="o">*</span><span class="n">specunit</span><span class="p">)</span>
        <span class="n">g2</span> <span class="o">=</span> <span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">amp2</span><span class="o">*</span><span class="n">ampunit</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">m2</span><span class="o">*</span><span class="n">specunit</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="n">stdev2</span><span class="o">*</span><span class="n">specunit</span><span class="p">)</span>
        <span class="n">gauss_cube_2component</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">g1</span><span class="p">(</span><span class="n">all_spec</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span><span class="o">+</span><span class="n">g2</span><span class="p">(</span><span class="n">all_spec</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span>

<span class="n">gauss_cube_2component_spec</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">all_spec</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span>
                                        <span class="n">flux</span><span class="o">=</span><span class="n">gauss_cube_2component</span><span class="o">*</span><span class="n">ampunit</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Note:</strong> Why is the fit not done with all components at once instead of adding the continuum component here?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add the continuum cube to the new model cube</span>
<span class="n">full_model</span> <span class="o">=</span> <span class="n">gauss_cube_2component_spec</span> <span class="o">+</span> <span class="n">continuum_data</span>
<span class="nb">print</span><span class="p">(</span><span class="n">full_model</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Subtract the model to create the final cube where the [Fe II] emission is isolated.</span>
<span class="c1"># Re-read in original IFU cube for manipulation</span>
<span class="n">cube_file</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/IFU_cube_continuum_fit/NGC4151_Hband.fits&#39;</span>
<span class="n">newfinalsub_header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">cube_file</span><span class="p">)</span>

<span class="c1"># Cube from cubeviz is scidata</span>
<span class="n">final_sub_cube</span> <span class="o">=</span> <span class="n">scidata</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">full_model</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span>

<span class="n">final_sub_cube_units</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">scidata</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span>
                                  <span class="n">flux</span><span class="o">=</span><span class="n">final_sub_cube</span><span class="o">*</span><span class="n">ampunit</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">final_sub_cube_units</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scidata</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Delete any existing output in current directory</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;NGC4151_Hband_FinalSubtract.fits&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;NGC4151_Hband_FinalSubtract.fits&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The file does not exist&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;NGC4151_Hband_ContinuumandBrackettModel.fits&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;NGC4151_Hband_ContinuumandBrackettModel.fits&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The file does not exist&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Developer note:</strong> Fits writeto gives an error. Making cell raw for now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make the final plots to illustrate the original spectrum, model fits, and final continuum+gassian subtracted cube</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">16200</span><span class="p">,</span> <span class="mi">16650</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">600</span><span class="p">,</span> <span class="mi">900</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_spec</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">continuum_data</span><span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Continuum&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_spec</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">scidata</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original Data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_spec</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">full_model</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;2 Component Model&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_spec</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">final_sub_cube_units</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="p">:]</span><span class="o">+</span><span class="mi">700</span><span class="o">*</span><span class="n">ampunit</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model Subtraction+Offset&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;wavelength&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;flux&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRSpec/IFU_cube_continuum_fit"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">IFU Cube Fitting</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cubeviz-visualization">Cubeviz Visualization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#video">Video:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-your-spectral-regions">Defining your Spectral Regions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#some-notes">Some Notes:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-subset-spectrum-in-cubeviz-spectrum-viewer">Extract Subset Spectrum in Cubeviz Spectrum Viewer</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-the-continuum-at-the-spectral-region-location">Fit the Continuum at the Spectral Region Location</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-api-instead">Use the API instead</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pulling-other-data">Pulling other data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#alternative-way-to-do-continuum-subtraction-using-numpy">Alternative way to do continuum subtraction using numpy</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-your-multiple-component-gaussian-model">Fitting your multiple component Gaussian Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">Exercise</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-what-we-need-from-cubeviz">Extract what we need from Cubeviz</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>