
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MIRI PSF 光度测量与 Space_Phot &#8212; STScI JDAT Notebooks 中文版</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css?v=b44a18d9" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/MIRI/psf_photometry/miri_spacephot_cn';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks 中文版 - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks 中文版 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">介绍</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">主页</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install_cn.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow_cn.html">笔记本开发工作流程</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">开发</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks_cn.html">提交笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements_cn.html">需求文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks_cn.html">Jupyter 笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files_cn.html">数据文件</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub 指南</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup_cn.html">GitHub 设置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow_cn.html">GitHub 工作流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr_cn.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">跨仪器通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example_cn.html">ASDF 示例</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation_cn.html">复杂的二维背景</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3_cn.html">复合模型光谱拟合</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query_cn.html">MAST 查询</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina_cn.html">Imviz RGB图像</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift_cn.html">Specviz 简单示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS_cn.html">提高纯平行数据集的WCS精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/stpsf_examples/stpsf_examples_cn.html">STPSF 示例</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis_cn.html">MRS Mstar - 数据分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc_cn.html">LMC中的IFU YSOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1_cn.html">LRS 光谱提取</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example_cn.html">点源光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_photometry/NIRCam_multiband_photometry_cn.html">扩展孔径光度测量</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry_cn.html">交叉滤光片 PSF 匹配</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example_cn.html">PSF 光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRCam/NIRCam_wisp_subtraction/nircam_wisp_subtraction_cn.html">NIRCam 光晕去除</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction_cn.html">WFSS 光谱 - 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra_cn.html">WFSS 光谱 - 合并和归一化 1D 光谱</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template_cn.html">WFSS 光谱 - 相关性模版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map_cn.html">WFSS 光谱 - 发射线图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup_cn.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3_cn.html">运行图像处理管道并创建源目录</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2_cn.html">运行 spec2 管道</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit_cn.html">IFU立方体拟合</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/cube_fitting/cube_fitting_cn.html">IFU Cube 建模</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/ifu_optimal/ifu_optimal_cn.html">IFU 光谱提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/optimal_extraction/Spectral_Extraction-static_cn.html">MOS 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/mos_spectroscopy_advanced/MOSspec_advanced_cn.html">星系外场的MOS光谱</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST_cn.html">BOTS 时间序列观测</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/galaxy_redshift/redshift_fitting_cn.html">红移和模板拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/FS_NSClean_example_cn.html">FS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/IFU_NSClean_example_cn.html">IFU 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/MOS_NSClean_example_cn.html">MOS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example_cn.html">BOTS 数据生成 （NSClean）</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/MIRI/psf_photometry/miri_spacephot_cn.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>MIRI PSF 光度测量与 Space_Phot</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">目录</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#webbpsfsynphot">1.1<font color="white">-</font>设置WebbPSF和Synphot目录<a class="anchor" id="webbpsf"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python">1.2<font color="white">-</font>Python 导入<a class="anchor" id="py_imports"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#level2">3.1<font color="white">-</font>多个 Level2 文件<a class="anchor" id="bso2"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#space-phot-psf">关于 Space_Phot 中 PSF 拟合的说明：<br/></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#level3">3.2<font color="white">-</font>单个 Level3 马赛克文件<a class="anchor" id="bso3"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">关于 Space_Phot 中 PSF 拟合的说明：<br/></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level2level3">Level2和Level3结果之间的良好一致性！</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">4.1<font color="white">-</font>多个 Level2 文件<a class="anchor" id="fso2"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">4.2<font color="white">-</font>单个，Level3 马赛克文件<a class="anchor" id="fso3"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">注意：您可以使用Level3合并数据产品进行更深入的分析</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#space-phot-space-phot-dolphotphotutils-space-phot">在这种情况下，我们将执行与第3节相同的步骤，但针对多个恒星。目的是展示在大量恒星上使用space_phot的工作流程和运行时间。我们建议，对于大量明亮恒星，space_phot可能不是最优选择。其他程序，如DOLPHOT或Photutils，可能更适合这种用例。space_phot的主要优势在于处理微弱的单一源。但如果需要，它也可以扩展到处理更多的恒星。</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">5.1<font color="white">-</font>多个 Level2 文件<a class="anchor" id="lmc2"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">现在对一组更大的恒星进行相同的操作并测试速度</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">5.2<font color="white">-</font>单个 Level3 拼接文件<a class="anchor" id="lmc3"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-snr">读者应参考上述讨论的所有诊断信息。一般来说，这个循环展示了在没有视觉检查的情况下，对各种星体（亮度、在探测器上的分布等）进行点扩散函数（PSF）光度测量的困难，尤其是在处理低信噪比（SNR）源时。这对于所有光度测量软件包都是适用的。用户应检查相关指标，并考虑为特定感兴趣的星体优化参数。尽管如此，拟合的成功总是可以通过相关的误差条来量化。</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="miri-psf-space-phot">
<h1>MIRI PSF 光度测量与 Space_Phot<a class="headerlink" href="#miri-psf-space-phot" title="Link to this heading">#</a></h1>
<p><strong>作者</strong>: Ori Fox<br></p>
<p><strong>提交时间</strong>: 2023年8月<br></p>
<p><strong>更新时间</strong>: 2023年11月<br></p>
<p><strong>使用案例</strong>: 使用专用包 Space_Phot (https://github.com/jpierel14/space_phot) 对 Level3 数据进行 PSF 光度测量。Space_phot 基于 Astropy 的 Photutils 包构建。与 photutils 不同，space_phot 可以用于 Level3 数据。这是因为它内置了生成给定探测器位置的重采样 Level3 PSF 的功能。这种用例对于微弱的点源目标或深限度观测特别有用，观察者需要利用合成图像堆栈。对于大量明亮源，用户可能会发现 space_phot 速度较慢，应考虑其他包，如 DOLPHOT 和/或 Photutils。<strong>注意</strong>: 存在一个配套的笔记本，说明如何使用 Photutils 处理相同的 Level2 数据集。<br></p>
<p><strong>重要提示</strong>: 何时不使用。由于 space_phot 参数的敏感性，此工具不适合用于大样本的恒星（即下面的第5节）。如果用户希望在多个源上使用 space_phot，他们应仔细构建一个参数表，为每个源进行精细调整。</p>
<p><strong>数据</strong>: MIRI 数据 PID 1028（校准程序；单星访问 006 A5V 矮星 2MASSJ17430448+6655015）和 MIRI 数据 PID 1171（大麦哲伦云；多星）。<br></p>
<p><strong>工具</strong>: photutils, space_phot drizzlepac, jupyter <br></p>
<p><strong>跨仪器</strong>: NIRCam, MIRI.<br></p>
<p><strong>文档</strong>: 此笔记本是 STScI 更大后处理数据分析工具生态系统的一部分，可以直接从 JDAT Notebook Github 目录下载。<br></p>
<p><strong>管道版本</strong>: JWST 管道<br></p>
<section id="id1">
<h2>目录<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<ol class="arabic">
<li><p><a class="reference internal" href="#intro"><span class="xref myst">介绍</span></a><br></p>
<p>1.1 <a class="reference internal" href="#webbpsf"><span class="xref myst">设置</span></a><br></p>
<p>1.2 <a class="reference internal" href="#py_imports"><span class="xref myst">Python 导入</span></a><br></p>
</li>
<li><p><a class="reference internal" href="#data"><span class="xref myst">下载数据</span></a><br></p></li>
<li><p><a class="reference internal" href="#bso"><span class="xref myst">明亮的单个天体</span></a><br></p>
<p>3.1 <a class="reference internal" href="#bso2"><span class="xref myst">多个 Level2 文件</span></a><br></p>
<p>3.2 <a class="reference internal" href="#bso3"><span class="xref myst">单个 Level3 马赛克文件</span></a><br></p>
</li>
<li><p><a class="reference internal" href="#fso"><span class="xref myst">微弱/上限，单个天体</span></a><br></p>
<p>4.1 <a class="reference internal" href="#fso2"><span class="xref myst">多个 Level2 文件</span></a><br></p>
<p>4.2 <a class="reference internal" href="#fso3"><span class="xref myst">单个 Level3 马赛克文件</span></a><br></p>
</li>
<li><p><a class="reference internal" href="#lmv"><span class="xref myst">恒星场 (大麦哲伦星云)</span></a><br></p>
<p>5.1 <a class="reference internal" href="#lmc2"><span class="xref myst">多个 Level2 文件</span></a><br></p>
<p>5.2 <a class="reference internal" href="#lmc3"><span class="xref myst">单个 Level3 马赛克文件</span></a><br></p>
</li>
</ol>
<p>1.<font color='white'>-</font>引言 <a class="anchor" id="intro"></a></p>
<hr class="docutils" />
<p>目标：<br></p>
<p>PSF（点扩散函数）光度测量可以通过以下方式获得：<br></p>
<ul class="simple">
<li><p>来自WebbPSF的PSF模型网格<br></p></li>
<li><p>单一有效PSF（ePSF）尚不可用<br></p></li>
<li><p>有效PSF网格尚不可用<br></p></li>
</ul>
<p>该笔记本展示了：<br></p>
<ul class="simple">
<li><p>如何从WebbPSF获取PSF模型（或构建ePSF）<br></p></li>
<li><p>如何在图像上执行PSF光度测量<br></p></li>
</ul>
<p><strong>数据</strong>：<br></p>
<p>MIRI数据 PID 1028（校准程序），F770W <br></p>
<p>MIRI数据 PID 1171（LMC），F560W/F770W</p>
<section id="webbpsfsynphot">
<h3>1.1<font color='white'>-</font>设置WebbPSF和Synphot目录<a class="anchor" id="webbpsf"></a><a class="headerlink" href="#webbpsfsynphot" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">space_phot</span>  <span class="c1"># 导入空间摄影模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">importlib.metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span>  <span class="c1"># 从importlib.metadata导入version函数</span>

<span class="n">version</span><span class="p">(</span><span class="s1">&#39;space_phot&#39;</span><span class="p">)</span>  <span class="c1"># 获取并返回&#39;space_phot&#39;模块的版本信息</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  <span class="c1"># 导入操作系统模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>  <span class="c1"># 导入用于文件路径操作的模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>  <span class="c1"># 导入用于文件和目录操作的模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>  <span class="c1"># 导入用于处理tar文件的模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>  <span class="c1"># 导入用于发送HTTP请求的模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>  <span class="c1"># 导入用于解析URL的模块</span>

<span class="c1"># 设置环境变量</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WEBBPSF_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;./webbpsf-data/webbpsf-data&quot;</span>  <span class="c1"># 设置WEBBPSF数据路径</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYSYN_CDBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;./grp/redcat/trds/&quot;</span>  <span class="c1"># 设置PYSYN数据路径</span>

<span class="c1"># WEBBPSF 数据链接和文件路径</span>

<span class="n">boxlink</span> <span class="o">=</span> <span class="s1">&#39;https://stsci.box.com/shared/static/qxpiaxsjwo15ml6m4pkhtk36c9jgj70k.gz&#39;</span>  <span class="c1"># WEBBPSF数据的下载链接</span>

<span class="n">boxfile</span> <span class="o">=</span> <span class="s1">&#39;./webbpsf-data/webbpsf-data-1.0.0.tar.gz&#39;</span>  <span class="c1"># 下载后的文件保存路径</span>

<span class="n">synphot_url</span> <span class="o">=</span> <span class="s1">&#39;http://ssb.stsci.edu/trds/tarfiles/synphot5.tar.gz&#39;</span>  <span class="c1"># Synphot数据的下载链接</span>

<span class="n">synphot_file</span> <span class="o">=</span> <span class="s1">&#39;./synphot5.tar.gz&#39;</span>  <span class="c1"># 下载后的Synphot文件保存路径</span>

<span class="n">webbpsf_folder</span> <span class="o">=</span> <span class="s1">&#39;./webbpsf-data&#39;</span>  <span class="c1"># WEBBPSF数据文件夹路径</span>

<span class="n">synphot_folder</span> <span class="o">=</span> <span class="s1">&#39;./grp&#39;</span>  <span class="c1"># Synphot数据文件夹路径</span>

<span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>  <span class="c1"># 定义下载文件的函数</span>

    <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  <span class="c1"># 解析URL</span>

    <span class="k">if</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">]:</span>  <span class="c1"># 检查URL协议是否为http或https</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported URL scheme: </span><span class="si">{</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 抛出不支持的协议错误</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>  <span class="c1"># 发送GET请求下载文件</span>

    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  <span class="c1"># 检查请求是否成功</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># 以二进制写入模式打开目标文件</span>

        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>  <span class="c1"># 分块读取响应内容</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>  <span class="c1"># 将读取的内容写入文件</span>

<span class="c1"># 收集webbpsf文件</span>

<span class="n">psfExist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">webbpsf_folder</span><span class="p">)</span>  <span class="c1"># 检查WEBBPSF文件夹是否存在</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">psfExist</span><span class="p">:</span>  <span class="c1"># 如果文件夹不存在</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">webbpsf_folder</span><span class="p">)</span>  <span class="c1"># 创建WEBBPSF文件夹</span>

    <span class="n">download_file</span><span class="p">(</span><span class="n">boxlink</span><span class="p">,</span> <span class="n">boxfile</span><span class="p">)</span>  <span class="c1"># 下载WEBBPSF数据文件</span>

    <span class="n">gzf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile</span><span class="p">)</span>  <span class="c1"># 打开下载的tar文件</span>

    <span class="n">gzf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">webbpsf_folder</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>  <span class="c1"># 解压文件到WEBBPSF文件夹</span>

<span class="c1"># 收集synphot文件</span>

<span class="n">synExist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">synphot_folder</span><span class="p">)</span>  <span class="c1"># 检查Synphot文件夹是否存在</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">synExist</span><span class="p">:</span>  <span class="c1"># 如果文件夹不存在</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">synphot_folder</span><span class="p">)</span>  <span class="c1"># 创建Synphot文件夹</span>

    <span class="n">download_file</span><span class="p">(</span><span class="n">synphot_url</span><span class="p">,</span> <span class="n">synphot_file</span><span class="p">)</span>  <span class="c1"># 下载Synphot数据文件</span>

    <span class="n">gzf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">synphot_file</span><span class="p">)</span>  <span class="c1"># 打开下载的tar文件</span>

    <span class="n">gzf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>  <span class="c1"># 解压文件到当前目录</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="python">
<h3>1.2<font color='white'>-</font>Python 导入<a class="anchor" id="py_imports"></a><a class="headerlink" href="#python" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>  <span class="c1"># 导入FITS文件处理模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTable</span>  <span class="c1"># 导入QTable模块，用于处理表格数据</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.nddata</span><span class="w"> </span><span class="kn">import</span> <span class="n">extract_array</span>  <span class="c1"># 导入数组提取功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>  <span class="c1"># 导入天球坐标处理模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">wcs</span>  <span class="c1"># 导入WCS（世界坐标系统）模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">skycoord_to_pixel</span>  <span class="c1"># 导入将天球坐标转换为像素坐标的工具</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>  <span class="c1"># 导入单位模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_norm</span>  <span class="c1"># 导入简单归一化功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astroquery.mast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Observations</span>  <span class="c1"># 导入用于查询MAST（微波天文数据中心）的模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">importlib.metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span>  <span class="c1"># 导入获取库版本信息的模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>  <span class="c1"># 导入时间模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>  <span class="c1"># 导入数学模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># 导入NumPy库，用于数值计算</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>  <span class="c1"># 导入Matplotlib库，用于绘图</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>  <span class="c1"># 导入Pandas库，用于数据处理</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>  <span class="c1"># 导入警告模块</span>

<span class="o">%</span><span class="k">matplotlib</span> inline  # 在Jupyter Notebook中内联显示Matplotlib图形

<span class="c1"># JWST模型</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.datamodels</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageModel</span>  <span class="c1"># 导入JWST图像模型</span>

<span class="c1"># 背景和PSF（点扩散函数）函数</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">MMMBackground</span><span class="p">,</span> <span class="n">MADStdBackgroundRMS</span><span class="p">,</span> <span class="n">LocalBackground</span>  <span class="c1"># 导入背景处理工具</span>

<span class="c1"># Photutils库和工具</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.aperture</span><span class="w"> </span><span class="kn">import</span> <span class="n">CircularAperture</span>  <span class="c1"># 导入圆形光圈工具</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAOStarFinder</span>  <span class="c1"># 导入DAO星点查找工具</span>

<span class="c1"># 如果需要，设置CRDS（天文数据系统）</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">crds</span><span class="w"> </span><span class="kn">import</span> <span class="n">client</span>  <span class="c1"># 导入CRDS客户端</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRDS_PATH&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># 检查CRDS路径环境变量是否存在</span>
    <span class="n">client</span><span class="o">.</span><span class="n">set_crds_server</span><span class="p">(</span><span class="s1">&#39;https://jwst-crds.stsci.edu&#39;</span><span class="p">)</span>  <span class="c1"># 设置CRDS服务器地址</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CRDS_SERVER_URL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;https://jwst-crds.stsci.edu&quot;</span>  <span class="c1"># 设置CRDS服务器URL环境变量</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CRDS_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># 设置CRDS路径环境变量为空</span>
</pre></div>
</div>
</div>
</div>
<p>2.<font color='white'>-</font>下载数据<a class="anchor" id="data"></a></p>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 查询MAST（Mikulski Archive for Space Telescopes）数据库中提案ID为1028且特定过滤器为&#39;F770W&#39;的观测数据</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">proposal_id</span><span class="o">=</span><span class="mi">1028</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;F770W&#39;</span><span class="p">])</span>

<span class="c1"># 获取与找到的观测相关的产品列表</span>
<span class="n">plist</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

<span class="c1"># 过滤产品列表，仅包含特定的产品子组：&#39;RATE&#39;，&#39;CAL&#39;，&#39;I2D&#39;和&#39;ASN&#39;</span>
<span class="n">fplist</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CAL&#39;</span><span class="p">,</span> <span class="s1">&#39;I2D&#39;</span><span class="p">,</span> <span class="s1">&#39;ASN&#39;</span><span class="p">])</span>

<span class="c1"># 从MAST数据库下载选定的产品（取消注释以下载）</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span><span class="n">fplist</span><span class="p">)</span>

<span class="c1"># 定义源目录和目标目录</span>
<span class="n">source_dir</span> <span class="o">=</span> <span class="s1">&#39;mastDownload/JWST/&#39;</span>  <span class="c1"># 源目录</span>
<span class="n">destination_dir</span> <span class="o">=</span> <span class="s1">&#39;mast/01028/&#39;</span>     <span class="c1"># 目标目录</span>

<span class="c1"># 如果目标目录不存在，则创建该目录</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">)</span>  <span class="c1"># 创建目标目录</span>

<span class="c1"># 使用glob查找所有匹配模式&#39;mastDownload/JWST/j*/jw01028*&#39;的文件</span>
<span class="n">files_to_copy</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="s1">&#39;j*/jw01028*&#39;</span><span class="p">))</span>

<span class="c1"># 将匹配的文件复制到目标目录</span>
<span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">files_to_copy</span><span class="p">:</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">destination_dir</span><span class="p">)</span>  <span class="c1"># 复制文件到目标目录</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 查询MAST（Mikulski Archive for Space Telescopes）数据库中的观测数据</span>
<span class="c1"># 使用提案ID 1171 和特定的滤光片 &#39;F560W&#39; 和 &#39;F770W&#39;</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">query_criteria</span><span class="p">(</span><span class="n">proposal_id</span><span class="o">=</span><span class="mi">1171</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;F560W&#39;</span><span class="p">,</span> <span class="s1">&#39;F770W&#39;</span><span class="p">])</span>

<span class="c1"># 获取与找到的观测相关的产品列表</span>
<span class="n">plist</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">get_product_list</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

<span class="c1"># 过滤产品列表，仅包含特定的产品子组：&#39;RATE&#39;, &#39;CAL&#39;, &#39;I2D&#39;, 和 &#39;ASN&#39;</span>
<span class="n">fplist</span> <span class="o">=</span> <span class="n">Observations</span><span class="o">.</span><span class="n">filter_products</span><span class="p">(</span><span class="n">plist</span><span class="p">,</span> <span class="n">productSubGroupDescription</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CAL&#39;</span><span class="p">,</span> <span class="s1">&#39;I2D&#39;</span><span class="p">,</span> <span class="s1">&#39;ASN&#39;</span><span class="p">])</span>

<span class="c1"># 从MAST数据库下载选定的产品（取消注释以下载）</span>
<span class="n">Observations</span><span class="o">.</span><span class="n">download_products</span><span class="p">(</span><span class="n">fplist</span><span class="p">)</span>

<span class="c1"># 定义源目录和目标目录</span>
<span class="n">source_dir</span> <span class="o">=</span> <span class="s1">&#39;mastDownload/JWST/&#39;</span>  <span class="c1"># 源目录</span>
<span class="n">destination_dir</span> <span class="o">=</span> <span class="s1">&#39;mast/01171/&#39;</span>     <span class="c1"># 目标目录</span>

<span class="c1"># 如果目标目录不存在，则创建该目录</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">)</span>  <span class="c1"># 创建目标目录</span>

<span class="c1"># 使用glob查找所有匹配模式 &#39;mastDownload/JWST/j*/jw01171*&#39; 的文件</span>
<span class="n">files_to_copy</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="s1">&#39;j*/jw01171*&#39;</span><span class="p">))</span>

<span class="c1"># 将匹配的文件复制到目标目录</span>
<span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">files_to_copy</span><span class="p">:</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">destination_dir</span><span class="p">)</span>  <span class="c1"># 复制文件到目标目录</span>
</pre></div>
</div>
</div>
</div>
<p>3.<font color='white'>-</font>明亮的单一天体<a class="anchor" id="bso"></a></p>
<hr class="docutils" />
<p>本节的目的是说明如何对单个明亮天体进行点扩散函数（PSF）光度测量。虽然在孤立情况下，光圈光度测量是可行的，但用户可能会发现，在拥挤的场域或复杂的背景中，PSF光度测量更为可取。</p>
</section>
<section id="level2">
<h3>3.1<font color='white'>-</font>多个 Level2 文件<a class="anchor" id="bso2"></a><a class="headerlink" href="#level2" title="Link to this heading">#</a></h3>
<p>一般来说，来自空间望远镜的数据的点扩散函数（PSF）光度测量在预拼接数据上进行最为准确。在哈勃太空望远镜（HST）的情况下，这对应于FLT文件而非DRZ文件。而在詹姆斯·韦伯太空望远镜（JWST）的情况下，这对应于Level 2文件而非Level 3文件。原因在于，拼接后的PSF会随着探测器上位置的变化而改变固有的PSF，因此没有足够的模型（理论或经验）可供使用。<br></p>
<p>在这个例子中，我们旨在同时在多个Level 2图像中拟合一个源。一个更基本的方法是单独拟合每个Level 2文件，然后将测得的通量平均在一起。然而，这种方法更容易纠正仅出现在一幅图像中的坏像素或宇宙射线，并通过减少每个源的自由参数数量来实现更准确的光度解决方案。<br></p>
<p>有用的参考文献：<br></p>
<p>HST关于PSF光度测量的文档: https://www.stsci.edu/hst/instrumentation/wfc3/data-analysis/psf<br></p>
<p>使用HSTPHOT进行WFPC2恒星光度测量: https://ui.adsabs.harvard.edu/abs/2000PASP..112.1383D/abstract<br></p>
<p>Space-Phot关于Level 2拟合的文档: https://space-phot.readthedocs.io/en/latest/examples/plot_a_psf.html#jwst-images<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义Level 3文件</span>
<span class="n">lvl3</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./mast/01028/jw01028-o006_t001_miri_f770w_i2d.fits&#39;</span><span class="p">]</span>  <span class="c1"># 指定Level 3文件的路径</span>

<span class="n">lvl3</span>  <span class="c1"># 输出Level 3文件列表</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 从ASN文件创建Level 2数据列表</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;./mast/01028/&quot;</span>  <span class="c1"># 定义文件路径前缀</span>

<span class="n">asn</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;jw01028-o006_*_image3_00004_asn.json&#39;</span><span class="p">)</span>  <span class="c1"># 获取ASN文件列表</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fi</span><span class="p">:</span>  <span class="c1"># 打开第一个ASN文件</span>

    <span class="n">lvl2</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化Level 2数据列表</span>

    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">fi</span><span class="p">:</span>  <span class="c1"># 遍历文件中的每一行</span>

        <span class="c1">#print(ln)  # 可选：打印当前行（调试用）</span>

        <span class="k">if</span> <span class="n">ln</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;                    &quot;expname&quot;:&#39;</span><span class="p">):</span>  <span class="c1"># 检查行是否以&quot;expname&quot;开头</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">ln</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>  <span class="c1"># 分割行，获取expname的内容</span>

            <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>  <span class="c1"># 进一步分割，提取文件名</span>

            <span class="n">lvl2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 将完整路径添加到Level 2数据列表中</span>

<span class="nb">print</span><span class="p">(</span><span class="n">lvl2</span><span class="p">)</span>  <span class="c1"># 打印Level 2数据列表</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 检查第一幅图像（在设置DQ标志之前）</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">lvl2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 从lvl2数据集中获取第一幅图像</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 打印图像数据</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 将图像数据转换为ImageModel对象</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 提取图像数据部分</span>

<span class="c1"># 该缩放应突出背景噪声，以便能够看到所有微弱源。</span>

<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 使用对数缩放规范化数据</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>  <span class="c1"># 创建一个20x12英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 显示图像数据，设置原点在下方，使用灰度色图</span>

<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>  <span class="c1"># 添加颜色条</span>

<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 设置颜色条标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 隐藏坐标轴刻度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为“像素”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为“像素”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 检查第一幅图像（在设置DQ标志之前）</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">lvl2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取第二级数据中的第一幅图像</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 打印图像文件名</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 打开FITS文件以读取数据</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 从FITS文件中提取科学数据</span>

<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 归一化数据以便于可视化</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 显示图像，设置原点在下方，使用灰度色图</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 隐藏坐标轴刻度和颜色</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图像</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将所有DQ标记的像素值更改为NANs</span>

<span class="c1"># JWST DQ标记定义的参考文献: https://jwst-pipeline.readthedocs.io/en/latest/jwst/references_general/references_general.html</span>

<span class="c1"># 在此情况下，我们选择所有DQ &gt; 10，但用户可以根据自己的需要选择相应的值。</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">lvl2</span><span class="p">:</span>  <span class="c1"># 遍历所有的lvl2文件</span>

    <span class="n">ref_fits</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>  <span class="c1"># 创建ImageModel对象以读取FITS文件</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取数据数组</span>

    <span class="n">dq</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">dq</span>  <span class="c1"># 获取DQ标记数组</span>

    <span class="n">data</span><span class="p">[</span><span class="n">dq</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># 将DQ标记大于等于10的像素值设置为NAN</span>

    <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>  <span class="c1"># 更新FITS对象中的数据</span>

    <span class="n">ref_fits</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>  <span class="c1"># 保存修改后的FITS文件</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将所有DQ标记的像素值更改为NAN</span>

<span class="c1"># JWST DQ标记定义的参考文档: https://jwst-pipeline.readthedocs.io/en/latest/jwst/references_general/references_general.html</span>

<span class="c1"># 在此情况下，我们选择所有DQ值大于10的像素，但用户可以根据需要选择自己的值。</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">lvl2</span><span class="p">:</span>  <span class="c1"># 遍历所有的文件</span>

    <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>  <span class="c1"># 以更新模式打开文件</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 读取科学数据</span>

    <span class="n">dq</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="s1">&#39;DQ&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 读取DQ数据</span>

    <span class="n">data</span><span class="p">[</span><span class="n">dq</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># 将DQ值大于等于10的像素设置为NAN</span>

    <span class="n">hdul</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>  <span class="c1"># 更新科学数据</span>

    <span class="n">hdul</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  <span class="c1"># 刷新文件以保存更改</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 检查第一幅图像（在设置DQ标志后）</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">lvl2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 从lvl2数据集中获取第一幅图像</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 打印图像数据</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 创建图像模型对象</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 提取图像数据</span>

<span class="c1"># 该缩放应突出背景噪声，以便能够看到所有微弱源。</span>

<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 使用对数缩放规范化数据</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>  <span class="c1"># 创建一个20x12英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 显示图像数据，使用灰度色图</span>

<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>  <span class="c1"># 添加颜色条</span>

<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 设置颜色条标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 隐藏坐标轴刻度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为“像素”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为“像素”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 放大以查看源。在这种情况下，我们的源来自MIRI程序ID #1028，这是一个校准程序。</span>

<span class="c1"># 我们使用访问006，目标是A5V矮星2MASSJ17430448+6655015</span>

<span class="c1"># 参考链接: http://simbad.cds.unistra.fr/simbad/sim-basic?Ident=2MASSJ17430448%2B6655015&amp;submit=SIMBAD+search</span>

<span class="n">source_location</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="s1">&#39;17:43:04.4879&#39;</span><span class="p">,</span> <span class="s1">&#39;+66:55:01.837&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>  <span class="c1"># 定义源的位置，使用天球坐标</span>

<span class="n">ref_wcs</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">get_fits_wcs</span><span class="p">()</span>  <span class="c1"># 获取参考图像的WCS（世界坐标系统）</span>

<span class="n">ref_y</span><span class="p">,</span> <span class="n">ref_x</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">source_location</span><span class="p">,</span> <span class="n">ref_wcs</span><span class="p">)</span>  <span class="c1"># 将天球坐标转换为像素坐标</span>

<span class="n">ref_cutout</span> <span class="o">=</span> <span class="n">extract_array</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span> <span class="p">(</span><span class="n">ref_x</span><span class="p">,</span> <span class="n">ref_y</span><span class="p">))</span>  <span class="c1"># 从参考数据中提取21x21的切片</span>

<span class="c1"># 该比例应突出背景噪声，以便能够看到所有微弱的源。</span>

<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">4.3</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># 使用对数伸缩标准化切片</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 显示切片图像，使用灰度色图</span>

<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>  <span class="c1"># 添加颜色条</span>

<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 设置颜色条标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PID1028,Obs006&#39;</span><span class="p">)</span>  <span class="c1"># 设置图像标题</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 隐藏坐标轴刻度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图像</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 检查第一幅图像（在设置DQ标志后）</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">lvl2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取第二级数据中的第一幅图像</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 打印图像文件名</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 打开FITS文件以读取数据</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 从FITS文件中提取科学数据</span>

<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 规范化数据以便于显示</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 显示图像，使用灰度色图</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 隐藏坐标轴刻度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图像</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 放大以查看源位置</span>

<span class="c1"># 定义源位置的天球坐标</span>
<span class="n">source_location</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="s1">&#39;17:43:04.4879&#39;</span><span class="p">,</span> <span class="s1">&#39;+66:55:01.837&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

<span class="c1"># 将天球坐标转换为像素坐标</span>
<span class="n">ref_y</span><span class="p">,</span> <span class="n">ref_x</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">source_location</span><span class="p">,</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">ref_fits</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ref_fits</span><span class="p">))</span>

<span class="c1"># 从参考数据中提取一个11x11的切片</span>
<span class="n">ref_cutout</span> <span class="o">=</span> <span class="n">extract_array</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="p">(</span><span class="n">ref_x</span><span class="p">,</span> <span class="n">ref_y</span><span class="p">))</span>

<span class="c1"># 对切片进行线性归一化处理</span>
<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 显示切片图像，设置原点在下方，使用灰度色图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># 设置图像标题</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PID1028,Obs006&#39;</span><span class="p">)</span>

<span class="c1"># 隐藏坐标轴的刻度和标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1"># 显示图像</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 从WebbPSF获取默认的点扩散函数（PSF）</span>

<span class="n">jwst_obs</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">observation2</span><span class="p">(</span><span class="n">lvl2</span><span class="p">)</span>  <span class="c1"># 使用lvl2数据创建JWST观测对象</span>

<span class="n">psfs</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">get_jwst_psf</span><span class="p">(</span><span class="n">jwst_obs</span><span class="p">,</span> <span class="n">source_location</span><span class="p">)</span>  <span class="c1"># 获取指定源位置的JWST PSF</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 该缩放应突出背景噪声，以便能够看到所有微弱源。</span>

<span class="c1"># 从psfs数据中提取41x41的切片，中心位置为(122, 122)</span>
<span class="n">ref_cutout</span> <span class="o">=</span> <span class="n">extract_array</span><span class="p">(</span><span class="n">psfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">41</span><span class="p">,</span> <span class="mi">41</span><span class="p">),</span> <span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="mi">122</span><span class="p">))</span>

<span class="c1"># 使用对数缩放进行归一化，最小值为0.0，最大值为0.2</span>
<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># 显示提取的切片图像，原点在下方，使用灰度色图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># 添加颜色条</span>
<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="c1"># 设置颜色条标签</span>
<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># 设置图表标题</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;WebbPSF Model&#39;</span><span class="p">)</span>

<span class="c1"># 设置x轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>

<span class="c1"># 设置y轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>

<span class="c1"># 隐藏坐标轴的刻度线</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1"># 显示图像</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="space-phot-psf">
<h4>关于 Space_Phot 中 PSF 拟合的说明：<br><a class="headerlink" href="#space-phot-psf" title="Link to this heading">#</a></h4>
<p>https://st-phot.readthedocs.io/en/latest/examples/plot_a_psf.html#jwst-images</p>
<p>如上所述，改进的文档将会推出。目前，这里有一些重要的注意事项。</p>
<p>所有拟合均使用 Astropy 的 Photutils 进行。与任何光度测量程序一样，打印的统计误差是成功的良好指示。</p>
<p>有不同的拟合技术，但当 fit_flux 参数设置为 ‘single’ 时，源在所有 Level2 图像中同时拟合。关于这一点，有一篇关于哈勃 PSF 拟合的论文对此进行了详细说明：https://iopscience.iop.org/article/10.1086/316630/pdf</p>
<p>因此，通量及其对应的误差考虑了单一的整体拟合。作为这一部分，拟合假设所有图像之间的零点是恒定的。虽然这并不完全正确，但通常在 1% 以内是成立的，对于我们的目的来说已经足够。用户也可以选择将 fit_flux 参数设置为 ‘multi’ 进行独立拟合，此时每幅图像都将被单独处理，因此最终的通量必须进行平均。</p>
<p>当你运行 space_phot 时，你会在单元格中看到一些额外的诊断信息。在顶部，打印的百分比值是残差中剩余通量的比例，可以视为模型和减法成功的良好指示。接下来是三列，分别显示每个 Level2 图像的原始数据、模型和残差。最后，还有角落图展示拟合的成功程度（更多文档和这些图的解释将会推出）。</p>
<p>在这种情况下，你会注意到残差中存在系统性趋势。PSF 在中心像素处被过度减去，而在边缘处则被减得不足。原因尚不清楚，可能是由于 PSF 模型不佳。用户应考虑生成更复杂的 PSF 模型，但这超出了本笔记本的范围。尽管如此，残差值相当不错，因此整体统计误差相对较小。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 使用space_phot进行PSF光度测量（拟合的详细信息在文档中）</span>

<span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_photometry</span><span class="p">(</span>

    <span class="n">psfs</span><span class="p">,</span>  <span class="c1"># 输入的点扩散函数（PSF）</span>

    <span class="n">source_location</span><span class="p">,</span>  <span class="c1"># 源的位置</span>

    <span class="n">bounds</span><span class="o">=</span><span class="p">{</span>  <span class="c1"># 设置参数的边界</span>

        <span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">],</span>  <span class="c1"># 流量的边界</span>

        <span class="s1">&#39;centroid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>  <span class="c1"># 重心的边界</span>

        <span class="s1">&#39;bkg&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>  <span class="c1"># 背景的边界</span>

    <span class="p">},</span>

    <span class="n">fit_width</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>  <span class="c1"># 拟合宽度</span>

    <span class="n">fit_centroid</span><span class="o">=</span><span class="s1">&#39;pixel&#39;</span><span class="p">,</span>  <span class="c1"># 拟合重心的单位为像素</span>

    <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 是否拟合背景</span>

    <span class="n">fit_flux</span><span class="o">=</span><span class="s1">&#39;single&#39;</span>  <span class="c1"># 拟合流量的方式为单一</span>

<span class="p">)</span>

<span class="c1"># 绘制PSF拟合结果</span>
<span class="n">jwst_obs</span><span class="o">.</span><span class="n">plot_psf_fit</span><span class="p">()</span>  
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示绘图</span>

<span class="c1"># 绘制PSF后验分布</span>
<span class="n">jwst_obs</span><span class="o">.</span><span class="n">plot_psf_posterior</span><span class="p">(</span><span class="n">minweight</span><span class="o">=</span><span class="mf">.0005</span><span class="p">)</span>  
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示绘图</span>

<span class="c1"># 打印光度测量结果的光校正表</span>
<span class="nb">print</span><span class="p">(</span><span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># jwst_obs.psf_result.phot_cal_table 是一个包含光度校正结果的表格</span>
<span class="c1"># 下面是对该表格的处理代码示例</span>

<span class="c1"># 导入必要的库</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># 导入NumPy库用于数值计算</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>  <span class="c1"># 导入Pandas库用于数据处理</span>

<span class="c1"># 假设我们有一个光度校正表格</span>
<span class="c1"># 创建一个示例数据框</span>
<span class="n">phot_cal_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;source_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>  <span class="c1"># 源ID</span>
    <span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">],</span>  <span class="c1"># 流量值</span>
    <span class="s1">&#39;flux_err&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">],</span>  <span class="c1"># 流量误差</span>
    <span class="s1">&#39;wavelength&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>  <span class="c1"># 波长值</span>
<span class="p">})</span>

<span class="c1"># 打印光度校正表格</span>
<span class="nb">print</span><span class="p">(</span><span class="n">phot_cal_table</span><span class="p">)</span>  <span class="c1"># 输出光度校正表格内容</span>

<span class="c1"># 进行一些基本的统计分析</span>
<span class="n">mean_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">])</span>  <span class="c1"># 计算流量的平均值</span>
<span class="n">std_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">])</span>  <span class="c1"># 计算流量的标准差</span>

<span class="c1"># 输出统计结果</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;平均流量: </span><span class="si">{</span><span class="n">mean_flux</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 输出平均流量</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;流量标准差: </span><span class="si">{</span><span class="n">std_flux</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 输出流量标准差</span>

<span class="n">以上代码示例展示了如何处理JWST望远镜的光度校正表格</span><span class="err">，</span><span class="n">并进行了基本的统计分析</span><span class="err">。</span><span class="n">每行代码都添加了中文注释以便于理解</span><span class="err">。</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 如上所述，因此，通量及其对应的误差考虑了单个整体拟合结果。</span>

<span class="c1"># 因此，不需要对结果的星等或误差进行平均。它们在各自的零点差异范围内应该是相同的（通常&lt;1%）。</span>

<span class="n">mag_lvl2_arr</span> <span class="o">=</span> <span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span>  <span class="c1"># 从JWST观测结果中提取星等数据</span>

<span class="n">magerr_lvl2_arr</span> <span class="o">=</span> <span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;magerr&#39;</span><span class="p">]</span>  <span class="c1"># 从JWST观测结果中提取星等误差数据</span>

<span class="c1"># 打印来自表格的星等和误差</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mag_lvl2_arr</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">magerr_lvl2_arr</span><span class="p">)</span>  <span class="c1"># 输出星等和对应的误差</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 使用space_phot模块的observation2函数处理JWST的第二级数据</span>
<span class="n">jwst_obs_fast</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">observation2</span><span class="p">(</span><span class="n">lvl2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 将lvl2列表中的第一个元素传递给observation2函数</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义中心点的坐标，包含参考点的x和y坐标</span>
<span class="n">centers</span> <span class="o">=</span> <span class="p">[</span><span class="n">ref_x</span><span class="p">,</span> <span class="n">ref_y</span><span class="p">]</span>

<span class="c1"># 调用JWST观测快速点扩散函数（PSF），传入第一个PSF和中心点坐标</span>
<span class="n">jwst_obs_fast</span><span class="o">.</span><span class="n">fast_psf</span><span class="p">(</span><span class="n">psfs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">centers</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="level3">
<h3>3.2<font color='white'>-</font>单个 Level3 马赛克文件<a class="anchor" id="bso3"></a><a class="headerlink" href="#level3" title="Link to this heading">#</a></h3>
<p>尽管上述讨论了在预拼接数据产品上进行点扩散函数（PSF）光度测量，但space_phot具有基于Level2图像在探测器的给定单一位置创建拼接的Level3 PSF的功能。这种方法的优点在于能够在预期微弱源在Level2数据中信噪比过低的情况下，对深度堆叠数据进行PSF光度测量。缺点是制作拼接的Level3 PSF所需的时间，因此这种方法在处理少量低信噪比源时最为有用。<br></p>
<p>有用的参考文献：<br></p>
<p>Space-Phot文档关于Level3拟合的说明：https://space-phot.readthedocs.io/en/latest/examples/plot_a_psf.html#level-3-psf<br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Level3 数据文件与上述相同</span>

<span class="n">lvl3</span>  <span class="c1"># 定义一个变量 lvl3，表示 Level3 数据</span>
 

<span class="n">请提供更多的上下文或代码</span><span class="err">，</span><span class="n">以便我能够更好地帮助您添加注释</span><span class="err">。</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 现在对Level 3数据进行相同的光度测量</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">lvl3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取Level 3数据中的第一幅图像</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 将图像数据转换为ImageModel对象</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 提取图像数据</span>

<span class="c1"># 该缩放应突出背景噪声，以便能够看到所有微弱源。</span>

<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 使用对数缩放规范化图像数据</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>  <span class="c1"># 创建一个20x12英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 显示图像数据，设置原点在下方，应用规范化和灰度色图</span>

<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>  <span class="c1"># 添加颜色条</span>

<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 设置颜色条标签及其位置和旋转</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 隐藏坐标轴刻度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为“像素”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为“像素”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义源位置，使用天球坐标</span>
<span class="n">source_location</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="s1">&#39;17:43:04.4879&#39;</span><span class="p">,</span> <span class="s1">&#39;+66:55:01.837&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

<span class="c1"># 从参考FITS文件中获取WCS（世界坐标系统）</span>
<span class="n">ref_wcs</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">get_fits_wcs</span><span class="p">()</span>

<span class="c1"># 将天球坐标转换为像素坐标</span>
<span class="n">ref_y</span><span class="p">,</span> <span class="n">ref_x</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">source_location</span><span class="p">,</span> <span class="n">ref_wcs</span><span class="p">)</span>

<span class="c1"># 从参考数据中提取一个21x21的切片</span>
<span class="n">ref_cutout</span> <span class="o">=</span> <span class="n">extract_array</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span> <span class="p">(</span><span class="n">ref_x</span><span class="p">,</span> <span class="n">ref_y</span><span class="p">))</span>

<span class="c1"># 归一化设置，突出背景噪声，以便能够看到所有微弱源</span>
<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="c1"># 显示切片图像，使用灰度色图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># 添加颜色条</span>
<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="c1"># 设置颜色条标签</span>
<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># 设置图像标题</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PID1028,Obs006&#39;</span><span class="p">)</span>

<span class="c1"># 设置x轴和y轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>

<span class="c1"># 隐藏坐标轴的刻度线</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1"># 显示图像</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 现在对Level 3数据进行相同的光度测量</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">lvl3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取Level 3数据中的第一幅图像</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 打开FITS文件以读取数据</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 从FITS文件中提取科学数据部分</span>

<span class="c1"># 使用简单归一化方法对数据进行归一化处理</span>
<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 显示图像，设置原点在下方，使用灰度色图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># 隐藏坐标轴的刻度和颜色</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图像</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 函数 get_jwst_psf 是 space_phot 的一个包装器，用于 WebbPSF 的 calc_psf 函数，并使用了许多相同的关键字。</span>

<span class="c1"># 生成 WebbPSF 的更高级方法，但超出了本笔记本的范围。</span>

<span class="c1"># 在本笔记本中，get_jwst_psf 使用的默认值为：</span>

<span class="c1"># oversample=4  # 过采样因子设置为4</span>

<span class="c1"># normalize=&#39;last&#39;  # 归一化方法设置为&#39;last&#39;</span>

<span class="c1"># 非失真 PSF</span>

<span class="c1"># 有用的参考文献: https://webbpsf.readthedocs.io/en/latest/api/webbpsf.JWInstrument.html#webbpsf.JWInstrument.calc_psf</span>

<span class="c1"># 从 WebbPSF 获取 PSF</span>

<span class="n">jwst3_obs</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">observation3</span><span class="p">(</span><span class="n">lvl3</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 获取 JWST 观测数据</span>

<span class="n">psf3</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">get_jwst3_psf</span><span class="p">(</span><span class="n">jwst_obs</span><span class="p">,</span> <span class="n">jwst3_obs</span><span class="p">,</span> <span class="n">source_location</span><span class="p">)</span>  <span class="c1"># 计算 PSF</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 该缩放应突出背景噪声，以便能够看到所有微弱源。</span>

<span class="c1"># 从psf3数据中提取161x161的切片，中心位置为(200, 200)</span>
<span class="n">ref_cutout</span> <span class="o">=</span> <span class="n">extract_array</span><span class="p">(</span><span class="n">psf3</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">161</span><span class="p">,</span> <span class="mi">161</span><span class="p">),</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

<span class="c1"># 使用对数缩放进行简单归一化，最小值为0.0，最大值为0.01</span>
<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># 显示提取的切片，原点在下方，使用灰度色图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># 添加颜色条</span>
<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="c1"># 设置颜色条标签</span>
<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># 设置图表标题</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;WebbPSF Model (Mosaiced)&#39;</span><span class="p">)</span>

<span class="c1"># 设置x轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>

<span class="c1"># 设置y轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>

<span class="c1"># 隐藏坐标轴的刻度线</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1"># 显示图表</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="id2">
<h4>关于 Space_Phot 中 PSF 拟合的说明：<br><a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<p>https://st-phot.readthedocs.io/en/latest/examples/plot_a_psf.html#jwst-images</p>
<p>如上所述，改进的文档将会发布。目前，这里有一些重要的注意事项。</p>
<p>请参阅上文第 3.1 节中的详细说明，了解拟合过程和诊断信息。</p>
<p>此外，请注意，jwst3_obs 正在通过使用 JWST 流水线来重采样和组合多个 Level2 PSF 来生成 Level3 PSF。Level2 PSF 是在每个 Level2 文件中源的精确位置生成的，以考虑探测器级别的效应。重采样使用默认的重采样参数。然而，用户应注意，如果他们对 Level2 数据产品进行了自定义重采样，则应对其 PSF 使用类似的重采样步骤。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 使用 space_phot 进行 PSF 光度测量（拟合的详细信息在文档中）</span>

<span class="c1"># 关于拟合过程和诊断的详细说明见上面的第 3.1 节</span>

<span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_photometry</span><span class="p">(</span>

    <span class="n">psf3</span><span class="p">,</span>  <span class="c1"># 输入的点扩散函数（PSF）</span>

    <span class="n">source_location</span><span class="p">,</span>  <span class="c1"># 源的位置</span>

    <span class="n">bounds</span><span class="o">=</span><span class="p">{</span>  <span class="c1"># 设置参数的边界</span>

        <span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">],</span>  <span class="c1"># 流量的边界</span>

        <span class="s1">&#39;centroid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>  <span class="c1"># 重心的边界</span>

        <span class="s1">&#39;bkg&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>  <span class="c1"># 背景的边界</span>

    <span class="p">},</span>

    <span class="n">fit_width</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>  <span class="c1"># 拟合宽度</span>

    <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 是否拟合背景</span>

    <span class="n">fit_flux</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># 是否拟合流量</span>

<span class="p">)</span>

<span class="c1"># 绘制 PSF 拟合结果</span>
<span class="n">jwst_obs</span><span class="o">.</span><span class="n">plot_psf_fit</span><span class="p">()</span>  
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>

<span class="c1"># 绘制 PSF 后验分布</span>
<span class="n">jwst_obs</span><span class="o">.</span><span class="n">plot_psf_posterior</span><span class="p">(</span><span class="n">minweight</span><span class="o">=</span><span class="mf">.0005</span><span class="p">)</span>  
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 从JWST观察数据中提取第一个光度值</span>
<span class="n">mag_lvl3psf</span> <span class="o">=</span> <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># 从JWST观察数据中提取第一个光度误差值</span>
<span class="n">magerr_lvl3psf</span> <span class="o">=</span> <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;magerr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># 打印第二级光度值和光度误差，保留四位小数</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">mag_lvl2_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">magerr_lvl2_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># 打印第三级PSF光度值和光度误差，保留五位小数</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">mag_lvl3psf</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">magerr_lvl3psf</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="level2level3">
<h2>Level2和Level3结果之间的良好一致性！<a class="headerlink" href="#level2level3" title="Link to this heading">#</a></h2>
<p>4.<font color='white'>-</font>微弱/上限，单个天体<a class="anchor" id="fso"></a></p>
<hr class="docutils" />
<p>本节的目的是说明如何使用点扩散函数（PSF）光度法计算天空空白区域的上限。</p>
<section id="id3">
<h3>4.1<font color='white'>-</font>多个 Level2 文件<a class="anchor" id="fso2"></a><a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Level 3 Files  # 定义一个包含Level 3文件路径的列表</span>

<span class="n">lvl3</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mast/01028/jw01028-o006_t001_miri_f770w_i2d.fits&#39;</span><span class="p">]</span>  <span class="c1"># 将文件路径添加到列表中</span>

<span class="n">lvl3</span>  <span class="c1"># 输出列表内容</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 从ASN文件创建Level 2数据列表</span>

<span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;./mast/01028/&quot;</span>  <span class="c1"># 定义文件路径前缀</span>

<span class="n">asn</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;jw01028-o006_*_image3_00004_asn.json&#39;</span><span class="p">)</span>  <span class="c1"># 获取符合条件的ASN文件列表</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">asn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fi</span><span class="p">:</span>  <span class="c1"># 打开第一个ASN文件进行读取</span>

    <span class="n">lvl2</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化Level 2数据列表</span>

    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">fi</span><span class="p">:</span>  <span class="c1"># 遍历文件中的每一行</span>

        <span class="k">if</span> <span class="n">ln</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;                    &quot;expname&quot;:&#39;</span><span class="p">):</span>  <span class="c1"># 检查行是否以&quot;expname&quot;开头</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">ln</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>  <span class="c1"># 去掉前两个字符并按冒号分割</span>

            <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>  <span class="c1"># 取出第二部分并按双引号分割</span>

            <span class="n">lvl2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 将构建的完整路径添加到Level 2数据列表中</span>

<span class="nb">print</span><span class="p">(</span><span class="n">lvl2</span><span class="p">)</span>  <span class="c1"># 输出Level 2数据列表</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将所有DQ标记的像素更改为NANs</span>

<span class="c1"># JWST DQ标记定义的参考文献: https://jwst-pipeline.readthedocs.io/en/latest/jwst/references_general/references_general.html</span>

<span class="c1"># 在这种情况下，我们选择所有DQ &gt; 10，但用户可以根据自己的需要选择相应的值。</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">lvl2</span><span class="p">:</span>  <span class="c1"># 遍历所有的lvl2文件</span>

    <span class="n">ref_fits</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>  <span class="c1"># 创建ImageModel对象以读取FITS文件</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取数据部分</span>

    <span class="n">dq</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">dq</span>  <span class="c1"># 获取DQ标记部分</span>

    <span class="n">data</span><span class="p">[</span><span class="n">dq</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># 将DQ标记大于等于10的像素值设置为NAN</span>

    <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>  <span class="c1"># 更新数据部分</span>

    <span class="n">ref_fits</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>  <span class="c1"># 保存修改后的FITS文件</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 检查第一幅图像（在设置DQ标志后）</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">lvl2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 从lvl2数据集中获取第一幅图像</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 打印图像数据</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 将图像数据转换为ImageModel对象</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 提取图像数据部分</span>

<span class="c1"># 该缩放应突出背景噪声，以便能够看到所有微弱源。</span>

<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 使用对数缩放规范化数据</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>  <span class="c1"># 创建一个20x12英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 显示图像数据，设置原点在下方，应用规范化和灰度色图</span>

<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>  <span class="c1"># 添加颜色条</span>

<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 设置颜色条标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 隐藏坐标轴刻度线</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为“像素”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为“像素”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 选择天空中一个空白区域以计算上限</span>

<span class="n">source_location</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="s1">&#39;17:43:00.0332&#39;</span><span class="p">,</span> <span class="s1">&#39;+66:54:42.677&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>  <span class="c1"># 定义源位置的天球坐标</span>

<span class="n">ref_wcs</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">get_fits_wcs</span><span class="p">()</span>  <span class="c1"># 获取参考图像的WCS（世界坐标系统）</span>

<span class="n">ref_y</span><span class="p">,</span> <span class="n">ref_x</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">source_location</span><span class="p">,</span> <span class="n">ref_wcs</span><span class="p">)</span>  <span class="c1"># 将天球坐标转换为像素坐标</span>

<span class="n">ref_cutout</span> <span class="o">=</span> <span class="n">extract_array</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span> <span class="p">(</span><span class="n">ref_x</span><span class="p">,</span> <span class="n">ref_y</span><span class="p">))</span>  <span class="c1"># 从参考数据中提取21x21的切片</span>

<span class="c1"># 该比例尺应突出背景噪声，以便能够看到所有微弱源。</span>

<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 使用对数伸缩规范化切片数据</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 显示切片图像，使用灰度色图</span>

<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>  <span class="c1"># 添加颜色条</span>

<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 设置颜色条标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PID1028,Obs006&#39;</span><span class="p">)</span>  <span class="c1"># 设置图像标题</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 隐藏坐标轴刻度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图像</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 检查第一张图像</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">lvl2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取第二级数据中的第一张图像</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 打印图像文件名</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 打开FITS文件以读取数据</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 从FITS文件中提取科学数据部分</span>

<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 规范化数据以便于显示</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 显示图像，设置原点在下方，使用灰度色图</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 隐藏坐标轴刻度和标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图像</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 选择天空中的一个空白区域来计算上限</span>

<span class="c1"># 定义源位置的天球坐标</span>
<span class="n">source_location</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="s1">&#39;17:43:00.0332&#39;</span><span class="p">,</span> <span class="s1">&#39;+66:54:42.677&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

<span class="c1"># 将天球坐标转换为像素坐标</span>
<span class="n">ref_y</span><span class="p">,</span> <span class="n">ref_x</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">source_location</span><span class="p">,</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">ref_fits</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ref_fits</span><span class="p">))</span>

<span class="c1"># 从参考数据中提取一个11x11的切片</span>
<span class="n">ref_cutout</span> <span class="o">=</span> <span class="n">extract_array</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="p">(</span><span class="n">ref_x</span><span class="p">,</span> <span class="n">ref_y</span><span class="p">))</span>

<span class="c1"># 对提取的切片进行归一化处理</span>
<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 显示切片图像，设置原点在下方，使用灰度色图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># 设置图像标题</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PID1028,Obs006&#39;</span><span class="p">)</span>

<span class="c1"># 隐藏坐标轴的刻度和颜色</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1"># 显示图像</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 函数 get_jwst_psf 是 space_phot 的一个包装器，用于 WebbPSF 的 calc_psf 函数，并使用了许多相同的关键字。</span>

<span class="c1"># 生成 WebbPSF 的更高级方法，但超出了本笔记本的范围。</span>

<span class="c1"># 在本笔记本中，get_jwst_psf 使用的默认值为：</span>

<span class="c1"># oversample=4  # 过采样因子设置为4</span>

<span class="c1"># normalize=&#39;last&#39;  # 归一化方法设置为&#39;last&#39;</span>

<span class="c1"># 非失真 PSF</span>

<span class="c1"># 有用的参考文献: https://webbpsf.readthedocs.io/en/latest/api/webbpsf.JWInstrument.html#webbpsf.JWInstrument.calc_psf</span>

<span class="c1"># 从 WebbPSF 获取 PSF</span>

<span class="n">jwst_obs</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">observation2</span><span class="p">(</span><span class="n">lvl2</span><span class="p">)</span>  <span class="c1"># 使用 lvl2 数据生成 JWST 观测对象</span>

<span class="n">psfs</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">get_jwst_psf</span><span class="p">(</span><span class="n">jwst_obs</span><span class="p">,</span> <span class="n">source_location</span><span class="p">)</span>  <span class="c1"># 获取指定源位置的 PSF</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 该缩放应突出背景噪声，以便能够看到所有微弱源。</span>

<span class="c1"># 从psf3数据中提取一个161x161的切片，中心位置为(200, 200)</span>
<span class="n">ref_cutout</span> <span class="o">=</span> <span class="n">extract_array</span><span class="p">(</span><span class="n">psf3</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">161</span><span class="p">,</span> <span class="mi">161</span><span class="p">),</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

<span class="c1"># 使用对数缩放进行归一化，最小值为0.0，最大值为0.01</span>
<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># 显示提取的切片，设置原点在下方，使用灰度色图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># 添加颜色条</span>
<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="c1"># 设置颜色条标签</span>
<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># 设置图表标题</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;WebbPSF Model&#39;</span><span class="p">)</span>

<span class="c1"># 设置x轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>

<span class="c1"># 设置y轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>

<span class="c1"># 隐藏坐标轴的刻度线</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1"># 显示图形</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 使用 space_phot 进行 PSF 光度测量（拟合的详细信息请参见文档）</span>

<span class="c1"># https://st-phot.readthedocs.io/en/latest/examples/plot_a_psf.html#jwst-images</span>

<span class="c1"># 调用 jwst_obs 的 psf_photometry 方法进行 PSF 光度测量</span>
<span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_photometry</span><span class="p">(</span>

    <span class="n">psfs</span><span class="p">,</span>  <span class="c1"># 输入的 PSF 数据</span>

    <span class="n">source_location</span><span class="p">,</span>  <span class="c1"># 源位置</span>

    <span class="n">bounds</span><span class="o">=</span><span class="p">{</span>  <span class="c1"># 设置参数的边界</span>
        <span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>  <span class="c1"># 流量的边界</span>
        <span class="s1">&#39;bkg&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>  <span class="c1"># 背景的边界</span>
    <span class="p">},</span>

    <span class="n">fit_width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># 拟合宽度设置为 5 像素</span>

    <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 是否拟合背景</span>
    <span class="n">fit_centroid</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span>  <span class="c1"># 中心位置固定</span>
    <span class="n">fit_flux</span><span class="o">=</span><span class="s1">&#39;single&#39;</span>  <span class="c1"># 拟合单一流量</span>
<span class="p">)</span>

<span class="c1"># 绘制 PSF 拟合结果</span>
<span class="n">jwst_obs</span><span class="o">.</span><span class="n">plot_psf_fit</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示绘制的图像</span>

<span class="c1"># 绘制 PSF 后验分布</span>
<span class="n">jwst_obs</span><span class="o">.</span><span class="n">plot_psf_posterior</span><span class="p">(</span><span class="n">minweight</span><span class="o">=</span><span class="mf">.0005</span><span class="p">)</span>  <span class="c1"># 设置最小权重为 0.0005</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示绘制的图像</span>

<span class="c1"># 打印 PSF 结果的光度校准表</span>
<span class="nb">print</span><span class="p">(</span><span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">)</span>  <span class="c1"># 输出光度校准结果</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 如上所述，结果是，通量及其对应的误差考虑了一个整体拟合。</span>

<span class="c1"># 因此，不需要对结果的亮度或误差进行平均。它们在各自的零点差异范围内应该都是相同的（通常&lt;1%）。</span>

<span class="c1"># 打印上限</span>

<span class="n">magupper_lvl2psf</span> <span class="o">=</span> <span class="n">jwst_obs</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">(</span><span class="n">nsigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 计算5σ的上限</span>

<span class="n">magupper_lvl2psf</span>  <span class="c1"># 输出上限值</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3>4.2<font color='white'>-</font>单个，Level3 马赛克文件<a class="anchor" id="fso3"></a><a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Level3数据文件与上述相同。</span>

<span class="n">lvl3</span>  <span class="c1"># 定义一个变量lvl3，表示Level 3数据</span>
 

<span class="n">请提供更多代码或上下文</span><span class="err">，</span><span class="n">以便我可以为您添加详细的中文注释</span><span class="err">。</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 现在对Level 3数据进行相同的光度测量</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">lvl3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取Level 3数据中的第一幅图像</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 将图像数据转换为ImageModel对象</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 提取图像数据</span>

<span class="c1"># 该缩放应突出背景噪声，以便能够看到所有微弱源。</span>

<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 使用对数缩放规范化数据</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>  <span class="c1"># 创建一个20x12英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 显示图像数据，使用灰度色图</span>

<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>  <span class="c1"># 添加颜色条</span>

<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 设置颜色条标签及其位置</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 隐藏坐标轴刻度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为“Pixels”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为“Pixels”</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 选择天空中一个空白区域以计算上限</span>

<span class="n">source_location</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="s1">&#39;17:43:00.0332&#39;</span><span class="p">,</span> <span class="s1">&#39;+66:54:42.677&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>  <span class="c1"># 定义源位置的天球坐标</span>

<span class="n">ref_wcs</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">get_fits_wcs</span><span class="p">()</span>  <span class="c1"># 获取参考图像的WCS（世界坐标系统）</span>

<span class="n">ref_y</span><span class="p">,</span> <span class="n">ref_x</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">source_location</span><span class="p">,</span> <span class="n">ref_wcs</span><span class="p">)</span>  <span class="c1"># 将天球坐标转换为像素坐标</span>

<span class="n">ref_cutout</span> <span class="o">=</span> <span class="n">extract_array</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span> <span class="p">(</span><span class="n">ref_x</span><span class="p">,</span> <span class="n">ref_y</span><span class="p">))</span>  <span class="c1"># 从参考数据中提取21x21的切片</span>

<span class="c1"># 该比例尺应突出背景噪声，以便能够看到所有微弱的源。</span>

<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 使用对数归一化来强调背景噪声</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 显示切片图像，使用灰度色图</span>

<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>  <span class="c1"># 添加颜色条</span>

<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 设置颜色条标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PID1028,Obs006&#39;</span><span class="p">)</span>  <span class="c1"># 设置图像标题</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 隐藏坐标轴刻度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图像</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 现在对Level 3数据进行相同的光度测量</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">lvl3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取Level 3数据的第一幅图像</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 打开FITS文件以读取数据</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 从FITS文件中提取科学数据部分</span>

<span class="c1"># 使用简单归一化方法对图像数据进行归一化处理</span>
<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 显示图像数据，设置原点在下方，使用灰度色图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># 隐藏坐标轴的刻度和颜色</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图像</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 选择天空中的一个空白区域以计算上限</span>

<span class="c1"># 定义源位置的天球坐标</span>
<span class="n">source_location</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="s1">&#39;17:43:00.0332&#39;</span><span class="p">,</span> <span class="s1">&#39;+66:54:42.677&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hourangle</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>

<span class="c1"># 将天球坐标转换为像素坐标</span>
<span class="n">ref_y</span><span class="p">,</span> <span class="n">ref_x</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">source_location</span><span class="p">,</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">ref_fits</span><span class="p">[</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ref_fits</span><span class="p">))</span>

<span class="c1"># 从参考数据中提取一个11x11的切片</span>
<span class="n">ref_cutout</span> <span class="o">=</span> <span class="n">extract_array</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="p">(</span><span class="n">ref_x</span><span class="p">,</span> <span class="n">ref_y</span><span class="p">))</span>

<span class="c1"># 对提取的切片进行归一化处理</span>
<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 显示切片图像，设置原点在下方，使用灰度色图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># 设置图像标题</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PID1028,Obs006 (level 3)&#39;</span><span class="p">)</span>

<span class="c1"># 隐藏坐标轴的刻度和颜色</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1"># 显示图像</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 函数 get_jwst_psf 是 space_phot 的一个包装器，用于 WebbPSF 的 calc_psf 函数，并使用了许多相同的关键字。</span>

<span class="c1"># 生成 WebbPSF 的更高级方法，但超出了本笔记本的范围。</span>

<span class="c1"># 在本笔记本中，get_jwst_psf 使用的默认值为：</span>

<span class="c1"># oversample=4  # 过采样因子设置为4</span>

<span class="c1"># normalize=&#39;last&#39;  # 归一化方法设置为&#39;last&#39;</span>

<span class="c1"># 非失真 PSF</span>

<span class="c1"># 有用的参考文献: https://webbpsf.readthedocs.io/en/latest/api/webbpsf.JWInstrument.html#webbpsf.JWInstrument.calc_psf</span>

<span class="c1"># 从 WebbPSF 获取 PSF</span>

<span class="n">jwst3_obs</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">observation3</span><span class="p">(</span><span class="n">lvl3</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 获取 JWST 第三观测的观测数据</span>

<span class="n">psf3</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">get_jwst3_psf</span><span class="p">(</span><span class="n">jwst_obs</span><span class="p">,</span> <span class="n">jwst3_obs</span><span class="p">,</span> <span class="n">source_location</span><span class="p">)</span>  <span class="c1"># 计算 PSF</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 该缩放应突出背景噪声，以便能够看到所有微弱源。</span>

<span class="c1"># 从psf3数据中提取161x161的切片，中心位置为(200, 200)</span>
<span class="n">ref_cutout</span> <span class="o">=</span> <span class="n">extract_array</span><span class="p">(</span><span class="n">psf3</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">161</span><span class="p">,</span> <span class="mi">161</span><span class="p">),</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

<span class="c1"># 使用对数缩放进行简单归一化，最小值为0.0，最大值为0.01</span>
<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># 显示提取的切片，设置原点在下方，使用灰度色图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_cutout</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># 添加颜色条</span>
<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

<span class="c1"># 设置颜色条标签</span>
<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># 设置图表标题</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;WebbPSF Model&#39;</span><span class="p">)</span>

<span class="c1"># 设置x轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>

<span class="c1"># 设置y轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>

<span class="c1"># 隐藏坐标轴的刻度线</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1"># 显示图表</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 调用JWST望远镜的PSF光度测量函数</span>
<span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_photometry</span><span class="p">(</span>

    <span class="n">psf3</span><span class="p">,</span>  <span class="c1"># 输入的点扩散函数（PSF）数据</span>

    <span class="n">source_location</span><span class="p">,</span>  <span class="c1"># 源位置，通常是一个包含坐标的元组或列表</span>

    <span class="n">bounds</span><span class="o">=</span><span class="p">{</span>  <span class="c1"># 设置参数的边界</span>
        <span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>  <span class="c1"># 流量的边界，限制流量范围</span>
        <span class="s1">&#39;bkg&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>  <span class="c1"># 背景的边界，限制背景范围</span>
    <span class="p">},</span>

    <span class="n">fit_width</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>  <span class="c1"># 拟合宽度，决定拟合区域的大小</span>

    <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 是否拟合背景</span>
    <span class="n">fit_centroid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 是否拟合中心位置</span>
    <span class="n">fit_flux</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># 是否拟合流量</span>
<span class="p">)</span>

<span class="c1"># 绘制PSF拟合结果</span>
<span class="n">jwst3_obs</span><span class="o">.</span><span class="n">plot_psf_fit</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示绘制的图形</span>

<span class="c1"># 绘制PSF后验分布，设置最小权重</span>
<span class="n">jwst3_obs</span><span class="o">.</span><span class="n">plot_psf_posterior</span><span class="p">(</span><span class="n">minweight</span><span class="o">=</span><span class="mf">.0005</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示绘制的图形</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">magupper_lvl3psf</span> <span class="o">=</span> <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">upper_limit</span><span class="p">(</span><span class="n">nsigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 计算JWST观测数据的上限，使用5个标准差</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">magupper_lvl2psf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># 输出第二级PSF的上限，保留4位小数</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">magupper_lvl3psf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">5</span><span class="p">))</span>  <span class="c1"># 输出第三级PSF的上限，保留5位小数</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id5">
<h2>注意：您可以使用Level3合并数据产品进行更深入的分析<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<p>5.<font color='white'>-</font>恒星场 (LMC)<a class="anchor" id="lmc"></a></p>
<hr class="docutils" />
<section id="space-phot-space-phot-dolphotphotutils-space-phot">
<h3>在这种情况下，我们将执行与第3节相同的步骤，但针对多个恒星。目的是展示在大量恒星上使用space_phot的工作流程和运行时间。我们建议，对于大量明亮恒星，space_phot可能不是最优选择。其他程序，如DOLPHOT或Photutils，可能更适合这种用例。space_phot的主要优势在于处理微弱的单一源。但如果需要，它也可以扩展到处理更多的恒星。<a class="headerlink" href="#space-phot-space-phot-dolphotphotutils-space-phot" title="Link to this heading">#</a></h3>
</section>
<section id="id6">
<h3>5.1<font color='white'>-</font>多个 Level2 文件<a class="anchor" id="lmc2"></a><a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<section id="id7">
<h4>现在对一组更大的恒星进行相同的操作并测试速度<a class="headerlink" href="#id7" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Level 3 Files  # 定义一个包含Level 3文件路径的列表</span>

<span class="n">lvl3</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;./mast/01171/jw01171-o004_t001_miri_f560w_i2d.fits&quot;</span><span class="p">]</span>  <span class="c1"># 将文件路径添加到列表中</span>

<span class="n">lvl3</span>  <span class="c1"># 输出列表内容</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 导入所需的库</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>  <span class="c1"># 用于文件路径操作</span>

<span class="c1"># Level 2 文件路径匹配</span>
<span class="n">lvl2</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./mast/01171/jw01171004*cal.fits&#39;</span><span class="p">)</span>  <span class="c1"># 查找符合模式的所有 Level 2 文件</span>

<span class="c1"># 输出匹配到的文件列表</span>
<span class="n">lvl2</span>  <span class="c1"># 显示找到的文件</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 在Level 3文件中查找恒星</span>

<span class="c1"># 获取背景的粗略估计（有更好的方法进行背景减法）</span>
<span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>  <span class="c1"># 创建一个MAD标准背景RMS对象</span>
<span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>  <span class="c1"># 创建一个MMM背景对象</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">lvl3</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 从Level 3数据中读取图像模型</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">get_fits_wcs</span><span class="p">()</span>  <span class="c1"># 获取图像的WCS（世界坐标系统）</span>

<span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 计算数据的标准差作为背景噪声</span>
<span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 计算背景值</span>
<span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 复制原始数据以进行背景减法</span>
<span class="n">data_bkgsub</span> <span class="o">-=</span> <span class="n">bkg</span>  <span class="c1"># 从数据中减去背景值</span>

<span class="n">fwhm_psf</span> <span class="o">=</span> <span class="mf">1.882</span>  <span class="c1"># F560W波段的PSF全宽半最大值（单位：像素）</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="mf">5.</span>  <span class="c1"># 设置恒星检测的阈值</span>

<span class="c1"># 创建DAOStarFinder对象以查找恒星</span>
<span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm_psf</span><span class="p">,</span> <span class="n">exclude_border</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_separation</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">found_stars</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data_bkgsub</span><span class="p">)</span>  <span class="c1"># 在减去背景后的数据中查找恒星</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 打印found_stars对象的所有星体信息，最多显示10行</span>
<span class="n">found_stars</span><span class="o">.</span><span class="n">pprint_all</span><span class="p">(</span><span class="n">max_lines</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 绘制找到的恒星</span>

<span class="c1"># 使用平方根归一化方法对背景减除后的数据进行归一化，99%为百分位数</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_bkgsub</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>

<span class="c1"># 创建一个10x10英寸的图形和坐标轴</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># 在坐标轴上显示背景减除后的数据，原点位于左下角，使用之前定义的归一化</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_bkgsub</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>

<span class="c1"># 将找到的恒星的中心坐标打包为一个可迭代对象</span>
<span class="n">xypos</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>

<span class="c1"># 创建一个半径为10的圆形光圈，表示恒星的位置</span>
<span class="n">aper</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">xypos</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 在坐标轴上绘制圆形光圈，颜色为红色</span>
<span class="n">aper</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 过滤出你想要的星星</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>  <span class="c1"># 创建一个12x8英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清除当前图形中的所有内容</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个2行1列的子图，选择第一个子图</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;mag&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为&#39;mag&#39;</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;sharpness&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为&#39;sharpness&#39;</span>

<span class="c1"># 设置x轴和y轴的范围</span>
<span class="n">xlim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.25</span>  <span class="c1"># x轴下限</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.25</span>  <span class="c1"># x轴上限</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;sharpness&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.15</span>  <span class="c1"># y轴下限</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;sharpness&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.15</span>  <span class="c1"># y轴上限</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span> <span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;sharpness&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图</span>

<span class="n">sh_inf</span> <span class="o">=</span> <span class="mf">0.40</span>  <span class="c1"># 锐度下限</span>
<span class="n">sh_sup</span> <span class="o">=</span> <span class="mf">0.82</span>  <span class="c1"># 锐度上限</span>
<span class="c1"># mag_lim = -5.0  # 原始的星等限制（未使用）</span>
<span class="n">lmag_lim</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.0</span>  <span class="c1"># 星等下限</span>
<span class="n">umag_lim</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span>  <span class="c1"># 星等上限</span>

<span class="c1"># 绘制锐度的限制线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">sh_sup</span><span class="p">,</span> <span class="n">sh_sup</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 上限线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">sh_inf</span><span class="p">,</span> <span class="n">sh_inf</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 下限线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">lmag_lim</span><span class="p">,</span> <span class="n">lmag_lim</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 星等下限线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">umag_lim</span><span class="p">,</span> <span class="n">umag_lim</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 星等上限线</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建一个2行1列的子图，选择第二个子图</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;mag&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为&#39;mag&#39;</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;roundness&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为&#39;roundness&#39;</span>

<span class="c1"># 设置y轴的范围</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;roundness2&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.25</span>  <span class="c1"># y轴下限</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;roundness2&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.25</span>  <span class="c1"># y轴上限</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">round_inf</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.40</span>  <span class="c1"># 圆度下限</span>
<span class="n">round_sup</span> <span class="o">=</span> <span class="mf">0.40</span>  <span class="c1"># 圆度上限</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span> <span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;roundness2&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图</span>

<span class="c1"># 绘制圆度的限制线</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">round_sup</span><span class="p">,</span> <span class="n">round_sup</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 上限线</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">round_inf</span><span class="p">,</span> <span class="n">round_inf</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 下限线</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">lmag_lim</span><span class="p">,</span> <span class="n">lmag_lim</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 星等下限线</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">umag_lim</span><span class="p">,</span> <span class="n">umag_lim</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 星等上限线</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图参数，使之填充整个图像区域</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 创建一个布尔掩码，筛选符合条件的星星</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lmag_lim</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># 星等小于下限</span>
        <span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">umag_lim</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># 星等大于上限</span>
        <span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;roundness2&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">round_inf</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># 圆度大于下限</span>
        <span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;roundness2&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">round_sup</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># 圆度小于上限</span>
        <span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;sharpness&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sh_inf</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># 锐度大于下限</span>
        <span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;sharpness&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sh_sup</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># 锐度小于上限</span>
        <span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># x坐标大于100</span>
        <span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">700</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># x坐标小于700</span>
        <span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># y坐标大于100</span>
        <span class="p">(</span><span class="n">found_stars</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">700</span><span class="p">))</span>  <span class="c1"># y坐标小于700</span>

<span class="c1"># 根据掩码筛选出符合条件的星星</span>
<span class="n">found_stars_sel</span> <span class="o">=</span> <span class="n">found_stars</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="c1"># 打印原始找到的星星数量</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of stars found originally:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_stars</span><span class="p">))</span>

<span class="c1"># 打印最终筛选出的星星数量</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of stars in final selection:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_stars_sel</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">看起来您提到的</span> <span class="err">`</span><span class="n">found_stars_sel</span><span class="err">`</span> <span class="n">可能是一个变量或函数的名称</span><span class="err">，</span><span class="n">但没有提供具体的代码</span><span class="err">。</span><span class="n">为了帮助您添加中文注释</span><span class="err">，</span><span class="n">我需要您提供相关的代码片段</span><span class="err">。</span><span class="n">请将代码粘贴在这里</span><span class="err">，</span><span class="n">我将为您添加行级中文注释</span><span class="err">。</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将像素坐标转换为世界坐标系（WCS）坐标</span>

<span class="c1"># 使用像素坐标（xcentroid, ycentroid）转换为天球坐标</span>
<span class="n">skycoords</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span><span class="n">found_stars_sel</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">found_stars_sel</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>

<span class="c1"># 获取转换后的天球坐标的数量</span>
<span class="nb">len</span><span class="p">(</span><span class="n">skycoords</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将所有DQ标记的像素值更改为NAN</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">lvl2</span><span class="p">:</span>  <span class="c1"># 遍历所有的lvl2文件</span>

    <span class="n">ref_fits</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>  <span class="c1"># 读取当前文件为ImageModel对象</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取数据部分</span>

    <span class="n">dq</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">dq</span>  <span class="c1"># 获取数据质量标志部分</span>

    <span class="n">data</span><span class="p">[</span><span class="n">dq</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># 将DQ标记大于等于10的像素值设置为NAN</span>

    <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>  <span class="c1"># 更新ImageModel对象中的数据部分</span>

    <span class="n">ref_fits</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>  <span class="c1"># 保存修改后的文件</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 创建一个用于快速查找的网格，使用WebbPSF。网格点数量越多，光度精度越高。</span>

<span class="c1"># 开发者注释：希望能有一个快速/近似的查找表。</span>

<span class="n">jwst_obs</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">observation2</span><span class="p">(</span><span class="n">lvl2</span><span class="p">)</span>  <span class="c1"># 将lvl2数据转换为JWST观测对象</span>

<span class="n">grid</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_jwst_psf_grid</span><span class="p">(</span><span class="n">jwst_obs</span><span class="p">,</span> <span class="n">num_psfs</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>  <span class="c1"># 获取JWST PSF网格，设置网格点数量为16</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 导入必要的库</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTable</span>

<span class="c1"># 创建一个包含天球坐标的QTable对象，skycoords是一个变量，包含了天球坐标数据</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">([</span><span class="n">skycoords</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;skycoord&quot;</span><span class="p">])</span>

<span class="c1"># 将QTable对象写入到一个名为&#39;skycoord.ecsv&#39;的文件中，overwrite=True表示如果文件已存在，则覆盖它</span>
<span class="n">t</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;skycoord.ecsv&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 现在循环遍历所有星星并构建光度表</span>

<span class="c1"># 读者应参考上述讨论的所有诊断信息。</span>

<span class="c1"># 应注意，空图对应于不覆盖特定坐标的LVL2文件的抖动位置。</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>  <span class="c1"># 忽略警告信息</span>

<span class="n">counter</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># 初始化计数器</span>

<span class="n">badindex</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化坏索引列表</span>

<span class="n">jwst_obs</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">observation2</span><span class="p">(</span><span class="n">lvl2</span><span class="p">)</span>  <span class="c1"># 创建JWST观测对象</span>

<span class="n">localbkg_estimator</span> <span class="o">=</span> <span class="n">LocalBackground</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">MMMBackground</span><span class="p">())</span>  <span class="c1"># 初始化局部背景估计器</span>

<span class="k">for</span> <span class="n">source_location</span> <span class="ow">in</span> <span class="n">skycoords</span><span class="p">:</span>  <span class="c1"># 遍历每个源位置</span>

    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting&#39;</span><span class="p">,</span> <span class="n">counter</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39; of&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">skycoords</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">source_location</span><span class="p">)</span>  <span class="c1"># 打印当前处理的源位置</span>

    <span class="n">psfs</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_jwst_psf_from_grid</span><span class="p">(</span><span class="n">jwst_obs</span><span class="p">,</span> <span class="n">source_location</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>  <span class="c1"># 获取点扩散函数（PSF）</span>

    <span class="n">xys</span> <span class="o">=</span> <span class="p">[</span><span class="n">jwst_obs</span><span class="o">.</span><span class="n">wcs_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">source_location</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jwst_obs</span><span class="o">.</span><span class="n">n_exposures</span><span class="p">)]</span>  <span class="c1"># 将世界坐标转换为像素坐标</span>

    <span class="n">bkg</span> <span class="o">=</span> <span class="p">[</span><span class="n">localbkg_estimator</span><span class="p">(</span><span class="n">jwst_obs</span><span class="o">.</span><span class="n">data_arr_pam</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xys</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">xys</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jwst_obs</span><span class="o">.</span><span class="n">n_exposures</span><span class="p">)]</span>  <span class="c1"># 估计背景</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">bkg</span><span class="p">)</span>  <span class="c1"># 打印背景值</span>

    <span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_photometry</span><span class="p">(</span>  <span class="c1"># 进行PSF光度测量</span>

        <span class="n">psfs</span><span class="p">,</span>

        <span class="n">source_location</span><span class="p">,</span>

        <span class="n">bounds</span><span class="o">=</span><span class="p">{</span>

            <span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">],</span>  <span class="c1"># 流量的边界</span>

            <span class="s1">&#39;centroid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>  <span class="c1"># 重心的边界</span>

        <span class="p">},</span>

        <span class="n">fit_width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># 拟合宽度</span>

        <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 不拟合背景</span>

        <span class="n">fit_centroid</span><span class="o">=</span><span class="s1">&#39;wcs&#39;</span><span class="p">,</span>  <span class="c1"># 使用WCS拟合重心</span>

        <span class="n">background</span><span class="o">=</span><span class="n">bkg</span><span class="p">,</span>  <span class="c1"># 使用估计的背景</span>

        <span class="n">fit_flux</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span>  <span class="c1"># 拟合单一流量</span>

        <span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span>  <span class="c1"># 最大迭代次数</span>

    <span class="p">)</span>

    

    <span class="n">jwst_obs</span><span class="o">.</span><span class="n">plot_psf_fit</span><span class="p">()</span>  <span class="c1"># 绘制PSF拟合图</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图像</span>

    <span class="n">ra</span> <span class="o">=</span> <span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取拟合的RA值</span>

    <span class="n">dec</span> <span class="o">=</span> <span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取拟合的DEC值</span>

    <span class="n">fit_location</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>  <span class="c1"># 创建拟合位置的天球坐标</span>

     

    <span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_photometry</span><span class="p">(</span>  <span class="c1"># 再次进行PSF光度测量</span>

        <span class="n">psfs</span><span class="p">,</span>

        <span class="n">fit_location</span><span class="p">,</span>

        <span class="n">bounds</span><span class="o">=</span><span class="p">{</span>

            <span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">],</span>  <span class="c1"># 流量的边界</span>

            <span class="s1">&#39;centroid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>  <span class="c1"># 重心的边界</span>

        <span class="p">},</span>

        <span class="n">fit_width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># 拟合宽度</span>

        <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 不拟合背景</span>

        <span class="n">background</span><span class="o">=</span><span class="n">bkg</span><span class="p">,</span>  <span class="c1"># 使用估计的背景</span>

        <span class="n">fit_centroid</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span>  <span class="c1"># 固定重心进行拟合</span>

        <span class="n">fit_flux</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span>  <span class="c1"># 拟合单一流量</span>

        <span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span>  <span class="c1"># 最大迭代次数</span>

    <span class="p">)</span>

    <span class="n">jwst_obs</span><span class="o">.</span><span class="n">plot_psf_fit</span><span class="p">()</span>  <span class="c1"># 绘制PSF拟合图</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图像</span>

    <span class="n">ra</span> <span class="o">=</span> <span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取拟合的RA值</span>

    <span class="n">dec</span> <span class="o">=</span> <span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取拟合的DEC值</span>

    <span class="n">mag_arr</span> <span class="o">=</span> <span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span>  <span class="c1"># 获取光度数组</span>

    <span class="n">magerr_arr</span> <span class="o">=</span> <span class="n">jwst_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;magerr&#39;</span><span class="p">]</span>  <span class="c1"># 获取光度误差数组</span>

    <span class="n">mag_lvl2psf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mag_arr</span><span class="p">)</span>  <span class="c1"># 计算光度的平均值</span>

    <span class="n">magerr_lvl2psf</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">magerr_arr</span><span class="p">))</span>  <span class="c1"># 计算光度误差的平方和的平方根</span>

    <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 如果是第一次迭代</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">mag_lvl2psf</span><span class="p">,</span> <span class="n">magerr_lvl2psf</span><span class="p">]]),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">,</span> <span class="s1">&#39;magerr&#39;</span><span class="p">])</span>  <span class="c1"># 创建数据框</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># 如果不是第一次迭代</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">mag_lvl2psf</span><span class="p">,</span> <span class="n">magerr_lvl2psf</span><span class="p">]]),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">,</span> <span class="s1">&#39;magerr&#39;</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 追加数据</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mf">1.</span>  <span class="c1"># 更新计数器</span>
    

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed Time for Photometry:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>  <span class="c1"># 打印光度测量的耗时</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">看起来您输入的内容不完整或不明确</span><span class="err">。</span><span class="n">如果您有特定的Python代码需要添加中文注释</span><span class="err">，</span><span class="n">请提供该代码</span><span class="err">，</span><span class="n">我将很乐意帮助您进行注释和解释</span><span class="err">。</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">看起来您提到的</span><span class="err">“</span><span class="n">df</span><span class="err">”</span><span class="n">可能是指一个数据框</span><span class="err">（</span><span class="n">DataFrame</span><span class="err">），</span><span class="n">但没有提供具体的代码或数据结构</span><span class="err">。</span><span class="n">为了帮助您</span><span class="err">，</span><span class="n">我需要更多的上下文或代码示例</span><span class="err">。</span>

<span class="n">如果您有特定的Python代码或数据处理任务</span><span class="err">，</span><span class="n">请提供相关的代码片段</span><span class="err">，</span><span class="n">我将为您添加中文注释并保持代码结构不变</span><span class="err">。</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将数据框(df)写入文件</span>

<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;miri_photometry_space_phot_lvl2.txt&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 将数据保存为CSV格式，不包含索引</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id8">
<h3>5.2<font color='white'>-</font>单个 Level3 拼接文件<a class="anchor" id="lmc3"></a><a class="headerlink" href="#id8" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 现在对Level 3数据进行相同的光度测量</span>

<span class="n">ref_image</span> <span class="o">=</span> <span class="n">lvl3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取Level 3数据中的第一幅图像</span>

<span class="n">ref_fits</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>  <span class="c1"># 将图像数据转换为ImageModel对象</span>

<span class="n">ref_data</span> <span class="o">=</span> <span class="n">ref_fits</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 提取图像数据</span>

<span class="c1"># 使用简单归一化方法设置图像的显示范围</span>
<span class="n">norm1</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">min_cut</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">max_cut</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># 创建一个新的图形，设置图形大小</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># 显示图像数据，设置原点在下方，使用灰度色图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># 添加颜色条以显示数据值的范围</span>
<span class="n">clb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">clb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;MJy/Str&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=-</span><span class="mi">40</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 设置颜色条标签</span>

<span class="c1"># 隐藏坐标轴的刻度线</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="c1"># 设置x轴和y轴的标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># x轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>  <span class="c1"># y轴标签</span>

<span class="c1"># 显示图形</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 从WebbPSF获取点扩散函数（PSF），并将其滴灌到源位置</span>

<span class="n">jwst3_obs</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">observation3</span><span class="p">(</span><span class="n">lvl3</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 调用space_phot模块中的observation3函数，获取第一个lvl3数据的JWST观测结果</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">看起来您提供的代码片段不完整</span><span class="err">，</span><span class="n">只有</span> <span class="err">`</span><span class="n">lvl3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="err">`</span> <span class="n">这一行</span><span class="err">。</span><span class="n">如果您希望我为某段代码添加中文注释</span><span class="err">，</span><span class="n">请提供完整的代码段</span><span class="err">。</span><span class="n">这样我才能更好地帮助您</span><span class="err">。</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">看起来您提到的</span><span class="err">“</span><span class="n">skycoords</span><span class="err">”</span><span class="n">可能是指天文学中用于处理天球坐标的工具</span><span class="err">，</span><span class="n">通常在Python中使用Astropy库</span><span class="err">。</span><span class="n">以下是一个示例代码</span><span class="err">，</span><span class="n">展示如何使用Astropy的SkyCoord类来处理天球坐标</span><span class="err">，</span><span class="n">并添加了中文注释</span><span class="err">。</span>

<span class="c1"># 导入所需的库</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>  <span class="c1"># 导入SkyCoord类用于天球坐标处理</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>  <span class="c1"># 导入单位模块以支持物理单位</span>

<span class="c1"># 创建一个SkyCoord对象，指定天球坐标（赤经和赤纬）</span>
<span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="mf">10.684</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mf">41.269</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>  <span class="c1"># 创建一个坐标对象，赤经为10.684度，赤纬为41.269度</span>

<span class="c1"># 输出坐标的银河坐标</span>
<span class="n">galactic_coord</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">galactic</span>  <span class="c1"># 将天球坐标转换为银河坐标</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;银河坐标: (l, b) = (</span><span class="si">{</span><span class="n">galactic_coord</span><span class="o">.</span><span class="n">l</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">galactic_coord</span><span class="o">.</span><span class="n">b</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># 打印银河坐标，格式化输出</span>

<span class="c1"># 计算两个坐标之间的角距离</span>
<span class="n">coord2</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="mf">10.684</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mf">41.269</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>  <span class="c1"># 创建第二个坐标对象</span>
<span class="n">separation</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">coord2</span><span class="p">)</span>  <span class="c1"># 计算两个坐标之间的角距离</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;角距离: </span><span class="si">{</span><span class="n">separation</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印角距离，格式化输出</span>

<span class="n">在这个示例中</span><span class="err">，</span><span class="n">我们使用了Astropy库中的SkyCoord类来创建天球坐标</span><span class="err">，</span><span class="n">并进行了银河坐标转换和角距离计算</span><span class="err">。</span><span class="n">每一行代码都添加了中文注释</span><span class="err">，</span><span class="n">以帮助理解代码的功能</span><span class="err">。</span><span class="n">请根据您的具体需求调整代码</span><span class="err">。</span>
</pre></div>
</div>
</div>
</div>
<section id="psf-snr">
<h4>读者应参考上述讨论的所有诊断信息。一般来说，这个循环展示了在没有视觉检查的情况下，对各种星体（亮度、在探测器上的分布等）进行点扩散函数（PSF）光度测量的困难，尤其是在处理低信噪比（SNR）源时。这对于所有光度测量软件包都是适用的。用户应检查相关指标，并考虑为特定感兴趣的星体优化参数。尽管如此，拟合的成功总是可以通过相关的误差条来量化。<a class="headerlink" href="#psf-snr" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 现在循环遍历所有星星并构建光度表</span>

<span class="n">counter</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># 计数器初始化为0</span>

<span class="n">badindex</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 存储坏索引的列表</span>

<span class="c1"># 遍历天空坐标中的前两个源位置</span>
<span class="k">for</span> <span class="n">source_location</span> <span class="ow">in</span> <span class="n">skycoords</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>

    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting&#39;</span><span class="p">,</span> <span class="n">counter</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">,</span> <span class="s1">&#39; of&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">skycoords</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">source_location</span><span class="p">)</span>  <span class="c1"># 打印当前处理的源位置</span>

    <span class="c1"># 获取JWST的点扩散函数（PSF）</span>
    <span class="n">psf3</span> <span class="o">=</span> <span class="n">space_phot</span><span class="o">.</span><span class="n">get_jwst3_psf</span><span class="p">(</span><span class="n">jwst_obs</span><span class="p">,</span> <span class="n">jwst3_obs</span><span class="p">,</span> <span class="n">source_location</span><span class="p">,</span> <span class="n">num_psfs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># 将源位置转换为像素坐标</span>
    <span class="n">xys</span> <span class="o">=</span> <span class="p">[</span><span class="n">jwst3_obs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">source_location</span><span class="p">)]</span>

    <span class="c1"># 估计局部背景</span>
    <span class="n">bkg</span> <span class="o">=</span> <span class="p">[</span><span class="n">localbkg_estimator</span><span class="p">(</span><span class="n">jwst3_obs</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">xys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">xys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">bkg</span><span class="p">)</span>  <span class="c1"># 打印背景估计值</span>

    <span class="c1"># 进行PSF光度测量</span>
    <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_photometry</span><span class="p">(</span>
        <span class="n">psf3</span><span class="p">,</span>
        <span class="n">source_location</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">],</span>  <span class="c1"># 光通量的边界</span>
            <span class="s1">&#39;centroid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>  <span class="c1"># 中心位置的边界</span>
        <span class="p">},</span>
        <span class="n">fit_width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># 拟合宽度</span>
        <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 不拟合背景</span>
        <span class="n">background</span><span class="o">=</span><span class="n">bkg</span><span class="p">,</span>  <span class="c1"># 使用估计的背景</span>
        <span class="n">fit_flux</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># 拟合光通量</span>
    <span class="p">)</span>

    <span class="c1"># 获取拟合结果的RA和DEC</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># 创建拟合位置的SkyCoord对象</span>
    <span class="n">fit_location</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>

    <span class="c1"># 进行光圈光度测量</span>
    <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">aperture_photometry</span><span class="p">(</span><span class="n">fit_location</span><span class="p">,</span> <span class="n">encircled_energy</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">jwst3_obs</span><span class="o">.</span><span class="n">aperture_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">])</span>  <span class="c1"># 打印光度结果</span>

    <span class="c1"># 再次进行PSF光度测量</span>
    <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_photometry</span><span class="p">(</span>
        <span class="n">psf3</span><span class="p">,</span>
        <span class="n">fit_location</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">],</span>  <span class="c1"># 光通量的边界</span>
            <span class="s1">&#39;centroid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>  <span class="c1"># 中心位置的边界</span>
        <span class="p">},</span>
        <span class="n">fit_width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># 拟合宽度</span>
        <span class="n">fit_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 不拟合背景</span>
        <span class="n">fit_centroid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 不拟合中心位置</span>
        <span class="n">background</span><span class="o">=</span><span class="n">bkg</span><span class="p">,</span>  <span class="c1"># 使用估计的背景</span>
        <span class="n">fit_flux</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># 拟合光通量</span>
    <span class="p">)</span>

    <span class="c1"># 绘制PSF拟合结果</span>
    <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">plot_psf_fit</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># 显示图形</span>

    <span class="c1"># 获取PSF拟合结果的RA、DEC、光度和光度误差</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mag_lvl3psf</span> <span class="o">=</span> <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">magerr_lvl3psf</span> <span class="o">=</span> <span class="n">jwst3_obs</span><span class="o">.</span><span class="n">psf_result</span><span class="o">.</span><span class="n">phot_cal_table</span><span class="p">[</span><span class="s1">&#39;magerr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># 如果是第一次循环，初始化数据框</span>
    <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">mag_lvl3psf</span><span class="p">,</span> <span class="n">magerr_lvl3psf</span><span class="p">]]),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">,</span> <span class="s1">&#39;magerr&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 否则，追加数据到数据框</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">mag_lvl3psf</span><span class="p">,</span> <span class="n">magerr_lvl3psf</span><span class="p">]]),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">,</span> <span class="s1">&#39;magerr&#39;</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mf">1.</span>  <span class="c1"># 增加计数器</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed Time for Photometry:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>  <span class="c1"># 打印光度测量的耗时</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">看起来您提到的</span><span class="err">“</span><span class="n">lvl2</span><span class="err">”</span><span class="n">可能是指JWST望远镜数据的第二级处理数据</span><span class="err">，</span><span class="n">但没有提供具体的代码或上下文</span><span class="err">。</span><span class="n">为了帮助您</span><span class="err">，</span><span class="n">我需要您提供相关的Python代码或数据处理的具体内容</span><span class="err">。</span><span class="n">请您提供更多信息</span><span class="err">，</span><span class="n">以便我能够为您添加中文注释并保持代码结构不变</span><span class="err">。</span><span class="n">谢谢</span><span class="err">！</span>
</pre></div>
</div>
</div>
</div>
<p><strong>重要说明</strong>：何时不使用。由于space_phot参数的敏感性，此工具不适合用于大样本的恒星（即下面的第5节）。如果用户希望在多个源上使用space_phot，他们应仔细构建一个参数表，为每个源精心调整参数。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">看起来您想要处理一个数据框</span><span class="err">（</span><span class="n">DataFrame</span><span class="err">），</span><span class="n">但没有提供具体的代码或数据结构</span><span class="err">。</span><span class="n">请提供您希望我添加中文注释的代码片段</span><span class="err">，</span><span class="n">这样我才能为您添加行级中文注释并保持代码结构不变</span><span class="err">。</span>
</pre></div>
</div>
</div>
</div>
<hr style="border:1px solid gray"> </hr><a class="reference internal image-reference" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="空间望远镜标志" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" />
</a>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/MIRI/psf_photometry"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">目录</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#webbpsfsynphot">1.1<font color="white">-</font>设置WebbPSF和Synphot目录<a class="anchor" id="webbpsf"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python">1.2<font color="white">-</font>Python 导入<a class="anchor" id="py_imports"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#level2">3.1<font color="white">-</font>多个 Level2 文件<a class="anchor" id="bso2"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#space-phot-psf">关于 Space_Phot 中 PSF 拟合的说明：<br/></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#level3">3.2<font color="white">-</font>单个 Level3 马赛克文件<a class="anchor" id="bso3"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">关于 Space_Phot 中 PSF 拟合的说明：<br/></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level2level3">Level2和Level3结果之间的良好一致性！</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">4.1<font color="white">-</font>多个 Level2 文件<a class="anchor" id="fso2"></a></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">4.2<font color="white">-</font>单个，Level3 马赛克文件<a class="anchor" id="fso3"></a></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">注意：您可以使用Level3合并数据产品进行更深入的分析</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#space-phot-space-phot-dolphotphotutils-space-phot">在这种情况下，我们将执行与第3节相同的步骤，但针对多个恒星。目的是展示在大量恒星上使用space_phot的工作流程和运行时间。我们建议，对于大量明亮恒星，space_phot可能不是最优选择。其他程序，如DOLPHOT或Photutils，可能更适合这种用例。space_phot的主要优势在于处理微弱的单一源。但如果需要，它也可以扩展到处理更多的恒星。</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">5.1<font color="white">-</font>多个 Level2 文件<a class="anchor" id="lmc2"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">现在对一组更大的恒星进行相同的操作并测试速度</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">5.2<font color="white">-</font>单个 Level3 拼接文件<a class="anchor" id="lmc3"></a></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-snr">读者应参考上述讨论的所有诊断信息。一般来说，这个循环展示了在没有视觉检查的情况下，对各种星体（亮度、在探测器上的分布等）进行点扩散函数（PSF）光度测量的困难，尤其是在处理低信噪比（SNR）源时。这对于所有光度测量软件包都是适用的。用户应检查相关指标，并考虑为特定感兴趣的星体优化参数。尽管如此，拟合的成功总是可以通过相关的误差条来量化。</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>