
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>PSF 光度测量 &#8212; STScI JDAT Notebooks 中文版</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css?v=b44a18d9" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example_cn';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="NIRCam Wisp 移除" href="../NIRCam_wisp_subtraction/nircam_wisp_subtraction_cn.html" />
    <link rel="prev" title="交叉滤波 PSF 匹配" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry_cn.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks 中文版 - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks 中文版 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">主页</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install_cn.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow_cn.html">笔记本开发工作流程</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">开发</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks_cn.html">提交笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements_cn.html">需求文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks_cn.html">Jupyter 笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files_cn.html">数据文件</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub 指南</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup_cn.html">GitHub 设置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow_cn.html">GitHub 工作流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr_cn.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">跨仪器通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example_cn.html">ASDF 示例</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation_cn.html">复杂的二维背景</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3_cn.html">复合模型光谱拟合</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query_cn.html">MAST 查询</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina_cn.html">Imviz RGB图像</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift_cn.html">Specviz 简单示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS_cn.html">提高纯平行数据集的WCS精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/stpsf_examples/stpsf_examples_cn.html">STPSF 示例</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis_cn.html">MRS Mstar - 数据分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc_cn.html">LMC中的IFU YSOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1_cn.html">LRS 光谱提取</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example_cn.html">点源光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry_cn.html">扩展孔径光度测量</a></li>


<li class="toctree-l1"><a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry_cn.html">交叉滤光片 PSF 匹配</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">PSF 光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam_wisp_subtraction/nircam_wisp_subtraction_cn.html">NIRCam 光晕去除</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction_cn.html">WFSS 光谱 - 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra_cn.html">WFSS 光谱 - 合并和归一化 1D 光谱</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template_cn.html">WFSS 光谱 - 相关性模版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map_cn.html">WFSS 光谱 - 发射线图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup_cn.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3_cn.html">运行图像处理管道并创建源目录</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2_cn.html">运行 spec2 管道</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit_cn.html">IFU立方体拟合</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/cube_fitting/cube_fitting_cn.html">IFU Cube 建模</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/ifu_optimal/ifu_optimal_cn.html">IFU 光谱提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/optimal_extraction/Spectral_Extraction-static_cn.html">MOS 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/mos_spectroscopy_advanced/MOSspec_advanced_cn.html">星系外场的MOS光谱</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST_cn.html">BOTS 时间序列观测</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/galaxy_redshift/redshift_fitting_cn.html">红移和模板拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/FS_NSClean_example_cn.html">FS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/IFU_NSClean_example_cn.html">IFU 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/MOS_NSClean_example_cn.html">MOS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example_cn.html">BOTS 数据生成 （NSClean）</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRCam/psf_photometry/NIRCam_PSF_Photometry_Example_cn.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>PSF 光度测量</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">进行中的工作：</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">导入</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">导入绘图函数</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stpsf-synphot">下载 STPSF 和 Synphot 数据</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">加载图像并创建一些有用的字典</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">选择用于分析的探测器和/或滤光片</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">显示图像</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">创建点扩散函数（PSF）模型</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-stpsf-psf">I. 使用 STPSF 创建 PSF 模型</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#single-psf-model">单一点扩散函数模型 (Single PSF model)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">显示单个点扩散函数（PSF）模型</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">PSF 网格</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">显示PSF网格</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ii-effective-psf-epsf">II. 创建有效点扩散函数模型 (Effective PSF, ePSF)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ii-psf">II. 构建有效的点扩散函数 (PSF)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#epsfs">显示ePSFs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">进行中的工作 - 构建有效的PSF网格</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#i-psf">I. 统计网格中每个区域的PSF星星数量</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#todo-epsf">TODO - 创建ePSF网格</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#todo-epsf-stpsf">TODO - 使用 ePSF 网格来扰动 STPSF 模型</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">执行PSF光度测量</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">输出光度表</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">显示减法图像</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">第二部分 - 数据分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">加载具有点扩散函数（PSF）光度的表格</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#datamodel">将图像转换为数据模型（DataModel）</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">对两个滤镜的四幅图像进行目录交叉匹配</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">四幅图像的颜色-星等图（仪器星等）</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#daofindpsf">daofind与PSF算法获取位置的差异（以像素为单位）</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">对每个滤光片交叉匹配4个目录</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">开发者注意事项：</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">最终颜色-星等图（仪器星等）</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#photometric-zeropoints">光度零点 (Photometric Zeropoints)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">加载已校准和矫正的图像（三级成像处理管道）</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">显示图像</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aperture-photometry">光圈光度法 (Aperture Photometry)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">寻找明亮的孤立恒星</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">加载孔径校正表</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">执行光圈光度法</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#zeropoints">推导零点（Zeropoints）</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">导入输入光度数据</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">校准的颜色-星等图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">输入与输出光度的比较</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id30">最后说明</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id31">关于此笔记本</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="psf">
<h1>PSF 光度测量<a class="headerlink" href="#psf" title="Link to this heading">#</a></h1>
<p><strong>用例：</strong> PSF光度测量，创建PSF，推导颜色-星等图。<br></p>
<p><strong>数据：</strong> 使用<a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-jwst-data-simulator">MIRAGE</a>获得的关于大麦哲伦云（LMC）天体测量校准场的NIRCam模拟图像，并通过<a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/">JWST管道</a>处理。这些模拟图像是通过对三个宽带滤光片对（F070W、F115W和F200W用于SW通道；F277W、F356W和F444W用于LW通道）进行4点亚像素抖动获得的。我们仅模拟了1个NIRCam SW探测器（即“ NRCB1”）。在本示例中，我们使用两个SW滤光片（F115W和F200W）的Level-2图像（.cal，已校准但未整形），并在每个滤光片中推导光度。其他滤光片的图像也可用，并可用于测试笔记本和/或不同的滤光片组合。<br></p>
<p><strong>工具：</strong> photutils。<br></p>
<p><strong>跨仪器：</strong> NIRSpec、NIRISS、MIRI。<br></p>
<p><strong>文档：</strong> 本笔记本是STScI更大<a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">后处理数据分析工具生态系统</a>的一部分。<br></p>
<p>PSF光度测量可以通过以下方式获得：</p>
<ul class="simple">
<li><p>从STPSF获得的单一模型</p></li>
<li><p>来自STPSF的PSF模型网格</p></li>
<li><p>单一有效PSF（ePSF）</p></li>
</ul>
<section id="id1">
<h2>进行中的工作：<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>创建ePSF网格并使用ePSF网格进行减缩</p></li>
<li><p>使用ePSF网格来扰动STPSF模型</p></li>
</ul>
<p>该笔记本展示了：</p>
<ul class="simple">
<li><p>如何从STPSF获得PSF模型（或构建ePSF）</p></li>
<li><p>如何对图像进行PSF光度测量</p></li>
<li><p>如何交叉匹配不同图像的目录</p></li>
<li><p>如何推导和应用光度零点</p></li>
</ul>
<p>最终图表显示：</p>
<ul class="simple">
<li><p>4幅图像的仪器颜色-星等图</p></li>
<li><p>仪器颜色-星等图及误差</p></li>
<li><p>星等零点</p></li>
<li><p>校准的颜色-星等图（与输入颜色-星等图进行比较）</p></li>
<li><p>输入和输出光度的比较</p></li>
</ul>
<p><strong>关于pysynphot的说明</strong>：pysynphot的数据文件由校准参考数据系统（Calibration Reference Data System，CRDS）单独分发。它们预计会遵循特定的目录结构，该结构位于根目录下，由必须在使用此软件包之前设置的PYSYN_CDBS环境变量标识。在下面的示例中，根目录被任意命名为/my/local/dir/trds/。</p>
<p>export PYSYN_CDBS=/my/local/dir/trds/</p>
<p>有关数据文件的配置和下载，请参见<a class="reference external" href="https://pysynphot.readthedocs.io/en/latest/#installation-and-setup">文档</a>。</p>
</section>
<section id="id2">
<h2>导入<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">glob</span>  <span class="c1"># 导入glob模块，用于文件路径操作</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  <span class="c1"># 导入os模块，用于操作系统功能</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>  <span class="c1"># 导入tarfile模块，用于处理tar文件</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>  <span class="c1"># 导入requests模块，用于HTTP请求</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>  <span class="c1"># 导入time模块，用于时间操作</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>  <span class="c1"># 导入warnings模块，用于发出警告</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">urllib</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span>  <span class="c1"># 从urllib导入request模块，用于处理URL请求</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>  <span class="c1"># 从urllib.parse导入urlparse，用于解析URL</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># 导入numpy库，用于数值计算</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>  <span class="c1"># 导入pandas库，用于数据处理</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">stpsf</span>  <span class="c1"># 导入stpsf模块，用于点扩散函数处理</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>  <span class="c1"># 从astropy导入单位模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">match_coordinates_sky</span>  <span class="c1"># 导入天文坐标相关功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>  <span class="c1"># 导入FITS文件处理模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.fitting</span><span class="w"> </span><span class="kn">import</span> <span class="n">LevMarLSQFitter</span>  <span class="c1"># 导入Levenberg-Marquardt最小二乘拟合器</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.nddata</span><span class="w"> </span><span class="kn">import</span> <span class="n">NDData</span>  <span class="c1"># 导入NDData类，用于处理多维数据</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clipped_stats</span>  <span class="c1"># 导入sigma裁剪统计功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTable</span><span class="p">,</span> <span class="n">Table</span>  <span class="c1"># 导入QTable和Table类，用于表格数据处理</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.utils.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">AstropyUserWarning</span>  <span class="c1"># 导入Astropy用户警告类</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_norm</span>  <span class="c1"># 导入简单归一化功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.datamodels</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageModel</span>  <span class="c1"># 从jwst.datamodels导入图像模型类</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.aperture</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">CircularAnnulus</span><span class="p">,</span> <span class="n">CircularAperture</span><span class="p">,</span>  <span class="c1"># 导入光度测量相关类</span>
                                <span class="n">aperture_photometry</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">MADStdBackgroundRMS</span><span class="p">,</span> <span class="n">MMMBackground</span>  <span class="c1"># 导入背景噪声估计类</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAOStarFinder</span>  <span class="c1"># 导入DAO星点查找器</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">EPSFBuilder</span><span class="p">,</span> <span class="n">GriddedPSFModel</span><span class="p">,</span> <span class="n">IterativePSFPhotometry</span><span class="p">,</span>  <span class="c1"># 导入PSF相关功能</span>
                           <span class="n">SourceGrouper</span><span class="p">,</span> <span class="n">extract_stars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h2>导入绘图函数<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline  # 在Jupyter Notebook中内联显示图形

<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>  <span class="c1"># 导入pyplot模块用于绘图</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ticker</span>  <span class="c1"># 导入ticker模块用于设置坐标轴刻度</span>

<span class="c1"># 设置图像的颜色映射为&#39;viridis&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span>

<span class="c1"># 设置图像的原点位置为左下角</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>

<span class="c1"># 设置坐标轴标题和标签的字体大小为14</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.titlesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span>

<span class="c1"># 设置x轴和y轴刻度标签的字体大小为14</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span>

<span class="c1"># 定义字体样式1</span>
<span class="n">font1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;helvetica&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="s1">&#39;12&#39;</span><span class="p">}</span>

<span class="c1"># 定义字体样式2</span>
<span class="n">font2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;helvetica&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="s1">&#39;20&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="stpsf-synphot">
<h2>下载 STPSF 和 Synphot 数据<a class="headerlink" href="#stpsf-synphot" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  <span class="c1"># 导入操作系统模块</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>  <span class="c1"># 导入请求模块</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>  <span class="c1"># 导入tarfile模块</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>  <span class="c1"># 导入URL解析模块</span>

<span class="c1"># 设置环境变量</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;STPSF_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;./data/stpsf-data&quot;</span>  <span class="c1"># 设置STPSF数据的路径</span>

<span class="c1"># STPSF数据的URL和文件路径</span>
<span class="n">stpsf_url</span> <span class="o">=</span> <span class="s1">&#39;https://stsci.box.com/shared/static/kqfolg2bfzqc4mjkgmujo06d3iaymahv.gz&#39;</span>  <span class="c1"># STPSF数据的下载链接</span>
<span class="n">stpsf_file</span> <span class="o">=</span> <span class="s1">&#39;./stpsf-data-LATEST.tar.gz&#39;</span>  <span class="c1"># 下载后保存的文件名</span>
<span class="n">stpsf_folder</span> <span class="o">=</span> <span class="s2">&quot;./data&quot;</span>  <span class="c1"># 解压后的文件夹路径</span>

<span class="c1"># 定义下载文件的函数</span>
<span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
    <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  <span class="c1"># 解析URL</span>

    <span class="c1"># 检查URL的协议是否支持</span>
    <span class="k">if</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported URL scheme: </span><span class="si">{</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 抛出不支持的协议错误</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>  <span class="c1"># 发送GET请求下载文件</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  <span class="c1"># 检查请求是否成功</span>

    <span class="c1"># 将下载的内容写入指定路径</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>  <span class="c1"># 按块读取内容</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>  <span class="c1"># 写入文件</span>

<span class="c1"># 检查STPSF文件夹是否存在</span>
<span class="n">stpsfExist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stpsf_folder</span><span class="p">)</span>  <span class="c1"># 检查文件夹是否存在</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">stpsfExist</span><span class="p">:</span>  <span class="c1"># 如果文件夹不存在</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stpsf_folder</span><span class="p">)</span>  <span class="c1"># 创建文件夹</span>
    <span class="n">download_file</span><span class="p">(</span><span class="n">stpsf_url</span><span class="p">,</span> <span class="n">stpsf_file</span><span class="p">)</span>  <span class="c1"># 下载STPSF数据文件</span>
    <span class="n">gzf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stpsf_file</span><span class="p">)</span>  <span class="c1"># 打开下载的tar.gz文件</span>
    <span class="n">gzf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">stpsf_folder</span><span class="p">)</span>  <span class="c1"># 解压文件到指定文件夹</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  <span class="c1"># 导入操作系统模块</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>  <span class="c1"># 导入tarfile模块以处理tar文件</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span>  <span class="c1"># 从urllib导入request模块以处理URL请求</span>

<span class="c1"># 设置环境变量</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYSYN_CDBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;./grp/redcat/trds/&quot;</span>  <span class="c1"># 设置PYSYN_CDBS环境变量，指向数据目录</span>

<span class="c1"># Synphot数据</span>
<span class="n">synphot_url</span> <span class="o">=</span> <span class="s1">&#39;http://ssb.stsci.edu/trds/tarfiles/synphot5.tar.gz&#39;</span>  <span class="c1"># Synphot数据的URL</span>
<span class="n">synphot_file</span> <span class="o">=</span> <span class="s1">&#39;./synphot5.tar.gz&#39;</span>  <span class="c1"># 下载的tar.gz文件的本地路径</span>
<span class="n">synphot_folder</span> <span class="o">=</span> <span class="s1">&#39;./grp&#39;</span>  <span class="c1"># 存放解压后文件的文件夹路径</span>

<span class="c1"># 收集synphot文件</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">synphot_folder</span><span class="p">):</span>  <span class="c1"># 如果文件夹不存在</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">synphot_folder</span><span class="p">)</span>  <span class="c1"># 创建文件夹</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">synphot_url</span><span class="p">,</span> <span class="n">synphot_file</span><span class="p">)</span>  <span class="c1"># 从URL下载文件到本地</span>
    <span class="n">gzf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">synphot_file</span><span class="p">)</span>  <span class="c1"># 打开下载的tar.gz文件</span>
    <span class="n">gzf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>  <span class="c1"># 解压文件到当前目录</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h2>加载图像并创建一些有用的字典<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<p>我们加载所有图像，并创建一个包含所有图像的字典，按探测器（detectors）和滤光片（filters）分类。这对于检查可用的探测器和滤光片非常有用，并帮助我们决定是否要对所有图像进行光度测量（photometry），还是仅对子集（例如，仅对SW滤光片）进行测量。</p>
<p>我们还创建了一个包含一些分析所需参数的字典。该字典包含光度零点（photometric zeropoints）（来自<a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-data-simulator">MIRAGE</a>配置文件）和NIRCam点扩散函数（PSF）全宽半高（FWHM），这些数据来自<a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-camera/nircam-predicted-performance/nircam-point-spread-functions">NIRCam点扩散函数</a>的JDox页面。FWHM是通过分析使用<a class="reference external" href="https://www.stsci.edu/jwst/science-planning/proposal-planning-toolbox/psf-simulation-tool">STPSF</a>模拟的预期NIRCam PSF计算得出的。</p>
<p><strong>注意</strong>：一旦在调试后每个探测器的零点和FWHM值可用，该字典将进行更新。</p>
<p>因此，我们有两个字典：</p>
<ul class="simple">
<li><p>单个Level-2校准图像的字典</p></li>
<li><p>包含其他一些有用参数的字典</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 初始化一个字典，用于存储不同探测器的图像数据</span>
<span class="n">dict_images</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NRCA1&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA2&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA3&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA4&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA5&#39;</span><span class="p">:</span> <span class="p">{},</span>
               <span class="s1">&#39;NRCB1&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB2&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB3&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB4&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB5&#39;</span><span class="p">:</span> <span class="p">{}}</span>

<span class="c1"># 初始化短波和长波滤光器的字典</span>
<span class="n">dict_filter_short</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">dict_filter_long</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># 初始化短波和长波的滤光器和探测器列表</span>
<span class="n">ff_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">det_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">det_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ff_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">detlist_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">detlist_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filtlist_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filtlist_long</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 检查当前目录下是否存在处理过的图像文件</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./*cal*fits&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading images&quot;</span><span class="p">)</span>  <span class="c1"># 如果没有，打印下载信息</span>

    <span class="c1"># 定义图像数据的下载链接和保存路径</span>
    <span class="n">boxlink_images_lev2</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/images_level2.tar.gz&#39;</span>
    <span class="n">boxfile_images_lev2</span> <span class="o">=</span> <span class="s1">&#39;./images_level2.tar.gz&#39;</span>

    <span class="c1"># 下载图像数据</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_images_lev2</span><span class="p">,</span> <span class="n">boxfile_images_lev2</span><span class="p">)</span>

    <span class="c1"># 解压下载的tar文件</span>
    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile_images_lev2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>

    <span class="c1"># 设置图像目录并获取所有处理过的图像文件</span>
    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
    <span class="n">images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">&quot;*cal.fits&quot;</span><span class="p">)))</span>

<span class="k">else</span><span class="p">:</span>
    <span class="c1"># 如果文件已存在，直接获取图像文件</span>
    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
    <span class="n">images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">&quot;*cal.fits&quot;</span><span class="p">)))</span>

<span class="c1"># 遍历所有图像文件</span>
<span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># 打开图像文件</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span>  <span class="c1"># 获取滤光器信息</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">]</span>  <span class="c1"># 获取探测器信息</span>

    <span class="c1"># 根据探测器类型进行调整</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">&#39;NRCBLONG&#39;</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">&#39;NRCB5&#39;</span>  <span class="c1"># 将NRCBLONG映射到NRCB5</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">&#39;NRCALONG&#39;</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">&#39;NRCA5&#39;</span>  <span class="c1"># 将NRCALONG映射到NRCA5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span>  <span class="c1"># 保持原样</span>

    <span class="n">wv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># 提取波长信息</span>

    <span class="c1"># 根据波长将图像分类为短波或长波</span>
    <span class="k">if</span> <span class="n">wv</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>         
        <span class="n">ff_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># 添加到长波滤光器列表</span>
        <span class="n">det_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>  <span class="c1"># 添加到长波探测器列表</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ff_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># 添加到短波滤光器列表</span>
        <span class="n">det_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>  <span class="c1"># 添加到短波探测器列表</span>

    <span class="c1"># 获取短波和长波探测器的唯一列表</span>
    <span class="n">detlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_short</span><span class="p">)))</span>
    <span class="n">detlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_long</span><span class="p">)))</span>

    <span class="c1"># 初始化唯一滤光器列表</span>
    <span class="n">unique_list_filters_short</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unique_list_filters_long</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 为短波滤光器创建字典</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_short</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_short</span><span class="p">:</span>
            <span class="n">dict_filter_short</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 如果滤光器不在列表中，则添加</span>

    <span class="c1"># 为长波滤光器创建字典</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_long</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_long</span><span class="p">:</span>
            <span class="n">dict_filter_long</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 如果滤光器不在列表中，则添加</span>

    <span class="c1"># 将短波探测器与其对应的滤光器字典关联</span>
    <span class="k">for</span> <span class="n">d_s</span> <span class="ow">in</span> <span class="n">detlist_short</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_short</span>

    <span class="c1"># 将长波探测器与其对应的滤光器字典关联</span>
    <span class="k">for</span> <span class="n">d_l</span> <span class="ow">in</span> <span class="n">detlist_long</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d_l</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_long</span>

    <span class="c1"># 获取短波和长波滤光器的唯一列表</span>
    <span class="n">filtlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_short</span><span class="p">)))</span>
    <span class="n">filtlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_long</span><span class="p">)))</span>

    <span class="c1"># 将图像文件添加到相应的探测器和滤光器字典中</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;images&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">image</span><span class="p">]}</span>  <span class="c1"># 如果没有图像，初始化列表</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># 否则，添加图像</span>

<span class="c1"># 打印可用的探测器和滤光器信息</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available Detectors for SW channel:&quot;</span><span class="p">,</span> <span class="n">detlist_short</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available Detectors for LW channel:&quot;</span><span class="p">,</span> <span class="n">detlist_long</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available SW Filters:&quot;</span><span class="p">,</span> <span class="n">filtlist_short</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available LW Filters:&quot;</span><span class="p">,</span> <span class="n">filtlist_long</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义JWST望远镜的滤光片列表</span>
<span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F070W&#39;</span><span class="p">,</span> <span class="s1">&#39;F090W&#39;</span><span class="p">,</span> <span class="s1">&#39;F115W&#39;</span><span class="p">,</span> <span class="s1">&#39;F140M&#39;</span><span class="p">,</span> <span class="s1">&#39;F150W2&#39;</span><span class="p">,</span> <span class="s1">&#39;F150W&#39;</span><span class="p">,</span> <span class="s1">&#39;F162M&#39;</span><span class="p">,</span> <span class="s1">&#39;F164N&#39;</span><span class="p">,</span> <span class="s1">&#39;F182M&#39;</span><span class="p">,</span>
           <span class="s1">&#39;F187N&#39;</span><span class="p">,</span> <span class="s1">&#39;F200W&#39;</span><span class="p">,</span> <span class="s1">&#39;F210M&#39;</span><span class="p">,</span> <span class="s1">&#39;F212N&#39;</span><span class="p">,</span> <span class="s1">&#39;F250M&#39;</span><span class="p">,</span> <span class="s1">&#39;F277W&#39;</span><span class="p">,</span> <span class="s1">&#39;F300M&#39;</span><span class="p">,</span> <span class="s1">&#39;F322W2&#39;</span><span class="p">,</span> <span class="s1">&#39;F323N&#39;</span><span class="p">,</span>
           <span class="s1">&#39;F335M&#39;</span><span class="p">,</span> <span class="s1">&#39;F356W&#39;</span><span class="p">,</span> <span class="s1">&#39;F360M&#39;</span><span class="p">,</span> <span class="s1">&#39;F405N&#39;</span><span class="p">,</span> <span class="s1">&#39;F410M&#39;</span><span class="p">,</span> <span class="s1">&#39;F430M&#39;</span><span class="p">,</span> <span class="s1">&#39;F444W&#39;</span><span class="p">,</span> <span class="s1">&#39;F460M&#39;</span><span class="p">,</span> <span class="s1">&#39;F466N&#39;</span><span class="p">,</span> <span class="s1">&#39;F470N&#39;</span><span class="p">,</span> <span class="s1">&#39;F480M&#39;</span><span class="p">]</span>

<span class="c1"># 定义每个滤光片的点扩散函数全宽半最大值（FWHM）</span>
<span class="n">psf_fwhm</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.987</span><span class="p">,</span> <span class="mf">1.103</span><span class="p">,</span> <span class="mf">1.298</span><span class="p">,</span> <span class="mf">1.553</span><span class="p">,</span> <span class="mf">1.628</span><span class="p">,</span> <span class="mf">1.770</span><span class="p">,</span> <span class="mf">1.801</span><span class="p">,</span> <span class="mf">1.494</span><span class="p">,</span> <span class="mf">1.990</span><span class="p">,</span> <span class="mf">2.060</span><span class="p">,</span> <span class="mf">2.141</span><span class="p">,</span> <span class="mf">2.304</span><span class="p">,</span> <span class="mf">2.341</span><span class="p">,</span> <span class="mf">1.340</span><span class="p">,</span>
            <span class="mf">1.444</span><span class="p">,</span> <span class="mf">1.585</span><span class="p">,</span> <span class="mf">1.547</span><span class="p">,</span> <span class="mf">1.711</span><span class="p">,</span> <span class="mf">1.760</span><span class="p">,</span> <span class="mf">1.830</span><span class="p">,</span> <span class="mf">1.901</span><span class="p">,</span> <span class="mf">2.165</span><span class="p">,</span> <span class="mf">2.179</span><span class="p">,</span> <span class="mf">2.300</span><span class="p">,</span> <span class="mf">2.302</span><span class="p">,</span> <span class="mf">2.459</span><span class="p">,</span> <span class="mf">2.507</span><span class="p">,</span> <span class="mf">2.535</span><span class="p">,</span> <span class="mf">2.574</span><span class="p">]</span>

<span class="c1"># 定义每个滤光片的零点磁度（ZP）对于模型A</span>
<span class="n">zp_modA</span> <span class="o">=</span> <span class="p">[</span><span class="mf">25.7977</span><span class="p">,</span> <span class="mf">25.9686</span><span class="p">,</span> <span class="mf">25.8419</span><span class="p">,</span> <span class="mf">24.8878</span><span class="p">,</span> <span class="mf">27.0048</span><span class="p">,</span> <span class="mf">25.6536</span><span class="p">,</span> <span class="mf">24.6957</span><span class="p">,</span> <span class="mf">22.3073</span><span class="p">,</span> <span class="mf">24.8258</span><span class="p">,</span> <span class="mf">22.1775</span><span class="p">,</span> <span class="mf">25.3677</span><span class="p">,</span> <span class="mf">24.3296</span><span class="p">,</span>
           <span class="mf">22.1036</span><span class="p">,</span> <span class="mf">22.7850</span><span class="p">,</span> <span class="mf">23.5964</span><span class="p">,</span> <span class="mf">24.8239</span><span class="p">,</span> <span class="mf">23.6452</span><span class="p">,</span> <span class="mf">25.3648</span><span class="p">,</span> <span class="mf">20.8604</span><span class="p">,</span> <span class="mf">23.5873</span><span class="p">,</span> <span class="mf">24.3778</span><span class="p">,</span> <span class="mf">23.4778</span><span class="p">,</span> <span class="mf">20.5588</span><span class="p">,</span>
           <span class="mf">23.2749</span><span class="p">,</span> <span class="mf">22.3584</span><span class="p">,</span> <span class="mf">23.9731</span><span class="p">,</span> <span class="mf">21.9502</span><span class="p">,</span> <span class="mf">20.0428</span><span class="p">,</span> <span class="mf">19.8869</span><span class="p">,</span> <span class="mf">21.9002</span><span class="p">]</span>

<span class="c1"># 定义每个滤光片的零点磁度（ZP）对于模型B</span>
<span class="n">zp_modB</span> <span class="o">=</span> <span class="p">[</span><span class="mf">25.7568</span><span class="p">,</span> <span class="mf">25.9771</span><span class="p">,</span> <span class="mf">25.8041</span><span class="p">,</span> <span class="mf">24.8738</span><span class="p">,</span> <span class="mf">26.9821</span><span class="p">,</span> <span class="mf">25.6279</span><span class="p">,</span> <span class="mf">24.6767</span><span class="p">,</span> <span class="mf">22.2903</span><span class="p">,</span> <span class="mf">24.8042</span><span class="p">,</span> <span class="mf">22.1499</span><span class="p">,</span> <span class="mf">25.3391</span><span class="p">,</span> <span class="mf">24.2909</span><span class="p">,</span>
           <span class="mf">22.0574</span><span class="p">,</span> <span class="mf">22.7596</span><span class="p">,</span> <span class="mf">23.5011</span><span class="p">,</span> <span class="mf">24.6792</span><span class="p">,</span> <span class="mf">23.5769</span><span class="p">,</span> <span class="mf">25.3455</span><span class="p">,</span> <span class="mf">20.8631</span><span class="p">,</span> <span class="mf">23.4885</span><span class="p">,</span> <span class="mf">24.3883</span><span class="p">,</span> <span class="mf">23.4555</span><span class="p">,</span> <span class="mf">20.7007</span><span class="p">,</span>
           <span class="mf">23.2763</span><span class="p">,</span> <span class="mf">22.4677</span><span class="p">,</span> <span class="mf">24.1562</span><span class="p">,</span> <span class="mf">22.0422</span><span class="p">,</span> <span class="mf">20.1430</span><span class="p">,</span> <span class="mf">20.0173</span><span class="p">,</span> <span class="mf">22.4086</span><span class="p">]</span>

<span class="c1"># 创建一个字典，将滤光片与其对应的PSF FWHM和零点磁度（模型A和模型B）关联起来</span>
<span class="n">dict_utils</span> <span class="o">=</span> <span class="p">{</span><span class="n">filters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="p">{</span><span class="s1">&#39;psf fwhm&#39;</span><span class="p">:</span> <span class="n">psf_fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;VegaMAG zp modA&#39;</span><span class="p">:</span> <span class="n">zp_modA</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                           <span class="s1">&#39;VegaMAG zp modB&#39;</span><span class="p">:</span> <span class="n">zp_modB</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">))}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h2>选择用于分析的探测器和/或滤光片<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<p>如果我们只对分析中的某些滤光片（和/或某些探测器）感兴趣，如本例所示，我们可以从字典中选择这些滤光片（探测器）的二级（Level-2）校准图像，并仅分析这些图像。</p>
<p>在这个特定的例子中，我们分析探测器 <strong>NRCB1</strong> 的滤光片 <strong>F115W</strong> 和 <strong>F200W</strong> 的图像。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dets_short</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NRCB1&#39;</span><span class="p">]</span>  <span class="c1"># 本例中感兴趣的探测器</span>

<span class="n">filts_short</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F115W&#39;</span><span class="p">,</span> <span class="s1">&#39;F200W&#39;</span><span class="p">]</span>  <span class="c1"># 本例中感兴趣的滤光片</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h2>显示图像<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>检查我们的图像是否存在伪影，并确认可以用于分析。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>  <span class="c1"># 创建一个包含2列的子图，图形大小为14x14</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短名称的探测器列表</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短名称的滤镜列表，并获取索引</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 打开指定探测器和滤镜的图像文件</span>

        <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>  <span class="c1"># 计算数据的归一化，以平方根方式和99%的百分位数</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">)</span>  <span class="c1"># 在子图中显示图像数据，使用灰度色图</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X [px]&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置X轴标签</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y [px]&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置Y轴标签</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置子图标题为滤镜名称</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图布局以避免重叠</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h2>创建点扩散函数（PSF）模型<a class="headerlink" href="#id7" title="Link to this heading">#</a></h2>
</section>
<section id="i-stpsf-psf">
<h2>I. 使用 STPSF 创建 PSF 模型<a class="headerlink" href="#i-stpsf-psf" title="Link to this heading">#</a></h2>
<p>我们创建一个字典，该字典将包含使用 STPSF 为上述选择的探测器和滤光片创建的 PSF。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_psfs_stpsf</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化一个空字典，用于存储PSF模型数据</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短名称的探测器列表</span>

    <span class="n">dict_psfs_stpsf</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 为每个探测器设置一个空字典，如果不存在则创建</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短名称的滤光片列表，并获取索引</span>

        <span class="n">dict_psfs_stpsf</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 为每个滤光片设置一个空字典，如果不存在则创建</span>

        <span class="n">dict_psfs_stpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf model grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 初始化PSF模型网格为None</span>

        <span class="n">dict_psfs_stpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf model single&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 初始化PSF单模型为None</span>
</pre></div>
</div>
</div>
</div>
<p>下面的函数创建一个单一的点扩散函数（PSF）或一个PSF网格，并允许用户将PSF保存为FITS文件。默认情况下，模型PSF存储在psf字典中。对于PSF网格，用户可以选择要创建的PSF数量。PSF可以以探测器采样或过采样的方式创建（过采样因子可以在函数内部更改）。</p>
<p><strong>注意</strong>：默认的源光谱是，如果安装了<code class="docutils literal notranslate"><span class="pre">pysynphot</span></code>，则为Castelli &amp; Kurucz（2004）提供的G2V星光谱。如果没有安装<code class="docutils literal notranslate"><span class="pre">pysynphot</span></code>，则默认使用一个简单的平坦光谱，使得在每个波长上检测到的光子数量相同。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_psf_model</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">&#39;NRCB1&#39;</span><span class="p">,</span> <span class="n">fov</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">create_grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">save_psf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detsampled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># 创建PSF模型的函数，参数包括探测器类型、视场大小、是否创建网格等</span>

    <span class="n">nrc</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">NIRCam</span><span class="p">()</span>  <span class="c1"># 初始化NIRCam对象</span>

    <span class="n">nrc</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">det</span>  <span class="c1"># 设置探测器类型</span>

    <span class="n">nrc</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">filt</span>  <span class="c1"># 设置滤光片类型</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">stpsf</span><span class="o">.</span><span class="n">specFromSpectralType</span><span class="p">(</span><span class="s1">&#39;G5V&#39;</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="s1">&#39;phoenix&#39;</span><span class="p">)</span>  <span class="c1"># 从光谱类型生成源对象</span>

    <span class="k">if</span> <span class="n">detsampled</span><span class="p">:</span>
        <span class="c1"># 如果选择了探测器采样</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating a detector sampled PSF&quot;</span><span class="p">)</span>  <span class="c1"># 打印信息</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="mi">21</span>  <span class="c1"># 设置视场大小为21</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 否则创建过采样的PSF</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating an oversampled PSF&quot;</span><span class="p">)</span>  <span class="c1"># 打印信息</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="n">fov</span>  <span class="c1"># 保持视场大小不变</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using a </span><span class="si">{</span><span class="n">fov</span><span class="si">}</span><span class="s2"> px fov&quot;</span><span class="p">)</span>  <span class="c1"># 打印使用的视场大小</span>

    <span class="k">if</span> <span class="n">create_grid</span><span class="p">:</span>
        <span class="c1"># 如果选择创建PSF网格</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating a grid of PSF for filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2"> and detector </span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印信息</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>

        <span class="n">outname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;nircam_</span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">_fovp</span><span class="si">{</span><span class="n">fov</span><span class="si">}</span><span class="s1">_samp4_npsf</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s1">.fits&#39;</span>  <span class="c1"># 设置输出文件名</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outname</span><span class="p">):</span>
            <span class="c1"># 如果输出文件已存在</span>
            <span class="n">grid_psf</span> <span class="o">=</span> <span class="n">GriddedPSFModel</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span>  <span class="c1"># 从文件读取网格PSF</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 否则创建新的网格PSF</span>
            <span class="n">grid_psf</span> <span class="o">=</span> <span class="n">nrc</span><span class="o">.</span><span class="n">psf_grid</span><span class="p">(</span><span class="n">num_psfs</span><span class="o">=</span><span class="n">num</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">all_detectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">fov_pixels</span><span class="o">=</span><span class="n">fov</span><span class="p">,</span> <span class="n">use_detsampled_psf</span><span class="o">=</span><span class="n">detsampled</span><span class="p">,</span>
                                    <span class="n">save</span><span class="o">=</span><span class="n">save_psf</span><span class="p">)</span>  <span class="c1"># 生成网格PSF</span>

        <span class="n">dict_psfs_stpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf model grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_psf</span>  <span class="c1"># 将网格PSF存入字典</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 如果选择创建单个PSF</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating a single PSF for filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2"> and detector </span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印信息</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>

        <span class="n">outname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;nircam_</span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">_fovp</span><span class="si">{</span><span class="n">fov</span><span class="si">}</span><span class="s1">_samp4_npsf</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s1">.fits&#39;</span>  <span class="c1"># 设置输出文件名</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outname</span><span class="p">):</span>
            <span class="c1"># 如果输出文件已存在</span>
            <span class="n">single_psf</span> <span class="o">=</span> <span class="n">GriddedPSFModel</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span>  <span class="c1"># 从文件读取单个PSF</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 否则创建新的单个PSF</span>
            <span class="n">single_psf</span> <span class="o">=</span> <span class="n">nrc</span><span class="o">.</span><span class="n">psf_grid</span><span class="p">(</span><span class="n">num_psfs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">all_detectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">fov_pixels</span><span class="o">=</span><span class="n">fov</span><span class="p">,</span> <span class="n">use_detsampled_psf</span><span class="o">=</span><span class="n">detsampled</span><span class="p">,</span>
                                      <span class="n">save</span><span class="o">=</span><span class="n">save_psf</span><span class="p">)</span>  <span class="c1"># 生成单个PSF</span>

        <span class="n">dict_psfs_stpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf model single&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_psf</span>  <span class="c1"># 将单个PSF存入字典</span>

    <span class="k">return</span> <span class="n">dict_psfs_stpsf</span>  <span class="c1"># 返回包含PSF模型的字典</span>
</pre></div>
</div>
</div>
</div>
<section id="single-psf-model">
<h3>单一点扩散函数模型 (Single PSF model)<a class="headerlink" href="#single-psf-model" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短列表中的每个探测器</span>

    <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filts_short</span><span class="p">:</span>  <span class="c1"># 遍历短列表中的每个滤光片</span>

        <span class="n">create_psf_model</span><span class="p">(</span><span class="n">fov</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">create_grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_psf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detsampled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 创建点扩散函数模型</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id8">
<h2>显示单个点扩散函数（PSF）模型<a class="headerlink" href="#id8" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>  <span class="c1"># 创建一个包含2列的子图，图像大小为14x14英寸</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短名称的探测器列表</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短名称的滤镜列表，并获取索引</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">dict_psfs_stpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf model single&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取指定探测器和滤镜的PSF模型图像数据</span>

        <span class="n">norm_epsf</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>  <span class="c1"># 使用对数归一化方法对图像进行归一化处理，99%为最大值</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_epsf</span><span class="p">)</span>  <span class="c1"># 在对应的子图中显示图像，应用归一化</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X [px]&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置X轴标签</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y [px]&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置Y轴标签</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置子图标题为当前滤镜名称</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图布局以避免重叠</span>
</pre></div>
</div>
</div>
</div>
<section id="id9">
<h3>PSF 网格<a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短列表中的每个探测器</span>

    <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filts_short</span><span class="p">:</span>  <span class="c1"># 遍历短列表中的每个滤光片</span>

        <span class="n">create_psf_model</span><span class="p">(</span><span class="n">fov</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">create_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_psf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detsampled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
        <span class="c1"># 创建点扩散函数模型，参数包括视场(fov)、样本数量(num)、是否创建网格(create_grid)、是否保存PSF(save_psf)以及探测器是否采样(detsampled)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id10">
<h2>显示PSF网格<a class="headerlink" href="#id10" title="Link to this heading">#</a></h2>
<p>我们展示了1个滤光片（<strong>F115W</strong>）的PSF网格及其与均值的差异。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 从字典中获取指定的PSF模型网格</span>
<span class="n">griddedpsfmodel</span> <span class="o">=</span> <span class="n">dict_psfs_stpsf</span><span class="p">[</span><span class="n">dets_short</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">filts_short</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;psf model grid&#39;</span><span class="p">]</span>

<span class="c1"># 绘制PSF模型网格，并设置图形大小为10x10英寸</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">griddedpsfmodel</span><span class="o">.</span><span class="n">plot_grid</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 使用griddedpsfmodel对象绘制网格图，设置图像大小为10x10</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">griddedpsfmodel</span><span class="o">.</span><span class="n">plot_grid</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">deltas</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">vmax_scale</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="ii-effective-psf-epsf">
<h2>II. 创建有效点扩散函数模型 (Effective PSF, ePSF)<a class="headerlink" href="#ii-effective-psf-epsf" title="Link to this heading">#</a></h2>
<p>有关 photutils 有效点扩散函数的更多信息，请参见 <a class="reference external" href="https://photutils.readthedocs.io/en/stable/user_guide/epsf.html">这里</a>。</p>
<ul class="simple">
<li><p>从我们想要用于构建点扩散函数 (PSF) 的图像中选择恒星。我们使用 <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.detection.DAOStarFinder.html">DAOStarFinder</a> 函数在图像中查找亮星（设置较高的检测阈值）。 <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.detection.DAOStarFinder.html#photutils.detection.DAOStarFinder">DAOStarFinder</a> 使用 DAOFIND (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1987PASP...99..191S/abstract">Stetson 1987</a>) 算法在图像中检测恒星。DAOFIND 在图像中搜索局部密度最大值，这些最大值的峰值幅度大于 <code class="docutils literal notranslate"><span class="pre">threshold</span></code>（大约；阈值应用于卷积图像），并且具有与定义的二维高斯核相似的大小和形状。</p></li>
</ul>
<p><strong>注意</strong>：阈值和与最近邻的最大距离取决于用户的科学案例（即视场中的恒星数量、拥挤程度、亮源数量、构建 ePSF 所需的最小恒星数量等），必须相应地进行修改。</p>
<ul class="simple">
<li><p>使用 <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.EPSFBuilder.html#photutils.psf.EPSFBuilder">EPSBuilder</a> 函数构建有效点扩散函数（排除边界框超出探测器边缘的物体）。</p></li>
</ul>
<p>我们创建一个字典，包含上述选择的探测器和滤光片的有效点扩散函数（PSF）。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_psfs_epsf</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化一个空字典，用于存储PSF和ePSF数据</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短名称的探测器列表</span>

    <span class="n">dict_psfs_epsf</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 为每个探测器设置一个空字典，如果不存在则创建</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短名称的滤光片列表，并获取索引</span>

        <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 为每个滤光片设置一个空字典，如果不存在则创建</span>

        <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;table psf stars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化表格PSF星体的字典</span>

        <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;epsf single&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化单个ePSF的字典</span>

        <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;epsf grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化ePSF网格的字典</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历图像列表的索引</span>

            <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;table psf stars&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 为表格PSF星体分配None值</span>

            <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;epsf single&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 为单个ePSF分配None值</span>

            <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;epsf grid&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 为ePSF网格分配None值</span>
</pre></div>
</div>
</div>
</div>
<p>请注意，来自处理管道的二级（Level-2）和三级（Level-3）图像的单位是 MJy/sr（因此是表面亮度）。图像的实际单位可以通过头文件关键字 <strong>BUNIT</strong> 进行检查。标量转换常数被复制到头文件关键字 <strong>PHOTMJSR</strong>，该关键字提供了从 DN/s 到 MJy/立体角的转换。对于我们的分析，我们将数据转换回 DN/s。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_stars_epsf</span><span class="p">(</span><span class="n">img_num</span><span class="p">,</span> <span class="n">filt_num</span><span class="p">,</span> <span class="n">det</span><span class="o">=</span><span class="s1">&#39;NRCA1&#39;</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">&#39;F070W&#39;</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># 定义函数，查找图像中的PSF星星</span>

    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>  <span class="c1"># 初始化背景噪声计算类</span>
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>  <span class="c1"># 初始化背景计算类</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="n">img_num</span><span class="p">])</span>  <span class="c1"># 打开指定图像文件</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>  <span class="c1"># 获取图像头信息</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finding PSF stars on image </span><span class="si">{</span><span class="n">img_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> of filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">, detector </span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印当前处理的图像信息</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span>  <span class="c1"># 将数据转换为DN/s</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span>  <span class="c1"># 获取数据单位</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversion factor from </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2"> to DN/s for filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印转换因子</span>

    <span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf fwhm&#39;</span><span class="p">]</span>  <span class="c1"># 获取PSF的FWHM值</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FWHM for the filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">sigma_psf</span><span class="si">}</span><span class="s2"> px&quot;</span><span class="p">)</span>  <span class="c1"># 打印FWHM值</span>

    <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 计算背景噪声的标准差</span>
    <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 计算背景值</span>

    <span class="c1"># 初始化DAOStarFinder以查找星星</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">th</span><span class="p">[</span><span class="n">filt_num</span><span class="p">]</span> <span class="o">*</span> <span class="n">std</span> <span class="o">+</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>

    <span class="n">psf_stars</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 查找星星并返回结果</span>
    <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;table psf stars&#39;</span><span class="p">][</span><span class="n">img_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stars</span>  <span class="c1"># 将结果存入字典</span>

    <span class="k">if</span> <span class="n">dist_sel</span><span class="p">:</span>  <span class="c1"># 如果选择计算距离</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating closest neighbour distance&quot;</span><span class="p">)</span>  <span class="c1"># 打印正在计算最近邻距离</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化距离列表</span>

        <span class="c1"># 初始化DAOStarFinder以查找所有星星</span>
        <span class="n">daofind_tot</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">std</span> <span class="o">+</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                                    <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>

        <span class="n">stars_tot</span> <span class="o">=</span> <span class="n">daofind_tot</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 查找所有星星</span>

        <span class="n">x_tot</span> <span class="o">=</span> <span class="n">stars_tot</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span>  <span class="c1"># 获取所有星星的x坐标</span>
        <span class="n">y_tot</span> <span class="o">=</span> <span class="n">stars_tot</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span>  <span class="c1"># 获取所有星星的y坐标</span>

        <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">psf_stars</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">psf_stars</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]):</span>  <span class="c1"># 遍历PSF星星</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化分离距离列表</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x_tot</span> <span class="o">-</span> <span class="n">xx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_tot</span> <span class="o">-</span> <span class="n">yy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 计算与所有星星的距离</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 找到最近的星星距离</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>  <span class="c1"># 将距离添加到列表中</span>

        <span class="n">psf_stars</span><span class="p">[</span><span class="s1">&#39;min distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>  <span class="c1"># 将最小距离添加到PSF星星表中</span>
        <span class="n">mask_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">psf_stars</span><span class="p">[</span><span class="s1">&#39;min distance&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">filt_num</span><span class="p">])</span>  <span class="c1"># 创建掩码以筛选星星</span>

        <span class="n">psf_stars</span> <span class="o">=</span> <span class="n">psf_stars</span><span class="p">[</span><span class="n">mask_dist</span><span class="p">]</span>  <span class="c1"># 应用掩码筛选星星</span>
        <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;table psf stars&#39;</span><span class="p">][</span><span class="n">img_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stars</span>  <span class="c1"># 更新字典中的结果</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum distance required:&quot;</span><span class="p">,</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">filt_num</span><span class="p">],</span> <span class="s2">&quot;px&quot;</span><span class="p">)</span>  <span class="c1"># 打印所需的最小距离</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of isolated sources found in the image used to build ePSF for </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">psf_stars</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印找到的孤立源数量</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------------------------------&quot;</span><span class="p">)</span>  <span class="c1"># 打印分隔线</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># 如果不计算距离</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of sources used to build ePSF for </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">psf_stars</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印用于构建ePSF的源数量</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------------------&quot;</span><span class="p">)</span>  <span class="c1"># 打印分隔线</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

<span class="n">th</span> <span class="o">=</span> <span class="p">[</span><span class="mi">700</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>  <span class="c1"># 两个滤波器的阈值水平（长度必须与分析的滤波器数量匹配）</span>

<span class="n">min_sep</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># ePSF星星与最近邻星星之间可接受的最小间隔</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短时间检测器列表</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短时间滤波器列表，并获取索引</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历当前检测器和滤波器的图像列表</span>

            <span class="n">find_stars_epsf</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 调用函数查找ePSF星星</span>

<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed Time for finding stars:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>  <span class="c1"># 输出查找星星所用的时间</span>
</pre></div>
</div>
</div>
</div>
<section id="ii-psf">
<h3>II. 构建有效的点扩散函数 (PSF)<a class="headerlink" href="#ii-psf" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">build_epsf</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">&#39;NRCA1&#39;</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">&#39;F070W&#39;</span><span class="p">):</span>
    <span class="c1"># 创建一个函数来构建电子点扩散函数（ePSF）</span>

    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>  <span class="c1"># 初始化背景估计器</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 打开指定探测器和滤光片的图像文件</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>  <span class="c1"># 获取图像头信息</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span>  <span class="c1"># 将数据标准化为每平方弧秒的光度</span>

    <span class="n">hsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># 计算半尺寸</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;table psf stars&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span>  <span class="c1"># 获取星星的x坐标</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;table psf stars&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span>  <span class="c1"># 获取星星的y坐标</span>

    <span class="c1"># 创建掩码，筛选出在图像有效范围内的星星</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">hsize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">hsize</span><span class="p">))</span> <span class="o">&amp;</span> 
            <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">hsize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">hsize</span><span class="p">)))</span>

    <span class="n">stars_tbl</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>  <span class="c1"># 创建一个表格来存储星星信息</span>
    <span class="n">stars_tbl</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>  <span class="c1"># 将符合条件的x坐标存入表格</span>
    <span class="n">stars_tbl</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>  <span class="c1"># 将符合条件的y坐标存入表格</span>

    <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 计算背景</span>

    <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 复制数据以进行背景减法</span>
    <span class="n">data_bkgsub</span> <span class="o">-=</span> <span class="n">bkg</span>  <span class="c1"># 从数据中减去背景</span>

    <span class="n">nddata</span> <span class="o">=</span> <span class="n">NDData</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_bkgsub</span><span class="p">)</span>  <span class="c1"># 创建NDData对象以存储背景减去后的数据</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">extract_stars</span><span class="p">(</span><span class="n">nddata</span><span class="p">,</span> <span class="n">stars_tbl</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>  <span class="c1"># 提取星星</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating ePSF for image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> of filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">, detector </span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印当前处理的信息</span>

    <span class="n">epsf_builder</span> <span class="o">=</span> <span class="n">EPSFBuilder</span><span class="p">(</span><span class="n">oversampling</span><span class="o">=</span><span class="n">oversample</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 初始化ePSF构建器</span>

    <span class="n">epsf</span><span class="p">,</span> <span class="n">fitted_stars</span> <span class="o">=</span> <span class="n">epsf_builder</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>  <span class="c1"># 构建ePSF并获取拟合的星星</span>
    <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;epsf single&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf</span>  <span class="c1"># 将构建的ePSF存入字典</span>
</pre></div>
</div>
</div>
</div>
<p><strong>注意</strong>：在这里我们将最大迭代次数限制为3次（以限制运行时间），但实际上应该使用大约10次或更多的迭代。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

<span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span>  <span class="c1"># 每个PSF星体的切割区域大小 - 必须与分析的滤光片数量匹配</span>

<span class="n">oversample</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># 过采样因子</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短时间内的探测器</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短时间内的滤光片</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历每个图像</span>

            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>  <span class="c1"># 捕获警告</span>

                <span class="c1"># 忽略关于星体靠近图像边缘的警告</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">AstropyUserWarning</span><span class="p">)</span> 

                <span class="n">build_epsf</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">)</span>  <span class="c1"># 构建有效的PSF</span>

<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time to build the Effective PSF:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>  <span class="c1"># 输出构建有效PSF所需的时间</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="epsfs">
<h2>显示ePSFs<a class="headerlink" href="#epsfs" title="Link to this heading">#</a></h2>
<p>我们仅为每个滤光片显示1个ePSF。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>  <span class="c1"># 创建一个包含2列的子图，图像大小为14x14</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短名称的探测器列表</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短名称的滤光片列表，并获取索引i</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;epsf single&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 从字典中获取对应探测器和滤光片的图像数据</span>

        <span class="n">norm_epsf</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>  <span class="c1"># 使用对数归一化方法对图像进行归一化，99%分位数</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_epsf</span><span class="p">)</span>  <span class="c1"># 在第i个子图中显示归一化后的图像</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置子图标题为当前滤光片名称，使用font2字体字典</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id11">
<h2>进行中的工作 - 构建有效的PSF网格<a class="headerlink" href="#id11" title="Link to this heading">#</a></h2>
<p>两个函数：</p>
<ul class="simple">
<li><p>统计网格中的PSF星星数量</p></li>
<li><p>创建网格化的ePSF</p></li>
</ul>
<p>第一个函数的目的是统计在用户定义的网格编号N所划分的每个子区域中有多少个良好的PSF星星。该函数应从用户提供的数字开始，并迭代直到最小网格大小为2x2。根据用户希望在网格每个单元中包含的PSF星星数量，他们可以选择合适的网格大小或修改星星检测的阈值，这些阈值是在创建单个ePSF时选择的（见上面的<strong>寻找星星</strong>单元）。</p>
<p>第二个函数使用EPSFBuilder创建PSF网格。该函数将返回一个GriddedEPSFModel对象，其中包含一个N × n × n的3D数组。该3D数组表示创建的N个2D n × n ePSF。它应包括一个grid_xypos键，该键将指明每个PSF在探测器上的位置。grid_xypos中的元组顺序对应于3D数组中PSF的编号。</p>
<section id="i-psf">
<h3>I. 统计网格中每个区域的PSF星星数量<a class="headerlink" href="#i-psf" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">count_PSFstars_grid</span><span class="p">(</span><span class="n">grid_points</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">min_numpsf</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
    <span class="c1"># 定义一个函数，用于计算给定网格中PSF星星的数量</span>

    <span class="n">num_grid_calc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">grid_points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个从2到grid_points的数组</span>
    <span class="n">num_grid_calc</span> <span class="o">=</span> <span class="n">num_grid_calc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 将数组反转</span>

    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">num_grid_calc</span><span class="p">:</span>  <span class="c1"># 遍历每个网格大小</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating the number of PSF stars in a </span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2"> grid&quot;</span><span class="p">)</span>  <span class="c1"># 打印当前计算的网格大小</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 打开指定的图像文件</span>
        <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>

        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">((</span><span class="n">data_sb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">num</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 计算每个网格的点数</span>
        <span class="n">x_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">points</span> <span class="o">*</span> <span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">points</span><span class="p">)</span>  <span class="c1"># 计算x轴中心点</span>
        <span class="n">y_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">points</span> <span class="o">*</span> <span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">points</span><span class="p">)</span>  <span class="c1"># 计算y轴中心点</span>

        <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建中心点的网格坐标</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">centers</span><span class="p">):</span>  <span class="c1"># 遍历每个中心点</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;table psf stars&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span>  <span class="c1"># 获取PSF星星的x坐标</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;table psf stars&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span>  <span class="c1"># 获取PSF星星的y坐标</span>
            <span class="c1"># flux = dict_psfs_epsf[det][filt][&#39;table psf stars&#39;][i + 1][&#39;flux&#39;]  # 获取PSF星星的flux（注释掉）</span>

            <span class="n">half_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># 计算网格的一半大小</span>

            <span class="n">lim1</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span> <span class="o">+</span> <span class="n">half_size</span>  <span class="c1"># 计算x轴的下限</span>
            <span class="n">lim2</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">points</span> <span class="o">-</span> <span class="n">half_size</span>  <span class="c1"># 计算x轴的上限</span>
            <span class="n">lim3</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span> <span class="o">+</span> <span class="n">half_size</span>  <span class="c1"># 计算y轴的下限</span>
            <span class="n">lim4</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">points</span> <span class="o">-</span> <span class="n">half_size</span>  <span class="c1"># 计算y轴的上限</span>

            <span class="n">test</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">lim1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">lim2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">lim3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">lim4</span><span class="p">)</span>  <span class="c1"># 检查PSF星星是否在当前网格内</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_numpsf</span><span class="p">:</span>  <span class="c1"># 如果当前网格内的PSF星星数量少于最小要求</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Center Coordinates of grid cell </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> are (</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">) --- Not enough PSF stars in the cell (number of PSF stars &lt; </span><span class="si">{</span><span class="n">min_numpsf</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>  <span class="c1"># 打印不足的提示</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># 如果当前网格内的PSF星星数量满足要求</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Center Coordinate of grid cell </span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> are (</span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">) --- Number of PSF stars: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印满足的提示</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短列表中的每个探测器</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短列表中的每个滤光片，并获取其索引</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历当前探测器和滤光片下的每个图像</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> of filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">, detector </span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印当前正在分析的图像信息</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行以便于阅读</span>

            <span class="n">count_PSFstars_grid</span><span class="p">(</span><span class="n">grid_points</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">min_numpsf</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>  <span class="c1"># 计算PSF星星的网格</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="todo-epsf">
<h2>TODO - 创建ePSF网格<a class="headerlink" href="#todo-epsf" title="Link to this heading">#</a></h2>
<p>以下是创建 ePSF 网格的函数，可以将其保存到 epsf 字典中。</p>
</section>
<section id="todo-epsf-stpsf">
<h2>TODO - 使用 ePSF 网格来扰动 STPSF 模型<a class="headerlink" href="#todo-epsf-stpsf" title="Link to this heading">#</a></h2>
<p>以下是创建一个PSF模型网格的函数，该网格是通过对上述创建的ePSF网格进行扰动得到的STPSF PSF模型。</p>
</section>
<section id="id12">
<h2>执行PSF光度测量<a class="headerlink" href="#id12" title="Link to this heading">#</a></h2>
<p>我们对图像执行PSF光度测量，默认情况下将输出目录和残差图像保存在下面创建的字典中。也可以使用参数<code class="docutils literal notranslate"><span class="pre">save_output</span></code>和<code class="docutils literal notranslate"><span class="pre">save_residuals</span></code>将输出目录（pickle pandas对象）和残差图像（fits文件）保存在当前目录中。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_phot</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化一个空字典，用于存储光度数据</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短名称的探测器列表</span>

    <span class="n">dict_phot</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 为每个探测器设置一个空字典，如果不存在则创建</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短名称的滤光片列表，并获取索引</span>

        <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 为每个滤光片设置一个空字典，如果不存在则创建</span>

        <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;residual images&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化残差图像字典</span>

        <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;output photometry tables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化输出光度表字典</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历当前探测器和滤光片的图像列表</span>

            <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;residual images&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 为每个图像索引初始化残差图像为None</span>

            <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;output photometry tables&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 为每个图像索引初始化输出光度表为None</span>
</pre></div>
</div>
</div>
</div>
<p><strong>注意</strong>：为了加快笔记本的运行速度，我们在查找算法中使用了一个较高的阈值（阈值 ~ 2000），并且在下面的分析中，我们将使用从之前的减缩运行中获得的sigma阈值 = 10的目录。为了进行有意义的数据减缩，用户应相应地修改阈值。</p>
<p>在这里，我们使用STPSF PSF的网格作为PSF模型，但用户可以更改模型并使用其他可用的模型（即，单个STPSF PSF，单个ePSF），通过修改函数中的<code class="docutils literal notranslate"><span class="pre">psf</span></code>参数。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">psf_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">&#39;NRCA1&#39;</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">&#39;F070W&#39;</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">psf</span><span class="o">=</span><span class="s1">&#39;grid_stpsf&#39;</span><span class="p">,</span> <span class="n">save_residuals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># 定义函数 psf_phot，接受多个参数，包括探测器、滤光片、阈值、PSF类型等</span>

    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>  <span class="c1"># 创建背景噪声标准差计算对象</span>
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>  <span class="c1"># 创建背景计算对象</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>  <span class="c1"># 创建最小二乘拟合器</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 打开指定探测器和滤光片的图像</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>  <span class="c1"># 获取图像头信息</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">]</span>  <span class="c1"># 获取探测器信息</span>
    <span class="n">prim_dith_pos</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;PATT_NUM&#39;</span><span class="p">]</span>  <span class="c1"># 获取主偏移位置</span>
    <span class="n">prim_dith_num</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NUMDTHPT&#39;</span><span class="p">]</span>  <span class="c1"># 获取主偏移点数量</span>
    <span class="n">subpx_dith_pos</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SUBPXNUM&#39;</span><span class="p">]</span>  <span class="c1"># 获取子像素偏移位置</span>
    <span class="n">subpx_dith_num</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SUBPXPNS&#39;</span><span class="p">]</span>  <span class="c1"># 获取子像素偏移点数量</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span>  <span class="c1"># 将数据转换为DN/s单位</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span>  <span class="c1"># 获取数据单位</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversion factor from </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2"> to DN/s for filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印转换因子</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying conversion to the data&quot;</span><span class="p">)</span>  <span class="c1"># 打印正在应用转换</span>

    <span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf fwhm&#39;</span><span class="p">]</span>  <span class="c1"># 获取PSF的全宽半最大值</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FWHM for the filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">sigma_psf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印FWHM值</span>

    <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 计算数据的背景噪声标准差</span>
    <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 计算数据的背景值</span>

    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">th</span> <span class="o">*</span> <span class="n">std</span> <span class="o">+</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>  <span class="c1"># 创建星源查找器</span>

    <span class="n">grouper</span> <span class="o">=</span> <span class="n">SourceGrouper</span><span class="p">(</span><span class="mf">5.0</span> <span class="o">*</span> <span class="n">sigma_psf</span><span class="p">)</span>  <span class="c1"># 创建源分组器</span>

    <span class="c1"># grid PSF</span>
    <span class="k">if</span> <span class="n">psf</span> <span class="o">==</span> <span class="s1">&#39;grid_stpsf&#39;</span><span class="p">:</span>  <span class="c1"># 如果选择网格PSF</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using as PSF model STPSF PSFs grid&quot;</span><span class="p">)</span>  <span class="c1"># 打印使用网格PSF模型</span>
        <span class="n">psf_model</span> <span class="o">=</span> <span class="n">dict_psfs_stpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf model grid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 复制网格PSF模型</span>

    <span class="c1"># single psf:</span>
    <span class="k">if</span> <span class="n">psf</span> <span class="o">==</span> <span class="s1">&#39;single_stpsf&#39;</span><span class="p">:</span>  <span class="c1"># 如果选择单个PSF</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using as PSF model STPSF single PSF&quot;</span><span class="p">)</span>  <span class="c1"># 打印使用单个PSF模型</span>
        <span class="n">psf_model</span> <span class="o">=</span> <span class="n">dict_psfs_stpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf model single&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 复制单个PSF模型</span>

    <span class="c1"># epsf:</span>
    <span class="k">if</span> <span class="n">psf</span> <span class="o">==</span> <span class="s1">&#39;single_epsf&#39;</span><span class="p">:</span>  <span class="c1"># 如果选择单个ePSF</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using as PSF model single ePSF&quot;</span><span class="p">)</span>  <span class="c1"># 打印使用单个ePSF模型</span>
        <span class="n">psf_model</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;epsf single&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 复制单个ePSF模型</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performing the photometry on image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> of filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">, detector </span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印正在进行光度测量的信息</span>

    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

    <span class="n">data_sub</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 从数据中减去背景</span>
    <span class="n">psf_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>  <span class="c1"># 定义PSF形状</span>

    <span class="n">phot</span> <span class="o">=</span> <span class="n">IterativePSFPhotometry</span><span class="p">(</span><span class="n">psf_model</span><span class="p">,</span> <span class="n">psf_shape</span><span class="p">,</span> <span class="n">daofind</span><span class="p">,</span>
                                  <span class="n">grouper</span><span class="o">=</span><span class="n">grouper</span><span class="p">,</span> <span class="n">fitter</span><span class="o">=</span><span class="n">fitter</span><span class="p">,</span>
                                  <span class="n">fitter_maxiters</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                  <span class="n">maxiters</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">aperture_radius</span><span class="o">=</span><span class="n">ap_radius</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>  <span class="c1"># 创建迭代PSF光度测量对象</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">phot</span><span class="p">(</span><span class="n">data_sub</span><span class="p">)</span>  <span class="c1"># 执行光度测量</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>

    <span class="n">dtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>  <span class="c1"># 计算光度测量所需时间</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time needed to perform photometry on image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">dtime</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>  <span class="c1"># 打印所需时间</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of sources detected in image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> for filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 打印检测到的源数量</span>

    <span class="n">residual_image</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">make_residual_image</span><span class="p">(</span><span class="n">data_sub</span><span class="p">,</span> <span class="n">psf_shape</span><span class="o">=</span><span class="n">psf_shape</span><span class="p">)</span>  <span class="c1"># 创建残差图像</span>

    <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;residual images&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">residual_image</span>  <span class="c1"># 保存残差图像</span>
    <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;output photometry tables&#39;</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>  <span class="c1"># 保存光度测量结果</span>

    <span class="c1"># save the residual images as fits file:</span>
    <span class="k">if</span> <span class="n">save_residuals</span><span class="p">:</span>  <span class="c1"># 如果选择保存残差图像</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">residual_image</span><span class="p">)</span>  <span class="c1"># 创建FITS主HDU</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu</span><span class="p">])</span>  <span class="c1"># 创建HDU列表</span>
        <span class="n">residual_outname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;residual_</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">_STPSF_gridPSF_</span><span class="si">{</span><span class="n">prim_dith_pos</span><span class="si">}</span><span class="s1">of</span><span class="si">{</span><span class="n">prim_dith_num</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">subpx_dith_pos</span><span class="si">}</span><span class="s1">of</span><span class="si">{</span><span class="n">subpx_dith_num</span><span class="si">}</span><span class="s1">.fits&#39;</span>  <span class="c1"># 定义输出文件名</span>

        <span class="n">dir_output_phot</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>  <span class="c1"># 定义输出目录</span>

        <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_output_phot</span><span class="p">,</span> <span class="n">residual_outname</span><span class="p">))</span>  <span class="c1"># 写入FITS文件</span>
        <span class="n">outname</span> <span class="o">=</span> <span class="s1">&#39;phot_</span><span class="si">{d}</span><span class="s1">_</span><span class="si">{filt}</span><span class="s1">_STPSF_gridPSF_level2_</span><span class="si">{prim_dith_pos}</span><span class="s1">of</span><span class="si">{prim_dith_num}</span><span class="s1">_</span><span class="si">{subpx_dith_pos}</span><span class="s1">of</span><span class="si">{subpx_dith_num}</span><span class="s1">.pkl&#39;</span>  <span class="c1"># 定义光度测量结果文件名</span>

    <span class="c1"># save the output photometry Tables</span>
    <span class="k">if</span> <span class="n">save_output</span><span class="p">:</span>  <span class="c1"># 如果选择保存光度测量结果</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>  <span class="c1"># 将结果转换为Pandas DataFrame</span>
        <span class="n">tab</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_output_phot</span><span class="p">,</span> <span class="n">outname</span><span class="p">))</span>  <span class="c1"># 保存为pickle文件</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tic_tot</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

<span class="n">ap_radius</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">]</span>  <span class="c1"># 光圈半径，必须与分析的滤波器数量匹配</span>

<span class="c1"># 检查当前目录是否存在残差图像文件</span>
<span class="k">if</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./*residual*.fits&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting Residual images from directory&quot;</span><span class="p">)</span>  <span class="c1"># 打印删除信息</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./residual*.fits&#39;</span><span class="p">)</span>  <span class="c1"># 获取所有残差图像文件</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>  <span class="c1"># 删除每个残差图像文件</span>

<span class="c1"># 遍历短名称探测器</span>
<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="c1"># 遍历短名称滤波器</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="c1"># 遍历当前探测器和滤波器的图像数量</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># 调用psf_phot函数进行光度测量</span>
            <span class="n">psf_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">psf</span><span class="o">=</span><span class="s1">&#39;grid_stpsf&#39;</span><span class="p">,</span> <span class="n">save_residuals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 

<span class="n">toc_tot</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>

<span class="n">number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filts_short</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">])</span>  <span class="c1"># 计算处理的图像总数</span>
<span class="n">dtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">toc_tot</span> <span class="o">-</span> <span class="n">tic_tot</span><span class="p">)</span>  <span class="c1"># 计算总耗时</span>

<span class="c1"># 打印处理所有图像所耗费的时间</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time elapsed to perform the photometry of the </span><span class="si">{</span><span class="n">number</span><span class="si">}</span><span class="s2"> images: </span><span class="si">{</span><span class="n">dtime</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id13">
<h2>输出光度表<a class="headerlink" href="#id13" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 访问字典 dict_phot 中的 NRCB1 关键字</span>
<span class="n">dict_phot</span><span class="p">[</span><span class="s1">&#39;NRCB1&#39;</span><span class="p">]</span>  <span class="c1"># 获取 NRCB1 的数据</span>

<span class="c1"># 在 NRCB1 中访问 F115W 关键字</span>
<span class="n">dict_phot</span><span class="p">[</span><span class="s1">&#39;NRCB1&#39;</span><span class="p">][</span><span class="s1">&#39;F115W&#39;</span><span class="p">]</span>  <span class="c1"># 获取 F115W 的数据</span>

<span class="c1"># 访问 output photometry tables 关键字</span>
<span class="n">dict_phot</span><span class="p">[</span><span class="s1">&#39;NRCB1&#39;</span><span class="p">][</span><span class="s1">&#39;F115W&#39;</span><span class="p">][</span><span class="s1">&#39;output photometry tables&#39;</span><span class="p">]</span>  <span class="c1"># 获取输出光度表的数据</span>

<span class="c1"># 获取 output photometry tables 中的第二个元素（索引为1）</span>
<span class="n">dict_phot</span><span class="p">[</span><span class="s1">&#39;NRCB1&#39;</span><span class="p">][</span><span class="s1">&#39;F115W&#39;</span><span class="p">][</span><span class="s1">&#39;output photometry tables&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 返回第二个光度表</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id14">
<h2>显示减法图像<a class="headerlink" href="#id14" title="Link to this heading">#</a></h2>
<p>作为一个示例，我们展示了一个科学图像与经过数据处理后的残差图像之间的比较，适用于两个滤光器。请注意，残差图像是通过在上面的单元中进行光度测量（photometry）时使用非常高的检测阈值（detection threshold）获得的。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>  <span class="c1"># 创建一个2x2的子图，图像大小为14x14英寸</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短名称的探测器</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短名称的滤镜，并获取索引</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 打开对应探测器和滤镜的图像文件</span>

        <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>  <span class="c1"># 计算归一化参数，使用平方根法和99%的百分位数</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">)</span>  <span class="c1"># 在第一个子图中显示图像数据，使用灰度色图</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X [px]&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置X轴标签</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y [px]&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置Y轴标签</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置子图标题为滤镜名称</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短名称的探测器</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短名称的滤镜，并获取索引</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;residual images&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 获取对应探测器和滤镜的残差图像数据</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>  <span class="c1"># 计算归一化参数，使用平方根法和99%的百分位数</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">)</span>  <span class="c1"># 在第二个子图中显示残差图像数据，使用灰度色图</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X [px]&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置X轴标签</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y [px]&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置Y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图布局以避免重叠</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id15">
<h2>第二部分 - 数据分析<a class="headerlink" href="#id15" title="Link to this heading">#</a></h2>
<p><strong>注意</strong>：在这里，我们使用通过STPSF PSF网格获得的降噪结果作为PSF模型。用户可以使用不同的PSF模型（单一PSF模型、PSF网格等）进行数据分析，并比较结果。</p>
</section>
<section id="id16">
<h2>加载具有点扩散函数（PSF）光度的表格<a class="headerlink" href="#id16" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 如果当前目录下没有符合条件的文件</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./*phot*gridPSF*.pkl&#39;</span><span class="p">):</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading Photometry Output&quot;</span><span class="p">)</span>  <span class="c1"># 打印下载提示</span>

    <span class="c1"># F115W波段的光度数据链接</span>
    <span class="n">boxlink_cat_f115w</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/phot_cat_F115W.tar.gz&#39;</span>
    <span class="n">boxfile_cat_f115w</span> <span class="o">=</span> <span class="s1">&#39;./phot_cat_F115W.tar.gz&#39;</span>  <span class="c1"># 下载后的文件名</span>

    <span class="c1"># 下载F115W数据</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_cat_f115w</span><span class="p">,</span> <span class="n">boxfile_cat_f115w</span><span class="p">)</span>

    <span class="c1"># 打开下载的tar文件</span>
    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile_cat_f115w</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>  <span class="c1"># 解压到指定目录</span>

    <span class="c1"># F200W波段的光度数据链接</span>
    <span class="n">boxlink_cat_f200w</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/phot_cat_F200W.tar.gz&#39;</span>
    <span class="n">boxfile_cat_f200w</span> <span class="o">=</span> <span class="s1">&#39;./phot_cat_F200W.tar.gz&#39;</span>  <span class="c1"># 下载后的文件名</span>

    <span class="c1"># 下载F200W数据</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_cat_f200w</span><span class="p">,</span> <span class="n">boxfile_cat_f200w</span><span class="p">)</span>

    <span class="c1"># 打开下载的tar文件</span>
    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile_cat_f200w</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>  <span class="c1"># 解压到指定目录</span>

    <span class="n">cat_dir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>  <span class="c1"># 数据目录</span>

    <span class="c1"># 获取F115W和F200W波段的光度数据文件列表</span>
    <span class="n">phots_pkl_f115w</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_dir</span><span class="p">,</span> <span class="s1">&#39;*F115W*gridPSF*.pkl&#39;</span><span class="p">)))</span>
    <span class="n">phots_pkl_f200w</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_dir</span><span class="p">,</span> <span class="s1">&#39;*F200W*gridPSF*.pkl&#39;</span><span class="p">)))</span>                       

<span class="k">else</span><span class="p">:</span>
    <span class="n">cat_dir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>  <span class="c1"># 数据目录</span>

    <span class="c1"># 获取F115W和F200W波段的光度数据文件列表</span>
    <span class="n">phots_pkl_f115w</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_dir</span><span class="p">,</span> <span class="s1">&#39;*F115W*gridPSF*.pkl&#39;</span><span class="p">)))</span>
    <span class="n">phots_pkl_f200w</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_dir</span><span class="p">,</span> <span class="s1">&#39;*F200W*gridPSF*.pkl&#39;</span><span class="p">)))</span>                      

<span class="n">results_f115w</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 存储F115W结果的列表</span>
<span class="n">results_f200w</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 存储F200W结果的列表</span>

<span class="c1"># 遍历F115W和F200W的光度数据文件</span>
<span class="k">for</span> <span class="n">phot_pkl_f115w</span><span class="p">,</span> <span class="n">phot_pkl_f200w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">phots_pkl_f115w</span><span class="p">,</span> <span class="n">phots_pkl_f200w</span><span class="p">):</span>
    
    <span class="n">ph_f115w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">phot_pkl_f115w</span><span class="p">)</span>  <span class="c1"># 读取F115W数据</span>
    <span class="n">ph_f200w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">phot_pkl_f200w</span><span class="p">)</span>  <span class="c1"># 读取F200W数据</span>

    <span class="n">result_f115w</span> <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">ph_f115w</span><span class="p">)</span>  <span class="c1"># 将F115W数据转换为QTable格式</span>
    <span class="n">result_f200w</span> <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">ph_f200w</span><span class="p">)</span>  <span class="c1"># 将F200W数据转换为QTable格式</span>

    <span class="n">results_f115w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_f115w</span><span class="p">)</span>  <span class="c1"># 将结果添加到列表中</span>
    <span class="n">results_f200w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_f200w</span><span class="p">)</span>  <span class="c1"># 将结果添加到列表中</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="datamodel">
<h2>将图像转换为数据模型（DataModel）<a class="headerlink" href="#datamodel" title="Link to this heading">#</a></h2>
<p>为了分配WCS坐标并进行图像的交叉匹配，我们需要将图像转换为数据模型（DataModel）。坐标是在JWST管道的步骤<a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/stable/jwst/assign_wcs/main.html?#using-the-wcs-interactively">assign_wcs</a>中分配的，这使我们能够对每个滤光片获得的不同目录进行交叉匹配。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">images_f115w</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化F115W图像列表</span>

<span class="n">images_f200w</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化F200W图像列表</span>

<span class="c1"># 遍历F115W图像字典中的每个图像</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="s1">&#39;NRCB1&#39;</span><span class="p">][</span><span class="s1">&#39;F115W&#39;</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>
    
    <span class="c1"># 创建F115W图像模型</span>
    <span class="n">image_f115w</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="s1">&#39;NRCB1&#39;</span><span class="p">][</span><span class="s1">&#39;F115W&#39;</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    
    <span class="c1"># 将图像模型添加到F115W图像列表中</span>
    <span class="n">images_f115w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_f115w</span><span class="p">)</span>
        

<span class="c1"># 遍历F200W图像字典中的每个图像</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="s1">&#39;NRCB1&#39;</span><span class="p">][</span><span class="s1">&#39;F200W&#39;</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>
    
    <span class="c1"># 创建F200W图像模型</span>
    <span class="n">image_f200w</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="s1">&#39;NRCB1&#39;</span><span class="p">][</span><span class="s1">&#39;F200W&#39;</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    
    <span class="c1"># 将图像模型添加到F200W图像列表中</span>
    <span class="n">images_f200w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_f200w</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id17">
<h2>对两个滤镜的四幅图像进行目录交叉匹配<a class="headerlink" href="#id17" title="Link to this heading">#</a></h2>
<p>我们对目录进行交叉匹配，以获得单一的颜色-星等图（color-magnitude diagrams）。</p>
<p>如果匹配之间的距离小于 0.5 像素（px），则将两个滤镜中的星体关联起来。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_clean_f115w</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化F115W清理结果列表</span>

<span class="n">results_clean_f200w</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化F200W清理结果列表</span>

<span class="c1"># 遍历F115W和F200W图像的索引</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">images_f115w</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>

    <span class="c1"># 创建F115W的掩码，筛选有效的x_fit, y_fit和flux_fit</span>
    <span class="n">mask_f115w</span> <span class="o">=</span> <span class="p">((</span><span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;x_fit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;x_fit&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;y_fit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;y_fit&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># 根据掩码过滤F115W结果</span>
    <span class="n">result_clean_f115w</span> <span class="o">=</span> <span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask_f115w</span><span class="p">]</span>

    <span class="c1"># 使用WCS转换获取F115W的RA和Dec</span>
    <span class="n">ra_f115w</span><span class="p">,</span> <span class="n">dec_f115w</span> <span class="o">=</span> <span class="n">images_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">result_clean_f115w</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">],</span> <span class="n">result_clean_f115w</span><span class="p">[</span><span class="s1">&#39;y_fit&#39;</span><span class="p">])</span>

    <span class="c1"># 创建SkyCoord对象以存储RA和Dec</span>
    <span class="n">radec_f115w</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra_f115w</span><span class="p">,</span> <span class="n">dec_f115w</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>

    <span class="c1"># 将RA和Dec添加到清理结果中</span>
    <span class="n">result_clean_f115w</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec_f115w</span>

    <span class="c1"># 将清理后的结果添加到F115W结果列表中</span>
    <span class="n">results_clean_f115w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_clean_f115w</span><span class="p">)</span>

    <span class="c1"># 创建F200W的掩码，筛选有效的x_fit, y_fit和flux_fit</span>
    <span class="n">mask_f200w</span> <span class="o">=</span> <span class="p">((</span><span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;x_fit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;x_fit&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;y_fit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;y_fit&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># 根据掩码过滤F200W结果</span>
    <span class="n">result_clean_f200w</span> <span class="o">=</span> <span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask_f200w</span><span class="p">]</span>

    <span class="c1"># 使用WCS转换获取F200W的RA和Dec</span>
    <span class="n">ra_f200w</span><span class="p">,</span> <span class="n">dec_f200w</span> <span class="o">=</span> <span class="n">images_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">result_clean_f200w</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">],</span> <span class="n">result_clean_f200w</span><span class="p">[</span><span class="s1">&#39;y_fit&#39;</span><span class="p">])</span>

    <span class="c1"># 创建SkyCoord对象以存储RA和Dec</span>
    <span class="n">radec_f200w</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra_f200w</span><span class="p">,</span> <span class="n">dec_f200w</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>

    <span class="c1"># 将RA和Dec添加到清理结果中</span>
    <span class="n">result_clean_f200w</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec_f200w</span>

    <span class="c1"># 将清理后的结果添加到F200W结果列表中</span>
    <span class="n">results_clean_f200w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_clean_f200w</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_sep</span> <span class="o">=</span> <span class="mf">0.015</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>  <span class="c1"># 定义最大分离角度为0.015角秒</span>

<span class="n">matches_phot_single</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化匹配结果列表</span>

<span class="n">filt1</span> <span class="o">=</span> <span class="s1">&#39;F115W&#39;</span>  <span class="c1"># 定义第一个滤光片</span>
<span class="n">filt2</span> <span class="o">=</span> <span class="s1">&#39;F200W&#39;</span>  <span class="c1"># 定义第二个滤光片</span>

<span class="c1"># 遍历两个结果集，分别为F115W和F200W</span>
<span class="k">for</span> <span class="n">res1</span><span class="p">,</span> <span class="n">res2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">results_clean_f115w</span><span class="p">,</span> <span class="n">results_clean_f200w</span><span class="p">):</span>

    <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">res1</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">],</span> <span class="n">res2</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">])</span>  <span class="c1"># 匹配两个结果集的坐标</span>

    <span class="n">sep_constraint</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;</span> <span class="n">max_sep</span>  <span class="c1"># 根据最大分离角度筛选匹配结果</span>

    <span class="n">match_phot_single</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>  <span class="c1"># 初始化单个匹配结果表</span>

    <span class="c1"># 从F115W结果中提取符合条件的参数</span>
    <span class="n">x_0_f115w</span> <span class="o">=</span> <span class="n">res1</span><span class="p">[</span><span class="s1">&#39;x_0&#39;</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>  <span class="c1"># 提取x_0坐标</span>
    <span class="n">y_0_f115w</span> <span class="o">=</span> <span class="n">res1</span><span class="p">[</span><span class="s1">&#39;y_0&#39;</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>  <span class="c1"># 提取y_0坐标</span>
    <span class="n">x_fit_f115w</span> <span class="o">=</span> <span class="n">res1</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>  <span class="c1"># 提取拟合x坐标</span>
    <span class="n">y_fit_f115w</span> <span class="o">=</span> <span class="n">res1</span><span class="p">[</span><span class="s1">&#39;y_fit&#39;</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>  <span class="c1"># 提取拟合y坐标</span>
    <span class="n">radec_f115w</span> <span class="o">=</span> <span class="n">res1</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>  <span class="c1"># 提取天球坐标</span>
    <span class="n">mag_f115w</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">res1</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">sep_constraint</span><span class="p">]</span>  <span class="c1"># 计算F115W的星等</span>
    <span class="n">emag_f115w</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">res1</span><span class="p">[</span><span class="s1">&#39;flux_unc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">res1</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">sep_constraint</span><span class="p">]</span>  <span class="c1"># 计算F115W的误差</span>

    <span class="c1"># 从F200W结果中提取符合条件的参数</span>
    <span class="n">x_0_f200w</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="s1">&#39;x_0&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>  <span class="c1"># 提取x_0坐标</span>
    <span class="n">y_0_f200w</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="s1">&#39;y_0&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>  <span class="c1"># 提取y_0坐标</span>
    <span class="n">x_fit_f200w</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="s1">&#39;x_fit&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>  <span class="c1"># 提取拟合x坐标</span>
    <span class="n">y_fit_f200w</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="s1">&#39;y_fit&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>  <span class="c1"># 提取拟合y坐标</span>
    <span class="n">radec_f200w</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>  <span class="c1"># 提取天球坐标</span>
    <span class="n">mag_f200w</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">res2</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>  <span class="c1"># 计算F200W的星等</span>
    <span class="n">emag_f200w</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">res2</span><span class="p">[</span><span class="s1">&#39;flux_unc&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">res2</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>  <span class="c1"># 计算F200W的误差</span>

    <span class="c1"># 将F115W的参数添加到匹配结果表中</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;x_0_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_0_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;y_0_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_0_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;x_fit_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_fit_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;y_fit_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_fit_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">emag_f115w</span>

    <span class="c1"># 将F200W的参数添加到匹配结果表中</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;x_0_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_0_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;y_0_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_0_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;x_fit_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_fit_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;y_fit_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_fit_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">emag_f200w</span>

    <span class="n">matches_phot_single</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match_phot_single</span><span class="p">)</span>  <span class="c1"># 将当前匹配结果添加到总列表中</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id18">
<h2>四幅图像的颜色-星等图（仪器星等）<a class="headerlink" href="#id18" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>  <span class="c1"># 创建一个12x16英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清空当前图形</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches_phot_single</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历所有匹配的单个光度数据</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个2x2的子图，选择第i+1个子图</span>

    <span class="n">j</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 将索引i转换为字符串形式</span>

    <span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>  <span class="c1"># 设置x轴下限</span>
    <span class="n">xlim1</span> <span class="o">=</span> <span class="mf">0.8</span>   <span class="c1"># 设置x轴上限</span>
    <span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>    <span class="c1"># 设置y轴下限</span>
    <span class="n">ylim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>    <span class="c1"># 设置y轴上限</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 应用x轴限制</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 应用y轴限制</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

    <span class="n">f115w_single</span> <span class="o">=</span> <span class="n">matches_phot_single</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span>  <span class="c1"># 获取filt1滤光片的光度数据</span>
    <span class="n">f200w_single</span> <span class="o">=</span> <span class="n">matches_phot_single</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span>  <span class="c1"># 获取filt2滤光片的光度数据</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_single</span> <span class="o">-</span> <span class="n">f200w_single</span><span class="p">,</span> <span class="n">f115w_single</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图，x轴为f115w与f200w的差值，y轴为f115w的光度</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.65</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 在图中添加文本，标识图像序号</span>
    

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图参数，使之填充整个图像区域</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="daofindpsf">
<h2>daofind与PSF算法获取位置的差异（以像素为单位）<a class="headerlink" href="#daofindpsf" title="Link to this heading">#</a></h2>
<p>我们展示了通过daofind和PSF拟合算法获得的星体位置之间的差异。我们还展示了差异 <span class="math notranslate nohighlight">\(\Delta\)</span>X 和 <span class="math notranslate nohighlight">\(\Delta\)</span>Y 与仪器星等（instrumental magnitudes）之间的关系。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  <span class="c1"># 创建一个12x6英寸的图形</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建1行2列的子图，选择第一个子图</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># x轴的最小值</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># x轴的最大值</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># y轴的最小值</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># y轴的最大值</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">x_find_f115w</span> <span class="o">=</span> <span class="n">results_clean_f115w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;x_0&#39;</span><span class="p">]</span>  <span class="c1"># 获取f115w结果中的x坐标</span>
<span class="n">y_find_f115w</span> <span class="o">=</span> <span class="n">results_clean_f115w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;y_0&#39;</span><span class="p">]</span>  <span class="c1"># 获取f115w结果中的y坐标</span>

<span class="n">x_psf_f115w</span> <span class="o">=</span> <span class="n">results_clean_f115w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;x_fit&#39;</span><span class="p">]</span>  <span class="c1"># 获取f115w结果中的拟合x坐标</span>
<span class="n">y_psf_f115w</span> <span class="o">=</span> <span class="n">results_clean_f115w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;y_fit&#39;</span><span class="p">]</span>  <span class="c1"># 获取f115w结果中的拟合y坐标</span>

<span class="n">delta_x_f115w</span> <span class="o">=</span> <span class="n">x_find_f115w</span> <span class="o">-</span> <span class="n">x_psf_f115w</span>  <span class="c1"># 计算x坐标的偏差</span>
<span class="n">delta_y_f115w</span> <span class="o">=</span> <span class="n">y_find_f115w</span> <span class="o">-</span> <span class="n">y_psf_f115w</span>  <span class="c1"># 计算y坐标的偏差</span>

<span class="n">_</span><span class="p">,</span> <span class="n">d_x_f115w</span><span class="p">,</span> <span class="n">sigma_d_x_f115w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">delta_x_f115w</span><span class="p">)</span>  <span class="c1"># 计算x偏差的统计量</span>
<span class="n">_</span><span class="p">,</span> <span class="n">d_y_f115w</span><span class="p">,</span> <span class="n">sigma_d_y_f115w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">delta_y_f115w</span><span class="p">)</span>  <span class="c1"># 计算y偏差的统计量</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">delta_x_f115w</span><span class="p">,</span> <span class="n">delta_y_f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 在子图中绘制散点图</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ X (px)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ Y (px)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置子图标题</span>

<span class="c1"># 在子图中添加文本，显示x和y的偏差及其标准差</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="sa">rf</span><span class="s1">&#39;$\Delta$ X = </span><span class="si">{</span><span class="n">d_x_f115w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">sigma_d_x_f115w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.30</span><span class="p">,</span> <span class="sa">rf</span><span class="s1">&#39;$\Delta$ Y = </span><span class="si">{</span><span class="n">d_y_f115w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">sigma_d_y_f115w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制x=0的虚线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制y=0的虚线</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建1行2列的子图，选择第二个子图</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">x_find_f200w</span> <span class="o">=</span> <span class="n">results_clean_f200w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;x_0&#39;</span><span class="p">]</span>  <span class="c1"># 获取f200w结果中的x坐标</span>
<span class="n">y_find_f200w</span> <span class="o">=</span> <span class="n">results_clean_f200w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;y_0&#39;</span><span class="p">]</span>  <span class="c1"># 获取f200w结果中的y坐标</span>

<span class="n">x_psf_f200w</span> <span class="o">=</span> <span class="n">results_clean_f200w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;x_fit&#39;</span><span class="p">]</span>  <span class="c1"># 获取f200w结果中的拟合x坐标</span>
<span class="n">y_psf_f200w</span> <span class="o">=</span> <span class="n">results_clean_f200w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;y_fit&#39;</span><span class="p">]</span>  <span class="c1"># 获取f200w结果中的拟合y坐标</span>

<span class="n">delta_x_f200w</span> <span class="o">=</span> <span class="n">x_find_f200w</span> <span class="o">-</span> <span class="n">x_psf_f200w</span>  <span class="c1"># 计算x坐标的偏差</span>
<span class="n">delta_y_f200w</span> <span class="o">=</span> <span class="n">y_find_f200w</span> <span class="o">-</span> <span class="n">y_psf_f200w</span>  <span class="c1"># 计算y坐标的偏差</span>

<span class="n">_</span><span class="p">,</span> <span class="n">d_x_f200w</span><span class="p">,</span> <span class="n">sigma_d_x_f200w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">delta_x_f200w</span><span class="p">)</span>  <span class="c1"># 计算x偏差的统计量</span>
<span class="n">_</span><span class="p">,</span> <span class="n">d_y_f200w</span><span class="p">,</span> <span class="n">sigma_d_y_f200w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">delta_y_f200w</span><span class="p">)</span>  <span class="c1"># 计算y偏差的统计量</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">delta_x_f200w</span><span class="p">,</span> <span class="n">delta_y_f200w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 在子图中绘制散点图</span>

<span class="c1"># 在子图中添加文本，显示x和y的偏差及其标准差</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="sa">rf</span><span class="s1">&#39;$\Delta$ X = </span><span class="si">{</span><span class="n">d_x_f200w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">sigma_d_x_f200w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.30</span><span class="p">,</span> <span class="sa">rf</span><span class="s1">&#39;$\Delta$ Y = </span><span class="si">{</span><span class="n">d_y_f200w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">sigma_d_y_f200w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制x=0的虚线</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制y=0的虚线</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ X (px)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ Y (px)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置子图标题</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图布局以避免重叠</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>  <span class="c1"># 创建一个12x8英寸的图形</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个2x2的子图，选择第一个子图</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>  <span class="c1"># 设置x轴的最小值</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># 设置x轴的最大值</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># 设置y轴的最小值</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># 设置y轴的最大值</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置第一个子图的x轴范围</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置第一个子图的y轴范围</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">mag_inst_f115w</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">results_clean_f115w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">])</span>  <span class="c1"># 计算F115W滤光片的瞬时星等</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag_inst_f115w</span><span class="p">,</span> <span class="n">delta_x_f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 在第一个子图中绘制散点图</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制y=0的虚线</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ X (px)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建第二个子图</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置第二个子图的x轴范围</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置第二个子图的y轴范围</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag_inst_f115w</span><span class="p">,</span> <span class="n">delta_y_f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 在第二个子图中绘制散点图</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制y=0的虚线</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ Y (px)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 创建第三个子图</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置第三个子图的x轴范围</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置第三个子图的y轴范围</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">mag_inst_f200w</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">results_clean_f200w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">])</span>  <span class="c1"># 计算F200W滤光片的瞬时星等</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag_inst_f200w</span><span class="p">,</span> <span class="n">delta_x_f200w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 在第三个子图中绘制散点图</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制y=0的虚线</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ X (px)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">ax4</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># 创建第四个子图</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置第四个子图的x轴范围</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置第四个子图的y轴范围</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag_inst_f200w</span><span class="p">,</span> <span class="n">delta_y_f200w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 在第四个子图中绘制散点图</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制y=0的虚线</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ Y (px)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 自动调整子图参数，使之填充整个图像区域</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id19">
<h2>对每个滤光片交叉匹配4个目录<a class="headerlink" href="#id19" title="Link to this heading">#</a></h2>
<p>为了获得最终的颜色-亮度图，我们需要对每个滤光片的所有目录进行交叉匹配，然后再交叉匹配得到的最终目录。</p>
<p><strong>注意</strong>：这是最保守的方法，因为我们要求一颗星星必须在所有4个目录中都能找到。</p>
<section id="id20">
<h3>开发者注意事项：<a class="headerlink" href="#id20" title="Link to this heading">#</a></h3>
<p>我找不到更简单的方法来编写这个函数，你需要匹配前两个目录，得出一个仅包含匹配项的子目录，然后对所有其他可用目录进行迭代。我们还应该考虑如何创建一个函数，以便在X个目录中保留星星，即使它们在Y个目录中可用（例如，如果由于某种原因，某个测量在1个图像中不可用，但在其他3个图像中测量良好，那么丢弃该对象是没有意义的）。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">crossmatch_filter</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># 初始化计数器</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># 创建一个字符串数组，表示每个分类的编号</span>
    <span class="n">num_cat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># 匹配第一个和第二个表的坐标</span>
    <span class="n">idx_12</span><span class="p">,</span> <span class="n">d2d_12</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">])</span>

    <span class="c1"># 设置分离约束条件</span>
    <span class="n">sep_constraint_12</span> <span class="o">=</span> <span class="n">d2d_12</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

    <span class="c1"># 创建一个表来存储匹配结果</span>
    <span class="n">matches_12</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

    <span class="c1"># 存储第一个表的匹配结果</span>
    <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">][</span><span class="n">sep_constraint_12</span><span class="p">]</span>
    <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">sep_constraint_12</span><span class="p">]</span>
    <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">&#39;flux_unc&#39;</span><span class="p">]</span> <span class="o">/</span> 
                                                   <span class="n">table</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">sep_constraint_12</span><span class="p">]</span>

    <span class="c1"># 存储第二个表的匹配结果</span>
    <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">][</span><span class="n">idx_12</span><span class="p">[</span><span class="n">sep_constraint_12</span><span class="p">]]</span>
    <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">idx_12</span><span class="p">[</span><span class="n">sep_constraint_12</span><span class="p">]]</span>
    <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;flux_unc&#39;</span><span class="p">]</span> <span class="o">/</span>
                                                       <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">idx_12</span><span class="p">[</span><span class="n">sep_constraint_12</span><span class="p">]]</span>

    <span class="c1"># 匹配结果与第三个表的坐标</span>
    <span class="n">idx_123</span><span class="p">,</span> <span class="n">d2d_123</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]],</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">])</span>

    <span class="c1"># 设置分离约束条件</span>
    <span class="n">sep_constraint_123</span> <span class="o">=</span> <span class="n">d2d_123</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

    <span class="c1"># 创建一个表来存储匹配结果</span>
    <span class="n">matches_123</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

    <span class="c1"># 存储第一个和第二个表的匹配结果</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">][</span><span class="n">idx_123</span><span class="p">[</span><span class="n">sep_constraint_123</span><span class="p">]]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">idx_123</span><span class="p">[</span><span class="n">sep_constraint_123</span><span class="p">]]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="s1">&#39;flux_unc&#39;</span><span class="p">]</span> <span class="o">/</span>
                                                        <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">idx_123</span><span class="p">[</span><span class="n">sep_constraint_123</span><span class="p">]]</span>

    <span class="c1"># 匹配结果与第四个表的坐标</span>
    <span class="n">idx_1234</span><span class="p">,</span> <span class="n">d2d_1234</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]],</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">])</span>

    <span class="c1"># 设置分离约束条件</span>
    <span class="n">sep_constraint_1234</span> <span class="o">=</span> <span class="n">d2d_1234</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

    <span class="c1"># 创建一个表来存储匹配结果</span>
    <span class="n">matches_1234</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

    <span class="c1"># 存储第一个、第二个和第三个表的匹配结果</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;radec_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">][</span><span class="n">idx_1234</span><span class="p">[</span><span class="n">sep_constraint_1234</span><span class="p">]]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;mag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">idx_1234</span><span class="p">[</span><span class="n">sep_constraint_1234</span><span class="p">]]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">&#39;emag_&#39;</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="s1">&#39;flux_unc&#39;</span><span class="p">]</span> <span class="o">/</span>
                                                         <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]))[</span><span class="n">idx_1234</span><span class="p">[</span><span class="n">sep_constraint_1234</span><span class="p">]]</span>

    <span class="c1"># 返回最终的匹配结果</span>
    <span class="k">return</span> <span class="n">matches_1234</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 使用 crossmatch_filter 函数对 F115W 结果进行交叉匹配</span>
<span class="n">matches_f115w</span> <span class="o">=</span> <span class="n">crossmatch_filter</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">results_clean_f115w</span><span class="p">)</span>

<span class="c1"># 使用 crossmatch_filter 函数对 F200W 结果进行交叉匹配</span>
<span class="n">matches_f200w</span> <span class="o">=</span> <span class="n">crossmatch_filter</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">results_clean_f200w</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>对于最终目录，我们假设亮度（magnitude）是4个测量值的平均值，而亮度的误差是其标准差。</p>
<p>为了方便在表格上执行这个算术操作，我们将表格转换为pandas数据框（dataframe）。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将 matches_f115w 转换为 pandas DataFrame</span>
<span class="n">df_f115w</span> <span class="o">=</span> <span class="n">matches_f115w</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

<span class="c1"># 将 matches_f200w 转换为 pandas DataFrame</span>
<span class="n">df_f200w</span> <span class="o">=</span> <span class="n">matches_f200w</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

<span class="c1"># 计算 RA 坐标的均值并存储在新列中</span>
<span class="n">df_f115w</span><span class="p">[</span><span class="s1">&#39;RA_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">&#39;radec_1.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_2.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_3.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_4.ra&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 计算 RA 坐标的标准差并存储在新列中</span>
<span class="n">df_f115w</span><span class="p">[</span><span class="s1">&#39;e_RA_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">&#39;radec_1.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_2.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_3.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_4.ra&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 计算 Dec 坐标的均值并存储在新列中</span>
<span class="n">df_f115w</span><span class="p">[</span><span class="s1">&#39;Dec_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">&#39;radec_1.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_2.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_3.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_4.dec&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 计算 Dec 坐标的标准差并存储在新列中</span>
<span class="n">df_f115w</span><span class="p">[</span><span class="s1">&#39;e_Dec_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">&#39;radec_1.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_2.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_3.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_4.dec&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 计算滤光片 f115w 的仪器测量值均值并存储在新列中</span>
<span class="n">df_f115w</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">&#39;mag_1&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_2&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_3&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_4&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 计算滤光片 f115w 的仪器测量值标准差并存储在新列中</span>
<span class="n">df_f115w</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">&#39;mag_1&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_2&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_3&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_4&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 计算 RA 坐标的均值并存储在新列中</span>
<span class="n">df_f200w</span><span class="p">[</span><span class="s1">&#39;RA_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">&#39;radec_1.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_2.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_3.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_4.ra&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 计算 RA 坐标的标准差并存储在新列中</span>
<span class="n">df_f200w</span><span class="p">[</span><span class="s1">&#39;e_RA_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">&#39;radec_1.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_2.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_3.ra&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_4.ra&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 计算 Dec 坐标的均值并存储在新列中</span>
<span class="n">df_f200w</span><span class="p">[</span><span class="s1">&#39;Dec_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">&#39;radec_1.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_2.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_3.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_4.dec&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 计算 Dec 坐标的标准差并存储在新列中</span>
<span class="n">df_f200w</span><span class="p">[</span><span class="s1">&#39;e_Dec_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">&#39;radec_1.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_2.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_3.dec&#39;</span><span class="p">,</span> <span class="s1">&#39;radec_4.dec&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 计算滤光片 f200w 的仪器测量值均值并存储在新列中</span>
<span class="n">df_f200w</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">&#39;mag_1&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_2&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_3&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_4&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 计算滤光片 f200w 的仪器测量值标准差并存储在新列中</span>
<span class="n">df_f200w</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">&#39;mag_1&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_2&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_3&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_4&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id21">
<h2>最终颜色-星等图（仪器星等）<a class="headerlink" href="#id21" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>  <span class="c1"># 创建一个12x14英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清空当前图形</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个1行2列的子图，选择第一个子图</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst -&#39;</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>  <span class="c1"># x轴下限</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mf">0.8</span>   <span class="c1"># x轴上限</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span>  <span class="c1"># y轴下限</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>    <span class="c1"># y轴上限</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="c1"># 创建SkyCoord对象，表示F115W和F200W的天球坐标</span>
<span class="n">radec_f115w_inst</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">df_f115w</span><span class="p">[</span><span class="s1">&#39;RA_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">],</span> <span class="n">df_f115w</span><span class="p">[</span><span class="s1">&#39;Dec_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
<span class="n">radec_f200w_inst</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">df_f200w</span><span class="p">[</span><span class="s1">&#39;RA_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">],</span> <span class="n">df_f200w</span><span class="p">[</span><span class="s1">&#39;Dec_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>

<span class="c1"># 匹配F115W和F200W的坐标</span>
<span class="n">idx_inst</span><span class="p">,</span> <span class="n">d2d_inst</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">radec_f115w_inst</span><span class="p">,</span> <span class="n">radec_f200w_inst</span><span class="p">)</span>

<span class="n">sep_constraint_inst</span> <span class="o">=</span> <span class="n">d2d_inst</span> <span class="o">&lt;</span> <span class="n">max_sep</span>  <span class="c1"># 根据最大分离限制筛选匹配</span>

<span class="c1"># 提取满足条件的F115W数据</span>
<span class="n">f115w_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f115w</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">])</span>
<span class="n">ef115w_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f115w</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">])</span>
<span class="n">radec_f115w</span> <span class="o">=</span> <span class="n">radec_f115w_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]</span>

<span class="c1"># 提取满足条件的F200W数据</span>
<span class="n">f200w_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f200w</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]])</span>
<span class="n">ef200w_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f200w</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]])</span>
<span class="n">radec_f200w</span> <span class="o">=</span> <span class="n">radec_f200w_inst</span><span class="p">[</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]]</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_inst</span> <span class="o">-</span> <span class="n">f200w_inst</span><span class="p">,</span> <span class="n">f115w_inst</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 在ax1上绘制散点图</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建第二个子图</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma$&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>  <span class="c1"># x轴下限</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span>  <span class="c1"># x轴上限</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.01</span>  <span class="c1"># y轴下限</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># y轴上限</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_f115w</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span> <span class="n">df_f115w</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 在ax2上绘制散点图</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># 创建第四个子图</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\sigma$&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_f200w</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span> <span class="n">df_f200w</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 在ax3上绘制散点图</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图布局以避免重叠</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="photometric-zeropoints">
<h2>光度零点 (Photometric Zeropoints)<a class="headerlink" href="#photometric-zeropoints" title="Link to this heading">#</a></h2>
<p>为了获得最终校准的颜色-星等图，我们需要计算光度零点。因此，我们需要对校准后的图像（Level-3）进行光圈光度测量 (aperture photometry)，应用适当的光圈修正（上面字典中提供的值是针对无限光圈的），然后将其与点扩散函数 (PSF) 光度测量进行比较。因此，我们可以将步骤总结如下：</p>
<ul class="simple">
<li><p>进行光圈光度测量</p></li>
<li><p>应用适当的光圈修正</p></li>
<li><p>应用表格化的零点</p></li>
<li><p>与PSF光度测量进行交叉匹配</p></li>
</ul>
</section>
<section id="id22">
<h2>加载已校准和矫正的图像（三级成像处理管道）<a class="headerlink" href="#id22" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 初始化一个字典，用于存储不同探测器的图像数据</span>
<span class="n">dict_images_combined</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NRCA1&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA2&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA3&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA4&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA5&#39;</span><span class="p">:</span> <span class="p">{},</span>
                        <span class="s1">&#39;NRCB1&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB2&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB3&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB4&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB5&#39;</span><span class="p">:</span> <span class="p">{}}</span>

<span class="c1"># 初始化短波和长波滤光器的字典</span>
<span class="n">dict_filter_short</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">dict_filter_long</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># 初始化短波和长波的滤光器、探测器列表</span>
<span class="n">ff_short</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 短波滤光器列表</span>
<span class="n">det_short</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 短波探测器列表</span>
<span class="n">det_long</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 长波探测器列表</span>
<span class="n">ff_long</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 长波滤光器列表</span>
<span class="n">detlist_short</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 短波探测器唯一列表</span>
<span class="n">detlist_long</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 长波探测器唯一列表</span>
<span class="n">filtlist_short</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 短波滤光器唯一列表</span>
<span class="n">filtlist_long</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 长波滤光器唯一列表</span>

<span class="c1"># 检查是否存在合并后的fits文件</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./*combined*fits&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading images&quot;</span><span class="p">)</span>  <span class="c1"># 打印下载图像的提示</span>

    <span class="c1"># 定义图像数据的下载链接和本地文件名</span>
    <span class="n">boxlink_images_lev3</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/images_level3.tar.gz&#39;</span>
    <span class="n">boxfile_images_lev3</span> <span class="o">=</span> <span class="s1">&#39;./images_level3.tar.gz&#39;</span>

    <span class="c1"># 下载图像数据</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_images_lev3</span><span class="p">,</span> <span class="n">boxfile_images_lev3</span><span class="p">)</span>

    <span class="c1"># 解压下载的tar文件</span>
    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile_images_lev3</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>

    <span class="c1"># 设置图像目录</span>
    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
    <span class="c1"># 获取合并后的fits文件列表</span>
    <span class="n">files_singles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">&quot;*combined*fits&quot;</span><span class="p">)))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># 如果文件已存在，直接获取合并后的fits文件列表</span>
    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
    <span class="n">files_singles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">&quot;*combined*fits&quot;</span><span class="p">)))</span>

<span class="c1"># 遍历每个合并后的fits文件</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files_singles</span><span class="p">:</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>  <span class="c1"># 打开fits文件</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span>  <span class="c1"># 获取滤光器信息</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">]</span>  <span class="c1"># 获取探测器信息</span>

    <span class="c1"># 根据探测器类型进行调整</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">&#39;NRCBLONG&#39;</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">&#39;NRCB5&#39;</span>  <span class="c1"># 将NRCBLONG映射为NRCB5</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">&#39;NRCALONG&#39;</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">&#39;NRCA5&#39;</span>  <span class="c1"># 将NRCALONG映射为NRCA5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span>  <span class="c1"># 保持原探测器名称</span>

    <span class="n">wv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># 提取波长信息</span>

    <span class="c1"># 根据波长将滤光器分类</span>
    <span class="k">if</span> <span class="n">wv</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
        <span class="n">ff_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># 添加到长波滤光器列表</span>
        <span class="n">det_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>  <span class="c1"># 添加到长波探测器列表</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ff_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># 添加到短波滤光器列表</span>
        <span class="n">det_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>  <span class="c1"># 添加到短波探测器列表</span>

    <span class="c1"># 获取短波和长波探测器的唯一列表</span>
    <span class="n">detlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_short</span><span class="p">)))</span>
    <span class="n">detlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_long</span><span class="p">)))</span>

    <span class="n">unique_list_filters_short</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 短波滤光器唯一列表</span>
    <span class="n">unique_list_filters_long</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 长波滤光器唯一列表</span>

    <span class="c1"># 更新短波滤光器字典</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_short</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_short</span><span class="p">:</span>
            <span class="n">dict_filter_short</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 如果滤光器不在列表中，则添加</span>

    <span class="c1"># 更新长波滤光器字典</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_long</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_long</span><span class="p">:</span>
            <span class="n">dict_filter_long</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 如果滤光器不在列表中，则添加</span>

    <span class="c1"># 将短波探测器与滤光器字典关联</span>
    <span class="k">for</span> <span class="n">d_s</span> <span class="ow">in</span> <span class="n">detlist_short</span><span class="p">:</span>
        <span class="n">dict_images_combined</span><span class="p">[</span><span class="n">d_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_short</span>

    <span class="c1"># 将长波探测器与滤光器字典关联</span>
    <span class="k">for</span> <span class="n">d_l</span> <span class="ow">in</span> <span class="n">detlist_long</span><span class="p">:</span>
        <span class="n">dict_images_combined</span><span class="p">[</span><span class="n">d_l</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_long</span>

    <span class="c1"># 获取短波和长波滤光器的唯一列表</span>
    <span class="n">filtlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_short</span><span class="p">)))</span>
    <span class="n">filtlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_long</span><span class="p">)))</span>

    <span class="c1"># 将图像文件添加到对应的探测器和滤光器字典中</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dict_images_combined</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;images&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">file</span><span class="p">]}</span>  <span class="c1"># 如果没有图像，初始化列表</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dict_images_combined</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>  <span class="c1"># 否则，添加图像文件</span>

<span class="c1"># 打印可用的探测器和滤光器信息</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available Detectors for SW channel:&quot;</span><span class="p">,</span> <span class="n">detlist_short</span><span class="p">)</span>  <span class="c1"># 打印短波探测器</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available Detectors for LW channel:&quot;</span><span class="p">,</span> <span class="n">detlist_long</span><span class="p">)</span>  <span class="c1"># 打印长波探测器</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available SW Filters:&quot;</span><span class="p">,</span> <span class="n">filtlist_short</span><span class="p">)</span>  <span class="c1"># 打印短波滤光器</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available LW Filters:&quot;</span><span class="p">,</span> <span class="n">filtlist_long</span><span class="p">)</span>  <span class="c1"># 打印长波滤光器</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id23">
<h2>显示图像<a class="headerlink" href="#id23" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>  <span class="c1"># 创建一个14x14英寸的图形</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短列表中的每个探测器</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短列表中的每个滤光片，并获取索引</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 打开对应探测器和滤光片的图像文件</span>

        <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filts_short</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建子图，行数为1，列数为滤光片数量，当前索引为i+1</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>  <span class="c1"># 使用平方根归一化数据，99%分位数</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X [px]&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y [px]&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置子图标题为当前滤光片名称</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">)</span>  <span class="c1"># 显示图像数据，使用灰度色图和归一化</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图布局以避免重叠</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="aperture-photometry">
<h2>光圈光度法 (Aperture Photometry)<a class="headerlink" href="#aperture-photometry" title="Link to this heading">#</a></h2>
<p>如我们之前所做的，我们创建一个字典，其中包含每个图像的衍生光圈光度（aperture photometry）表格。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_aper</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化一个空字典，用于存储光圈数据</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短列表中的每个探测器</span>

    <span class="n">dict_aper</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 如果字典中没有该探测器，则初始化一个空字典</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短列表中的每个滤光片，并获取其索引</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 如果该探测器下没有该滤光片，则初始化一个空字典</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;stars for ap phot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 初始化用于光圈光度测量的星星数据为None</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;stars for ap phot matched&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 初始化匹配的光圈光度测量星星数据为None</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 初始化光圈光度表为None</span>
</pre></div>
</div>
</div>
</div>
<section id="id24">
<h3>寻找明亮的孤立恒星<a class="headerlink" href="#id24" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_bright_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">&#39;NRCA1&#39;</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">&#39;F070W&#39;</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># 初始化背景噪声计算方法</span>
    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>
    <span class="c1"># 初始化背景均值计算方法</span>
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>

    <span class="c1"># 打开指定探测器和滤光片的图像文件</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="c1"># 获取图像数据</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="c1"># 获取图像头信息</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="c1"># 打印当前处理的图像信息</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selecting stars for aperture photometry on image </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> of filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">, detector </span><span class="si">{</span><span class="n">det</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 将数据转换为DN/s单位</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span>
    <span class="c1"># 打印单位转换因子</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversion factor from </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2"> to DN/s for filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 获取滤光片的点扩散函数（PSF）全宽半最大值（FWHM）</span>
    <span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf fwhm&#39;</span><span class="p">]</span>
    <span class="c1"># 打印FWHM值</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FWHM for the filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">sigma_psf</span><span class="si">}</span><span class="s2"> px&quot;</span><span class="p">)</span>

    <span class="c1"># 计算背景标准差</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># 计算背景值</span>
    <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># 使用DAOStarFinder寻找星点</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">th</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">std</span> <span class="o">+</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>
    <span class="c1"># 获取经过校正的星点</span>
    <span class="n">apcorr_stars</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># 将找到的星点存储在字典中</span>
    <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;stars for ap phot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apcorr_stars</span>

    <span class="k">if</span> <span class="n">dist_sel</span><span class="p">:</span>
        <span class="c1"># 如果需要计算距离选择</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating closest neighbour distance&quot;</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化距离列表</span>

        <span class="c1"># 使用DAOStarFinder寻找所有星点</span>
        <span class="n">daofind_tot</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">std</span> <span class="o">+</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                                    <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>
        <span class="n">stars_tot</span> <span class="o">=</span> <span class="n">daofind_tot</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># 获取所有星点的坐标</span>
        <span class="n">x_tot</span> <span class="o">=</span> <span class="n">stars_tot</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span>
        <span class="n">y_tot</span> <span class="o">=</span> <span class="n">stars_tot</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span>

        <span class="c1"># 计算每个经过校正的星点与所有其他星点的距离</span>
        <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">apcorr_stars</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">apcorr_stars</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]):</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化距离列表</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x_tot</span> <span class="o">-</span> <span class="n">xx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_tot</span> <span class="o">-</span> <span class="n">yy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 计算距离</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取最近邻距离</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>  <span class="c1"># 将距离添加到列表中</span>

        <span class="c1"># 将最小距离添加到校正星点数据中</span>
        <span class="n">apcorr_stars</span><span class="p">[</span><span class="s1">&#39;min distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">mask_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">apcorr_stars</span><span class="p">[</span><span class="s1">&#39;min distance&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>  <span class="c1"># 创建距离掩码</span>

        <span class="c1"># 应用掩码过滤星点</span>
        <span class="n">apcorr_stars</span> <span class="o">=</span> <span class="n">apcorr_stars</span><span class="p">[</span><span class="n">mask_dist</span><span class="p">]</span>

        <span class="c1"># 更新字典中的星点数据</span>
        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;stars for ap phot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apcorr_stars</span>

        <span class="c1"># 打印最小距离和找到的星点数量</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum distance required:&quot;</span><span class="p">,</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s2">&quot;px&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of bright isolated sources found in the image for </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">apcorr_stars</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 如果不需要距离选择，直接打印找到的星点数量</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of bright sources found in the image for </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">apcorr_stars</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span>  <span class="c1"># 返回函数结束</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

<span class="n">th</span> <span class="o">=</span> <span class="p">[</span><span class="mi">700</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>  <span class="c1"># 两个滤光器的阈值水平（长度必须与分析的滤光器数量匹配）</span>

<span class="n">min_sep</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># zp 星星与最近邻星星之间可接受的最小距离</span>

<span class="c1"># 遍历短时间检测列表</span>
<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>

    <span class="c1"># 遍历短时间滤光器列表</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>

        <span class="c1"># 遍历合并图像的索引</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="c1"># 查找明亮的星星，dist_sel参数设为False</span>
            <span class="n">find_bright_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>

<span class="c1"># 打印用于光度测量的星星查找所用的时间</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed Time for finding stars for Aperture Photometry:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>为了进一步获得高质量的样本，我们对两个滤光器的目录进行交叉匹配，仅保留共同的恒星。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短时间序列中的每个探测器</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短时间序列中的每个滤光片</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历当前探测器和滤光片的所有图像</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 创建图像模型对象</span>

            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;stars for ap phot&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span>  <span class="c1"># 获取天体的RA和Dec</span>
                                     <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;stars for ap phot&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>

            <span class="n">radec</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>  <span class="c1"># 创建SkyCoord对象以存储RA和Dec坐标</span>

            <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;stars for ap phot&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec</span>  <span class="c1"># 将RA和Dec坐标存储到字典中</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 使用 match_coordinates_sky 函数匹配两个滤波器中的星体坐标</span>
<span class="n">idx_ap</span><span class="p">,</span> <span class="n">d2d_ap</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;stars for ap phot&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">],</span>
                                          <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;stars for ap phot&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">])</span>

<span class="c1"># 设置分离约束条件，筛选出距离小于最大分离的匹配</span>
<span class="n">sep_constraint_ap</span> <span class="o">=</span> <span class="n">d2d_ap</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="c1"># 创建两个空的表格用于存储匹配结果</span>
<span class="n">matched_apcorr_f115w</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>  <span class="c1"># 用于存储滤波器 f115w 的匹配结果</span>
<span class="n">matched_apcorr_f200w</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>   <span class="c1"># 用于存储滤波器 f200w 的匹配结果</span>

<span class="c1"># 根据分离约束条件从 f115w 中提取匹配的星体</span>
<span class="n">matched_apcorr_f115w</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;stars for ap phot&#39;</span><span class="p">][</span><span class="n">sep_constraint_ap</span><span class="p">]</span>

<span class="c1"># 根据索引从 f200w 中提取匹配的星体</span>
<span class="n">matched_apcorr_f200w</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;stars for ap phot&#39;</span><span class="p">][</span><span class="n">idx_ap</span><span class="p">[</span><span class="n">sep_constraint_ap</span><span class="p">]]</span>

<span class="c1"># 将匹配结果存储回字典中</span>
<span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;stars for ap phot matched&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_apcorr_f115w</span>
<span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;stars for ap phot matched&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_apcorr_f200w</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id25">
<h3>加载孔径校正表<a class="headerlink" href="#id25" title="Link to this heading">#</a></h3>
<p><strong>注意</strong>：这些值是通过对合成STPSF点扩散函数（PSFs）的研究获得的。一旦我们获得了飞行中的测量数据，这些值将会更新。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;./aperture_correction_table.txt&#39;</span><span class="p">):</span>  <span class="c1"># 检查文件是否存在</span>

    <span class="n">ap_tab</span> <span class="o">=</span> <span class="s1">&#39;./aperture_correction_table.txt&#39;</span>  <span class="c1"># 如果存在，设置文件路径</span>

<span class="k">else</span><span class="p">:</span>  <span class="c1"># 如果文件不存在</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading the aperture correction table&quot;</span><span class="p">)</span>  <span class="c1"># 打印下载提示</span>

    <span class="n">boxlink_apcorr_table</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/aperture_correction_table.txt&#39;</span>  <span class="c1"># 定义下载链接</span>

    <span class="n">boxfile_apcorr_table</span> <span class="o">=</span> <span class="s1">&#39;./aperture_correction_table.txt&#39;</span>  <span class="c1"># 定义保存路径</span>

    <span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_apcorr_table</span><span class="p">,</span> <span class="n">boxfile_apcorr_table</span><span class="p">)</span>  <span class="c1"># 下载文件并保存</span>

    <span class="n">ap_tab</span> <span class="o">=</span> <span class="s1">&#39;./aperture_correction_table.txt&#39;</span>  <span class="c1"># 设置文件路径</span>

<span class="c1"># 读取光圈校正表，指定无表头，分隔符为任意空白字符，第一列作为索引</span>
<span class="n">aper_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ap_tab</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;pupil&#39;</span><span class="p">,</span> <span class="s1">&#39;wave&#39;</span><span class="p">,</span> <span class="s1">&#39;r10&#39;</span><span class="p">,</span> <span class="s1">&#39;r20&#39;</span><span class="p">,</span> <span class="s1">&#39;r30&#39;</span><span class="p">,</span> <span class="s1">&#39;r40&#39;</span><span class="p">,</span> <span class="s1">&#39;r50&#39;</span><span class="p">,</span> <span class="s1">&#39;r60&#39;</span><span class="p">,</span> <span class="s1">&#39;r70&#39;</span><span class="p">,</span> <span class="s1">&#39;r80&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;r85&#39;</span><span class="p">,</span> <span class="s1">&#39;r90&#39;</span><span class="p">,</span> <span class="s1">&#39;sky_flux_px&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr10&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr20&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr30&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr40&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;apcorr50&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr60&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr70&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr80&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr85&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr90&#39;</span><span class="p">,</span> <span class="s1">&#39;sky_in&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;sky_out&#39;</span><span class="p">],</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">))</span>

<span class="n">aper_table</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>  <span class="c1"># 显示数据表的前几行</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id26">
<h3>执行光圈光度法<a class="headerlink" href="#id26" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">&#39;F070W&#39;</span><span class="p">):</span>
    <span class="c1"># 定义一个函数，用于进行光度测量，输入参数为探测器和滤光片</span>

    <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;r70&#39;</span><span class="p">]]</span>
    <span class="c1"># 从光度表中获取对应滤光片的半径</span>

    <span class="n">ees</span> <span class="o">=</span> <span class="s1">&#39;70&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="c1"># 定义等效半径的列表</span>

    <span class="n">ee_radii</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ees</span><span class="p">,</span> <span class="n">radii</span><span class="p">))</span>
    <span class="c1"># 创建一个字典，将等效半径与其对应的值关联</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;stars for ap phot matched&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span>
                              <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;stars for ap phot matched&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
    <span class="c1"># 获取匹配的星体的中心坐标</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># 打开合成图像文件</span>

    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="c1"># 获取图像数据</span>

    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="c1"># 获取图像头信息</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span>
    <span class="c1"># 进行数据的光度校正</span>

    <span class="c1"># 从光度校正表中获取天空背景的参数：</span>
    <span class="n">sky</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sky_in&quot;</span><span class="p">:</span> <span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;r80&#39;</span><span class="p">],</span> <span class="s2">&quot;sky_out&quot;</span><span class="p">:</span> <span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;r85&#39;</span><span class="p">]}</span>
    <span class="c1"># 定义天空背景的内外半径</span>

    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1"># 记录开始时间</span>

    <span class="n">table_aper</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
    <span class="c1"># 创建一个表格用于存储光度测量结果</span>

    <span class="k">for</span> <span class="n">ee</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="n">ee_radii</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># 遍历每个等效半径</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performing aperture photometry for radius equivalent to EE = </span><span class="si">{</span><span class="n">ee</span><span class="si">}</span><span class="s2">% for filter </span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># 打印当前处理的信息</span>

        <span class="n">aperture</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>
        <span class="c1"># 创建一个圆形光圈用于光度测量</span>

        <span class="n">annulus_aperture</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="n">sky</span><span class="p">[</span><span class="s2">&quot;sky_in&quot;</span><span class="p">],</span> <span class="n">r_out</span><span class="o">=</span><span class="n">sky</span><span class="p">[</span><span class="s2">&quot;sky_out&quot;</span><span class="p">])</span>
        <span class="c1"># 创建一个圆环用于背景测量</span>

        <span class="n">annulus_mask</span> <span class="o">=</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="c1"># 将圆环转换为掩膜</span>

        <span class="n">bkg_median</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 初始化背景中值列表</span>

        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">annulus_mask</span><span class="p">:</span>
            <span class="c1"># 遍历每个掩膜</span>
            <span class="n">annulus_data</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># 使用掩膜提取背景数据</span>

            <span class="n">annulus_data_1d</span> <span class="o">=</span> <span class="n">annulus_data</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="c1"># 将有效数据转换为一维数组</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">median_sigclip</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">annulus_data_1d</span><span class="p">)</span>
            <span class="c1"># 计算背景数据的中值，使用sigma剪切方法</span>

            <span class="n">bkg_median</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_sigclip</span><span class="p">)</span>
            <span class="c1"># 将中值添加到列表中</span>

        <span class="n">bkg_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bkg_median</span><span class="p">)</span>
        <span class="c1"># 将背景中值列表转换为NumPy数组</span>

        <span class="n">phot</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">)</span>
        <span class="c1"># 进行光度测量</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span>
        <span class="c1"># 将背景中值添加到光度测量结果中</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span>
        <span class="c1"># 计算光圈背景</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">]</span>
        <span class="c1"># 计算背景校正后的光度总和</span>

        <span class="n">apcorr</span> <span class="o">=</span> <span class="p">[</span><span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;apcorr70&#39;</span><span class="p">]]</span>
        <span class="c1"># 获取光度校正因子</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_corrected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">apcorr</span>
        <span class="c1"># 应用校正因子</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;mag_corrected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_corrected&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;VegaMAG zp modB&#39;</span><span class="p">]</span>
        <span class="c1"># 计算校正后的星等</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aper_sum_&#39;</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="c1"># 将光度总和添加到结果表中</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;annulus_median_&#39;</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="c1"># 将背景中值添加到结果表中</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aper_bkg_ee_&#39;</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="c1"># 将光圈背景添加到结果表中</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aper_sum_bkgsub_&#39;</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="c1"># 将背景校正后的光度总和添加到结果表中</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_corrected&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aper_sum_corrected_&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="p">)</span> 
        <span class="c1"># 将校正后的光度总和添加到结果表中</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;mag_corrected&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mag_corrected_&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="p">)</span>
        <span class="c1"># 将校正后的星等添加到结果表中</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_aper</span>
        <span class="c1"># 将结果表存储到字典中</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1"># 记录结束时间</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time Elapsed:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>
    <span class="c1"># 打印耗时</span>

    <span class="k">return</span>
    <span class="c1"># 返回函数结束</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 使用指定的滤镜对检测数据进行光度测量</span>
<span class="n">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt1</span><span class="p">)</span>  <span class="c1"># 对det数据应用filt1滤镜进行光度测量</span>

<span class="n">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt2</span><span class="p">)</span>  <span class="c1"># 对det数据应用filt2滤镜进行光度测量</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="zeropoints">
<h3>推导零点（Zeropoints）<a class="headerlink" href="#zeropoints" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>  <span class="c1"># 创建一个14x8英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清除当前图形中的所有内容</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个2行1列的子图，选择第一个子图</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为filt1</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Zeropoint&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为&#39;Zeropoint&#39;</span>

<span class="c1"># 匹配星体坐标，获取索引和距离</span>
<span class="n">idx_zp_1</span><span class="p">,</span> <span class="n">d2d_zp_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;stars for ap phot matched&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">],</span> <span class="n">radec_f115w_inst</span><span class="p">)</span>

<span class="n">sep_constraint_zp_1</span> <span class="o">=</span> <span class="n">d2d_zp_1</span> <span class="o">&lt;</span> <span class="n">max_sep</span>  <span class="c1"># 设置距离约束条件</span>

<span class="c1"># 获取匹配的光度数据</span>
<span class="n">f115w_ap_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;mag_corrected_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">][</span><span class="n">sep_constraint_zp_1</span><span class="p">])</span>
<span class="n">f115w_psf_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f115w</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">idx_zp_1</span><span class="p">[</span><span class="n">sep_constraint_zp_1</span><span class="p">]])</span>

<span class="c1"># 计算差异并进行统计</span>
<span class="n">diff_f115w</span> <span class="o">=</span> <span class="n">f115w_ap_matched</span> <span class="o">-</span> <span class="n">f115w_psf_matched</span>
<span class="n">_</span><span class="p">,</span> <span class="n">zp_f115w</span><span class="p">,</span> <span class="n">zp_sigma_f115w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span>  <span class="c1"># 计算零点和标准差</span>

<span class="c1"># 设置x和y轴的限制</span>
<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="c1"># 设置坐标轴的刻度</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 主刻度自动定位</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 次刻度自动定位</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 主刻度自动定位</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 次刻度自动定位</span>

<span class="c1"># 绘制散点图和零点线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_psf_matched</span><span class="p">,</span> <span class="n">diff_f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">zp_f115w</span><span class="p">,</span> <span class="n">zp_f115w</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制零点线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">filt1</span> <span class="o">+</span> <span class="sa">rf</span><span class="s1">&#39; Zeropoint = </span><span class="si">{</span><span class="n">zp_f115w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">zp_sigma_f115w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 添加文本注释</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建第二个子图</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为filt2</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Zeropoint&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为&#39;Zeropoint&#39;</span>

<span class="c1"># 匹配星体坐标，获取索引和距离</span>
<span class="n">idx_zp_2</span><span class="p">,</span> <span class="n">d2d_zp_2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;stars for ap phot matched&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">],</span> <span class="n">radec_f200w_inst</span><span class="p">)</span>

<span class="n">sep_constraint_zp_2</span> <span class="o">=</span> <span class="n">d2d_zp_2</span> <span class="o">&lt;</span> <span class="n">max_sep</span>  <span class="c1"># 设置距离约束条件</span>

<span class="c1"># 获取匹配的光度数据</span>
<span class="n">f200w_ap_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;mag_corrected_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">][</span><span class="n">sep_constraint_zp_2</span><span class="p">])</span>
<span class="n">f200w_psf_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f200w</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">idx_zp_2</span><span class="p">[</span><span class="n">sep_constraint_zp_2</span><span class="p">]])</span>

<span class="c1"># 计算差异并进行统计</span>
<span class="n">diff_f200w</span> <span class="o">=</span> <span class="n">f200w_ap_matched</span> <span class="o">-</span> <span class="n">f200w_psf_matched</span>
<span class="n">_</span><span class="p">,</span> <span class="n">zp_f200w</span><span class="p">,</span> <span class="n">zp_sigma_f200w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span>  <span class="c1"># 计算零点和标准差</span>

<span class="c1"># 设置x和y轴的限制</span>
<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="c1"># 设置坐标轴的刻度</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 主刻度自动定位</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 次刻度自动定位</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 主刻度自动定位</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 次刻度自动定位</span>

<span class="c1"># 绘制散点图和零点线</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f200w_psf_matched</span><span class="p">,</span> <span class="n">diff_f200w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">zp_f200w</span><span class="p">,</span> <span class="n">zp_f200w</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制零点线</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">filt2</span> <span class="o">+</span> <span class="sa">rf</span><span class="s1">&#39; Zeropoint = </span><span class="si">{</span><span class="n">zp_f200w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">zp_sigma_f200w</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 添加文本注释</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图间距</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id27">
<h2>导入输入光度数据<a class="headerlink" href="#id27" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  <span class="c1"># 导入os模块，用于文件和目录操作</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>  <span class="c1"># 导入pandas库，用于数据处理</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib</span><span class="w"> </span><span class="kn">import</span> <span class="n">request</span>  <span class="c1"># 从urllib库导入request模块，用于下载文件</span>

<span class="c1"># 检查当前目录下是否存在&#39;pointsource.cat&#39;文件</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;./pointsource.cat&#39;</span><span class="p">):</span>
    <span class="n">input_cat</span> <span class="o">=</span> <span class="s1">&#39;./pointsource.cat&#39;</span>  <span class="c1"># 如果文件存在，设置输入目录为该文件</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading input pointsource catalog&quot;</span><span class="p">)</span>  <span class="c1"># 如果文件不存在，打印下载提示</span>

    <span class="c1"># 设置要下载的文件链接</span>
    <span class="n">boxlink_input_cat</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/pointsource.cat&#39;</span>
    <span class="n">boxfile_input_cat</span> <span class="o">=</span> <span class="s1">&#39;./pointsource.cat&#39;</span>  <span class="c1"># 设置下载后保存的文件名</span>

    <span class="c1"># 下载文件并保存到指定路径</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_input_cat</span><span class="p">,</span> <span class="n">boxfile_input_cat</span><span class="p">)</span>
    <span class="n">input_cat</span> <span class="o">=</span> <span class="s1">&#39;./pointsource.cat&#39;</span>  <span class="c1"># 设置输入目录为下载的文件</span>

<span class="c1"># 读取输入的点源目录文件，指定列名和数据格式</span>
<span class="n">cat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_cat</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ra_in&#39;</span><span class="p">,</span> <span class="s1">&#39;dec_in&#39;</span><span class="p">,</span> <span class="s1">&#39;f070w_in&#39;</span><span class="p">,</span> <span class="s1">&#39;f115w_in&#39;</span><span class="p">,</span>
                                                             <span class="s1">&#39;f200w_in&#39;</span><span class="p">,</span> <span class="s1">&#39;f277w_in&#39;</span><span class="p">,</span> <span class="s1">&#39;f356w_in&#39;</span><span class="p">,</span> <span class="s1">&#39;f444w_in&#39;</span><span class="p">],</span>
                  <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">cat</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>  <span class="c1"># 显示数据框的前几行</span>
</pre></div>
</div>
</div>
</div>
<p>从输入目录中提取与所分析区域相同的星星</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lim_ra_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>  <span class="c1"># 计算ra的最小值</span>

<span class="n">lim_ra_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>  <span class="c1"># 计算ra的最大值</span>

<span class="n">lim_dec_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>  <span class="c1"># 计算dec的最小值</span>

<span class="n">lim_dec_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>  <span class="c1"># 计算dec的最大值</span>

<span class="c1"># 选择在指定ra和dec范围内的天体数据</span>
<span class="n">cat_sel</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;ra_in&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lim_ra_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;ra_in&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lim_ra_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;dec_in&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lim_dec_min</span><span class="p">)</span>

              <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;dec_in&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lim_dec_max</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id28">
<h2>校准的颜色-星等图<a class="headerlink" href="#id28" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>  <span class="c1"># 创建一个12x14英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清除当前图形中的所有内容</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个1行2列的子图，选择第一个子图</span>

<span class="n">mag1_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;f115w_in&#39;</span><span class="p">])</span>  <span class="c1"># 从cat_sel中提取f115w_in数据并转换为numpy数组</span>
<span class="n">mag2_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;f200w_in&#39;</span><span class="p">])</span>  <span class="c1"># 从cat_sel中提取f200w_in数据并转换为numpy数组</span>
<span class="n">diff_in</span> <span class="o">=</span> <span class="n">mag1_in</span> <span class="o">-</span> <span class="n">mag2_in</span>  <span class="c1"># 计算f115w和f200w之间的差值</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span>  <span class="c1"># 设置x轴的最小值</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mf">1.75</span>   <span class="c1"># 设置x轴的最大值</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="mi">25</span>     <span class="c1"># 设置y轴的最小值</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">15</span>     <span class="c1"># 设置y轴的最大值</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置第一个子图的x轴范围</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>   <span class="c1"># 设置第一个子图的y轴范围</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 自动选择x轴主刻度</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 自动选择x轴次刻度</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 自动选择y轴主刻度</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 自动选择y轴次刻度</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag1_in</span> <span class="o">-</span> <span class="n">mag2_in</span><span class="p">,</span> <span class="n">mag1_in</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 在第一个子图中绘制散点图</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">15.5</span><span class="p">,</span> <span class="s2">&quot;Input&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 在图中添加文本“Input”</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建一个1行2列的子图，选择第二个子图</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置第二个子图的x轴范围</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>   <span class="c1"># 设置第二个子图的y轴范围</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 自动选择x轴主刻度</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 自动选择x轴次刻度</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 自动选择y轴主刻度</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 自动选择y轴次刻度</span>

<span class="n">f115w</span> <span class="o">=</span> <span class="n">f115w_inst</span> <span class="o">+</span> <span class="n">zp_f115w</span>  <span class="c1"># 计算f115w的实际值</span>
<span class="n">f200w</span> <span class="o">=</span> <span class="n">f200w_inst</span> <span class="o">+</span> <span class="n">zp_f200w</span>  <span class="c1"># 计算f200w的实际值</span>

<span class="n">maglim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个从18到25的范围，步长为1</span>
<span class="n">mags</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化一个空列表用于存储星等</span>
<span class="n">errs_mag</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化一个空列表用于存储星等误差</span>
<span class="n">errs_col</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化一个空列表用于存储颜色误差</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">maglim</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历maglim的每个区间</span>

    <span class="n">mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># 计算当前区间的中间值</span>
    <span class="n">err_mag1</span> <span class="o">=</span> <span class="n">ef115w_inst</span><span class="p">[(</span><span class="n">f115w</span> <span class="o">&gt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f115w</span> <span class="o">&lt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])]</span>  <span class="c1"># 计算f115w在当前区间的误差</span>
    <span class="n">err_mag2</span> <span class="o">=</span> <span class="n">ef200w_inst</span><span class="p">[(</span><span class="n">f115w</span> <span class="o">&gt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f115w</span> <span class="o">&lt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])]</span>  <span class="c1"># 计算f200w在当前区间的误差</span>
    <span class="n">err_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">err_mag1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 计算当前区间的平均误差</span>
    <span class="n">err_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err_mag1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">err_mag2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 计算误差的平方和的平方根</span>
    <span class="n">err_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">err_temp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 计算颜色误差的平均值</span>

    <span class="n">errs_mag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_mag</span><span class="p">)</span>  <span class="c1"># 将当前星等误差添加到列表中</span>
    <span class="n">errs_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_col</span><span class="p">)</span>  <span class="c1"># 将当前颜色误差添加到列表中</span>
    <span class="n">mags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span>  <span class="c1"># 将当前星等添加到列表中</span>

<span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">maglim</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 初始化颜色列表，长度为maglim的长度减1</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">mags</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errs_mag</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">errs_col</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 在第二个子图中绘制误差条</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w</span> <span class="o">-</span> <span class="n">f200w</span><span class="p">,</span> <span class="n">f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 在第二个子图中绘制散点图</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">15.5</span><span class="p">,</span> <span class="s2">&quot;Output&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 在图中添加文本“Output”</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置第二个子图的x轴标签</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置第二个子图的y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图参数，使之填充整个图像区域</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id29">
<h2>输入与输出光度的比较<a class="headerlink" href="#id29" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>  <span class="c1"># 创建一个14x8英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清除当前图形中的所有内容</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个2行1列的子图，选择第一个子图</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为filt1，使用font2字体字典</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ Mag&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为Δ Mag，使用font2字体字典</span>

<span class="n">radec_input</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;ra_in&#39;</span><span class="p">],</span> <span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;dec_in&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>  <span class="c1"># 创建SkyCoord对象，使用输入的RA和Dec</span>

<span class="n">idx_f115w_cfr</span><span class="p">,</span> <span class="n">d2d_f115w_cfr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">radec_input</span><span class="p">,</span> <span class="n">radec_f115w</span><span class="p">)</span>  <span class="c1"># 匹配输入坐标与f115w坐标</span>

<span class="n">sep_f115w_cfr</span> <span class="o">=</span> <span class="n">d2d_f115w_cfr</span> <span class="o">&lt;</span> <span class="n">max_sep</span>  <span class="c1"># 计算匹配的分离度，判断是否小于最大分离度</span>

<span class="n">f115w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;f115w_in&#39;</span><span class="p">][</span><span class="n">sep_f115w_cfr</span><span class="p">])</span>  <span class="c1"># 获取输入的f115w数据</span>
<span class="n">f115w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f115w</span><span class="p">[</span><span class="n">idx_f115w_cfr</span><span class="p">[</span><span class="n">sep_f115w_cfr</span><span class="p">]])</span>  <span class="c1"># 获取PSF的f115w数据</span>

<span class="n">diff_f115w_cfr</span> <span class="o">=</span> <span class="n">f115w_inp_cfr</span> <span class="o">-</span> <span class="n">f115w_psf_cfr</span>  <span class="c1"># 计算输入与PSF之间的差异</span>
<span class="n">_</span><span class="p">,</span> <span class="n">med_diff_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f115w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f115w_cfr</span><span class="p">)</span>  <span class="c1"># 计算差异的中位数和标准差</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># 设置x轴下限</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mf">24.5</span>  <span class="c1"># 设置x轴上限</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w_cfr</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>  <span class="c1"># 设置y轴下限</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w_cfr</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># 设置y轴上限</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_psf_cfr</span><span class="p">,</span> <span class="n">diff_f115w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图，x为PSF数据，y为差异</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制水平参考线</span>

<span class="n">text</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filt1</span><span class="si">}</span><span class="s1"> $\Delta$ Mag = </span><span class="si">{</span><span class="n">med_diff_f115w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">sig_diff_f115w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span>  <span class="c1"># 创建文本字符串，显示中位数和标准差</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 在图中添加文本</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建第二个子图</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为filt2，使用font2字体字典</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ Mag&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为Δ Mag，使用font2字体字典</span>

<span class="n">idx_f200w_cfr</span><span class="p">,</span> <span class="n">d2d_f200w_cfr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">radec_input</span><span class="p">,</span> <span class="n">radec_f200w</span><span class="p">)</span>  <span class="c1"># 匹配输入坐标与f200w坐标</span>

<span class="n">sep_f200w_cfr</span> <span class="o">=</span> <span class="n">d2d_f200w_cfr</span> <span class="o">&lt;</span> <span class="n">max_sep</span>  <span class="c1"># 计算匹配的分离度，判断是否小于最大分离度</span>

<span class="n">f200w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;f200w_in&#39;</span><span class="p">][</span><span class="n">sep_f200w_cfr</span><span class="p">])</span>  <span class="c1"># 获取输入的f200w数据</span>
<span class="n">f200w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f200w</span><span class="p">[</span><span class="n">idx_f200w_cfr</span><span class="p">[</span><span class="n">sep_f200w_cfr</span><span class="p">]])</span>  <span class="c1"># 获取PSF的f200w数据</span>

<span class="n">diff_f200w_cfr</span> <span class="o">=</span> <span class="n">f200w_inp_cfr</span> <span class="o">-</span> <span class="n">f200w_psf_cfr</span>  <span class="c1"># 计算输入与PSF之间的差异</span>
<span class="n">_</span><span class="p">,</span> <span class="n">med_diff_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f200w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f200w_cfr</span><span class="p">)</span>  <span class="c1"># 计算差异的中位数和标准差</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># 设置x轴下限</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">24</span>  <span class="c1"># 设置x轴上限</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w_cfr</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>  <span class="c1"># 设置y轴下限</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w_cfr</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># 设置y轴上限</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f200w_psf_cfr</span><span class="p">,</span> <span class="n">diff_f200w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图，x为PSF数据，y为差异</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制水平参考线</span>

<span class="n">text</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filt2</span><span class="si">}</span><span class="s1"> $\Delta$ Mag = </span><span class="si">{</span><span class="n">med_diff_f200w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">sig_diff_f200w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span>  <span class="c1"># 创建文本字符串，显示中位数和标准差</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 在图中添加文本</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图参数，使之填充整个图像区域</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  <span class="c1"># 创建一个12x6英寸的图形</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建1行2列的第一个子图</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>  <span class="c1"># x轴下限</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">10</span>   <span class="c1"># x轴上限</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>  <span class="c1"># y轴下限</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">10</span>   <span class="c1"># y轴上限</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>   <span class="c1"># 设置y轴范围</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ RA (mas)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ Dec (mas)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置子图标题</span>

<span class="c1"># 获取输入和PSF的RA值</span>
<span class="n">ra_f115w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;ra_in&#39;</span><span class="p">][</span><span class="n">sep_f115w_cfr</span><span class="p">])</span>  <span class="c1"># 输入RA值</span>
<span class="n">ra_f115w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">idx_f115w_cfr</span><span class="p">[</span><span class="n">sep_f115w_cfr</span><span class="p">]])</span>  <span class="c1"># PSF RA值</span>

<span class="c1"># 获取输入和PSF的Dec值</span>
<span class="n">dec_f115w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;dec_in&#39;</span><span class="p">][</span><span class="n">sep_f115w_cfr</span><span class="p">])</span>  <span class="c1"># 输入Dec值</span>
<span class="n">dec_f115w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">dec</span><span class="p">[</span><span class="n">idx_f115w_cfr</span><span class="p">[</span><span class="n">sep_f115w_cfr</span><span class="p">]])</span>  <span class="c1"># PSF Dec值</span>

<span class="n">dec_rad_f115w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dec_f115w_psf_cfr</span><span class="p">)</span>  <span class="c1"># 将Dec值转换为弧度</span>

<span class="c1"># 计算RA差异</span>
<span class="n">diffra_f115w_cfr</span> <span class="o">=</span> <span class="p">((((</span><span class="n">ra_f115w_inp_cfr</span> <span class="o">-</span> <span class="n">ra_f115w_psf_cfr</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec_rad_f115w</span><span class="p">))</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span>  <span class="c1"># RA差异转换为毫角秒</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diffra_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diffra_f115w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diffra_f115w_cfr</span><span class="p">)</span>  <span class="c1"># 计算RA差异的中位数和标准差</span>

<span class="c1"># 计算Dec差异</span>
<span class="n">diffdec_f115w_cfr</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dec_f115w_inp_cfr</span> <span class="o">-</span> <span class="n">dec_f115w_psf_cfr</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span>  <span class="c1"># Dec差异转换为毫角秒</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diffdec_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diffdec_f115w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diffdec_f115w_cfr</span><span class="p">)</span>  <span class="c1"># 计算Dec差异的中位数和标准差</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">diffra_f115w_cfr</span><span class="p">,</span> <span class="n">diffdec_f115w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制RA和Dec差异的散点图</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制x=0的虚线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制y=0的虚线</span>

<span class="c1"># 添加RA差异的文本</span>
<span class="n">text</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;$\Delta$ RA (mas) = </span><span class="si">{</span><span class="n">med_diffra_f115w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">sig_diffra_f115w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">1.50</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 在图中添加文本</span>

<span class="c1"># 添加Dec差异的文本</span>
<span class="n">text</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;$\Delta$ Dec (mas) = </span><span class="si">{</span><span class="n">med_diffdec_f115w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">sig_diffdec_f115w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 在图中添加文本</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建1行2列的第二个子图</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>  <span class="c1"># x轴下限</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">10</span>   <span class="c1"># x轴上限</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>  <span class="c1"># y轴下限</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">10</span>   <span class="c1"># y轴上限</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>   <span class="c1"># 设置y轴范围</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置子图标题</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ RA (mas)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta$ Dec (mas)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="c1"># 获取输入和PSF的RA值</span>
<span class="n">ra_f200w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;ra_in&#39;</span><span class="p">][</span><span class="n">sep_f200w_cfr</span><span class="p">])</span>  <span class="c1"># 输入RA值</span>
<span class="n">ra_f200w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radec_f200w</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">idx_f200w_cfr</span><span class="p">[</span><span class="n">sep_f200w_cfr</span><span class="p">]])</span>  <span class="c1"># PSF RA值</span>

<span class="c1"># 获取输入和PSF的Dec值</span>
<span class="n">dec_f200w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;dec_in&#39;</span><span class="p">][</span><span class="n">sep_f200w_cfr</span><span class="p">])</span>  <span class="c1"># 输入Dec值</span>
<span class="n">dec_f200w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radec_f200w</span><span class="o">.</span><span class="n">dec</span><span class="p">[</span><span class="n">idx_f200w_cfr</span><span class="p">[</span><span class="n">sep_f200w_cfr</span><span class="p">]])</span>  <span class="c1"># PSF Dec值</span>

<span class="n">dec_rad_f200w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dec_f200w_psf_cfr</span><span class="p">)</span>  <span class="c1"># 将Dec值转换为弧度</span>

<span class="c1"># 计算RA差异</span>
<span class="n">diffra_f200w_cfr</span> <span class="o">=</span> <span class="p">((((</span><span class="n">ra_f200w_inp_cfr</span> <span class="o">-</span> <span class="n">ra_f200w_psf_cfr</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec_rad_f200w</span><span class="p">))</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span>  <span class="c1"># RA差异转换为毫角秒</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diffra_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diffra_f200w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diffra_f200w_cfr</span><span class="p">)</span>  <span class="c1"># 计算RA差异的中位数和标准差</span>

<span class="c1"># 计算Dec差异</span>
<span class="n">diffdec_f200w_cfr</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dec_f200w_inp_cfr</span> <span class="o">-</span> <span class="n">dec_f200w_psf_cfr</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span>  <span class="c1"># Dec差异转换为毫角秒</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diffdec_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diffdec_f200w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diffdec_f200w_cfr</span><span class="p">)</span>  <span class="c1"># 计算Dec差异的中位数和标准差</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">diffra_f200w_cfr</span><span class="p">,</span> <span class="n">diffdec_f200w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制RA和Dec差异的散点图</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制x=0的虚线</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制y=0的虚线</span>

<span class="c1"># 添加Dec差异的文本</span>
<span class="n">text</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;$\Delta$ Dec (mas) = </span><span class="si">{</span><span class="n">med_diffdec_f200w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">sig_diffdec_f200w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">1.50</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 在图中添加文本</span>

<span class="c1"># 添加RA差异的文本</span>
<span class="n">text</span> <span class="o">=</span> <span class="sa">rf</span><span class="s1">&#39;$\Delta$ RA (mas) = </span><span class="si">{</span><span class="n">med_diffra_f200w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1"> $\pm$ </span><span class="si">{</span><span class="n">sig_diffra_f200w_cfr</span><span class="si">:</span><span class="s1">5.3f</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 在图中添加文本</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图间距</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id30">
<h2>最后说明<a class="headerlink" href="#id30" title="Link to this heading">#</a></h2>
<p>本笔记本提供了如何使用 <a class="reference external" href="https://photutils.readthedocs.io/en/stable/">photutils</a> 包进行点扩散函数（PSF）光度测量的总体概述。在所有减缩步骤中采用的不同参数的选择以及PSF模型的选择取决于具体的用户科学案例。此外，只有在仪器调试后获得真实数据时，才能进行详细分析，以提供关于如何设置这些参数的建议，并概述在采用不同PSF模型（单一模型与PSF网格、网格中的PSF数量等）时输出光度测量的差异。在此背景下，我们注意到，选定的一个ERS项目（ERS 1334 - 解析恒星种群早期发布科学项目）将提供一个基本的测试基准，以探索上述不同选择如何影响拥挤恒星区域中PSF光度测量的质量。</p>
</section>
<section id="id31">
<h2>关于此笔记本<a class="headerlink" href="#id31" title="Link to this heading">#</a></h2>
<p><strong>作者</strong>: Matteo Correnti, JWST/NIRCam STScI 科学家 II &amp; Larry Bradley, 数据分析工具分支副主任\</p>
<p><strong>更新时间</strong>: 2025-02-27，使用 STPSF 替代 WebbPSF</p>
<p><a class="reference internal" href="#top"><span class="xref myst">页面顶部</span></a></p>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="空间望远镜标志" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" />
</a>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRCam/psf_photometry"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry_cn.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">交叉滤波 PSF 匹配</p>
      </div>
    </a>
    <a class="right-next"
       href="../NIRCam_wisp_subtraction/nircam_wisp_subtraction_cn.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">NIRCam Wisp 移除</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">进行中的工作：</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">导入</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">导入绘图函数</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stpsf-synphot">下载 STPSF 和 Synphot 数据</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">加载图像并创建一些有用的字典</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">选择用于分析的探测器和/或滤光片</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">显示图像</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">创建点扩散函数（PSF）模型</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#i-stpsf-psf">I. 使用 STPSF 创建 PSF 模型</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#single-psf-model">单一点扩散函数模型 (Single PSF model)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">显示单个点扩散函数（PSF）模型</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">PSF 网格</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">显示PSF网格</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ii-effective-psf-epsf">II. 创建有效点扩散函数模型 (Effective PSF, ePSF)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ii-psf">II. 构建有效的点扩散函数 (PSF)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#epsfs">显示ePSFs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">进行中的工作 - 构建有效的PSF网格</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#i-psf">I. 统计网格中每个区域的PSF星星数量</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#todo-epsf">TODO - 创建ePSF网格</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#todo-epsf-stpsf">TODO - 使用 ePSF 网格来扰动 STPSF 模型</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">执行PSF光度测量</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">输出光度表</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">显示减法图像</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">第二部分 - 数据分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">加载具有点扩散函数（PSF）光度的表格</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#datamodel">将图像转换为数据模型（DataModel）</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">对两个滤镜的四幅图像进行目录交叉匹配</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">四幅图像的颜色-星等图（仪器星等）</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#daofindpsf">daofind与PSF算法获取位置的差异（以像素为单位）</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">对每个滤光片交叉匹配4个目录</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">开发者注意事项：</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">最终颜色-星等图（仪器星等）</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#photometric-zeropoints">光度零点 (Photometric Zeropoints)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">加载已校准和矫正的图像（三级成像处理管道）</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">显示图像</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aperture-photometry">光圈光度法 (Aperture Photometry)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">寻找明亮的孤立恒星</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">加载孔径校正表</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">执行光圈光度法</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#zeropoints">推导零点（Zeropoints）</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">导入输入光度数据</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">校准的颜色-星等图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">输入与输出光度的比较</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id30">最后说明</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id31">关于此笔记本</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>