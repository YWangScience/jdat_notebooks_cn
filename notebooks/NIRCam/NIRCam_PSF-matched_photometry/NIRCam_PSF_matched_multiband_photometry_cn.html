
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>交叉滤波 PSF 匹配 &#8212; STScI JDAT Notebooks 中文版</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css?v=b44a18d9" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry_cn';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="PSF 光度测量" href="../psf_photometry/NIRCam_PSF_Photometry_Example_cn.html" />
    <link rel="prev" title="扩展孔径光度测量" href="../NIRCam_photometry/NIRCam_multiband_photometry_cn.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks 中文版 - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks 中文版 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">主页</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install_cn.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow_cn.html">笔记本开发工作流程</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">开发</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks_cn.html">提交笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements_cn.html">需求文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks_cn.html">Jupyter 笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files_cn.html">数据文件</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub 指南</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup_cn.html">GitHub 设置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow_cn.html">GitHub 工作流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr_cn.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">跨仪器通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example_cn.html">ASDF 示例</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation_cn.html">复杂的二维背景</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3_cn.html">复合模型光谱拟合</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query_cn.html">MAST 查询</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina_cn.html">Imviz RGB图像</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift_cn.html">Specviz 简单示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS_cn.html">提高纯平行数据集的WCS精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/stpsf_examples/stpsf_examples_cn.html">STPSF 示例</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis_cn.html">MRS Mstar - 数据分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc_cn.html">LMC中的IFU YSOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1_cn.html">LRS 光谱提取</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example_cn.html">点源光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry_cn.html">扩展孔径光度测量</a></li>


<li class="toctree-l1 current active"><a class="current reference internal" href="#">交叉滤光片 PSF 匹配</a></li>
<li class="toctree-l1"><a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example_cn.html">PSF 光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam_wisp_subtraction/nircam_wisp_subtraction_cn.html">NIRCam 光晕去除</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction_cn.html">WFSS 光谱 - 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra_cn.html">WFSS 光谱 - 合并和归一化 1D 光谱</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template_cn.html">WFSS 光谱 - 相关性模版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map_cn.html">WFSS 光谱 - 发射线图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup_cn.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3_cn.html">运行图像处理管道并创建源目录</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2_cn.html">运行 spec2 管道</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit_cn.html">IFU立方体拟合</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/cube_fitting/cube_fitting_cn.html">IFU Cube 建模</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/ifu_optimal/ifu_optimal_cn.html">IFU 光谱提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/optimal_extraction/Spectral_Extraction-static_cn.html">MOS 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/mos_spectroscopy_advanced/MOSspec_advanced_cn.html">星系外场的MOS光谱</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST_cn.html">BOTS 时间序列观测</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/galaxy_redshift/redshift_fitting_cn.html">红移和模板拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/FS_NSClean_example_cn.html">FS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/IFU_NSClean_example_cn.html">IFU 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/MOS_NSClean_example_cn.html">MOS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example_cn.html">BOTS 数据生成 （NSClean）</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRCam/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry_cn.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>交叉滤波 PSF 匹配</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">引言</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">导入包</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#matplotlib">Matplotlib 设置用于绘图</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">创建待加载和分析的图像列表</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f200w">加载探测图像：F200W</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">报告图像大小和视场</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">创建彩色图像（可选）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#astropy-photutils">使用 astropy.photutils 检测源和去混叠</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">在检测图像中测量光度（及更多）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">显示检测结果与图像（可选）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">查看 / 保存检测图像中的测量量（可选）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">仅保留某些量</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">将测量的通量（数据单位）转换为星等</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">使用在检测图像中定义的等亮度光圈进行多波段光度测量</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#isophotal-kron">光圈修正：等光度（isophotal）到总（Kron光圈）通量</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">重新格式化输出目录以提高可读性（可选）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">无点扩散函数（PSF）校正的等光度测光</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">PSF幅度校正</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#psfs">加载点扩散函数 (PSFs)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">PSF 匹配</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">确定PSF卷积核</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#f200w-psfs">将F200W探测图像卷积到长波长点扩散函数（PSFs）</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">卷积图像中的多波段光度测量</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">PSF 亮度修正</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">开始新会话并分析结果</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">加载目录和分割图</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#jades-jaguar">输入模拟 JADES JAGUAR 目录</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#photutils">将天体与 photutils 目录匹配</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f200w-f090w">绘制 F200W 与 F090W 亮度图并寻找掉落星系</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">在所有滤光片中显示选定对象</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sed">绘制单个天体的光谱能量分布 (SED)</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="psf">
<h1>交叉滤波 PSF 匹配<a class="headerlink" href="#psf" title="Link to this heading">#</a></h1>
<p><strong>用例：</strong> 在一个星系外的“空白”区域测量星系光度。相关于 <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-camera/nircam-example-science-programs/nircam-deep-field-imaging-with-miri-imaging-parallels">JDox 科学用例 #22</a>。<br></p>
<p><strong>数据：</strong> JWST 模拟的 NIRCam 图像来自 <a class="reference external" href="http://fenrir.as.arizona.edu/jwstmock/">JADES JWST GTO 星系外空白区域</a>。<br></p>
<p>（Williams et al. 2018）https://ui.adsabs.harvard.edu/abs/2018ApJS..236…33W。<br></p>
<p><strong>工具：</strong> photutils, matplotlib。<br></p>
<p><strong>跨仪器：</strong> 可能涉及 NIRISS, MIRI。<br></p>
<p><strong>文档：</strong> 本笔记本是 STScI 更大 <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">后处理数据分析工具生态系统</a> 的一部分。<br></p>
<section id="id1">
<h2>引言<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>本笔记本使用 <code class="docutils literal notranslate"><span class="pre">photutils</span></code> 在 NIRCam 深成像中检测天体/星系。首先在 F200W 图像中进行检测，然后在所有 9 个滤光片（F090W, F115W, F150W, F200W, F277W, F335M, F356W, F410M, F444W）中获取等光度光度测量。使用 PSF 匹配来校正在长波长图像（红色于 F200W 之上）中测量的光度。</p>
<p>在保存光度目录后，笔记本演示了如何在新会话中加载该笔记本。</p>
<p>它展示了对完整目录和单个星系的一些简单分析。</p>
<p>通过将测量的颜色与模拟输入颜色进行比较，</p>
<p>它显示经过 PSF 校正后，测量更为准确，尽管仍可进一步改进。</p>
<p>该笔记本仅分析完整 JADES 模拟的中心 1000 x 1000 像素（30” x 30”）。这些切片已获得作者（Williams et al.）的许可，并在 STScI 进行存档。</p>
<p><strong>注意事项：</strong></p>
<ul class="simple">
<li><p>这是一项正在进行中的工作。可能获得更准确的光度测量。</p></li>
<li><p>这些 JADES 图像是使用 <a class="reference external" href="https://github.com/cnaw/guitarra">Guitarra</a> 模拟的，而不是 <a class="reference external" href="https://github.com/spacetelescope/mirage">MIRAGE</a>。它们具有不同的属性和单位（e-/s），与 JWST 管道产品（MJy/sr）不同。</p></li>
<li><p>所有图像在分析前都已对齐至相同的 0.03” 像素网格。如果需要，可以使用 <a class="reference external" href="https://reproject.readthedocs.io"><code class="docutils literal notranslate"><span class="pre">reproject</span></code></a> 进行此对齐。</p></li>
<li><p>通过考虑相关噪声和/或更直接地测量每个图像中的噪声，可以进一步改善通量不确定性计算。</p></li>
</ul>
<p><em>开发者笔记：</em></p>
<p>以下是报告的问题摘要：</p>
<ul class="simple">
<li><p>单位在 <code class="docutils literal notranslate"><span class="pre">plot</span></code> 中可以正常工作，但与 <code class="docutils literal notranslate"><span class="pre">errorbar</span></code> 和 <code class="docutils literal notranslate"><span class="pre">text</span></code> 不兼容。</p></li>
<li><p>流量单位可以自动转换为 AB 亮度，但流量 <em>不确定性</em> 不能自动转换为亮度不确定性。</p></li>
<li><p>次要轴应该自动处理流量和 AB 亮度单位之间的转换。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sharex</span></code> 和 <code class="docutils literal notranslate"><span class="pre">sharey</span></code> 在 WCS <code class="docutils literal notranslate"><span class="pre">projection</span></code> 中无法正常工作。</p></li>
</ul>
<p>我也无法弄明白如何：</p>
<ul class="simple">
<li><p>使绘图坐标轴自动缩放到仅 <em>部分</em> 绘制的数据。</p></li>
<li><p>在交互式图中使工具提示悬停在光标下的数据点上。</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 检查PEP 8风格格式</span>

<span class="c1"># %load_ext pycodestyle_magic  # 加载pycodestyle_magic扩展以检查代码风格</span>

<span class="c1"># %flake8_on --ignore E261,E501,W291,W2,E302,E305  # 启用flake8检查，忽略特定的错误代码</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h2>导入包<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Numpy 用于一般数组计算</p></li>
<li><p>Photutils 用于光度计算、PSF 匹配</p></li>
<li><p>Astropy 用于处理 FITS、WCS、表格、单位、彩色图像、绘图、卷积</p></li>
<li><p>os 和 glob 用于文件管理</p></li>
<li><p>copy 用于表格修改</p></li>
<li><p>Matplotlib 用于绘图</p></li>
<li><p>Watermark 用于检查所有导入包的版本（可选）</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># 导入NumPy库，用于数值计算</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  <span class="c1"># 导入os库，用于操作系统相关功能</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">glob</span>  <span class="c1"># 从glob模块导入glob函数，用于文件路径匹配</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>  <span class="c1"># 从copy模块导入deepcopy函数，用于深拷贝对象</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astropy</span>  <span class="c1"># 导入Astropy库，版本4.2用于将亮度写入ecsv文件</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>  <span class="c1"># 从astropy.io模块导入fits，用于处理FITS文件</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.wcs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">wcs</span>  <span class="c1"># 导入astropy.wcs模块，用于处理世界坐标系统（WCS）</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">QTable</span><span class="p">,</span> <span class="n">Table</span>  <span class="c1"># 从astropy.table模块导入QTable和Table，用于表格数据处理</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>  <span class="c1"># 导入astropy.units模块，用于处理物理单位</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_lupton_rgb</span><span class="p">,</span> <span class="n">SqrtStretch</span><span class="p">,</span> <span class="n">LogStretch</span><span class="p">,</span> <span class="n">hist</span>  <span class="c1"># 导入可视化相关函数</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization.mpl_normalize</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageNormalize</span>  <span class="c1"># 导入图像归一化工具</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.convolution</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gaussian2DKernel</span>  <span class="c1"># 导入高斯2D卷积核</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_fwhm_to_sigma</span>  <span class="c1"># 导入将FWHM转换为sigma的函数</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>  <span class="c1"># 导入SkyCoord类，用于天球坐标处理</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">Background2D</span><span class="p">,</span> <span class="n">MedianBackground</span>  <span class="c1"># 导入背景处理工具</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.segmentation</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">detect_sources</span><span class="p">,</span> <span class="n">deblend_sources</span><span class="p">,</span> <span class="n">SourceCatalog</span><span class="p">,</span>  <span class="c1"># 导入源检测和分离工具</span>
                                    <span class="n">make_2dgaussian_kernel</span><span class="p">,</span> <span class="n">SegmentationImage</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">calc_total_error</span>  <span class="c1"># 导入计算总误差的工具</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf.matching</span><span class="w"> </span><span class="kn">import</span> <span class="n">resize_psf</span><span class="p">,</span> <span class="n">SplitCosineBellWindow</span><span class="p">,</span> <span class="n">create_matching_kernel</span>  <span class="c1"># 导入PSF匹配工具</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.convolution</span><span class="w"> </span><span class="kn">import</span> <span class="n">convolve</span><span class="p">,</span> <span class="n">convolve_fft</span>  <span class="c1"># 导入卷积函数</span>
</pre></div>
</div>
</div>
</div>
<section id="matplotlib">
<h3>Matplotlib 设置用于绘图<a class="headerlink" href="#matplotlib" title="Link to this heading">#</a></h3>
<p>有两个版本</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">notebook</span></code> – 提供交互式图形，但使整个笔记本的滚动变得稍微困难</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inline</span></code> – 提供非交互式图形，以便更好地滚动整体内容</p></li>
</ul>
<p><em>开发者笔记：</em></p>
<p><code class="docutils literal notranslate"><span class="pre">%matplotlib</span> <span class="pre">notebook</span></code> 有时会生成过大的图形；需要重新运行单元格以使其恢复正常</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>  <span class="c1"># 导入绘图库，用于绘制图形</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>  <span class="c1"># 导入matplotlib库的其他功能</span>

<span class="c1"># 使用此版本进行非交互式绘图（更容易滚动笔记本）</span>

<span class="o">%</span><span class="k">matplotlib</span> inline  # 设置为内联模式，图形将在笔记本中直接显示

<span class="c1"># 如果您想要交互式图形，请使用此版本</span>

<span class="c1"># %matplotlib notebook  # 设置为交互模式，允许与图形交互</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ticker</span>  <span class="c1"># 导入刻度器，用于自定义坐标轴刻度</span>

<span class="n">mpl_colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>  <span class="c1"># 获取当前绘图颜色循环</span>

<span class="c1"># 这些技巧是为了使图形的大小在内联和笔记本版本中保持一致</span>

<span class="o">%</span><span class="k">config</span> InlineBackend.print_figure_kwargs = {&#39;bbox_inches&#39;: None}  # 配置图形输出时的边界框设置

<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># 设置保存图形时的分辨率为100 DPI</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># 设置图形显示时的分辨率为100 DPI</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">mplcursors</span>  <span class="c1"># 可选：用于悬停在绘制的点上并显示ID号码</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 显示Python及导入库的版本信息</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">watermark</span>  <span class="c1"># 导入watermark库，用于显示版本信息</span>

    <span class="o">%</span><span class="k">load_ext</span> watermark  # 加载watermark扩展

    <span class="c1"># %watermark -n -v -m -g -iv  # 原始命令，显示更多信息（已注释）</span>

    <span class="o">%</span><span class="k">watermark</span> -iv -v  # 显示导入库的版本和Python的版本

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>  <span class="c1"># 如果没有安装watermark库，则跳过</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h3>创建待加载和分析的图像列表<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p>所有数据和权重图像必须对齐到相同的像素网格。</p>
<p>（如有需要，请使用 <a class="reference external" href="https://reproject.readthedocs.io"><code class="docutils literal notranslate"><span class="pre">reproject</span></code></a> 来实现。）</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_file_url</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/&#39;</span>  <span class="c1"># 输入文件的URL地址</span>

<span class="n">filters</span> <span class="o">=</span> <span class="s1">&#39;F090W F115W F150W F200W F277W F335M F356W F410M F444W&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>  <span class="c1"># 定义滤光片列表并分割成单个滤光片</span>

<span class="n">wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">filt</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span>  <span class="c1"># 将滤光片的波长转换为微米，例如F115W = 1.15微米</span>

<span class="c1"># 数据图像 [e-/s]，与JWST管道图像的单位 [Myr/sr] 不同</span>
<span class="n">image_files</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 创建一个字典来存储图像文件路径</span>

<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>  <span class="c1"># 遍历每个滤光片</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;jades_jwst_nircam_goods_s_crop_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">.fits&#39;</span>  <span class="c1"># 构建图像文件名</span>
    <span class="n">image_files</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_file_url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>  <span class="c1"># 将完整路径存入字典</span>

<span class="c1"># 权重图像（逆方差图；IVM）</span>
<span class="n">weight_files</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 创建一个字典来存储权重文件路径</span>

<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>  <span class="c1"># 遍历每个滤光片</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;jades_jwst_nircam_goods_s_crop_</span><span class="si">{</span><span class="n">filt</span><span class="si">}</span><span class="s1">_wht.fits&#39;</span>  <span class="c1"># 构建权重文件名</span>
    <span class="n">weight_files</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_file_url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>  <span class="c1"># 将完整路径存入字典</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="f200w">
<h3>加载探测图像：F200W<a class="headerlink" href="#f200w" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">detection_filter</span> <span class="o">=</span> <span class="n">filt</span> <span class="o">=</span> <span class="s1">&#39;F200W&#39;</span>  <span class="c1"># 设置检测滤光器为F200W</span>

<span class="n">infile</span> <span class="o">=</span> <span class="n">image_files</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>  <span class="c1"># 从图像文件中获取对应滤光器的文件名</span>

<span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>  <span class="c1"># 打开图像文件，返回HDU对象</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取HDU对象中第一个扩展的数据部分</span>

<span class="n">imwcs</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">hdu</span><span class="p">)</span>  <span class="c1"># 创建WCS对象以处理图像的世界坐标系统</span>

<span class="n">weight</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">weight_files</span><span class="p">[</span><span class="n">filt</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 打开权重文件并获取数据部分</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3>报告图像大小和视场<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># 获取数据的行数和列数</span>

<span class="c1"># image_pixel_scale = np.abs(hdu[0].header[&#39;CD1_1&#39;]) * 3600  # 原始像素比例计算（已注释掉）</span>

<span class="n">image_pixel_scale</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">proj_plane_pixel_scales</span><span class="p">(</span><span class="n">imwcs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 计算图像的像素比例</span>

<span class="n">image_pixel_scale</span> <span class="o">*=</span> <span class="n">imwcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cunit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>  <span class="c1"># 将单位转换为角秒</span>

<span class="n">outline</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> x </span><span class="si">%d</span><span class="s1"> pixels&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>  <span class="c1"># 创建输出字符串，包含像素的行数和列数</span>

<span class="n">outline</span> <span class="o">+=</span> <span class="s1">&#39; = </span><span class="si">%g</span><span class="s1">&quot; x </span><span class="si">%g</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ny</span> <span class="o">*</span> <span class="n">image_pixel_scale</span><span class="p">,</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">image_pixel_scale</span><span class="p">)</span>  <span class="c1"># 添加图像的实际尺寸</span>

<span class="n">outline</span> <span class="o">+=</span> <span class="s1">&#39; (</span><span class="si">%.2f</span><span class="s1">&quot; / pixel)&#39;</span> <span class="o">%</span> <span class="n">image_pixel_scale</span>  <span class="c1"># 添加每个像素的尺寸</span>

<span class="nb">print</span><span class="p">(</span><span class="n">outline</span><span class="p">)</span>  <span class="c1"># 打印输出结果</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h3>创建彩色图像（可选）<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 3 NIRCam短波长通道图像</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F200W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 打开F200W图像文件并获取数据，赋值给r</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F150W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 打开F150W图像文件并获取数据，赋值给g</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F090W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 打开F090W图像文件并获取数据，赋值给b</span>

<span class="n">color_image_short_wavelength</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>  <span class="c1"># 使用Lupton RGB方法生成短波长彩色图像</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 3 NIRCam长波长通道图像</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F444W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 打开F444W图像文件并获取数据</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F356W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 打开F356W图像文件并获取数据</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="s1">&#39;F277W&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 打开F277W图像文件并获取数据</span>

<span class="n">color_image_long_wavelength</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span> <span class="c1"># 生成长波长的RGB图像</span>
</pre></div>
</div>
</div>
</div>
<p><em>开发者注释：</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sharex 和 sharey 在 projection=imwcs 下似乎存在一些兼容性问题

作为一种解决方法，我尝试过但未能关闭下面右侧图的 y 轴标签
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># 创建一个9.5x4英寸的图形</span>

<span class="n">ax_sw</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">imwcs</span><span class="p">)</span>  <span class="c1"># 添加第一个子图，使用给定的WCS投影</span>
<span class="c1"># , sharex=True, sharey=True)  # 注释掉的代码用于共享x和y轴</span>

<span class="n">ax_sw</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">color_image_short_wavelength</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>  <span class="c1"># 显示短波长通道的图像，原点在下方</span>

<span class="n">ax_sw</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为“赤经”</span>

<span class="n">ax_sw</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Declination&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为“赤纬”</span>

<span class="n">ax_sw</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Short Wavelength Channel&#39;</span><span class="p">)</span>  <span class="c1"># 设置子图标题为“短波长通道”</span>

<span class="n">ax_lw</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">imwcs</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax_sw</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax_sw</span><span class="p">)</span>  <span class="c1"># 添加第二个子图，使用相同的WCS投影，并共享x和y轴</span>

<span class="n">ax_lw</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">color_image_long_wavelength</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>  <span class="c1"># 显示长波长通道的图像，原点在下方</span>

<span class="n">ax_lw</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Right Ascension&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为“赤经”</span>

<span class="n">ax_lw</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Long Wavelength Channel&#39;</span><span class="p">)</span>  <span class="c1"># 设置子图标题为“长波长通道”</span>

<span class="n">ax_lw</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为空</span>

<span class="c1"># ax_lw.set(yticklabels=[])  # 注释掉的代码用于隐藏y轴刻度标签</span>

<span class="c1"># plt.subplots_adjust(left=0.15)  # 注释掉的代码用于调整子图的左边距</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Interactive zoom / pan controls both images simultaneously&#39;</span><span class="p">)</span>  <span class="c1"># 打印信息，表示交互式缩放/平移同时控制两个图像</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="astropy-photutils">
<h3>使用 astropy.photutils 检测源和去混叠<a class="headerlink" href="#astropy-photutils" title="Link to this heading">#</a></h3>
<p>https://photutils.readthedocs.io/en/latest/segmentation.html</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 在此定义所有检测和测量参数，以便对每个图像进行一致的测量</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Photutils_Catalog</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">image_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># 初始化函数，接收滤波器、图像文件和详细输出参数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_file</span> <span class="o">=</span> <span class="n">image_file</span> <span class="ow">or</span> <span class="n">image_files</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>  <span class="c1"># 如果未提供图像文件，则使用默认图像文件</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_file</span><span class="p">)</span>  <span class="c1"># 打开图像文件</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imwcs</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">)</span>  <span class="c1"># 获取图像的WCS信息</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zeropoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ABMAG&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span>  <span class="c1"># 获取零点星等</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weight_file</span> <span class="o">=</span> <span class="n">weight_files</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>  <span class="c1"># 获取权重文件名</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">weight_files</span><span class="p">[</span><span class="n">filt</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 打开权重文件并获取数据</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="c1"># 如果verbose为真，输出滤波器、零点和图像文件信息</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;  zeropoint =&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zeropoint</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight_file</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">measure_background_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bkg_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># 计算50x50像素单元中的sigma裁剪背景，然后在3x3单元上进行中值滤波</span>
        <span class="c1"># 为获得最佳结果，图像应在两个维度上跨越整数个单元（这里，1000=20x50像素）</span>
        <span class="c1"># https://photutils.readthedocs.io/en/stable/background.html</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">bkg_size</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="n">filter_size</span><span class="p">)</span>  <span class="c1"># 计算背景图</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_detect_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">,</span> <span class="n">npixels</span><span class="p">,</span> <span class="n">smooth_fwhm</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                           <span class="n">deblend_levels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">deblend_contrast</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># 设置检测阈值图为背景基线以上nsigma倍的RMS</span>
        <span class="n">detection_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">nsigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_rms</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background</span>

        <span class="c1"># 在检测之前，用高斯函数对数据进行卷积</span>
        <span class="n">smooth_kernel</span> <span class="o">=</span> <span class="n">make_2dgaussian_kernel</span><span class="p">(</span><span class="n">smooth_fwhm</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">)</span>  <span class="c1"># 创建高斯卷积核</span>
        <span class="n">convolved_data</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">smooth_kernel</span><span class="p">)</span>  <span class="c1"># 对数据进行卷积处理</span>

        <span class="c1"># 在经过卷积的图像中检测具有npixels个连接像素的源</span>
        <span class="c1"># https://photutils.readthedocs.io/en/stable/segmentation.html</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segm_detect</span> <span class="o">=</span> <span class="n">detect_sources</span><span class="p">(</span><span class="n">convolved_data</span><span class="p">,</span> <span class="n">detection_threshold</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="n">npixels</span><span class="p">)</span>  <span class="c1"># 检测源</span>

        <span class="c1"># 去混叠：分离连接/重叠的源</span>
        <span class="c1"># https://photutils.readthedocs.io/en/stable/segmentation.html#source-deblending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segm_deblend</span> <span class="o">=</span> <span class="n">deblend_sources</span><span class="p">(</span><span class="n">convolved_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segm_detect</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="n">npixels</span><span class="p">,</span>
                                            <span class="n">nlevels</span><span class="o">=</span><span class="n">deblend_levels</span><span class="p">,</span> <span class="n">contrast</span><span class="o">=</span><span class="n">deblend_contrast</span><span class="p">)</span>  <span class="c1"># 去混叠处理</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="c1"># 如果verbose为真，输出检测和去混叠的结果</span>
            <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;Cataloged </span><span class="si">%d</span><span class="s1"> objects&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">segm_deblend</span><span class="o">.</span><span class="n">nlabels</span>  <span class="c1"># 输出去混叠后的对象数量</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39;, deblended from </span><span class="si">%d</span><span class="s1"> detections&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">segm_detect</span><span class="o">.</span><span class="n">nlabels</span>  <span class="c1"># 输出检测到的对象数量</span>
            <span class="n">median_threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">nsigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_rms_median</span><span class="p">)</span> \
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_median</span>  <span class="c1"># 计算中值阈值</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39; with </span><span class="si">%d</span><span class="s1"> pixels above </span><span class="si">%g</span><span class="s1">-sigma threshold&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npixels</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">)</span>  <span class="c1"># 输出阈值信息</span>
            <span class="c1"># 背景输出等同于SourceExtractor报告的内容</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39;Background median </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_median</span>  <span class="c1"># 输出背景中值</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39;, RMS </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_rms_median</span>  <span class="c1"># 输出背景RMS</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s1">&#39;, threshold median </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">median_threshold</span>  <span class="c1"># 输出阈值中值</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>  <span class="c1"># 打印输出信息</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">measure_source_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_time</span><span class="p">,</span> <span class="n">local_background_width</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
        <span class="c1"># &quot;effective_gain&quot; = 曝光时间图（从数据速率单位转换为计数）</span>
        <span class="c1"># 权重 = 逆方差图 = 1 / sigma_background**2（没有源）</span>
        <span class="c1"># https://photutils.readthedocs.io/en/latest/api/photutils.utils.calc_total_error.html</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_map</span> <span class="o">=</span> <span class="n">exposure_time</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_rms_median</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span>  <span class="c1"># 计算曝光时间图</span>

        <span class="c1"># 数据RMS不确定性是背景RMS和源泊松不确定性的组合</span>
        <span class="n">background_rms</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>  <span class="c1"># 计算背景RMS</span>
        <span class="c1"># 有效增益参数需要在每个地方都是正值（不能为零），因此添加小值1e-8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_rms</span> <span class="o">=</span> <span class="n">calc_total_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">background_rms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time_map</span><span class="o">+</span><span class="mf">1e-8</span><span class="p">)</span>  <span class="c1"># 计算数据RMS</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">SourceCatalog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">segm_deblend</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imwcs</span><span class="p">,</span> 
                                         <span class="n">error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_rms</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> 
                                         <span class="n">localbkg_width</span><span class="o">=</span><span class="n">local_background_width</span><span class="p">)</span>  <span class="c1"># 创建源目录</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 创建一个Photutils_Catalog对象，使用指定的检测滤波器</span>
<span class="n">detection_catalog</span> <span class="o">=</span> <span class="n">Photutils_Catalog</span><span class="p">(</span><span class="n">detection_filter</span><span class="p">)</span>

<span class="c1"># 测量背景图，以便后续源检测使用</span>
<span class="n">detection_catalog</span><span class="o">.</span><span class="n">measure_background_map</span><span class="p">()</span>

<span class="c1"># 运行源检测，设置检测阈值为2个标准差，最小连通像素数为5</span>
<span class="n">detection_catalog</span><span class="o">.</span><span class="n">run_detect_sources</span><span class="p">(</span><span class="n">nsigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h3>在检测图像中测量光度（及更多）<a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<p>https://photutils.readthedocs.io/en/latest/segmentation.html#centroids-photometry-and-morphological-properties</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># exposure_time = hdu[0].header.get(&#39;EXPTIME&#39;)  # seconds  # 从图像头文件中获取曝光时间（秒）</span>

<span class="n">exposure_time</span> <span class="o">=</span> <span class="mi">49500</span>  <span class="c1"># seconds; Adding by hand because it&#39;s missing from the image header  # 手动添加曝光时间，因为图像头文件中缺失</span>

<span class="n">detection_catalog</span><span class="o">.</span><span class="n">measure_source_properties</span><span class="p">(</span><span class="n">exposure_time</span><span class="p">)</span>  <span class="c1"># 使用曝光时间测量源属性</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 保存检测到的物体的分割图</span>

<span class="c1"># 创建一个主HDU对象，包含分割图数据，并将WCS头信息添加到HDU中</span>
<span class="n">segm_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">detection_catalog</span><span class="o">.</span><span class="n">segm_deblend</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="n">imwcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">())</span>

<span class="c1"># 将HDU写入FITS文件，文件名为&#39;JADES_detections_segm.fits&#39;，如果文件已存在则覆盖</span>
<span class="n">segm_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;JADES_detections_segm.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h3>显示检测结果与图像（可选）<a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<p><em>开发者注释：</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>交互式图表可以同时缩放/平移所有帧。（用户可以对单个星系进行缩放。）
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  <span class="c1"># 创建一个2行3列的子图，x和y轴共享，设置图像大小</span>

<span class="c1"># fig, ax = plt.subplots(2, 3, sharex=True, sharey=True, figsize=(9.5, 6), subplot_kw={&#39;projection&#39;: imwcs})</span>
<span class="c1"># 如果需要使用RA和Dec坐标轴而不是像素坐标，可以添加: , subplot_kw={&#39;projection&#39;: imwcs})</span>

<span class="c1"># 彩色图像</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">color_image_short_wavelength</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>  <span class="c1"># 显示短波长的彩色图像，原点在下方</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Color Image&#39;</span><span class="p">)</span>  <span class="c1"># 设置子图标题为“彩色图像”</span>

<span class="c1"># 数据</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 创建图像归一化对象，使用平方根拉伸，最小值为0</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>  <span class="c1"># 显示检测图像，使用灰度反转色图</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Detection Image F200W&#39;</span><span class="p">)</span>  <span class="c1"># 设置子图标题为“检测图像 F200W”</span>

<span class="c1"># 分割图</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">detection_catalog</span><span class="o">.</span><span class="n">segm_deblend</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>  <span class="c1"># 创建分割图的色图，使用随机种子</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">detection_catalog</span><span class="o">.</span><span class="n">segm_deblend</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>  <span class="c1"># 显示分割图，原点在下方</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Detections (Segmentation Image)&#39;</span><span class="p">)</span>  <span class="c1"># 设置子图标题为“检测（分割图）”</span>

<span class="c1"># norm = ImageNormalize(stretch=SqrtStretch())</span>
<span class="c1"># ax[1,0].imshow(weight, origin=&#39;lower&#39;, cmap=&#39;Greys_r&#39;, vmin=0)</span>
<span class="c1"># ax[1,0].set_title(&#39;Weight Image F200W&#39;)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">detection_catalog</span><span class="o">.</span><span class="n">exposure_time_map</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 显示曝光时间图，原点在下方</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Exposure Time Map&#39;</span><span class="p">)</span>  <span class="c1"># 设置子图标题为“曝光时间图”</span>

<span class="c1"># ax[1,0].imshow(background_map.background, origin=&#39;lower&#39;, cmap=&#39;Greys_r&#39;)</span>
<span class="c1"># ax[1,0].set_title(&#39;Background Pedestal&#39;)</span>

<span class="c1"># RMS</span>
<span class="c1"># norm = ImageNormalize()</span>
<span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0035</span>  <span class="c1"># 设置RMS图像的最小值和最大值</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">detection_catalog</span><span class="o">.</span><span class="n">background_map</span><span class="o">.</span><span class="n">background_rms</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>  <span class="c1"># 显示背景RMS图，原点在下方</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Background RMS&#39;</span><span class="p">)</span>  <span class="c1"># 设置子图标题为“背景RMS”</span>

<span class="c1"># 包括泊松噪声的总误差</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">detection_catalog</span><span class="o">.</span><span class="n">data_rms</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>  <span class="c1"># 显示数据RMS图，原点在下方</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS + Poisson noise&#39;</span><span class="p">)</span>  <span class="c1"># 设置子图标题为“RMS + 泊松噪声”</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图布局，使其更紧凑</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Interactive zoom / pan controls all images simultaneously&#39;</span><span class="p">)</span>  <span class="c1"># 打印信息，表示所有图像的交互缩放/平移控制同时生效</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id8">
<h3>查看 / 保存检测图像中的测量量（可选）<a class="headerlink" href="#id8" title="Link to this heading">#</a></h3>
</section>
<section id="id9">
<h3>仅保留某些量<a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义所需的列名</span>
<span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;label xcentroid ycentroid sky_centroid area semimajor_sigma semiminor_sigma&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="c1"># 添加更多的列名</span>
<span class="n">columns</span> <span class="o">+=</span> <span class="s1">&#39;ellipticity orientation gini&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="c1"># 再添加一些列名</span>
<span class="n">columns</span> <span class="o">+=</span> <span class="s1">&#39;kron_radius local_background segment_flux segment_fluxerr kron_flux kron_fluxerr&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="c1"># 注释掉的代码，可能是为了添加更多的列名</span>
<span class="c1"># columns += &#39;source_sum source_sum_err kron_flux kron_fluxerr kron_radius local_background&#39;.split()</span>

<span class="c1"># 将检测目录转换为表格格式，并选择指定的列</span>
<span class="n">source_table</span> <span class="o">=</span> <span class="n">detection_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">to_table</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

<span class="c1"># 将 &#39;semimajor_sigma&#39; 列重命名为 &#39;a&#39;</span>
<span class="n">source_table</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;semimajor_sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>

<span class="c1"># 将 &#39;semiminor_sigma&#39; 列重命名为 &#39;b&#39;</span>
<span class="n">source_table</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s1">&#39;semiminor_sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>

<span class="c1"># 用 &#39;ra&#39; 和 &#39;dec&#39; 替换 &#39;sky_centroid&#39;</span>
<span class="n">source_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_table</span><span class="p">[</span><span class="s1">&#39;sky_centroid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">degree</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span>  <span class="c1"># 获取天球坐标的右升角</span>
<span class="n">source_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_table</span><span class="p">[</span><span class="s1">&#39;sky_centroid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">degree</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span>  <span class="c1"># 获取天球坐标的 declination</span>

<span class="c1"># 获取当前表格的所有列名</span>
<span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">source_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="c1"># 重新排列列的顺序，保持 &#39;ra&#39; 和 &#39;dec&#39; 在前面</span>
<span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">columns</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># 根据新的列顺序更新表格</span>
<span class="n">source_table</span> <span class="o">=</span> <span class="n">source_table</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 如果感兴趣，可以查看/保存输出，但其他滤光片的光度测量将很快添加！</span>

<span class="c1"># 将源表写入名为 &#39;JADES_detections.ecsv&#39; 的文件，允许覆盖</span>
<span class="c1"># source_table.write(&#39;JADES_detections.ecsv&#39;, overwrite=True)</span>

<span class="c1"># 将源表写入名为 &#39;JADES_detections.cat&#39; 的文件，格式为固定宽度的两行ASCII，使用空格作为分隔符，允许覆盖</span>
<span class="c1"># source_table.write(&#39;JADES_detections.cat&#39;, format=&#39;ascii.fixed_width_two_line&#39;, delimiter=&#39; &#39;, overwrite=True)</span>

<span class="c1"># 显示源表内容</span>
<span class="c1"># source_table</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id10">
<h3>将测量的通量（数据单位）转换为星等<a class="headerlink" href="#id10" title="Link to this heading">#</a></h3>
<p>有关单位的详细信息，请参见以下链接：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/units/">Astropy单位文档</a></p></li>
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/units/equivalencies.html#photometric-zero-point-equivalency">Astropy单位等效性文档</a></p></li>
<li><p><a class="reference external" href="https://docs.astropy.org/en/stable/units/logarithmic_units.html#logarithmic-units">Astropy对数单位文档</a></p></li>
</ul>
<p><em>开发者注释：</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>流量单位可以自动转换为星等单位

但流量不确定性 *不能* 自动转换为星等不确定性

因此我编写了这个函数来实现转换



对于检测到的星等不确定性，应该使用 u.mag 而不是 u.ABmag

但对于未检测到的星等不确定性，则引用 u.ABmag 上限

它们需要保持一致，因此我们选择使用 u.ABmag
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 未检测到: mag =  99; magerr = 1-σ上限假设零通量</span>

<span class="c1"># 未观察到: mag = -99; magerr = 0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fluxes2mags</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">fluxerr</span><span class="p">):</span>
    <span class="n">nondet</span> <span class="o">=</span> <span class="n">flux</span> <span class="o">&lt;</span> <span class="mi">0</span>  <span class="c1"># 如果通量为负，则为非检测</span>

    <span class="n">unobs</span> <span class="o">=</span> <span class="p">(</span><span class="n">fluxerr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">fluxerr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>  <span class="c1"># 如果通量不确定性为负或无穷大，则为未观察到</span>

    <span class="n">mag</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span>  <span class="c1"># 将通量转换为AB星等</span>

    <span class="n">magupperlimit</span> <span class="o">=</span> <span class="n">fluxerr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span>  <span class="c1"># 如果通量=0，则为1-σ上限</span>

    <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nondet</span><span class="p">,</span> <span class="mi">99</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">,</span> <span class="n">mag</span><span class="p">)</span>  <span class="c1"># 对于非检测，设置星等为99</span>

    <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unobs</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">,</span> <span class="n">mag</span><span class="p">)</span>  <span class="c1"># 对于未观察到，设置星等为-99</span>

    <span class="n">magerr</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">fluxerr</span><span class="o">/</span><span class="n">flux</span><span class="p">)</span>  <span class="c1"># 计算星等的不确定性</span>

    <span class="n">magerr</span> <span class="o">=</span> <span class="n">magerr</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span>  <span class="c1"># 将不确定性转换为AB星等</span>

    <span class="n">magerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nondet</span><span class="p">,</span> <span class="n">magupperlimit</span><span class="p">,</span> <span class="n">magerr</span><span class="p">)</span>  <span class="c1"># 对于非检测，使用上限作为不确定性</span>

    <span class="n">magerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">unobs</span><span class="p">,</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">,</span> <span class="n">magerr</span><span class="p">)</span>  <span class="c1"># 对于未观察到，设置不确定性为0</span>

    <span class="k">return</span> <span class="n">mag</span><span class="p">,</span> <span class="n">magerr</span>  <span class="c1"># 返回星等和不确定性</span>

<span class="c1"># 包含我在astropy中找不到的特性:</span>

<span class="c1"># 对于非检测/未观察到，mag = 99 / -99</span>

<span class="c1"># 通量不确定性 -&gt; 星等不确定性</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id11">
<h3>使用在检测图像中定义的等亮度光圈进行多波段光度测量<a class="headerlink" href="#id11" title="Link to this heading">#</a></h3>
<p>（类似于在双图像模式下运行SourceExtractor）</p>
<p>（尚未进行点扩散函数（PSF）校正）</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># filters = &#39;F090W F200W F444W&#39;.split()  # 为测试而快速定义过滤器</span>

<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>  <span class="c1"># 遍历每个过滤器</span>

    <span class="n">filter_catalog</span> <span class="o">=</span> <span class="n">Photutils_Catalog</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>  <span class="c1"># 创建一个新的Photutils_Catalog对象，使用当前过滤器</span>

    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">measure_background_map</span><span class="p">()</span>  <span class="c1"># 测量背景图</span>

    <span class="c1"># 在检测到的图像中测量该过滤器的天体光度</span>

    <span class="c1"># 分割图将定义等光度光圈</span>

    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">segm_deblend</span> <span class="o">=</span> <span class="n">detection_catalog</span><span class="o">.</span><span class="n">segm_deblend</span>  <span class="c1"># 将分割去混叠信息赋值给当前过滤器的分割图</span>

    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">measure_source_properties</span><span class="p">(</span><span class="n">exposure_time</span><span class="p">)</span>  <span class="c1"># 测量源属性，使用曝光时间</span>

    <span class="c1"># 将测量到的通量转换为nJy和AB星等</span>

    <span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>  <span class="c1"># 将过滤器目录转换为表格格式</span>

    <span class="n">source_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">[</span><span class="s1">&#39;segment_flux&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">filter_catalog</span><span class="o">.</span><span class="n">zeropoint</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span>  <span class="c1"># 计算并存储通量</span>

    <span class="n">source_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxerr</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">[</span><span class="s1">&#39;segment_fluxerr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">filter_catalog</span><span class="o">.</span><span class="n">zeropoint</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span>  <span class="c1"># 计算并存储通量误差</span>

    <span class="n">mag</span><span class="p">,</span> <span class="n">magerr</span> <span class="o">=</span> <span class="n">fluxes2mags</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">fluxerr</span><span class="p">)</span>  <span class="c1"># 将通量和通量误差转换为星等和星等误差</span>

    <span class="n">source_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag</span>  <span class="c1"># 存储星等</span>

    <span class="n">source_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_magerr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magerr</span>  <span class="c1"># 存储星等误差</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="isophotal-kron">
<h3>光圈修正：等光度（isophotal）到总（Kron光圈）通量<a class="headerlink" href="#isophotal-kron" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total_flux_table</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">source_table</span><span class="p">)</span>  <span class="c1"># 复制源表到新表，以包含总光度校正</span>

<span class="n">reference_flux_auto</span> <span class="o">=</span> <span class="n">total_flux_table</span><span class="p">[</span><span class="s1">&#39;kron_flux&#39;</span><span class="p">]</span>  <span class="c1"># 获取自动克朗光流</span>

<span class="n">reference_flux_iso</span> <span class="o">=</span> <span class="n">total_flux_table</span><span class="p">[</span><span class="s1">&#39;segment_flux&#39;</span><span class="p">]</span>  <span class="c1"># 获取分段光流</span>

<span class="n">kron_flux_corrections</span> <span class="o">=</span> <span class="n">reference_flux_auto</span> <span class="o">/</span> <span class="n">reference_flux_iso</span>  <span class="c1"># 计算克朗光流校正因子</span>

<span class="n">total_flux_table</span><span class="p">[</span><span class="s1">&#39;total_flux_cor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kron_flux_corrections</span>  <span class="c1"># 将校正因子添加到总光流表中</span>

<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>  <span class="c1"># 遍历每个滤光片</span>

    <span class="n">total_flux_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">kron_flux_corrections</span>  <span class="c1"># 校正每个滤光片的光流</span>

    <span class="n">total_flux_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">kron_flux_corrections</span>  <span class="c1"># 校正每个滤光片的光流误差</span>

    <span class="c1"># total_flux_table[filt+&#39;_mag&#39;] = total_flux_table[filt+&#39;_flux&#39;].to(u.ABmag)  # 不处理未检测到的情况</span>

    <span class="n">total_flux_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxes2mags</span><span class="p">(</span><span class="n">total_flux_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">],</span> <span class="n">total_flux_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 将光流转换为星等</span>

    <span class="c1"># 星等的不确定性 magerr 保持不变</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id12">
<h3>重新格式化输出目录以提高可读性（可选）<a class="headerlink" href="#id12" title="Link to this heading">#</a></h3>
<p><em>开发者注释：</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&#39;d&#39; 格式与单位不兼容 (pix2)

作为解决方法，我将格式设置为 &#39;.0f&#39;（一个没有小数的浮点数）

ValueError: 无法解析格式字符串 &quot;d&quot; 对于列 &quot;area&quot; 中的条目 &quot;101.0&quot;
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">isophotal_table</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">total_flux_table</span><span class="p">)</span>  <span class="c1"># 复制总通量表到新表，以包含PSF校正</span>

<span class="n">old_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">isophotal_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>  <span class="c1"># 获取旧列名列表</span>

<span class="c1"># 重新排列列的顺序</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">old_columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;segment_flux&#39;</span><span class="p">)</span>  <span class="c1"># 找到&#39;segment_flux&#39;的索引</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">old_columns</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">)</span>  <span class="c1"># 找到第一个滤光片的通量索引</span>

<span class="n">columns</span> <span class="o">=</span> <span class="n">old_columns</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># 获取检测目录（不包括source_sum和kron_flux）</span>
<span class="n">columns</span> <span class="o">+=</span> <span class="n">old_columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># 添加总通量校正列</span>
<span class="n">columns</span> <span class="o">+=</span> <span class="n">old_columns</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 添加所有滤光片的光度列</span>

<span class="n">isophotal_table</span> <span class="o">=</span> <span class="n">isophotal_table</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>  <span class="c1"># 根据新列顺序重新构建表</span>

<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>  <span class="c1"># 遍历每一列</span>
    <span class="n">isophotal_table</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;.4f&#39;</span>  <span class="c1"># 设置每列的格式为小数点后4位</span>

<span class="n">isophotal_table</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;11.7f&#39;</span>  <span class="c1"># 设置&#39;ra&#39;列格式为小数点后7位，总宽度11位</span>
<span class="n">isophotal_table</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39; 11.7f&#39;</span>  <span class="c1"># 设置&#39;dec&#39;列格式为小数点后7位，总宽度11位</span>

<span class="n">isophotal_table</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>  <span class="c1"># 设置&#39;label&#39;列格式为整数</span>
<span class="n">isophotal_table</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;.0f&#39;</span>  <span class="c1"># 设置&#39;area&#39;列格式为整数（不带小数），&#39;d&#39;会引发错误</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id13">
<h3>无点扩散函数（PSF）校正的等光度测光<a class="headerlink" href="#id13" title="Link to this heading">#</a></h3>
<p>我们建议在长波长通道中进行点扩散函数（PSF）校正的测光。但如果您有兴趣，您可以现在保存目录。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将等光度表写入ECSV格式文件，文件名为&#39;JADES_isophotal_photometry.ecsv&#39;，并允许覆盖</span>
<span class="c1"># isophotal_table.write(&#39;JADES_isophotal_photometry.ecsv&#39;, overwrite=True)</span>

<span class="c1"># 将等光度表写入ASCII格式文件，文件名为&#39;JADES_isophotal_photometry.cat&#39;，格式为固定宽度两行，分隔符为空格，并允许覆盖</span>
<span class="c1"># isophotal_table.write(&#39;JADES_isophotal_photometry.cat&#39;, format=&#39;ascii.fixed_width_two_line&#39;, delimiter=&#39; &#39;, overwrite=True)</span>

<span class="c1"># 输出等光度表的内容</span>
<span class="c1"># isophotal_table</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id14">
<h2>PSF幅度校正<a class="headerlink" href="#id14" title="Link to this heading">#</a></h2>
<p>颜色校正的执行方式如下所述：</p>
<p>https://www.stsci.edu/~dcoe/ColorPro/color</p>
<p>请注意，这与一种常见的方法不同，该方法是将每个图像降级到最宽的点扩散函数（PSF）。</p>
<p>光度校正仅在长波长图像中进行，波长大于2.4微米。F200W探测图像被卷积（模糊）到每个长波长图像的PSF。然后，我们根据在该孔径中损失的幅度来校正颜色：</p>
<ul class="simple">
<li><p>PSF幅度校正 = 探测图像幅度 - 模糊探测图像幅度</p></li>
</ul>
<p>在实践中，我们实际上校正的是通量：</p>
<ul class="simple">
<li><p>PSF通量校正 = 探测图像通量 / 模糊探测图像通量</p></li>
</ul>
<section id="psfs">
<h3>加载点扩散函数 (PSFs)<a class="headerlink" href="#psfs" title="Link to this heading">#</a></h3>
<p>本笔记本中使用的PSF文件是从JDox上的tar文件中提取的：</p>
<p>https://jwst-docs.stsci.edu/near-infrared-camera/nircam-predicted-performance/nircam-point-spread-functions#NIRCamPointSpreadFunctions-SimulatedNIRCamPSFs</p>
<p>PSFs_SW_filters（短波长通道）：https://stsci.box.com/s/s2lepxr9086gq4sogr3kwftp54n1c5vl</p>
<p>PSFs_LW_filters（长波长通道）：https://stsci.box.com/s/gzl7blxb1k3p4n66gs7jvt7xorfrotyb</p>
<p>每个FITS文件包含：</p>
<p>– hdu[0]：一个4倍过采样的PSF</p>
<p>– hdu[1]：在探测器像素尺度下的PSF（短波长和长波长通道分别为0.031”和0.063”）</p>
<p>本笔记本将使用后者：在探测器像素尺度下的PSF。我们认为前者对本笔记本没有优势。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PSF_inputs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化字典以存储PSF输入数据</span>

<span class="n">PSF_images</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化字典以存储PSF图像</span>

<span class="n">detector_pixel_scales</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SW&#39;</span><span class="p">:</span> <span class="mf">0.031</span><span class="p">,</span> <span class="s1">&#39;LW&#39;</span><span class="p">:</span> <span class="mf">0.063</span><span class="p">}</span>  <span class="c1"># 定义探测器像素比例，SW和LW通道的像素比例</span>

<span class="n">PSF_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_file_url</span><span class="p">,</span> <span class="s1">&#39;NIRCam_PSFs&#39;</span><span class="p">)</span>  <span class="c1"># 构建PSF文件的URL路径</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">):</span>  <span class="c1"># 遍历每个滤光片及其索引</span>

    <span class="n">lam</span> <span class="o">=</span> <span class="n">wavelengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># 获取对应的波长</span>

    <span class="k">if</span> <span class="n">lam</span> <span class="o">&lt;</span> <span class="mf">2.4</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">:</span>  <span class="c1"># 判断波长是否小于2.4微米</span>

        <span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;SW&#39;</span>  <span class="c1"># 短波长通道 &lt; 2.4 微米</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">channel</span> <span class="o">=</span> <span class="s1">&#39;LW&#39;</span>  <span class="c1"># 长波长通道 &gt; 2.4 微米</span>

    <span class="c1"># 加载PSF文件</span>

    <span class="n">PSF_file</span> <span class="o">=</span> <span class="s1">&#39;PSF_</span><span class="si">%s</span><span class="s1">cen_G5V_fov299px_ISIM41.fits&#39;</span> <span class="o">%</span> <span class="n">filt</span>  <span class="c1"># 构建PSF文件名</span>

    <span class="c1"># PSF_file = os.path.join(&#39;NIRCam_PSFs_&#39; + channel, PSF_file)  # 原始路径构建（已注释）</span>

    <span class="n">PSF_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PSF_url</span><span class="p">,</span> <span class="n">PSF_file</span><span class="p">)</span>  <span class="c1"># 组合成完整的PSF文件路径</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">PSF_file</span><span class="p">)</span>  <span class="c1"># 打印PSF文件路径</span>

    <span class="n">PSF_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">PSF_file</span><span class="p">)</span>  <span class="c1"># 打开PSF文件</span>

    <span class="n">PSF_inputs</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">=</span> <span class="n">PSF_hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 将扩展[1]的数据存储到PSF输入字典中（像素比例未过采样）</span>

    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># 获取PSF数据的形状</span>

    <span class="c1"># 从探测器像素比例调整到图像像素比例（此处为0.03&quot; / 像素）</span>

    <span class="n">detector_pixel_scale</span> <span class="o">=</span> <span class="n">detector_pixel_scales</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span>  <span class="c1"># 获取当前通道的探测器像素比例</span>

    <span class="n">ny_resize</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">detector_pixel_scale</span> <span class="o">/</span> <span class="n">image_pixel_scale</span>  <span class="c1"># 计算调整后的高度</span>

    <span class="n">ny_resize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ny_resize</span><span class="p">)</span>  <span class="c1"># 四舍五入</span>

    <span class="n">ny_resize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">ny_resize</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 确保像素数为奇数，以确保PSF居中</span>

    <span class="n">PSF_pixel_scale</span> <span class="o">=</span> <span class="n">ny_resize</span> <span class="o">/</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">image_pixel_scale</span>  <span class="c1"># 计算PSF的像素比例    </span>

    <span class="n">PSF_image</span> <span class="o">=</span> <span class="n">resize_psf</span><span class="p">(</span><span class="n">PSF_inputs</span><span class="p">[</span><span class="n">filt</span><span class="p">],</span> <span class="n">PSF_pixel_scale</span><span class="p">,</span> <span class="n">image_pixel_scale</span><span class="p">)</span>  <span class="c1"># 调整PSF大小</span>

    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">ny_resize</span> <span class="o">-</span> <span class="n">ny</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># 计算需要裁剪的边界</span>

    <span class="n">PSF_images</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">PSF_image</span><span class="p">[</span><span class="n">r</span><span class="p">:</span><span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span><span class="o">-</span><span class="n">r</span><span class="p">]</span>  <span class="c1"># 裁剪PSF图像以与输入PSF大小相同</span>

    <span class="c1"># 注意PSF现在未归一化，但将在卷积步骤中进行归一化</span>

    <span class="c1"># print(filt, ny, ny_resize, PSF_image.shape, PSF_images[filt].shape, PSF_pixel_scale)  # 打印调试信息（已注释）</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PSF_images</span><span class="p">[</span><span class="n">filt</span><span class="p">])</span>  <span class="c1"># 计算指定滤波器下PSF图像的总和</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PSF_image</span><span class="p">[</span><span class="n">r</span><span class="p">:</span><span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span><span class="o">-</span><span class="n">r</span><span class="p">])</span>  <span class="c1"># 计算PSF_image数组中去掉边缘r个像素后的区域的所有元素的总和</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 显示点扩散函数（PSF）（可选）</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 创建子图，设置图形大小和共享坐标轴</span>

<span class="n">r</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># PSF 将显示到半径 r（像素）</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">):</span>  <span class="c1"># 遍历每个滤光片</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">PSF_images</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>  <span class="c1"># 获取当前滤光片的 PSF 数据</span>

    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># 获取数据的形状（高度和宽度）</span>

    <span class="n">yc</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># 计算图像中心的 y 坐标</span>

    <span class="n">xc</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># 计算图像中心的 x 坐标</span>

    <span class="n">stamp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">yc</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">yc</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xc</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">xc</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 提取中心区域的 PSF 图像</span>

    <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">LogStretch</span><span class="p">())</span>  <span class="c1"># 为每个滤光片单独缩放</span>

    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>  <span class="c1"># 显示 PSF 图像，使用灰度反转色图</span>

    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>  <span class="c1"># 设置子图标题为滤光片名称（大写）</span>

    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># 关闭坐标轴</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id15">
<h2>PSF 匹配<a class="headerlink" href="#id15" title="Link to this heading">#</a></h2>
<p>https://photutils.readthedocs.io/en/stable/psf_matching.html</p>
<section id="id16">
<h3>确定PSF卷积核<a class="headerlink" href="#id16" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PSF_kernels</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 创建一个空字典用于存储PSF核</span>

<span class="n">reference_filter</span> <span class="o">=</span> <span class="s1">&#39;F200W&#39;</span>  <span class="c1"># 定义参考滤波器为&#39;F200W&#39;</span>

<span class="n">reference_PSF</span> <span class="o">=</span> <span class="n">PSF_images</span><span class="p">[</span><span class="n">reference_filter</span><span class="p">]</span>  <span class="c1"># 获取参考滤波器的PSF图像</span>

<span class="n">i_reference</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">reference_filter</span><span class="p">)</span>  <span class="c1"># 找到参考滤波器在滤波器列表中的索引</span>

<span class="n">window</span> <span class="o">=</span> <span class="n">SplitCosineBellWindow</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>  <span class="c1"># 创建一个分割余弦贝尔窗口</span>

<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">[</span><span class="n">i_reference</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># 遍历参考滤波器之后的所有滤波器</span>

    <span class="n">PSF_kernels</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_matching_kernel</span><span class="p">(</span><span class="n">reference_PSF</span><span class="p">,</span> <span class="n">PSF_images</span><span class="p">[</span><span class="n">filt</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>  <span class="c1"># 创建匹配核并存储在字典中</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="f200w-psfs">
<h2>将F200W探测图像卷积到长波长点扩散函数（PSFs）<a class="headerlink" href="#f200w-psfs" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 打开参考图像文件</span>
<span class="n">reference_image_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="n">reference_filter</span><span class="p">])</span>

<span class="c1"># 获取参考图像的数据</span>
<span class="n">reference_image_data</span> <span class="o">=</span> <span class="n">reference_image_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>

<span class="c1"># 遍历输出滤波器，从参考滤波器的下一个开始</span>
<span class="k">for</span> <span class="n">output_filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">[</span><span class="n">i_reference</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>

    <span class="c1"># 定义输出图像的文件名</span>
    <span class="n">output_image</span> <span class="o">=</span> <span class="s1">&#39;jades_convolved_</span><span class="si">%s</span><span class="s1">_to_</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reference_filter</span><span class="p">,</span> <span class="n">output_filter</span><span class="p">)</span>

    <span class="c1"># 检查输出图像文件是否已存在</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_image</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output_image</span><span class="p">,</span> <span class="s1">&#39;EXISTS&#39;</span><span class="p">)</span>  <span class="c1"># 如果存在，打印提示信息</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output_filter</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span>  <span class="c1"># 打印当前处理的输出滤波器</span>

        <span class="c1"># 获取对应输出滤波器的PSF核</span>
        <span class="n">PSF_kernel</span> <span class="o">=</span> <span class="n">PSF_kernels</span><span class="p">[</span><span class="n">output_filter</span><span class="p">][</span><span class="n">yc</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">yc</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xc</span><span class="o">-</span><span class="n">r</span><span class="p">:</span><span class="n">xc</span><span class="o">+</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># 使用卷积进行图像处理，normalize_kernel=True表示归一化核</span>
        <span class="n">convolved_image</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">reference_image_data</span><span class="p">,</span> <span class="n">PSF_kernel</span><span class="p">,</span> <span class="n">normalize_kernel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 将卷积后的图像数据更新到参考图像中</span>
        <span class="n">reference_image_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">convolved_image</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SAVING </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">output_image</span><span class="p">)</span>  <span class="c1"># 打印保存信息</span>

        <span class="c1"># 将处理后的图像数据写入输出文件</span>
        <span class="n">reference_image_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output_image</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="id17">
<h3>卷积图像中的多波段光度测量<a class="headerlink" href="#id17" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 测量并保存每个模糊图像中的通量</span>

<span class="n">blurry_catalog</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">()</span>  <span class="c1"># 创建一个空的QTable以存储模糊图像的通量数据</span>

<span class="k">for</span> <span class="n">blurry_filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">[</span><span class="n">i_reference</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># 遍历参考滤光片之后的所有模糊滤光片</span>

    <span class="n">image_file</span> <span class="o">=</span> <span class="s1">&#39;jades_convolved_</span><span class="si">%s</span><span class="s1">_to_</span><span class="si">%s</span><span class="s1">.fits&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reference_filter</span><span class="p">,</span> <span class="n">blurry_filter</span><span class="p">)</span>  <span class="c1"># 构建模糊图像文件名</span>

    <span class="n">filter_catalog</span> <span class="o">=</span> <span class="n">Photutils_Catalog</span><span class="p">(</span><span class="n">blurry_filter</span><span class="p">,</span> <span class="n">image_file</span><span class="o">=</span><span class="n">image_file</span><span class="p">)</span>  <span class="c1"># 创建Photutils_Catalog对象以处理当前滤光片的图像</span>

    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">measure_background_map</span><span class="p">()</span>  <span class="c1"># 测量背景图以便后续处理</span>

    <span class="c1"># 在检测到的图像中测量该滤光片的光度</span>

    <span class="c1"># 分割图将定义等光度孔径</span>

    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">segm_deblend</span> <span class="o">=</span> <span class="n">detection_catalog</span><span class="o">.</span><span class="n">segm_deblend</span>  <span class="c1"># 将检测到的图像的分割图应用于当前滤光片</span>

    <span class="n">filter_catalog</span><span class="o">.</span><span class="n">measure_source_properties</span><span class="p">(</span><span class="n">exposure_time</span><span class="p">)</span>  <span class="c1"># 测量源属性，包括通量等</span>

    <span class="c1"># 将测量的通量转换为nJy单位</span>

    <span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_catalog</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">to_table</span><span class="p">()</span>  <span class="c1"># 将测量结果转换为表格格式</span>

    <span class="n">blurry_catalog</span><span class="p">[</span><span class="n">blurry_filter</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">[</span><span class="s1">&#39;segment_flux&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">filter_catalog</span><span class="o">.</span><span class="n">zeropoint</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span>  <span class="c1"># 将通量转换为nJy并存储在模糊目录中</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id18">
<h3>PSF 亮度修正<a class="headerlink" href="#id18" title="Link to this heading">#</a></h3>
<p>抱歉，我无法直接访问外部链接。不过，如果您能提供该链接中的具体内容或文本，我将很乐意帮助您进行翻译和处理。请将需要翻译的内容粘贴在这里。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PSF_corrected_table</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">isophotal_table</span><span class="p">)</span>  <span class="c1"># 深拷贝isophotal_table，创建PSF_corrected_table</span>

<span class="n">reference_fluxes</span> <span class="o">=</span> <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">reference_filter</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span>  <span class="c1"># 获取参考滤光片的流量，det_flux_auto</span>

<span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">[</span><span class="n">i_reference</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># 遍历参考滤光片之后的所有滤光片</span>

    <span class="c1"># 将等光度流量转换为总流量</span>
    <span class="n">blurry_total_fluxes</span> <span class="o">=</span> <span class="n">blurry_catalog</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">kron_flux_corrections</span>  <span class="c1"># 计算模糊总流量</span>

    <span class="n">PSF_flux_corrections</span> <span class="o">=</span> <span class="n">reference_fluxes</span> <span class="o">/</span> <span class="n">blurry_total_fluxes</span>  <span class="c1"># 计算PSF流量校正因子</span>

    <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">PSF_flux_corrections</span>  <span class="c1"># 更新PSF校正后的流量</span>

    <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">PSF_flux_corrections</span>  <span class="c1"># 更新PSF校正后的流量误差</span>

    <span class="c1"># PSF_corrected_table[filt+&#39;_mag&#39;] = PSF_corrected_fluxes.to(u.ABmag)  # 不处理未探测到的情况</span>

    <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_mag&#39;</span><span class="p">],</span> <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_magerr&#39;</span><span class="p">]</span> <span class="o">=</span> \  <span class="c1"># 计算校正后的星等和误差</span>
        <span class="n">fluxes2mags</span><span class="p">(</span><span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">],</span> <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">])</span>

    <span class="n">PSF_corrected_table</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_PSF_flux_cor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PSF_flux_corrections</span>  <span class="c1"># 将PSF流量校正因子存入表中</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将PSF校正后的表格写入ECSV格式文件，文件名为&#39;JADES_photometry.ecsv&#39;，允许覆盖</span>
<span class="n">PSF_corrected_table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;JADES_photometry.ecsv&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 将PSF校正后的表格写入ASCII格式文件，文件名为&#39;JADES_photometry.cat&#39;，使用固定宽度的两行格式，分隔符为空格，允许覆盖</span>
<span class="n">PSF_corrected_table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;JADES_photometry.cat&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.fixed_width_two_line&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># PSF_corrected_table</span>

<span class="c1"># 导入必要的库</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># 导入NumPy库用于数值计算</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>  <span class="c1"># 导入Pandas库用于数据处理</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>  <span class="c1"># 导入Astropy库用于处理FITS文件</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jwst</span><span class="w"> </span><span class="kn">import</span> <span class="n">datamodels</span>  <span class="c1"># 导入JWST数据模型库</span>

<span class="c1"># 定义函数以读取FITS文件并返回数据</span>
<span class="k">def</span><span class="w"> </span><span class="nf">read_fits_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="c1"># 使用Astropy读取FITS文件</span>
    <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
        <span class="c1"># 返回数据部分</span>
        <span class="k">return</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 返回第二个HDU的数据</span>

<span class="c1"># 定义函数以处理PSF校正</span>
<span class="k">def</span><span class="w"> </span><span class="nf">psf_correction</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># 在这里进行PSF校正的具体实现</span>
    <span class="c1"># 假设我们进行简单的归一化处理</span>
    <span class="n">corrected_data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 将数据归一化</span>
    <span class="k">return</span> <span class="n">corrected_data</span>  <span class="c1"># 返回校正后的数据</span>

<span class="c1"># 定义主函数</span>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 读取FITS文件</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;path/to/your/fits/file.fits&#39;</span>  <span class="c1"># 指定FITS文件路径</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">read_fits_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>  <span class="c1"># 调用函数读取数据</span>

    <span class="c1"># 进行PSF校正</span>
    <span class="n">corrected_data</span> <span class="o">=</span> <span class="n">psf_correction</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 调用函数进行校正</span>

    <span class="c1"># 将校正后的数据转换为DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">corrected_data</span><span class="p">)</span>  <span class="c1"># 创建Pandas DataFrame</span>

    <span class="c1"># 保存校正后的数据到CSV文件</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;psf_corrected_data.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 保存为CSV文件，不包含索引</span>

<span class="c1"># 如果该脚本是主程序，则执行主函数</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>  <span class="c1"># 调用主函数</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !cat JADES_photometry.cat  # 显示名为JADES_photometry.cat的文件内容</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id19">
<h2>开始新会话并分析结果<a class="headerlink" href="#id19" title="Link to this heading">#</a></h2>
<p>只需运行上面的前几个代码块，包括导入库、定义文件列表和创建彩色图像。</p>
<section id="id20">
<h3>加载目录和分割图<a class="headerlink" href="#id20" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Catalog: ecsv格式保留单位，以便在Python笔记本中加载</span>

<span class="n">output_catalog</span> <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;JADES_photometry.ecsv&#39;</span><span class="p">)</span>  <span class="c1"># 读取名为&#39;JADES_photometry.ecsv&#39;的文件并将其存储为QTable对象</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 重新构建滤光片列表</span>

<span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化滤光片列表</span>

<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">output_catalog</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>  <span class="c1"># 遍历输出目录中的每一列</span>

    <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_mag&#39;</span><span class="p">:</span>  <span class="c1"># 检查列名是否以&#39;_mag&#39;结尾</span>

        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># 将列名去掉&#39;_mag&#39;后添加到滤光片列表中</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 分割图像文件名</span>
<span class="n">segmfile</span> <span class="o">=</span> <span class="s1">&#39;JADES_detections_segm.fits&#39;</span>

<span class="c1"># 打开FITS文件并读取数据</span>
<span class="n">segm</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">segmfile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># 将数据转换为分割图像对象</span>
<span class="n">segm</span> <span class="o">=</span> <span class="n">SegmentationImage</span><span class="p">(</span><span class="n">segm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="jades-jaguar">
<h2>输入模拟 JADES JAGUAR 目录<a class="headerlink" href="#jades-jaguar" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># full_catalog_file = &#39;JADES_SF_mock_r1_v1.1.fits.gz&#39;  # 原始数据文件在此演示中不可用</span>

<span class="c1"># 从302,515个模拟星系中裁剪出653个，适用于本演示的小图像区域</span>

<span class="n">cropped_catalog_file</span> <span class="o">=</span> <span class="s1">&#39;JADES_SF_mock_r1_v1.1_crop.fits.gz&#39;</span>  <span class="c1"># 裁剪后的星系目录文件名</span>

<span class="n">input_catalog_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_file_url</span><span class="p">,</span> <span class="n">cropped_catalog_file</span><span class="p">)</span>  <span class="c1"># 生成完整的输入文件路径</span>

<span class="n">simulated_catalog</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">input_catalog_file</span><span class="p">)</span>  <span class="c1"># 读取裁剪后的星系目录数据</span>
</pre></div>
</div>
</div>
</div>
<section id="photutils">
<h3>将天体与 photutils 目录匹配<a class="headerlink" href="#photutils" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://docs.astropy.org/en/stable/coordinates/matchsep.html">匹配天体的文档</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将输入坐标转换为SkyCoord对象，使用RA和DEC列，并指定单位为度</span>
<span class="n">input_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">simulated_catalog</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">simulated_catalog</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>

<span class="c1"># 如果在表中保存了output_catalog[&#39;sky_centroid&#39;]，可以使用它，但此示例保存了（ra, dec）坐标：</span>
<span class="c1"># 将输出目录中的RA和DEC列转换为SkyCoord对象</span>
<span class="n">detected_coordinates</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">])</span>

<span class="c1"># 将photutils检测到的源与输入对象目录进行匹配：</span>
<span class="c1"># input_indices为匹配的索引，separation2d为二维分离距离，distance3d为三维距离</span>
<span class="n">input_indices</span><span class="p">,</span> <span class="n">separation2d</span><span class="p">,</span> <span class="n">distance3d</span> <span class="o">=</span> <span class="n">detected_coordinates</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">input_coordinates</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>确定输入对象与匹配输出源之间的阈值最大距离</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># 创建一个图形，设置大小为9.5x4英寸</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">separation2d</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 绘制分离度的排序图，zorder设置图层顺序</span>

<span class="n">separation_max</span> <span class="o">=</span> <span class="mf">0.036</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>  <span class="c1"># 通过观察图形确定的最大分离度</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>  <span class="c1"># 绘制y=0的水平虚线，颜色为黑色</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">separation_max</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&quot;good&quot; matches&#39;</span><span class="p">)</span>  <span class="c1"># 绘制最大分离度的水平虚线，颜色为红色，线型为虚线，并添加标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Matches between output (detected) and input (simulated) catalogs&#39;</span><span class="p">)</span>  <span class="c1"># 设置图形标题</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Detected sources (sorted)&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Separation (arcsec)&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  <span class="c1"># 显示图例</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 判断哪些匹配的距离小于最大分离距离</span>
<span class="n">good_matches</span> <span class="o">=</span> <span class="n">separation2d</span> <span class="o">&lt;</span> <span class="n">separation_max</span>

<span class="c1"># 找到唯一的匹配项及其计数</span>
<span class="n">unique_matches</span><span class="p">,</span> <span class="n">index_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">input_indices</span><span class="p">[</span><span class="n">good_matches</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 打印匹配的数量和唯一匹配的数量</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> matches (</span><span class="si">%d</span><span class="s1"> unique) between input catalog (</span><span class="si">%d</span><span class="s1"> galaxies) and photutils catalog (</span><span class="si">%d</span><span class="s1"> detected sources)&#39;</span>
      <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">good_matches</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_matches</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">simulated_catalog</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_catalog</span><span class="p">)))</span>

<span class="c1"># 找到匹配次数大于1的多个匹配项</span>
<span class="n">multiple_matches</span> <span class="o">=</span> <span class="n">unique_matches</span><span class="p">[</span><span class="n">index_counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># 如果存在多个匹配项，则打印这些输入源的ID</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiple_matches</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input sources matched multiple times:&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="n">multiple_matches</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 输入与输出颜色</span>

<span class="c1"># 定义两个滤波器</span>
<span class="n">filt1</span><span class="p">,</span> <span class="n">filt2</span> <span class="o">=</span> <span class="s1">&#39;F200W F444W&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="c1"># 从模拟目录中获取输入光通量，使用滤波器1</span>
<span class="n">input_flux1</span> <span class="o">=</span> <span class="n">simulated_catalog</span><span class="p">[</span><span class="s1">&#39;NRC_</span><span class="si">%s</span><span class="s1">_fnu&#39;</span> <span class="o">%</span> <span class="n">filt1</span><span class="p">][</span><span class="n">input_indices</span><span class="p">][</span><span class="n">good_matches</span><span class="p">]</span>

<span class="c1"># 从模拟目录中获取输入光通量，使用滤波器2</span>
<span class="n">input_flux2</span> <span class="o">=</span> <span class="n">simulated_catalog</span><span class="p">[</span><span class="s1">&#39;NRC_</span><span class="si">%s</span><span class="s1">_fnu&#39;</span> <span class="o">%</span> <span class="n">filt2</span><span class="p">][</span><span class="n">input_indices</span><span class="p">][</span><span class="n">good_matches</span><span class="p">]</span>

<span class="c1"># 将输入光通量转换为AB星等，滤波器1</span>
<span class="n">input_mag1</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_flux1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

<span class="c1"># 将输入光通量转换为AB星等，滤波器2</span>
<span class="n">input_mag2</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_flux2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

<span class="c1"># 从输出目录中获取输出星等，滤波器1</span>
<span class="n">output_mag1</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_mag&#39;</span><span class="p">][</span><span class="n">good_matches</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

<span class="c1"># 从输出目录中获取输出星等，滤波器2</span>
<span class="n">output_mag2</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_mag&#39;</span><span class="p">][</span><span class="n">good_matches</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

<span class="c1"># 获取输出目录中的标签</span>
<span class="n">output_ids</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">good_matches</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 仅绘制检测到的对象</span>
<span class="n">det1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">output_mag1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">output_mag1</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">)</span>  <span class="c1"># 检测到的滤波器1的对象</span>
<span class="n">det2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">output_mag2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">output_mag2</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">)</span>  <span class="c1"># 检测到的滤波器2的对象</span>
<span class="n">det</span> <span class="o">=</span> <span class="n">det1</span> <span class="o">*</span> <span class="n">det2</span>  <span class="c1"># 仅保留同时在两个滤波器中检测到的对象</span>

<span class="c1"># 根据检测条件筛选输出星等</span>
<span class="n">output_mag1</span> <span class="o">=</span> <span class="n">output_mag1</span><span class="p">[</span><span class="n">det</span><span class="p">]</span>
<span class="n">output_mag2</span> <span class="o">=</span> <span class="n">output_mag2</span><span class="p">[</span><span class="n">det</span><span class="p">]</span>

<span class="c1"># 计算输入颜色</span>
<span class="n">input_color</span> <span class="o">=</span> <span class="n">input_mag1</span> <span class="o">-</span> <span class="n">input_mag2</span>

<span class="c1"># 计算输出颜色</span>
<span class="n">output_color</span> <span class="o">=</span> <span class="n">output_mag1</span> <span class="o">-</span> <span class="n">output_mag2</span>

<span class="c1"># 保存未校正的输出星等</span>
<span class="n">output_mag1_uncor</span> <span class="o">=</span> <span class="n">output_mag1</span>

<span class="c1"># 获取滤波器2的PSF校正光通量</span>
<span class="n">PSF_flux_cor</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">filt2</span><span class="o">+</span><span class="s1">&#39;_PSF_flux_cor&#39;</span><span class="p">]</span>

<span class="c1"># 计算PSF校正后的星等</span>
<span class="n">PSF_mag_cor</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">PSF_flux_cor</span><span class="p">)</span>

<span class="c1"># 计算未校正的输出星等</span>
<span class="n">output_mag2_uncor</span> <span class="o">=</span> <span class="n">output_mag2</span> <span class="o">-</span> <span class="n">PSF_mag_cor</span><span class="p">[</span><span class="n">good_matches</span><span class="p">][</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

<span class="c1"># 计算未校正的输出颜色</span>
<span class="n">output_color_uncor</span> <span class="o">=</span> <span class="n">output_mag1_uncor</span> <span class="o">-</span> <span class="n">output_mag2_uncor</span>

<span class="c1"># 创建绘图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># 绘制PSF校正后的数据点</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_mag1</span><span class="p">,</span> <span class="n">output_color</span> <span class="o">-</span> <span class="n">input_color</span><span class="p">,</span> <span class="s1">&#39;bo&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PSF corrected&#39;</span><span class="p">)</span>

<span class="c1"># 绘制未校正的数据点</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">input_mag1</span><span class="p">,</span> <span class="n">output_color_uncor</span> <span class="o">-</span> <span class="n">input_color</span><span class="p">,</span> <span class="s1">&#39;r.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;uncorrected&#39;</span><span class="p">)</span>

<span class="c1"># 添加水平线表示正确的颜色差</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;correct&#39;</span><span class="p">)</span>

<span class="c1"># 设置x轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Input  &#39;</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;  (mag)&#39;</span><span class="p">)</span>

<span class="c1"># 设置y轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Measured $-$ Input colors  [</span><span class="si">%s</span><span class="s1"> $-$ </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">filt2</span><span class="p">))</span>

<span class="c1"># 设置图表标题</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Accuracy of measured JADES photometry colors&#39;</span><span class="p">)</span>

<span class="c1"># 显示图例</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># 保存图像（注释掉以避免自动保存）</span>
<span class="c1"># plt.savefig(&#39;JADES_color_deviation_%s-%s.png&#39; % (filt1, filt2))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="f200w-f090w">
<h3>绘制 F200W 与 F090W 亮度图并寻找掉落星系<a class="headerlink" href="#f200w-f090w" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mag1</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;F090W_mag&#39;</span><span class="p">]</span>  <span class="c1"># 获取F090W波段的星等数据</span>

<span class="n">mag2</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;F200W_mag&#39;</span><span class="p">]</span>  <span class="c1"># 获取F200W波段的星等数据</span>

<span class="c1"># 仅绘制F200W波段的检测结果</span>

<span class="n">det2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span> <span class="o">&lt;</span> <span class="n">mag2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mag2</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span>  <span class="c1"># 筛选出F200W波段星等在0到90之间的检测结果</span>

<span class="n">mag1</span> <span class="o">=</span> <span class="n">mag1</span><span class="p">[</span><span class="n">det2</span><span class="p">]</span>  <span class="c1"># 根据检测结果筛选F090W波段星等</span>

<span class="n">mag2</span> <span class="o">=</span> <span class="n">mag2</span><span class="p">[</span><span class="n">det2</span><span class="p">]</span>  <span class="c1"># 根据检测结果筛选F200W波段星等</span>

<span class="n">ids</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">det2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># 获取对应的标签并转换为整数类型</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>  <span class="c1"># 创建一个8x4英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag1</span><span class="p">,</span> <span class="n">mag2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>  <span class="c1"># 绘制散点图，x轴为F090W星等，y轴为F200W星等，点的颜色由ids决定</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;F090W AB magnitude&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;F200W AB magnitude&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 反转x轴，使亮度较高的星等在右侧</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 反转y轴，使亮度较高的星等在顶部</span>

<span class="n">mplcursors</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">hover</span><span class="o">=</span><span class="n">mplcursors</span><span class="o">.</span><span class="n">HoverMode</span><span class="o">.</span><span class="n">Transient</span><span class="p">)</span>  <span class="c1"># 添加悬停光标功能</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hover cursor over data point to reveal magnitudes and catalog ID number&#39;</span><span class="p">)</span>  <span class="c1"># 提示用户悬停以查看星等和目录ID</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 选择最亮的 F090W 脱落源</span>

<span class="n">dropouts</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="s1">&#39;F090W_mag&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">90</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span>  <span class="c1"># 筛选出 F090W 星等大于 90 的脱落源</span>

<span class="n">i_brightest_dropout</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">dropouts</span><span class="p">][</span><span class="s1">&#39;F200W_mag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>  <span class="c1"># 在脱落源中找到 F200W 星等最小的索引</span>

<span class="n">output_id</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">dropouts</span><span class="p">][</span><span class="n">i_brightest_dropout</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>  <span class="c1"># 获取最亮脱落源的标签</span>

<span class="n">output_id</span>  <span class="c1"># 输出最亮脱落源的标签</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 从目录中选择具有特定ID的对象</span>

<span class="n">output_index</span> <span class="o">=</span> <span class="n">segm</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">output_id</span><span class="p">)</span>  <span class="c1"># 获取输出ID在分段中的索引</span>

<span class="n">output_obj</span> <span class="o">=</span> <span class="n">output_catalog</span><span class="p">[</span><span class="n">output_index</span><span class="p">]</span>  <span class="c1"># 根据索引从输出目录中获取对象</span>

<span class="n">segmobj</span> <span class="o">=</span> <span class="n">segm</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="n">segm</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">output_id</span><span class="p">)]</span>  <span class="c1"># 获取与输出ID对应的分段对象</span>

<span class="nb">print</span><span class="p">(</span><span class="n">output_id</span><span class="p">,</span> <span class="n">output_obj</span><span class="p">[</span><span class="s1">&#39;F090W_mag&#39;</span><span class="p">],</span> <span class="n">output_obj</span><span class="p">[</span><span class="s1">&#39;F200W_mag&#39;</span><span class="p">])</span>  <span class="c1"># 打印输出ID及其对应的F090W和F200W波段的星等</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 可选择通过位置选择一个对象</span>

<span class="c1"># x, y = 905, 276  # 定义对象的 x 和 y 坐标</span>

<span class="c1"># id = segm.data[y,x]  # 从分段数据中获取指定位置的对象 ID</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id21">
<h3>在所有滤光片中显示选定对象<a class="headerlink" href="#id21" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 创建一个2行(len(filters)+1)列的子图</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">color_image_short_wavelength</span><span class="p">[</span><span class="n">segmobj</span><span class="o">.</span><span class="n">slices</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">segmobj</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span>  <span class="c1"># 显示短波长的彩色图像</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Color&#39;</span><span class="p">)</span>  <span class="c1"># 设置标题为&#39;Color&#39;</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">segm</span><span class="o">.</span><span class="n">make_cmap</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">12345</span><span class="p">)</span>  <span class="c1"># 创建一个颜色映射（cmap），使用随机种子12345</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">segm</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">segmobj</span><span class="o">.</span><span class="n">slices</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">segmobj</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>  <span class="c1"># 显示分段数据</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>  <span class="c1"># 使用最近邻插值</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Segment&#39;</span><span class="p">)</span>  <span class="c1"># 设置标题为&#39;Segment&#39;</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历每个滤波器</span>

    <span class="n">filt</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 获取当前滤波器</span>

    <span class="c1"># Show data on top row</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="n">filt</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 打开当前滤波器对应的图像文件</span>
    <span class="n">stamp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">segmobj</span><span class="o">.</span><span class="n">slices</span><span class="p">]</span>  <span class="c1"># 提取感兴趣区域的数据</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>  <span class="c1"># 创建一个归一化对象，使用平方根拉伸</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">segmobj</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>  <span class="c1"># 显示图像数据</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>  <span class="c1"># 设置标题为滤波器名称（大写）</span>

    <span class="c1"># Show weights on bottom row</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">weight_files</span><span class="p">[</span><span class="n">filt</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 打开当前滤波器对应的权重文件</span>
    <span class="n">stamp</span> <span class="o">=</span> <span class="n">weight</span><span class="p">[</span><span class="n">segmobj</span><span class="o">.</span><span class="n">slices</span><span class="p">]</span>  <span class="c1"># 提取感兴趣区域的权重数据</span>
    <span class="c1"># set black to zero weight (no exposure time / bad pixel)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stamp</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">segmobj</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>  <span class="c1"># 显示权重数据，黑色表示权重为零</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>  <span class="c1"># 设置左侧y轴标签为&#39;Data&#39;</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Weight&#39;</span><span class="p">);</span>  <span class="c1"># 设置左侧y轴标签为&#39;Weight&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="sed">
<h2>绘制单个天体的光谱能量分布 (SED)<a class="headerlink" href="#sed" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># output_obj = output_catalog[index]  # 已在上面完成</span>

<span class="c1"># 从模拟目录中获取输入对象，使用输入索引和输出索引</span>
<span class="n">input_obj</span> <span class="o">=</span> <span class="n">simulated_catalog</span><span class="p">[</span><span class="n">input_indices</span><span class="p">][</span><span class="n">output_index</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 从输入对象中提取每个滤波器的光通量，并将其存储为NumPy数组</span>
<span class="n">input_fluxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">input_obj</span><span class="p">[</span><span class="s1">&#39;NRC_</span><span class="si">%s</span><span class="s1">_fnu&#39;</span> <span class="o">%</span> <span class="n">filt</span><span class="p">]</span> <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">])</span>

<span class="c1"># 从输出对象中提取每个滤波器的光通量，并将其存储为NumPy数组</span>
<span class="n">output_fluxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">output_obj</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">])</span>

<span class="c1"># 从输出对象中提取每个滤波器的光通量误差，并将其存储为NumPy数组</span>
<span class="n">output_flux_errs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">output_obj</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_fluxerr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 测量的通量未能恢复总输入通量</span>

<span class="c1"># 给定已知的模拟输入，确定恢复的通量占比</span>

<span class="c1"># 使用此比例将测量的SED缩放到输入SED以进行比较，下面将绘制结果</span>

<span class="c1"># 仅使用F200W缩放输出到输入通量（其他滤波器可能有不正确的通量校正）</span>

<span class="n">filt</span> <span class="o">=</span> <span class="s1">&#39;F200W&#39;</span>  <span class="c1"># 定义滤波器为F200W</span>

<span class="c1"># 计算输出通量与输入通量的比例</span>
<span class="n">flux_scale_factor</span> <span class="o">=</span> <span class="n">output_obj</span><span class="p">[</span><span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">input_obj</span><span class="p">[</span><span class="s1">&#39;NRC_</span><span class="si">%s</span><span class="s1">_fnu&#39;</span> <span class="o">%</span> <span class="n">filt</span><span class="p">]</span>

<span class="c1"># 计算通量因子，即输入通量与输出通量的比值</span>
<span class="n">flux_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">flux_scale_factor</span>  <span class="c1"># 输入通量 / 输出通量</span>

<span class="c1"># 打印通过photutils恢复的输入通量的百分比</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d%%</span><span class="s1"> of input flux recovered by photutils&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">flux_scale_factor</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="mi">0</span><span class="p">:</span>

    <span class="c1"># 将输出缩放到输入通量，考虑所有测量的通量和不确定性</span>

    <span class="c1"># Benitez+00 方程 8 和 9</span>

    <span class="n">FOT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">input_fluxes</span> <span class="o">*</span> <span class="n">output_fluxes</span> <span class="o">/</span> <span class="n">output_flux_errs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 计算加权输入和输出通量的总和</span>

    <span class="n">FTT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">input_fluxes</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">output_flux_errs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 计算加权输入通量平方的总和</span>

    <span class="n">flux_scale_factor</span> <span class="o">=</span> <span class="n">FOT</span> <span class="o">/</span> <span class="n">FTT</span>  <span class="c1"># a_m: 观察到的 / 理论的 (输出 / 输入)</span>

    <span class="n">flux_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">flux_scale_factor</span>  <span class="c1"># 输入 / 输出</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d%%</span><span class="s1"> of input flux recovered by photutils&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">flux_scale_factor</span><span class="p">))</span>  <span class="c1"># 打印通过 photutils 恢复的输入通量的百分比</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PSF_flux_corrections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">))</span>  <span class="c1"># 初始化一个与filters长度相同的数组，所有元素为1</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filters</span><span class="p">):</span>  <span class="c1"># 遍历filters列表，i为索引，filt为当前过滤器名称</span>

    <span class="n">PSFcor_column</span> <span class="o">=</span> <span class="n">filt</span><span class="o">+</span><span class="s1">&#39;_PSF_flux_cor&#39;</span>  <span class="c1"># 生成对应的PSF_flux_cor列名</span>

    <span class="k">if</span> <span class="n">PSFcor_column</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">output_obj</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>  <span class="c1"># 检查该列名是否在output_obj的列中</span>

        <span class="n">PSF_flux_corrections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_obj</span><span class="p">[</span><span class="n">PSFcor_column</span><span class="p">]</span>  <span class="c1"># 如果存在，则将该列的值赋给PSF_flux_corrections数组的对应位置</span>

<span class="n">PSF_flux_corrections</span>  <span class="c1"># 输出最终的PSF_flux_corrections数组</span>
</pre></div>
</div>
</div>
</div>
<p><em>开发者注释：</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>当通量扩展到负值时，自动次轴的幅度无法正常工作

所以我编写了自己的代码来实现这一功能
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">add_magnitude_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">flux_units</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">,</span> <span class="n">plothuge</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># 获取当前y轴的上下限并转换为指定的流量单位</span>
    <span class="n">ylo</span><span class="p">,</span> <span class="n">yhi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span> <span class="o">*</span> <span class="n">flux_units</span>

    <span class="c1"># 将y轴的上限转换为AB星等</span>
    <span class="n">maghi</span> <span class="o">=</span> <span class="n">yhi</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># 计算y轴标签的第一个值，向上取整到小数点后一位</span>
    <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">maghi</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.</span>  <span class="c1"># 例如：24.101 -&gt; 24.2</span>

    <span class="c1"># 计算y轴标签的第二个值，向上取整到整数</span>
    <span class="n">ytx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">maghi</span><span class="p">)</span>  <span class="c1"># 例如：24.1 -&gt; 25</span>

    <span class="c1"># 计算ytx1的小数部分</span>
    <span class="n">fpart</span> <span class="o">=</span> <span class="n">ytx1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">ytx1</span><span class="p">)</span>  <span class="c1"># 例如：0.2</span>

    <span class="c1"># 根据小数部分的值决定ytx1的内容</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">):</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 如果小数部分接近0或0.9，则ytx1为空</span>

    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">):</span>
        <span class="c1"># 如果小数部分接近0.1或0.2，生成多个y轴标签</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx1</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.3</span><span class="p">])</span>  <span class="c1"># 例如：24.1, 24.3, 24.5, 24.7</span>

    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">):</span>
        <span class="c1"># 如果小数部分接近0.3或0.4，生成多个y轴标签</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx1</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.3</span><span class="p">])</span>  <span class="c1"># 例如：24.3, 24.5, 24.7</span>

    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">):</span>
        <span class="c1"># 如果小数部分接近0.5，生成两个y轴标签</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx1</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.3</span><span class="p">])</span>  <span class="c1"># 例如：24.5, 24.7</span>

    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fpart</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">):</span>
        <span class="c1"># 如果小数部分接近0.6，生成一个y轴标签</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx1</span><span class="p">,</span> <span class="n">ytx2</span><span class="o">-</span><span class="mf">0.2</span><span class="p">])</span>  <span class="c1"># 例如：24.6, 24.8</span>

    <span class="c1"># 如果ytx1是浮点数，则将其转换为数组</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ytx1</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">ytx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx1</span><span class="p">])</span>

    <span class="c1"># 根据plothuge的值决定ytx3的内容</span>
    <span class="k">if</span> <span class="n">plothuge</span><span class="p">:</span>
        <span class="n">ytx3</span> <span class="o">=</span> <span class="n">ytx2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># 大范围的y轴标签</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ytx3</span> <span class="o">=</span> <span class="n">ytx2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>  <span class="c1"># 小范围的y轴标签</span>

    <span class="c1"># 将ytx2转换为数组</span>
    <span class="n">ytx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ytx2</span><span class="p">])</span>

    <span class="c1"># 合并ytx1和ytx3</span>
    <span class="n">ytx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ytx1</span><span class="p">,</span> <span class="n">ytx3</span><span class="p">])</span>

    <span class="c1"># 将y轴标签格式化为字符串</span>
    <span class="n">yts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mag</span> <span class="k">for</span> <span class="n">mag</span> <span class="ow">in</span> <span class="n">ytx</span><span class="p">]</span>

    <span class="c1"># 将y轴标签从AB星等转换为指定的流量单位</span>
    <span class="n">ytx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ytx</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">flux_units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># 创建一个共享y轴的第二个坐标轴</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

    <span class="c1"># 设置y轴标签位置</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

    <span class="c1"># 设置y轴刻度方向</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_left</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">tick_right</span><span class="p">()</span>

    <span class="c1"># 设置第二个坐标轴的y轴刻度和标签</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ytx</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yts</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Magnitude (AB)&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为“Magnitude (AB)”</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylo</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">yhi</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># 设置y轴的上下限</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># 设置z轴顺序，确保交互光标输出左侧坐标轴ax</span>
</pre></div>
</div>
</div>
</div>
<p><em>开发者注释：</em></p>
<p>errorbar 也不支持单位</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  <span class="c1"># 创建一个8x6英寸的图形和坐标轴</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">input_fluxes</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input fluxes&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 绘制输入通量的折线图，点标记为圆圈</span>

<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Measured PSF-corrected fluxes $</span><span class="se">\\</span><span class="s1">times$ </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_factor</span>  <span class="c1"># 创建标签，表示经过PSF校正的通量</span>

<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">output_fluxes</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span> <span class="n">output_flux_errs</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span>  <span class="c1"># 绘制经过PSF校正的通量的误差条</span>
             <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">mpl_colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>  <span class="c1"># 设置标记样式和颜色</span>

<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Measured uncorrected fluxes $</span><span class="se">\\</span><span class="s1">times$ </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_factor</span>  <span class="c1"># 创建标签，表示未经校正的通量</span>

<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">output_fluxes</span> <span class="o">*</span> <span class="n">flux_factor</span> <span class="o">/</span> <span class="n">PSF_flux_corrections</span><span class="p">,</span> <span class="n">output_flux_errs</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span>  <span class="c1"># 绘制未经校正的通量的误差条</span>
             <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># 设置标记样式和颜色</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  <span class="c1"># 显示图例</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>  <span class="c1"># 绘制一条水平的虚线，y=0</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 设置x轴的范围为0到5</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($</span><span class="se">\\</span><span class="s1">mu$m)&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为波长</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (nJy)&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为通量</span>
<span class="n">add_magnitude_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>  <span class="c1"># 添加幅度轴</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;JADES photutils SED linear.png&#39;</span><span class="p">)</span>  <span class="c1"># 保存图形为PNG文件</span>
</pre></div>
</div>
</div>
</div>
<p><em>开发者笔记：</em></p>
<p>理想情况下，辅助轴应该能够知道如何在单位之间转换。</p>
<p>作为一种解决方法，我编写了函数并将其输入。</p>
<p>即便如此，这仅在通量（flux）为正值时有效。</p>
<p>将所有通量裁剪为正值也无法解决问题。</p>
<p>我希望能够自动缩放y轴的限制，仅针对某些绘制的数据，类似于：</p>
<p>https://stackoverflow.com/questions/7386872/make-matplotlib-autoscaling-ignore-some-of-the-plots</p>
<p>但那个旧的解决方案并没有奏效。</p>
<p>所以目前，我只是硬编码了一个适用于该对象的范围：y=10-70。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  <span class="c1"># 创建一个8x6英寸的图形和坐标轴</span>

<span class="k">if</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 这段代码没有生效</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 自动缩放坐标轴</span>
    <span class="n">detections</span> <span class="o">=</span> <span class="n">output_fluxes</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># 检测输出通量大于0的值</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">detections</span><span class="p">],</span> <span class="n">output_fluxes</span><span class="p">[</span><span class="n">detections</span><span class="p">]</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 绘制可见的输出通量</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 关闭自动缩放</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">input_fluxes</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input fluxes&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">scaley</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 绘制输入通量</span>

<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Measured PSF-corrected fluxes $</span><span class="se">\\</span><span class="s1">times$ </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_factor</span>  <span class="c1"># 创建标签，显示PSF校正后的通量</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">output_fluxes</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span> <span class="n">output_flux_errs</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span>  <span class="c1"># 绘制带误差条的输出通量</span>
             <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="n">mpl_colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

<span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Measured uncorrected fluxes $</span><span class="se">\\</span><span class="s1">times$ </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_factor</span>  <span class="c1"># 创建标签，显示未校正的通量</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">output_fluxes</span> <span class="o">*</span> <span class="n">flux_factor</span> <span class="o">/</span> <span class="n">PSF_flux_corrections</span><span class="p">,</span> <span class="n">output_flux_errs</span> <span class="o">*</span> <span class="n">flux_factor</span><span class="p">,</span>  <span class="c1"># 绘制带误差条的未校正通量</span>
             <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  <span class="c1"># 显示图例</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>  <span class="c1"># 绘制y=0的水平线</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength ($</span><span class="se">\\</span><span class="s1">mu$m)&#39;</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Flux (nJy)&#39;</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>  <span class="c1"># 使用对数y轴</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">))</span>  <span class="c1"># 设置y轴主刻度格式</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">))</span>  <span class="c1"># 设置y轴次刻度格式</span>

<span class="c1"># 添加AB星等作为右侧的次坐标轴</span>
<span class="c1"># （注意：如果任何通量为负，则此功能会失效）</span>
<span class="c1"># https://matplotlib.org/gallery/subplots_axes_and_figures/secondary_axis.html#sphx-glr-gallery-subplots-axes-and-figures-secondary-axis-py</span>

<span class="k">def</span><span class="w"> </span><span class="nf">AB2nJy</span><span class="p">(</span><span class="n">mAB</span><span class="p">):</span>  <span class="c1"># 定义AB星等到nJy的转换函数</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mAB</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">ABmag</span>  <span class="c1"># 将AB星等转换为量纲</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nJy</span><span class="p">)</span>  <span class="c1"># 转换为nJy</span>
    <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 返回nJy值</span>

<span class="k">def</span><span class="w"> </span><span class="nf">nJy2AB</span><span class="p">(</span><span class="n">F_nJy</span><span class="p">):</span>  <span class="c1"># 定义nJy到AB星等的转换函数</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">F_nJy</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nJy</span>  <span class="c1"># 将nJy值转换为量纲</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">ABmag</span><span class="p">)</span>  <span class="c1"># 转换为AB星等</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># 返回AB星等值</span>

<span class="c1"># secondary_axis = add_magnitude_axis(ax, flux_units)  # 这行代码被注释掉</span>
<span class="n">secax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">secondary_yaxis</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="p">(</span><span class="n">nJy2AB</span><span class="p">,</span> <span class="n">AB2nJy</span><span class="p">))</span>  <span class="c1"># 创建右侧次坐标轴</span>
<span class="n">secax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;magnitude (AB)&#39;</span><span class="p">)</span>  <span class="c1"># 设置次坐标轴的y轴标签</span>
<span class="n">secax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">))</span>  <span class="c1"># 设置次坐标轴主刻度格式</span>
<span class="n">secax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%g</span><span class="s2">&quot;</span><span class="p">))</span>  <span class="c1"># 设置次坐标轴次刻度格式</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;JADES SED PSF-corrected&#39;</span><span class="p">)</span>  <span class="c1"># 设置图形标题</span>
<span class="c1"># plt.savefig(&#39;JADES photutils SED.png&#39;)  # 保存图形（这行代码被注释掉）</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRCam/NIRCam_PSF-matched_photometry"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../NIRCam_photometry/NIRCam_multiband_photometry_cn.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">扩展孔径光度测量</p>
      </div>
    </a>
    <a class="right-next"
       href="../psf_photometry/NIRCam_PSF_Photometry_Example_cn.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">PSF 光度测量</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">引言</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">导入包</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#matplotlib">Matplotlib 设置用于绘图</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">创建待加载和分析的图像列表</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f200w">加载探测图像：F200W</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">报告图像大小和视场</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">创建彩色图像（可选）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#astropy-photutils">使用 astropy.photutils 检测源和去混叠</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">在检测图像中测量光度（及更多）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">显示检测结果与图像（可选）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">查看 / 保存检测图像中的测量量（可选）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">仅保留某些量</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">将测量的通量（数据单位）转换为星等</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">使用在检测图像中定义的等亮度光圈进行多波段光度测量</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#isophotal-kron">光圈修正：等光度（isophotal）到总（Kron光圈）通量</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">重新格式化输出目录以提高可读性（可选）</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">无点扩散函数（PSF）校正的等光度测光</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">PSF幅度校正</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#psfs">加载点扩散函数 (PSFs)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">PSF 匹配</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">确定PSF卷积核</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#f200w-psfs">将F200W探测图像卷积到长波长点扩散函数（PSFs）</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">卷积图像中的多波段光度测量</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">PSF 亮度修正</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">开始新会话并分析结果</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">加载目录和分割图</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#jades-jaguar">输入模拟 JADES JAGUAR 目录</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#photutils">将天体与 photutils 目录匹配</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f200w-f090w">绘制 F200W 与 F090W 亮度图并寻找掉落星系</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">在所有滤光片中显示选定对象</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sed">绘制单个天体的光谱能量分布 (SED)</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>