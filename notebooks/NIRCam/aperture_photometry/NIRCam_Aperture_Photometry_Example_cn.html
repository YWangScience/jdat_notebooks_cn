
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>点源光度测量 &#8212; STScI JDAT Notebooks 中文版</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css?v=b44a18d9" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example_cn';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="扩展孔径光度测量" href="../NIRCam_photometry/NIRCam_multiband_photometry_cn.html" />
    <link rel="prev" title="MIRI LRS 窄缝光谱学：使用 JWST 管道进行光谱提取" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1_cn.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/stsci_logo2.png" class="logo__image only-light" alt="STScI JDAT Notebooks 中文版 - Home"/>
    <script>document.write(`<img src="../../../_static/stsci_logo2.png" class="logo__image only-dark" alt="STScI JDAT Notebooks 中文版 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">主页</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install_cn.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebook_development_workflow_cn.html">笔记本开发工作流程</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">开发</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/submitting_notebooks_cn.html">提交笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/requirements_cn.html">需求文件</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/notebooks_cn.html">Jupyter 笔记本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/data_files_cn.html">数据文件</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub 指南</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_setup_cn.html">GitHub 设置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_workflow_cn.html">GitHub 工作流程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/github_pr_cn.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">跨仪器通用</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/asdf_example/asdf_example_cn.html">ASDF 示例</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/background_estimation_imaging/Imaging_Sky_Background_Estimation_cn.html">复杂的二维背景</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/composite_model_fitting/specfit_demo_3_cn.html">复合模型光谱拟合</a></li>


<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/NIRSpec_MAST_Query/NIRSpec_MAST_Query_cn.html">MAST 查询</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/rgb_imviz/imviz_rgb_carina_cn.html">Imviz RGB图像</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift_cn.html">Specviz 简单示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/update_pure_parallel_wcs/NIRISS_correct_pure_parallel_WCS_cn.html">提高纯平行数据集的WCS精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross_instrument/stpsf_examples/stpsf_examples_cn.html">STPSF 示例</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis_cn.html">MRS Mstar - 数据分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc_cn.html">LMC中的IFU YSOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1_cn.html">LRS 光谱提取</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">点源光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry_cn.html">扩展孔径光度测量</a></li>


<li class="toctree-l1"><a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry_cn.html">交叉滤光片 PSF 匹配</a></li>
<li class="toctree-l1"><a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example_cn.html">PSF 光度测量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam_wisp_subtraction/nircam_wisp_subtraction_cn.html">NIRCam 光晕去除</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/00_Optimal_extraction_cn.html">WFSS 光谱 - 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra_cn.html">WFSS 光谱 - 合并和归一化 1D 光谱</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/02_Cross_correlation_template_cn.html">WFSS 光谱 - 相关性模版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map_cn.html">WFSS 光谱 - 发射线图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/00_niriss_mast_query_data_setup_cn.html">NIRISS MAST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/01_niriss_wfss_image2_image3_cn.html">运行图像处理管道并创建源目录</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRISS/NIRISS_WFSS_advanced/02_niriss_wfss_spec2_cn.html">运行 spec2 管道</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit_cn.html">IFU立方体拟合</a></li>




<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/cube_fitting/cube_fitting_cn.html">IFU Cube 建模</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/ifu_optimal/ifu_optimal_cn.html">IFU 光谱提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/optimal_extraction/Spectral_Extraction-static_cn.html">MOS 提取</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/mos_spectroscopy_advanced/MOSspec_advanced_cn.html">星系外场的MOS光谱</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST_cn.html">BOTS 时间序列观测</a></li>








<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/galaxy_redshift/redshift_fitting_cn.html">红移和模板拟合</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/FS_NSClean_example_cn.html">FS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/IFU_NSClean_example_cn.html">IFU 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/MOS_NSClean_example_cn.html">MOS 数据生成 （NSClean）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../NIRSpec/NIRSpec_NSClean/BOTS_NSClean_example_cn.html">BOTS 数据生成 （NSClean）</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/notebooks/NIRCam/aperture_photometry/NIRCam_Aperture_Photometry_Example_cn.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>点源光度测量</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">导入函数</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">导入绘图函数</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">加载图像并创建一些有用的字典</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">选择用于分析的探测器和/或滤光片</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">显示图像</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aperture-photometry">光圈光度法 (Aperture Photometry)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">1. 寻找源</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">2. 光圈光度法 (Aperture Photometry)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">3. 包含星等和位置的表格</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">匹配源表</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">仪器颜色-星等图及误差</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#photometric-zeropoints">光度零点 (Photometric Zeropoints)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">加载孔径校正表</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-cmd">1a. 使用CMD作为参考进行子采样</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">明亮孤立星的光圈光度测量</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#zeropoints">推导零点 (Zeropoints)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">导入输入目录</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">校准的颜色-星等图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">输入与输出光度的比较</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">关于此笔记本</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>点源光度测量<a class="headerlink" href="#id1" title="Link to this heading">#</a></h1>
<p><strong>使用案例：</strong> 光度测量、交叉匹配目录、推导并应用光度零点。<br></p>
<p><strong>数据：</strong> 使用 <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-data-simulator">MIRAGE</a> 模拟的 NIRCam 图像，并通过 <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/">JWST 流水线</a> 处理大麦哲伦云 (LMC) 天体测量校准场。模拟使用了 4 点子像素抖动，针对三对宽滤光片：SW 通道的 F070W、F115W 和 F200W，以及 LW 通道的 F277W、F356W 和 F444W。我们仅模拟了 1 个 NIRCam SW 探测器（即 “NRCB1”）。在此示例中，我们使用两个 SW 滤光片（即 F115W 和 F200W）的 Level-3 图像（已校准和整形），并在每个图像中推导光度测量。其他滤光片的图像也可用，并可用于测试笔记本和/或不同滤光片组合。<br></p>
<p><strong>工具：</strong> astropy, photutils。<br></p>
<p><strong>跨仪器：</strong> NIRSpec, NIRISS, MIRI。<br></p>
<p><strong>文档：</strong> 此笔记本是 STScI 更大 <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">后处理数据分析工具生态系统</a> 的一部分。<br></p>
<p>最终图表显示：</p>
<ul class="simple">
<li><p>仪器颜色-星等图及误差</p></li>
<li><p>星等零点</p></li>
<li><p>校准颜色-星等图（与输入颜色-星等图比较）</p></li>
<li><p>输入与输出光度测量的比较</p></li>
</ul>
<section id="id2">
<h2>导入函数<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  <span class="c1"># 导入操作系统模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>  <span class="c1"># 导入系统模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>  <span class="c1"># 导入时间模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>  <span class="c1"># 导入NumPy库，用于数值计算</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>  <span class="c1"># 导入Pandas库，用于数据处理</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">glob</span>  <span class="c1"># 导入glob模块，用于文件路径匹配</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>  <span class="c1"># 导入tarfile模块，用于处理tar文件</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>  <span class="c1"># 导入urllib.request模块，用于处理URL请求</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">jwst</span>  <span class="c1"># 导入JWST相关模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jwst.datamodels</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageModel</span>  <span class="c1"># 从JWST数据模型中导入图像模型</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>  <span class="c1"># 从Astropy库导入FITS文件处理模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>  <span class="c1"># 从Astropy库导入表格处理模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">ZScaleInterval</span><span class="p">,</span> <span class="n">SqrtStretch</span><span class="p">,</span> <span class="n">ImageNormalize</span><span class="p">)</span>  <span class="c1"># 导入图像可视化相关模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_norm</span>  <span class="c1"># 导入简单归一化函数</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sigma_clipped_stats</span><span class="p">,</span> <span class="n">SigmaClip</span>  <span class="c1"># 导入统计分析相关模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">match_coordinates_sky</span>  <span class="c1"># 导入天文坐标相关模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>  <span class="c1"># 导入单位模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.detection</span><span class="w"> </span><span class="kn">import</span> <span class="n">DAOStarFinder</span>  <span class="c1"># 从Photutils库导入星点检测器</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">MMMBackground</span><span class="p">,</span> <span class="n">MADStdBackgroundRMS</span><span class="p">,</span> <span class="n">Background2D</span>  <span class="c1"># 导入背景处理相关模块</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.aperture</span><span class="w"> </span><span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">CircularAnnulus</span><span class="p">,</span> <span class="n">aperture_photometry</span>  <span class="c1"># 导入光度测量相关模块</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h2>导入绘图函数<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline  # 在Jupyter Notebook中内联显示图形

<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">style</span><span class="p">,</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>  <span class="c1"># 导入matplotlib的样式和绘图模块</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">patches</span>  <span class="c1"># 导入绘图补丁模块，用于添加形状</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ticker</span>  <span class="c1"># 导入刻度模块，用于自定义坐标轴刻度</span>

<span class="c1"># 设置图像的颜色映射为&#39;viridis&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span>

<span class="c1"># 设置图像的原点位置为左下角</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>

<span class="c1"># 设置坐标轴标题和标签的字体大小为30</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.titlesize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># 设置x轴和y轴刻度标签的字体大小为30</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># 定义字体样式1</span>
<span class="n">font1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;helvetica&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="s1">&#39;12&#39;</span><span class="p">}</span>

<span class="c1"># 定义字体样式2</span>
<span class="n">font2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;helvetica&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="s1">&#39;20&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h2>加载图像并创建一些有用的字典<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<p>我们加载所有图像，并创建一个包含所有图像的字典，按探测器（detectors）和滤光片（filters）进行分类。这对于检查可用的探测器和滤光片非常有用，并帮助我们决定是否对所有图像进行光度测量（photometry），还是仅对子集进行（例如，仅对SW滤光片进行）。</p>
<p>我们还创建了一个包含一些分析所需参数的字典。该字典包含光度零点（photometric zeropoints，来自<a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-data-simulator">MIRAGE</a>配置文件）和NIRCam点扩散函数（PSF）全宽半最大值（FWHM），这些数据来自<a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-camera/nircam-predicted-performance/nircam-point-spread-functions">NIRCam点扩散函数</a>的JDox页面。FWHM是通过分析使用<a class="reference external" href="https://www.stsci.edu/jwst/science-planning/proposal-planning-toolbox/psf-simulation-tool">WebbPSF</a>模拟的预期NIRCam PSF计算得出的。</p>
<p><strong>注意</strong>：一旦每个探测器/滤光片的零点和FWHM值在调试完成后可用，该字典将会更新。</p>
<p>因此，我们有两个字典：</p>
<ul class="simple">
<li><p>Level-3图像的字典</p></li>
<li><p>其他一些有用参数的字典</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 初始化一个字典，用于存储不同探测器的图像数据</span>
<span class="n">dict_images</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NRCA1&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA2&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA3&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA4&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCA5&#39;</span><span class="p">:</span> <span class="p">{},</span>
               <span class="s1">&#39;NRCB1&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB2&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB3&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB4&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;NRCB5&#39;</span><span class="p">:</span> <span class="p">{}}</span>

<span class="c1"># 初始化短波和长波过滤器的字典</span>
<span class="n">dict_filter_short</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">dict_filter_long</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># 初始化短波和长波的过滤器和探测器列表</span>
<span class="n">ff_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">det_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">det_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ff_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">detlist_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">detlist_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filtlist_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filtlist_long</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 检查当前目录下是否存在已合并的fits文件</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./*combined*fits&#39;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading images&quot;</span><span class="p">)</span>  <span class="c1"># 打印下载图像的提示</span>

    <span class="c1"># 定义图像数据的下载链接和保存路径</span>
    <span class="n">boxlink_images_lev3</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/images_level3.tar.gz&#39;</span>
    <span class="n">boxfile_images_lev3</span> <span class="o">=</span> <span class="s1">&#39;./images_level3.tar.gz&#39;</span>

    <span class="c1"># 下载图像数据</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_images_lev3</span><span class="p">,</span> <span class="n">boxfile_images_lev3</span><span class="p">)</span>

    <span class="c1"># 解压下载的tar文件</span>
    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile_images_lev3</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>  <span class="c1"># 添加filter=&#39;data&#39;以跳过绝对路径或相对路径</span>

    <span class="c1"># 设置图像目录</span>
    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
    <span class="n">images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">&quot;*combined*fits&quot;</span><span class="p">)))</span>  <span class="c1"># 获取所有合并的fits文件</span>

<span class="k">else</span><span class="p">:</span>
    <span class="c1"># 如果已存在合并的fits文件，直接获取文件列表</span>
    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
    <span class="n">images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">&quot;*combined*fits&quot;</span><span class="p">)))</span>

<span class="c1"># 遍历所有图像文件</span>
<span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># 打开fits文件</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span>  <span class="c1"># 获取过滤器信息</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DETECTOR&#39;</span><span class="p">]</span>  <span class="c1"># 获取探测器信息</span>

    <span class="c1"># 根据探测器类型进行重命名</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">&#39;NRCBLONG&#39;</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">&#39;NRCB5&#39;</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">&#39;NRCALONG&#39;</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">&#39;NRCA5&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span>

    <span class="n">wv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># 获取波长信息</span>

    <span class="c1"># 根据波长将图像分类到短波或长波列表</span>
    <span class="k">if</span> <span class="n">wv</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
        <span class="n">ff_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># 添加到长波过滤器列表</span>
        <span class="n">det_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>  <span class="c1"># 添加到长波探测器列表</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ff_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># 添加到短波过滤器列表</span>
        <span class="n">det_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>  <span class="c1"># 添加到短波探测器列表</span>

    <span class="c1"># 获取短波和长波探测器的唯一列表</span>
    <span class="n">detlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_short</span><span class="p">)))</span>
    <span class="n">detlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_long</span><span class="p">)))</span>

    <span class="c1"># 初始化唯一过滤器列表</span>
    <span class="n">unique_list_filters_short</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unique_list_filters_long</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 为短波过滤器创建字典</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_short</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_short</span><span class="p">:</span>
            <span class="n">dict_filter_short</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># 为长波过滤器创建字典</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_long</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_long</span><span class="p">:</span>
            <span class="n">dict_filter_long</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># 将短波探测器与其对应的过滤器字典关联</span>
    <span class="k">for</span> <span class="n">d_s</span> <span class="ow">in</span> <span class="n">detlist_short</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_short</span>

    <span class="c1"># 将长波探测器与其对应的过滤器字典关联</span>
    <span class="k">for</span> <span class="n">d_l</span> <span class="ow">in</span> <span class="n">detlist_long</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d_l</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_long</span>

    <span class="c1"># 获取短波和长波过滤器的唯一列表</span>
    <span class="n">filtlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_short</span><span class="p">)))</span>
    <span class="n">filtlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_long</span><span class="p">)))</span>

    <span class="c1"># 将图像添加到对应的探测器和过滤器字典中</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;images&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">image</span><span class="p">]}</span>  <span class="c1"># 如果没有图像，初始化列表</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  <span class="c1"># 否则，添加图像到列表中</span>

<span class="c1"># 打印可用的探测器和过滤器信息</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available Detectors for SW channel:&quot;</span><span class="p">,</span> <span class="n">detlist_short</span><span class="p">)</span>  <span class="c1"># 打印短波通道的可用探测器</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available Detectors for LW channel:&quot;</span><span class="p">,</span> <span class="n">detlist_long</span><span class="p">)</span>  <span class="c1"># 打印长波通道的可用探测器</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available SW Filters:&quot;</span><span class="p">,</span> <span class="n">filtlist_short</span><span class="p">)</span>  <span class="c1"># 打印可用的短波过滤器</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available LW Filters:&quot;</span><span class="p">,</span> <span class="n">filtlist_long</span><span class="p">)</span>  <span class="c1"># 打印可用的长波过滤器</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 定义过滤器列表</span>
<span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F070W&#39;</span><span class="p">,</span> <span class="s1">&#39;F090W&#39;</span><span class="p">,</span> <span class="s1">&#39;F115W&#39;</span><span class="p">,</span> <span class="s1">&#39;F140M&#39;</span><span class="p">,</span> <span class="s1">&#39;F150W2&#39;</span><span class="p">,</span> <span class="s1">&#39;F150W&#39;</span><span class="p">,</span> <span class="s1">&#39;F162M&#39;</span><span class="p">,</span> <span class="s1">&#39;F164N&#39;</span><span class="p">,</span> <span class="s1">&#39;F182M&#39;</span><span class="p">,</span>
           <span class="s1">&#39;F187N&#39;</span><span class="p">,</span> <span class="s1">&#39;F200W&#39;</span><span class="p">,</span> <span class="s1">&#39;F210M&#39;</span><span class="p">,</span> <span class="s1">&#39;F212N&#39;</span><span class="p">,</span> <span class="s1">&#39;F250M&#39;</span><span class="p">,</span> <span class="s1">&#39;F277W&#39;</span><span class="p">,</span> <span class="s1">&#39;F300M&#39;</span><span class="p">,</span> <span class="s1">&#39;F322W2&#39;</span><span class="p">,</span> <span class="s1">&#39;F323N&#39;</span><span class="p">,</span>
           <span class="s1">&#39;F335M&#39;</span><span class="p">,</span> <span class="s1">&#39;F356W&#39;</span><span class="p">,</span> <span class="s1">&#39;F360M&#39;</span><span class="p">,</span> <span class="s1">&#39;F405N&#39;</span><span class="p">,</span> <span class="s1">&#39;F410M&#39;</span><span class="p">,</span> <span class="s1">&#39;F430M&#39;</span><span class="p">,</span> <span class="s1">&#39;F444W&#39;</span><span class="p">,</span> <span class="s1">&#39;F460M&#39;</span><span class="p">,</span> <span class="s1">&#39;F466N&#39;</span><span class="p">,</span> <span class="s1">&#39;F470N&#39;</span><span class="p">,</span> <span class="s1">&#39;F480M&#39;</span><span class="p">]</span>

<span class="c1"># 定义点扩散函数的全宽半最大值（FWHM）</span>
<span class="n">psf_fwhm</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.987</span><span class="p">,</span> <span class="mf">1.103</span><span class="p">,</span> <span class="mf">1.298</span><span class="p">,</span> <span class="mf">1.553</span><span class="p">,</span> <span class="mf">1.628</span><span class="p">,</span> <span class="mf">1.770</span><span class="p">,</span> <span class="mf">1.801</span><span class="p">,</span> <span class="mf">1.494</span><span class="p">,</span> <span class="mf">1.990</span><span class="p">,</span> <span class="mf">2.060</span><span class="p">,</span> <span class="mf">2.141</span><span class="p">,</span> <span class="mf">2.304</span><span class="p">,</span> <span class="mf">2.341</span><span class="p">,</span> <span class="mf">1.340</span><span class="p">,</span>
            <span class="mf">1.444</span><span class="p">,</span> <span class="mf">1.585</span><span class="p">,</span> <span class="mf">1.547</span><span class="p">,</span> <span class="mf">1.711</span><span class="p">,</span> <span class="mf">1.760</span><span class="p">,</span> <span class="mf">1.830</span><span class="p">,</span> <span class="mf">1.901</span><span class="p">,</span> <span class="mf">2.165</span><span class="p">,</span> <span class="mf">2.179</span><span class="p">,</span> <span class="mf">2.300</span><span class="p">,</span> <span class="mf">2.302</span><span class="p">,</span> <span class="mf">2.459</span><span class="p">,</span> <span class="mf">2.507</span><span class="p">,</span> <span class="mf">2.535</span><span class="p">,</span> <span class="mf">2.574</span><span class="p">]</span>

<span class="c1"># 定义模型A的零点磁量</span>
<span class="n">zp_modA</span> <span class="o">=</span> <span class="p">[</span><span class="mf">25.7977</span><span class="p">,</span> <span class="mf">25.9686</span><span class="p">,</span> <span class="mf">25.8419</span><span class="p">,</span> <span class="mf">24.8878</span><span class="p">,</span> <span class="mf">27.0048</span><span class="p">,</span> <span class="mf">25.6536</span><span class="p">,</span> <span class="mf">24.6957</span><span class="p">,</span> <span class="mf">22.3073</span><span class="p">,</span> <span class="mf">24.8258</span><span class="p">,</span> <span class="mf">22.1775</span><span class="p">,</span> <span class="mf">25.3677</span><span class="p">,</span> <span class="mf">24.3296</span><span class="p">,</span>
           <span class="mf">22.1036</span><span class="p">,</span> <span class="mf">22.7850</span><span class="p">,</span> <span class="mf">23.5964</span><span class="p">,</span> <span class="mf">24.8239</span><span class="p">,</span> <span class="mf">23.6452</span><span class="p">,</span> <span class="mf">25.3648</span><span class="p">,</span> <span class="mf">20.8604</span><span class="p">,</span> <span class="mf">23.5873</span><span class="p">,</span> <span class="mf">24.3778</span><span class="p">,</span> <span class="mf">23.4778</span><span class="p">,</span> <span class="mf">20.5588</span><span class="p">,</span>
           <span class="mf">23.2749</span><span class="p">,</span> <span class="mf">22.3584</span><span class="p">,</span> <span class="mf">23.9731</span><span class="p">,</span> <span class="mf">21.9502</span><span class="p">,</span> <span class="mf">20.0428</span><span class="p">,</span> <span class="mf">19.8869</span><span class="p">,</span> <span class="mf">21.9002</span><span class="p">]</span>

<span class="c1"># 定义模型B的零点磁量</span>
<span class="n">zp_modB</span> <span class="o">=</span> <span class="p">[</span><span class="mf">25.7568</span><span class="p">,</span> <span class="mf">25.9771</span><span class="p">,</span> <span class="mf">25.8041</span><span class="p">,</span> <span class="mf">24.8738</span><span class="p">,</span> <span class="mf">26.9821</span><span class="p">,</span> <span class="mf">25.6279</span><span class="p">,</span> <span class="mf">24.6767</span><span class="p">,</span> <span class="mf">22.2903</span><span class="p">,</span> <span class="mf">24.8042</span><span class="p">,</span> <span class="mf">22.1499</span><span class="p">,</span> <span class="mf">25.3391</span><span class="p">,</span> <span class="mf">24.2909</span><span class="p">,</span>
           <span class="mf">22.0574</span><span class="p">,</span> <span class="mf">22.7596</span><span class="p">,</span> <span class="mf">23.5011</span><span class="p">,</span> <span class="mf">24.6792</span><span class="p">,</span> <span class="mf">23.5769</span><span class="p">,</span> <span class="mf">25.3455</span><span class="p">,</span> <span class="mf">20.8631</span><span class="p">,</span> <span class="mf">23.4885</span><span class="p">,</span> <span class="mf">24.3883</span><span class="p">,</span> <span class="mf">23.4555</span><span class="p">,</span> <span class="mf">20.7007</span><span class="p">,</span>
           <span class="mf">23.2763</span><span class="p">,</span> <span class="mf">22.4677</span><span class="p">,</span> <span class="mf">24.1562</span><span class="p">,</span> <span class="mf">22.0422</span><span class="p">,</span> <span class="mf">20.1430</span><span class="p">,</span> <span class="mf">20.0173</span><span class="p">,</span> <span class="mf">22.4086</span><span class="p">]</span>

<span class="c1"># 创建一个字典，将过滤器与其对应的PSF FWHM和零点磁量关联起来</span>
<span class="n">dict_utils</span> <span class="o">=</span> <span class="p">{</span><span class="n">filters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="p">{</span><span class="s1">&#39;psf fwhm&#39;</span><span class="p">:</span> <span class="n">psf_fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;VegaMAG zp modA&#39;</span><span class="p">:</span> <span class="n">zp_modA</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                           <span class="s1">&#39;VegaMAG zp modB&#39;</span><span class="p">:</span> <span class="n">zp_modB</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">))}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h2>选择用于分析的探测器和/或滤光片<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<p>如果我们只对分析中的某些滤光片（和/或某些探测器）感兴趣，如本例所示，我们可以从字典中选择这些滤光片（探测器）的图像，并仅分析这些图像。</p>
<p>在这个特定的例子中，我们分析探测器 <strong>NRCB1</strong> 的滤光片 <strong>F115W</strong> 和 <strong>F200W</strong> 的图像。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dets_short</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NRCB1&#39;</span><span class="p">]</span>  <span class="c1"># 本例中感兴趣的探测器</span>

<span class="n">filts_short</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F115W&#39;</span><span class="p">,</span> <span class="s1">&#39;F200W&#39;</span><span class="p">]</span>  <span class="c1"># 本例中感兴趣的滤光片</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h2>显示图像<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>为了检查我们的图像是否存在伪影并且可以用于分析，我们将其显示出来。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>  <span class="c1"># 创建一个14x14英寸的图形</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短列表中的每个探测器</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短列表中的每个滤镜，并获取索引</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 打开指定探测器和滤镜的图像文件</span>
        <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filts_short</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建子图，行数为1，列数为滤镜数量，当前索引为i+1</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X [px]&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置X轴标签</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y [px]&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置Y轴标签</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置子图标题为当前滤镜名称</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>  <span class="c1"># 使用平方根归一化数据，99%分位数</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">)</span>  <span class="c1"># 显示图像数据，使用灰度色图</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图布局以避免重叠</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="aperture-photometry">
<h2>光圈光度法 (Aperture Photometry)<a class="headerlink" href="#aperture-photometry" title="Link to this heading">#</a></h2>
<p>有关使用 Photutils 进行光圈光度法的更多信息，请访问这里：<a class="reference external" href="https://photutils.readthedocs.io/en/stable/aperture.html">光圈光度法</a></p>
<p>首先，我们创建一个有用的字典，其中包含：使用我们的查找算法检测到的源（<a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.detection.DAOStarFinder.html#photutils.detection.DAOStarFinder">DAOStarFinder</a>），包含光圈光度结果的表格，以及一个最终的表格，包含检测到的源的位置（包括 x,y 和 RA,Dec）、仪器星等（instrumental magnitudes）及其误差。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_aper</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化一个空字典，用于存储光圈数据</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短名称的探测器列表</span>

    <span class="n">dict_aper</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 为每个探测器设置一个空字典，如果不存在则创建</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短名称的滤光片列表，并获取索引</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 为每个滤光片设置一个空字典，如果不存在则创建</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 初始化“找到的源”键，值为None</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 初始化“光圈光度表”键，值为None</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 初始化“最终光圈光度表”键，值为None</span>
</pre></div>
</div>
</div>
</div>
<section id="id7">
<h3>1. 寻找源<a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.detection.DAOStarFinder.html#photutils.detection.DAOStarFinder">DAOStarFinder</a> 使用 DAOFIND (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1987PASP...99..191S/abstract">Stetson 1987</a>) 算法在图像中检测星星。DAOFIND 在图像中搜索局部密度最大值，这些最大值的峰值幅度大于 <code class="docutils literal notranslate"><span class="pre">threshold</span></code>（大致上；阈值应用于卷积图像），并且具有与定义的二维高斯核相似的大小和形状。</p>
<p><strong>注意</strong>：我们采用了作为背景估计器的函数 <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.background.MMMBackground.html#photutils.background.MMMBackground">MMMBackground</a>，该函数使用 DAOPHOT MMM 算法计算整个图像的背景。</p>
<p>在处理可变背景和/或需要屏蔽没有数据的区域（例如，如果我们正在分析包含所有 4 个 NIRCam SW 探测器的图像，即包含芯片间隙的图像）时，我们可以设置 <code class="docutils literal notranslate"><span class="pre">var_bkg</span></code> = True，并使用一种更复杂的算法来考虑这些问题。</p>
<p>请注意，来自管道的 Level-2 和 Level-3 图像的单位是 MJy/sr（因此是表面亮度）。图像的实际单位可以通过头文件关键字 <strong>BUNIT</strong> 检查。标量转换常数被复制到头文件关键字 <strong>PHOTMJSR</strong>，该关键字提供从 DN/s 到 megaJy/steradian 的转换。对于我们的分析，我们回退到 DN/s。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">&#39;NRCA1&#39;</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">&#39;F070W&#39;</span><span class="p">,</span> <span class="n">var_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># 定义查找星星的函数，参数包括探测器、滤光片和是否使用变背景</span>

    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>  <span class="c1"># 初始化MAD标准背景RMS对象</span>

    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>  <span class="c1"># 初始化MMM背景估计对象</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 打开指定探测器和滤光片的图像文件</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>  <span class="c1"># 获取图像头信息</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding sources on image </span><span class="si">{number}</span><span class="s2">, filter </span><span class="si">{f}</span><span class="s2">, detector </span><span class="si">{d}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>  <span class="c1"># 打印当前处理的图像信息</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span>  <span class="c1"># 将图像数据转换为DN/S单位</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Conversion factor from </span><span class="si">{units}</span><span class="s2"> to DN/S for filter </span><span class="si">{f}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">imh</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">],</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">])</span>  <span class="c1"># 打印转换因子</span>

    <span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf fwhm&#39;</span><span class="p">]</span>  <span class="c1"># 获取滤光片的PSF FWHM值</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FWHM for the filter </span><span class="si">{f}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">sigma_psf</span><span class="p">,</span> <span class="s2">&quot;px&quot;</span><span class="p">)</span>  <span class="c1"># 打印FWHM值</span>

    <span class="k">if</span> <span class="n">var_bkg</span><span class="p">:</span>  <span class="c1"># 如果使用变背景</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using 2D Background&quot;</span><span class="p">)</span>  <span class="c1"># 打印使用2D背景的信息</span>
        <span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">)</span>  <span class="c1"># 初始化SigmaClip对象</span>
        <span class="n">coverage_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 创建覆盖掩码，标记数据为0的区域</span>

        <span class="c1"># 计算2D背景</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="n">filter_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span> <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">mmm_bkg</span><span class="p">,</span>
                           <span class="n">coverage_mask</span><span class="o">=</span><span class="n">coverage_mask</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 复制数据</span>
        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data_bkgsub</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span>  <span class="c1"># 从数据中减去背景</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data_bkgsub</span><span class="p">)</span>  <span class="c1"># 计算经过sigma裁剪的统计量</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># 如果不使用变背景</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 计算背景的标准差</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 估计背景</span>

        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 复制数据</span>
        <span class="n">data_bkgsub</span> <span class="o">-=</span> <span class="n">bkg</span>  <span class="c1"># 从数据中减去背景</span>

    <span class="c1"># 初始化DAOStarFinder以查找星源</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">th</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>

    <span class="n">found_stars</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data_bkgsub</span><span class="p">)</span>  <span class="c1"># 在背景减去后的数据中查找星源</span>
    <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">found_stars</span>  <span class="c1"># 将找到的星源存入字典</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of sources found in the image:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_stars</span><span class="p">))</span>  <span class="c1"># 打印找到的星源数量</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------------&quot;</span><span class="p">)</span>  <span class="c1"># 打印分隔线</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

<span class="n">th</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># 两个滤波器的阈值水平（长度必须与分析的滤波器数量匹配）</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短时间检测器列表</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短时间滤波器列表，并获取索引</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历当前检测器和滤波器的图像</span>

            <span class="n">find_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">var_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 调用函数查找星星，背景变量设为False</span>

<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed Time for finding stars:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>  <span class="c1"># 输出查找星星的耗时</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id8">
<h3>2. 光圈光度法 (Aperture Photometry)<a class="headerlink" href="#id8" title="Link to this heading">#</a></h3>
<p>在下面的函数中，我们需要指定4个参数，以执行光圈光度法：用于分析的滤光片（即图像）、光圈半径以及用于确定局部背景的环形区域的内半径和外半径。光圈半径和环形区域的值取决于所采用的滤光片和用户的科学案例。</p>
<p>请注意，光圈对象支持多个位置，允许在每个位置执行<a class="reference external" href="https://photutils.readthedocs.io/en/latest/aperture.html#multiple-apertures-at-each-position">多个光圈</a>的光度测量。对于多个光圈，输出表的列名会附加位置索引。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">[</span><span class="mf">3.5</span><span class="p">],</span> <span class="n">sky_in</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">sky_out</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="c1"># 定义一个函数，用于进行光度测量，输入参数包括探测器、滤光片、半径、内外天区半径</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span>
                              <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])))</span>
    <span class="c1"># 获取源的位置坐标，x和y中心坐标</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># 打开指定的图像文件</span>

    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="c1"># 获取图像数据</span>

    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="c1"># 获取图像头信息</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span>
    <span class="c1"># 将数据归一化，除以光度单位</span>

    <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># 找到数据中小于0的元素的索引</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># 将小于0的值置为0</span>

    <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># 计算数据的误差，使用平方根</span>

    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1"># 记录开始时间</span>

    <span class="n">table_aper</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
    <span class="c1"># 创建一个空的表格，用于存储光度测量结果</span>

    <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">radius</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performing aperture photometry for filter </span><span class="si">{1}</span><span class="s2">; radius r = </span><span class="si">{0}</span><span class="s2"> px&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">filt</span><span class="p">))</span>
        <span class="c1"># 打印当前正在处理的滤光片和半径信息</span>

        <span class="n">rr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
        <span class="c1"># 将半径转换为字符串</span>

        <span class="n">aperture</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">rad</span><span class="p">)</span>
        <span class="c1"># 创建一个圆形光圈对象</span>

        <span class="n">annulus_aperture</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="n">sky_in</span><span class="p">,</span> <span class="n">r_out</span><span class="o">=</span><span class="n">sky_out</span><span class="p">)</span>
        <span class="c1"># 创建一个圆环天区对象</span>

        <span class="n">annulus_mask</span> <span class="o">=</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="c1"># 将圆环天区转换为掩模</span>

        <span class="n">bkg_median</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 初始化背景中值列表</span>

        <span class="n">bkg_stdev</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 初始化背景标准差列表</span>

        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">annulus_mask</span><span class="p">:</span>
            <span class="n">annulus_data</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># 使用掩模提取圆环区域的数据</span>

            <span class="n">annulus_data_1d</span> <span class="o">=</span> <span class="n">annulus_data</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="c1"># 将掩模区域的数据展平为一维数组</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">median_sigclip</span><span class="p">,</span> <span class="n">stdev_sigclip</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">annulus_data_1d</span><span class="p">)</span>
            <span class="c1"># 计算背景的中值和标准差，使用sigma剪切法</span>

            <span class="n">bkg_median</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_sigclip</span><span class="p">)</span>
            <span class="c1"># 将中值添加到列表中</span>

            <span class="n">bkg_stdev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stdev_sigclip</span><span class="p">)</span>
            <span class="c1"># 将标准差添加到列表中</span>

        <span class="n">bkg_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bkg_median</span><span class="p">)</span>
        <span class="c1"># 将背景中值列表转换为数组</span>

        <span class="n">bkg_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bkg_stdev</span><span class="p">)</span>
        <span class="c1"># 将背景标准差列表转换为数组</span>

        <span class="n">phot</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
        <span class="c1"># 进行光度测量，使用精确方法</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span>
        <span class="c1"># 将背景中值添加到光度测量结果中</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span>
        <span class="c1"># 计算并添加光圈背景值</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">]</span>
        <span class="c1"># 计算并添加背景校正后的光圈总和</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aper_sum_&#39;</span> <span class="o">+</span> <span class="n">rr</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">)</span>
        <span class="c1"># 将光圈总和添加到结果表中</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;annulus_median_&#39;</span> <span class="o">+</span> <span class="n">rr</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">)</span>
        <span class="c1"># 将背景中值添加到结果表中</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aper_bkg_&#39;</span> <span class="o">+</span> <span class="n">rr</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">)</span>
        <span class="c1"># 将光圈背景值添加到结果表中</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aper_sum_bkgsub_&#39;</span> <span class="o">+</span> <span class="n">rr</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">)</span>
        <span class="c1"># 将背景校正后的光圈总和添加到结果表中</span>

        <span class="n">error_poisson</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum_err&#39;</span><span class="p">]</span>
        <span class="c1"># 获取光圈总和的泊松误差</span>

        <span class="n">error_scatter_sky</span> <span class="o">=</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span> <span class="o">*</span> <span class="n">bkg_stdev</span><span class="o">**</span><span class="mi">2</span>
        <span class="c1"># 计算由于背景散射引起的误差</span>

        <span class="n">error_mean_sky</span> <span class="o">=</span> <span class="n">bkg_stdev</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">area</span>
        <span class="c1"># 计算平均背景引起的误差</span>

        <span class="n">fluxerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_poisson</span> <span class="o">+</span> <span class="n">error_scatter_sky</span> <span class="o">+</span> <span class="n">error_mean_sky</span><span class="p">)</span>
        <span class="c1"># 计算总误差</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">fluxerr</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;flux_err_&#39;</span> <span class="o">+</span> <span class="n">rr</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">)</span>
        <span class="c1"># 将总误差添加到结果表中</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_aper</span>
        <span class="c1"># 将结果表存储到字典中</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1"># 记录结束时间</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time Elapsed:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>
    <span class="c1"># 打印耗时信息</span>

    <span class="k">return</span>
    <span class="c1"># 返回函数结束</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">det</span> <span class="o">=</span> <span class="s1">&#39;NRCB1&#39;</span>  <span class="c1"># 设置探测器为NRCB1</span>

<span class="n">filt1</span> <span class="o">=</span> <span class="s1">&#39;F115W&#39;</span>  <span class="c1"># 设置第一个滤光片为F115W</span>

<span class="n">filt2</span> <span class="o">=</span> <span class="s1">&#39;F200W&#39;</span>  <span class="c1"># 设置第二个滤光片为F200W</span>

<span class="c1"># 对于第一个滤光片进行光度测量，使用半径为3.5的光圈，天空区域内外半径分别为7和10</span>
<span class="n">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt1</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">[</span><span class="mf">3.5</span><span class="p">],</span> <span class="n">sky_in</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">sky_out</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 对于第二个滤光片进行光度测量，使用半径为4.0的光圈，天空区域内外半径分别为6和9</span>
<span class="n">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt2</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">[</span><span class="mf">4.0</span><span class="p">],</span> <span class="n">sky_in</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">sky_out</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id9">
<h3>3. 包含星等和位置的表格<a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<p>我们创建最终的表格，包含每个目录的位置信息、星等和误差。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">]</span>  <span class="c1"># 定义半径列表</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短时间检测列表</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短时间滤波器列表</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历图像索引</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">radii</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>  <span class="c1"># 将当前半径转换为字符串</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 打开图像文件</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>

            <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 创建图像模型</span>

            <span class="c1"># 创建掩膜，筛选出有效的源</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;aper_sum_bkgsub_&#39;</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>

            <span class="n">table_phot</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>  <span class="c1"># 创建一个新的表格对象</span>

            <span class="c1"># 将掩膜筛选后的x和y坐标存入表格</span>
            <span class="n">table_phot</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">table_phot</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>

            <span class="c1"># 使用WCS将x和y坐标转换为RA和Dec</span>
            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">table_phot</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">table_phot</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
            <span class="n">table_phot</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>  <span class="c1"># 将RA和Dec存入表格</span>

            <span class="c1"># 计算并存储光度</span>
            <span class="n">table_phot</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;aper_sum_bkgsub_&#39;</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
            <span class="c1"># 计算并存储光度误差</span>
            <span class="n">table_phot</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;flux_err_&#39;</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">/</span>
                                                        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;aper_sum_bkgsub_&#39;</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>

            <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_phot</span>  <span class="c1"># 将最终的光度表存入字典</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id10">
<h3>匹配源表<a class="headerlink" href="#id10" title="Link to this heading">#</a></h3>
<p>我们交叉匹配目录以获得单一的颜色-亮度图（color-magnitude diagram）。</p>
<p>如果匹配之间的距离小于 0.5 像素（px），则来自两个滤光片的星体被关联。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_sep</span> <span class="o">=</span> <span class="mf">0.015</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>  <span class="c1"># 定义最大分离角度为0.015角秒</span>

<span class="c1"># 匹配两个滤波器的天体坐标</span>
<span class="n">idx_inst</span><span class="p">,</span> <span class="n">d2d_inst</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">],</span>
                                              <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">])</span>

<span class="n">sep_constraint_inst</span> <span class="o">=</span> <span class="n">d2d_inst</span> <span class="o">&lt;</span> <span class="n">max_sep</span>  <span class="c1"># 计算分离角度是否小于最大分离角度</span>

<span class="n">matched_sources</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>  <span class="c1"># 创建一个新的表格以存储匹配的源</span>

<span class="c1"># 将匹配的源的坐标和其他信息添加到表格中</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">]</span>  <span class="c1"># 添加滤波器1的坐标</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;x_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">]</span>  <span class="c1"># 添加滤波器1的x坐标</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">]</span>  <span class="c1"># 添加滤波器1的y坐标</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;x_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]]</span>  <span class="c1"># 添加滤波器2的x坐标</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]]</span>  <span class="c1"># 添加滤波器2的y坐标</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">]</span>  <span class="c1"># 添加滤波器1的测量值</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">]</span>  <span class="c1"># 添加滤波器1的误差</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]]</span>  <span class="c1"># 添加滤波器2的测量值</span>
<span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]]</span>  <span class="c1"># 添加滤波器2的误差</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id11">
<h2>仪器颜色-星等图及误差<a class="headerlink" href="#id11" title="Link to this heading">#</a></h2>
<p>在误差图中，灰色点表示在每个滤光片中所有检测的测量值，而黑色点表示在两个目录之间匹配的检测值。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>  <span class="c1"># 创建一个12x14英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清空当前图形</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建1行2列的子图，选择第1个子图</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst -&#39;</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>  <span class="c1"># x轴下限</span>

<span class="n">xlim1</span> <span class="o">=</span> <span class="mf">0.8</span>   <span class="c1"># x轴上限</span>

<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>  <span class="c1"># y轴下限</span>

<span class="n">ylim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>    <span class="c1"># y轴上限</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">matched_sources</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span> <span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span>  <span class="c1"># 绘制散点图</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 设置点的大小和颜色</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建2行2列的子图，选择第2个子图</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\sigma$ &#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">11</span>  <span class="c1"># x轴下限</span>

<span class="n">xlim1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>  <span class="c1"># x轴上限</span>

<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.01</span>  <span class="c1"># y轴下限</span>

<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># y轴上限</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span>  <span class="c1"># 绘制散点图</span>
            <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 设置点的大小和颜色</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># 创建2行2列的子图，选择第4个子图</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\sigma$ &#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span>  <span class="c1"># 绘制散点图</span>
            <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># 设置点的大小和颜色</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">matched_sources</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图间距以避免重叠</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="photometric-zeropoints">
<h2>光度零点 (Photometric Zeropoints)<a class="headerlink" href="#photometric-zeropoints" title="Link to this heading">#</a></h2>
<p>为了获得最终校准的颜色-星等图 (color-magnitude diagram)，我们需要计算光度零点 (photometric zeropoints)。因此，我们需要对图像进行光圈光度测量 (aperture photometry)，使用与包围能量 (encircled energy, EE) 值相对应的光圈半径，并应用适当的光圈修正 (aperture correction)，因为所采用的光圈是有限的（上面字典中提供的值是针对无限光圈的）。然后，将其与上述确定的光圈光度测量进行比较。因此，我们可以将步骤总结如下：</p>
<ul class="simple">
<li><p>使用适当的半径（相当于某个EE值）进行光圈光度测量</p></li>
<li><p>应用适当的光圈修正</p></li>
<li><p>应用表格化的零点</p></li>
<li><p>与光圈光度测量进行交叉匹配</p></li>
</ul>
<p><strong>注意</strong>：为了选择用于零点计算的恒星，我们可以使用CMD作为参考选择一个子样本，或者对一组明亮的孤立恒星进行光圈光度测量。要更改所使用的方法，我们可以分别设置 <code class="docutils literal notranslate"><span class="pre">sample</span></code> = cmd 或 <code class="docutils literal notranslate"><span class="pre">sample</span></code> = found。</p>
<section id="id12">
<h3>加载孔径校正表<a class="headerlink" href="#id12" title="Link to this heading">#</a></h3>
<p><strong>注意</strong>：这些值是通过对合成的WebbPSF点扩散函数（PSFs）进行研究获得的。一旦我们获得了飞行中的测量数据，这些值将会更新。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  <span class="c1"># 导入os模块，用于文件和目录操作</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>  <span class="c1"># 导入urllib.request模块，用于下载文件</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>  <span class="c1"># 导入pandas库，用于数据处理</span>

<span class="c1"># 检查是否存在名为&#39;aperture_correction_table.txt&#39;的文件</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;./aperture_correction_table.txt&#39;</span><span class="p">):</span>
    <span class="n">ap_tab</span> <span class="o">=</span> <span class="s1">&#39;./aperture_correction_table.txt&#39;</span>  <span class="c1"># 如果文件存在，设置文件路径</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading the aperture correction table&quot;</span><span class="p">)</span>  <span class="c1"># 如果文件不存在，打印下载提示</span>

    <span class="c1"># 定义要下载的文件链接</span>
    <span class="n">boxlink_apcorr_table</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/aperture_correction_table.txt&#39;</span>
    <span class="n">boxfile_apcorr_table</span> <span class="o">=</span> <span class="s1">&#39;./aperture_correction_table.txt&#39;</span>  <span class="c1"># 定义下载后保存的文件路径</span>

    <span class="c1"># 下载文件并保存到指定路径</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_apcorr_table</span><span class="p">,</span> <span class="n">boxfile_apcorr_table</span><span class="p">)</span>
    <span class="n">ap_tab</span> <span class="o">=</span> <span class="s1">&#39;./aperture_correction_table.txt&#39;</span>  <span class="c1"># 设置文件路径</span>

<span class="c1"># 读取&#39;aperture_correction_table.txt&#39;文件，使用空格作为分隔符</span>
<span class="n">aper_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ap_tab</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;pupil&#39;</span><span class="p">,</span> <span class="s1">&#39;wave&#39;</span><span class="p">,</span> <span class="s1">&#39;r10&#39;</span><span class="p">,</span> <span class="s1">&#39;r20&#39;</span><span class="p">,</span> <span class="s1">&#39;r30&#39;</span><span class="p">,</span> <span class="s1">&#39;r40&#39;</span><span class="p">,</span> <span class="s1">&#39;r50&#39;</span><span class="p">,</span> <span class="s1">&#39;r60&#39;</span><span class="p">,</span> <span class="s1">&#39;r70&#39;</span><span class="p">,</span> <span class="s1">&#39;r80&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;r85&#39;</span><span class="p">,</span> <span class="s1">&#39;r90&#39;</span><span class="p">,</span> <span class="s1">&#39;sky_flux_px&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr10&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr20&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr30&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr40&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;apcorr50&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr60&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr70&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr80&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr85&#39;</span><span class="p">,</span> <span class="s1">&#39;apcorr90&#39;</span><span class="p">,</span> <span class="s1">&#39;sky_in&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;sky_out&#39;</span><span class="p">],</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">))</span>

<span class="c1"># 显示数据表的前几行</span>
<span class="n">aper_table</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-cmd">
<h3>1a. 使用CMD作为参考进行子采样<a class="headerlink" href="#a-cmd" title="Link to this heading">#</a></h3>
<p><strong>注意</strong>：如果用户希望施加更严格的条件，可以在子样本中选择没有邻近星星距离小于X像素的星星，其中X可以适当固定，这可以通过设置<code class="docutils literal notranslate"><span class="pre">dist_sel</span></code> = True来实现。</p>
<p>限制星等和最近邻星的最大距离取决于用户的科学案例（即视场中的星星数量、拥挤程度、亮源数量等），必须相应地进行修改。</p>
<p>最终表格<code class="docutils literal notranslate"><span class="pre">xy_cmd</span></code>包含在两个滤光片中所选星星的位置（X,Y）。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xy_cmd</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>  <span class="c1"># 创建一个空的表格用于存储选中的星体坐标</span>

<span class="n">mag_lim_bright</span> <span class="o">=</span> <span class="o">-</span><span class="mf">7.0</span>  <span class="c1"># 明亮星体的亮度限制</span>
<span class="n">mag_lim_faint</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.5</span>   <span class="c1"># 微弱星体的亮度限制</span>

<span class="c1"># 创建一个掩码，筛选出亮度在限制范围内的星体</span>
<span class="n">mask_xy</span> <span class="o">=</span> <span class="p">((</span><span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mag_lim_faint</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">mag_lim_bright</span><span class="p">))</span>

<span class="c1"># 将符合条件的星体坐标添加到xy_cmd表中</span>
<span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;x_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;x_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">][</span><span class="n">mask_xy</span><span class="p">]</span>  <span class="c1"># 添加filt1的x坐标</span>
<span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">][</span><span class="n">mask_xy</span><span class="p">]</span>  <span class="c1"># 添加filt1的y坐标</span>
<span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;x_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;x_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">][</span><span class="n">mask_xy</span><span class="p">]</span>  <span class="c1"># 添加filt2的x坐标</span>
<span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">][</span><span class="n">mask_xy</span><span class="p">]</span>  <span class="c1"># 添加filt2的y坐标</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of stars selected from CMD:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy_cmd</span><span class="p">))</span>  <span class="c1"># 打印选中的星体数量</span>

<span class="n">dist_sel</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 是否计算距离的标志</span>

<span class="k">if</span> <span class="n">dist_sel</span><span class="p">:</span>  <span class="c1"># 如果选择计算距离</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating closest neighbour distance&quot;</span><span class="p">)</span>  <span class="c1"># 打印计算最近邻距离的提示</span>

    <span class="n">d_filt1</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 存储filt1的最小距离</span>
    <span class="n">d_filt2</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 存储filt2的最小距离</span>
    <span class="n">min_sep_filt1</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># filt1的最小距离阈值</span>
    <span class="n">min_sep_filt2</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># filt2的最小距离阈值</span>

    <span class="c1"># 计算filt1的最小距离</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;x_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">],</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]):</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 存储距离</span>
        <span class="c1"># 计算当前星体到所有其他星体的距离</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 找到最近的邻居距离</span>
        <span class="n">d_filt1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>  <span class="c1"># 将距离添加到列表中</span>

    <span class="c1"># 计算filt2的最小距离</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;x_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">],</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]):</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 存储距离</span>
        <span class="c1"># 计算当前星体到所有其他星体的距离</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 找到最近的邻居距离</span>
        <span class="n">d_filt2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>  <span class="c1"># 将距离添加到列表中</span>

    <span class="c1"># 将最小距离添加到xy_cmd表中</span>
    <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;min distance &#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_filt1</span>
    <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;min distance &#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_filt2</span>

    <span class="c1"># 创建一个掩码，筛选出符合最小距离要求的星体</span>
    <span class="n">mask_dist</span> <span class="o">=</span> <span class="p">((</span><span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;min distance &#39;</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_sep_filt1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;min distance &#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_sep_filt2</span><span class="p">))</span>

    <span class="n">xy_cmd</span> <span class="o">=</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="n">mask_dist</span><span class="p">]</span>  <span class="c1"># 应用掩码，更新xy_cmd表</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum distance required for filter </span><span class="si">{f}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt1</span><span class="p">),</span> <span class="n">min_sep_filt1</span><span class="p">,</span> <span class="s2">&quot;px&quot;</span><span class="p">)</span>  <span class="c1"># 打印filt1的最小距离要求</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum distance required for filter </span><span class="si">{f}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt2</span><span class="p">),</span> <span class="n">min_sep_filt2</span><span class="p">,</span> <span class="s2">&quot;px&quot;</span><span class="p">)</span>  <span class="c1"># 打印filt2的最小距离要求</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of stars selected from CMD including distance constraints:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xy_cmd</span><span class="p">))</span>  <span class="c1"># 打印考虑距离约束后选中的星体数量</span>
</pre></div>
</div>
</div>
</div>
<p>如我们之前所做，我们创建一个字典，其中包含每个图像的衍生光圈光度（aperture photometry，针对明亮恒星）的表格。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_zp</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 初始化一个空字典，用于存储每个探测器和滤光片的相关信息</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历每个短探测器</span>
    <span class="n">dict_zp</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 如果字典中没有该探测器，则初始化一个空字典</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历每个短滤光片</span>
        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>  <span class="c1"># 如果该探测器下没有该滤光片，则初始化一个空字典</span>

        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 初始化&#39;找到的源&#39;为None</span>
        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 初始化&#39;光圈光度表&#39;为None</span>
        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 初始化&#39;最终光圈光度表&#39;为None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_bright_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">&#39;NRCA1&#39;</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">&#39;F070W&#39;</span><span class="p">,</span> <span class="n">var_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># 定义寻找亮星的函数，参数包括探测器、滤光片、是否使用变背景和是否选择距离</span>

    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>  <span class="c1"># 初始化MAD标准背景RMS对象</span>
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>  <span class="c1"># 初始化MMM背景估计对象</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 打开指定探测器和滤光片的图像文件</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>  <span class="c1"># 获取图像头信息</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding sources on image </span><span class="si">{number}</span><span class="s2">, filter </span><span class="si">{f}</span><span class="s2">, detector </span><span class="si">{d}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>  <span class="c1"># 打印当前处理的图像信息</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span>  <span class="c1"># 将图像数据转换为DN/s</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Conversion factor from </span><span class="si">{units}</span><span class="s2"> to DN/s for filter </span><span class="si">{f}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">imh</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">],</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">])</span>  <span class="c1"># 打印转换因子</span>

    <span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;psf fwhm&#39;</span><span class="p">]</span>  <span class="c1"># 获取滤光片的PSF FWHM</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FWHM for the filter </span><span class="si">{f}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">sigma_psf</span><span class="p">,</span> <span class="s2">&quot;px&quot;</span><span class="p">)</span>  <span class="c1"># 打印FWHM信息</span>

    <span class="k">if</span> <span class="n">var_bkg</span><span class="p">:</span>  <span class="c1"># 如果使用变背景</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using 2D Background&quot;</span><span class="p">)</span>  <span class="c1"># 打印使用2D背景的信息</span>
        <span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">)</span>  <span class="c1"># 初始化SigmaClip对象</span>
        <span class="n">coverage_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 创建覆盖掩码，标记数据为0的区域</span>

        <span class="c1"># 计算2D背景</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="n">filter_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span>
                           <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">mmm_bkg</span><span class="p">,</span> <span class="n">coverage_mask</span><span class="o">=</span><span class="n">coverage_mask</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 复制数据</span>
        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data_bkgsub</span> <span class="o">-</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span>  <span class="c1"># 从数据中减去背景</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data_bkgsub</span><span class="p">)</span>  <span class="c1"># 计算背景减去后的标准差</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># 如果不使用变背景</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 计算背景RMS</span>
        <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 估计背景</span>

        <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 复制数据</span>
        <span class="n">data_bkgsub</span> <span class="o">-=</span> <span class="n">bkg</span>  <span class="c1"># 从数据中减去背景</span>

    <span class="c1"># 初始化DAOStarFinder以寻找星源</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">th</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">std</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>

    <span class="n">zp_stars</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data_bkgsub</span><span class="p">)</span>  <span class="c1"># 在背景减去后的数据中寻找星源</span>

    <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp_stars</span>  <span class="c1"># 将找到的星源存入字典</span>

    <span class="k">if</span> <span class="n">dist_sel</span><span class="p">:</span>  <span class="c1"># 如果选择距离</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating closest neighbour distance&quot;</span><span class="p">)</span>  <span class="c1"># 打印计算最近邻距离的信息</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化距离列表</span>

        <span class="c1"># 遍历找到的星源</span>
        <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">zp_stars</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">zp_stars</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]):</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化分离距离列表</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">xx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                           <span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">yy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 计算距离</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 获取最近的距离</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>  <span class="c1"># 将距离添加到列表中</span>

        <span class="n">zp_stars</span><span class="p">[</span><span class="s1">&#39;min distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>  <span class="c1"># 将最小距离添加到星源数据中</span>
        <span class="n">mask_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">zp_stars</span><span class="p">[</span><span class="s1">&#39;min distance&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>  <span class="c1"># 创建距离掩码</span>

        <span class="n">zp_stars</span> <span class="o">=</span> <span class="n">zp_stars</span><span class="p">[</span><span class="n">mask_dist</span><span class="p">]</span>  <span class="c1"># 应用距离掩码</span>

        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp_stars</span>  <span class="c1"># 更新找到的星源字典</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum distance required:&quot;</span><span class="p">,</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s2">&quot;px&quot;</span><span class="p">)</span>  <span class="c1"># 打印所需的最小距离</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of bright isolated sources found in the image:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">zp_stars</span><span class="p">))</span>  <span class="c1"># 打印找到的孤立亮星数量</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------------------------------&quot;</span><span class="p">)</span>  <span class="c1"># 打印分隔线</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># 如果不选择距离</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of bright sources found in the image:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">zp_stars</span><span class="p">))</span>  <span class="c1"># 打印找到的亮星数量</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------------------&quot;</span><span class="p">)</span>  <span class="c1"># 打印分隔线</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 打印空行</span>
</pre></div>
</div>
</div>
</div>
<p>阈值（threshold）和最近邻（closest neighbour）的最大距离（maximum distance）取决于用户的科学案例（science case）（即视场内的星星数量、拥挤程度、亮源数量等），必须相应地进行调整。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

<span class="n">th</span> <span class="o">=</span> <span class="p">[</span><span class="mi">700</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>  <span class="c1"># 两个滤波器的阈值水平（长度必须与分析的滤波器数量匹配）</span>

<span class="n">min_sep</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># zp 星星与最近邻星星之间可接受的最小间隔</span>

<span class="c1"># 遍历短时间检测列表</span>
<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>

    <span class="c1"># 遍历短时间滤波器列表</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>

        <span class="c1"># 遍历当前图像字典中指定检测和滤波器的图像</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="c1"># 查找明亮的星星，参数包括检测、滤波器、是否考虑背景变化、是否选择距离</span>
            <span class="n">find_bright_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">var_bkg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>

<span class="c1"># 打印查找星星所用的时间</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed Time for finding stars:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id13">
<h3>明亮孤立星的光圈光度测量<a class="headerlink" href="#id13" title="Link to this heading">#</a></h3>
<p>要选择我们希望在光圈光度测量中使用的星星样本，请修改 <code class="docutils literal notranslate"><span class="pre">sample</span></code> 关键字，使用 <em>cmd</em> 或 <em>found</em>。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">aperture_phot_zp</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="s1">&#39;found&#39;</span><span class="p">):</span>
    <span class="c1"># 定义一个函数，用于进行光度测量，输入参数包括探测器、滤光片和样本类型</span>

    <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;r70&#39;</span><span class="p">]]</span>  <span class="c1"># 获取对应滤光片的70%半径</span>

    <span class="n">ees</span> <span class="o">=</span> <span class="s1">&#39;70&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>  <span class="c1"># 定义有效半径的列表</span>
    <span class="n">ee_radii</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ees</span><span class="p">,</span> <span class="n">radii</span><span class="p">))</span>  <span class="c1"># 将有效半径与其对应的值组合成字典</span>

    <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;found&#39;</span><span class="p">:</span>
        <span class="c1"># 如果样本类型为&#39;found&#39;，则获取已找到的源的位置</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span>
                                  <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;cmd&#39;</span><span class="p">:</span>
        <span class="c1"># 如果样本类型为&#39;cmd&#39;，则获取命令中的源位置</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;x_&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="p">],</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="p">]))</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 打开对应的图像文件</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>  <span class="c1"># 获取图像头信息</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">&#39;PHOTMJSR&#39;</span><span class="p">]</span>  <span class="c1"># 进行数据的光度校正</span>

    <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 查找数据中小于0的值的索引</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aa</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># 将小于0的值替换为0</span>
        <span class="n">data</span><span class="p">[</span><span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># 从光圈校正表中获取天空背景的内外半径</span>
    <span class="n">sky</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sky_in&quot;</span><span class="p">:</span> <span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;r80&#39;</span><span class="p">],</span> <span class="s2">&quot;sky_out&quot;</span><span class="p">:</span> <span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;r85&#39;</span><span class="p">]}</span>

    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录开始时间</span>

    <span class="n">table_zp</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>  <span class="c1"># 创建一个新的表格用于存储结果</span>

    <span class="k">for</span> <span class="n">ee</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="n">ee_radii</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># 对每个有效半径进行光度测量</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performing aperture photometry for radius equivalent to EE = </span><span class="si">{0}% f</span><span class="s2">or filter </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">filt</span><span class="p">))</span>
        <span class="n">aperture</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>  <span class="c1"># 创建光圈对象</span>
        <span class="n">annulus_aperture</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="n">sky</span><span class="p">[</span><span class="s2">&quot;sky_in&quot;</span><span class="p">],</span> <span class="n">r_out</span><span class="o">=</span><span class="n">sky</span><span class="p">[</span><span class="s2">&quot;sky_out&quot;</span><span class="p">])</span>  <span class="c1"># 创建环形光圈对象</span>
        <span class="n">annulus_mask</span> <span class="o">=</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>  <span class="c1"># 生成环形光圈的掩膜</span>

        <span class="n">bkg_median</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化背景中值列表</span>

        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">annulus_mask</span><span class="p">:</span>
            <span class="c1"># 对每个掩膜进行处理</span>
            <span class="n">annulus_data</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># 计算环形区域的数据</span>
            <span class="n">annulus_data_1d</span> <span class="o">=</span> <span class="n">annulus_data</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># 提取有效数据</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">median_sigclip</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">annulus_data_1d</span><span class="p">)</span>  <span class="c1"># 计算背景中值</span>
            <span class="n">bkg_median</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_sigclip</span><span class="p">)</span>  <span class="c1"># 将中值添加到列表中</span>

        <span class="n">bkg_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bkg_median</span><span class="p">)</span>  <span class="c1"># 转换为数组</span>

        <span class="n">phot</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">)</span>  <span class="c1"># 进行光度测量</span>
        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span>  <span class="c1"># 添加背景中值到结果中</span>
        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span>  <span class="c1"># 计算光圈背景</span>
        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">]</span>  <span class="c1"># 计算背景校正后的光度</span>

        <span class="n">apcorr</span> <span class="o">=</span> <span class="p">[</span><span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;apcorr70&#39;</span><span class="p">]]</span>  <span class="c1"># 获取光圈校正因子</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_corrected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">apcorr</span>  <span class="c1"># 计算校正后的光度</span>

        <span class="c1"># 将结果添加到表格中</span>
        <span class="n">table_zp</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aper_sum_&#39;</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_zp</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;annulus_median&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;annulus_median_&#39;</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_zp</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_bkg&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aper_bkg_ee_&#39;</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_zp</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_bkgsub&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aper_sum_bkgsub_&#39;</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_zp</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">&#39;aper_sum_corrected&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aper_sum_corrected_&#39;</span> <span class="o">+</span> <span class="n">ee</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="p">)</span>

        <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_zp</span>  <span class="c1"># 将结果表格存储到字典中</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>  <span class="c1"># 记录结束时间</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time Elapsed:&quot;</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>  <span class="c1"># 输出耗时</span>

    <span class="k">return</span>  <span class="c1"># 返回函数结束</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 使用指定的检测器和滤光片进行光度测量，样本为&#39;cmd&#39;</span>
<span class="n">aperture_phot_zp</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt1</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="s1">&#39;cmd&#39;</span><span class="p">)</span>  <span class="c1"># 对第一个滤光片进行光度测量</span>

<span class="c1"># 使用指定的检测器和第二个滤光片进行光度测量，样本为&#39;cmd&#39;</span>
<span class="n">aperture_phot_zp</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt2</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="s1">&#39;cmd&#39;</span><span class="p">)</span>  <span class="c1"># 对第二个滤光片进行光度测量</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ee</span> <span class="o">=</span> <span class="s1">&#39;70&#39;</span>  <span class="c1"># 设置等效光度的值</span>

<span class="n">sample</span> <span class="o">=</span> <span class="s1">&#39;cmd&#39;</span>  <span class="c1"># 设置样本类型为&#39;cmd&#39;</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>  <span class="c1"># 遍历短名称的探测器</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>  <span class="c1"># 遍历短名称的滤光片</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历图像列表</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 打开图像文件</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># 获取图像数据</span>

            <span class="n">image_model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;images&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 创建图像模型</span>

            <span class="n">table_zp_mag</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>  <span class="c1"># 创建一个新的表格用于存储零点光度数据</span>

            <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;found&#39;</span><span class="p">:</span>  <span class="c1"># 如果样本类型为&#39;found&#39;</span>

                <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># 创建掩码，筛选有效的x坐标</span>

                        <span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>  <span class="c1"># x坐标小于图像宽度</span>

                        <span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># 筛选有效的y坐标</span>

                        <span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>  <span class="c1"># y坐标小于图像高度</span>

                        <span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;aper_sum_corrected_&#39;</span> <span class="o">+</span> <span class="n">ee</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># 确保光度值大于0</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>  <span class="c1"># 存储x坐标</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;sources found&#39;</span><span class="p">][</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>  <span class="c1"># 存储y坐标</span>

                <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>  <span class="c1"># 将像素坐标转换为天球坐标</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>  <span class="c1"># 存储天球坐标</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;aper_sum_corrected_&#39;</span> <span class="o">+</span> <span class="n">ee</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>  <span class="c1"># 计算并存储瞬时光度</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">&#39;_zp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;VegaMAG zp modB&#39;</span><span class="p">]</span>  <span class="c1"># 计算并存储零点光度</span>

                <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_zp_mag</span>  <span class="c1"># 更新字典中的最终光度表</span>

            <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;cmd&#39;</span><span class="p">:</span>  <span class="c1"># 如果样本类型为&#39;cmd&#39;</span>

                <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;aper_sum_corrected_&#39;</span> <span class="o">+</span> <span class="n">ee</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># 创建掩码，筛选有效的光度值</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;x_&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>  <span class="c1"># 存储x坐标</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_cmd</span><span class="p">[</span><span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>  <span class="c1"># 存储y坐标</span>

                <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">image_model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>  <span class="c1"># 将像素坐标转换为天球坐标</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>  <span class="c1"># 存储天球坐标</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;aper_sum_corrected_&#39;</span> <span class="o">+</span> <span class="n">ee</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>  <span class="c1"># 计算并存储瞬时光度</span>

                <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">&#39;_zp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_zp_mag</span><span class="p">[</span><span class="n">filt</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;VegaMAG zp modB&#39;</span><span class="p">]</span>  <span class="c1"># 计算并存储零点光度</span>

                <span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_zp_mag</span>  <span class="c1"># 更新字典中的最终光度表</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="zeropoints">
<h3>推导零点 (Zeropoints)<a class="headerlink" href="#zeropoints" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>  <span class="c1"># 创建一个14x8英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清除当前图形中的所有内容</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个2行1列的子图，选择第一个子图</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_ZP&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="c1"># 匹配天文坐标，获取索引和距离</span>
<span class="n">idx_zp_1</span><span class="p">,</span> <span class="n">d2d_zp_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">],</span>
                                              <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">])</span>

<span class="n">sep_constraint_zp_1</span> <span class="o">=</span> <span class="n">d2d_zp_1</span> <span class="o">&lt;</span> <span class="n">max_sep</span>  <span class="c1"># 设置距离约束条件</span>

<span class="c1"># 根据约束条件提取匹配的零点和观测值</span>
<span class="n">f115w_apZP_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_zp&#39;</span><span class="p">][</span><span class="n">sep_constraint_zp_1</span><span class="p">])</span>
<span class="n">f115w_ap_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">idx_zp_1</span><span class="p">[</span><span class="n">sep_constraint_zp_1</span><span class="p">]])</span>

<span class="n">diff_f115w</span> <span class="o">=</span> <span class="n">f115w_apZP_matched</span> <span class="o">-</span> <span class="n">f115w_ap_matched</span>  <span class="c1"># 计算差值</span>
<span class="n">_</span><span class="p">,</span> <span class="n">zp_f115w</span><span class="p">,</span> <span class="n">zp_sigma_f115w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span>  <span class="c1"># 计算零点和标准差</span>

<span class="c1"># 设置x轴和y轴的限制</span>
<span class="n">xlim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f115w_ap_matched</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.25</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f115w_ap_matched</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.25</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.35</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.35</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="c1"># 设置坐标轴的刻度</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_ap_matched</span><span class="p">,</span> <span class="n">diff_f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">zp_f115w</span><span class="p">,</span> <span class="n">zp_f115w</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制零点线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39; Zeropoint = </span><span class="si">%5.3f</span><span class="s1"> $\pm $ </span><span class="si">%5.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zp_f115w</span><span class="p">,</span> <span class="n">zp_sigma_f115w</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 添加文本注释</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建第二个子图</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_ZP&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="c1"># 匹配天文坐标，获取索引和距离</span>
<span class="n">idx_zp_2</span><span class="p">,</span> <span class="n">d2d_zp_2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">],</span>
                                              <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">])</span>

<span class="n">sep_constraint_zp_2</span> <span class="o">=</span> <span class="n">d2d_zp_2</span> <span class="o">&lt;</span> <span class="n">max_sep</span>  <span class="c1"># 设置距离约束条件</span>

<span class="c1"># 根据约束条件提取匹配的零点和观测值</span>
<span class="n">f200w_apZP_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_zp</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_zp&#39;</span><span class="p">][</span><span class="n">sep_constraint_zp_2</span><span class="p">])</span>
<span class="n">f200w_ap_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][</span><span class="n">idx_zp_2</span><span class="p">[</span><span class="n">sep_constraint_zp_2</span><span class="p">]])</span>

<span class="n">diff_f200w</span> <span class="o">=</span> <span class="n">f200w_apZP_matched</span> <span class="o">-</span> <span class="n">f200w_ap_matched</span>  <span class="c1"># 计算差值</span>
<span class="n">_</span><span class="p">,</span> <span class="n">zp_f200w</span><span class="p">,</span> <span class="n">zp_sigma_f200w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span>  <span class="c1"># 计算零点和标准差</span>

<span class="c1"># 设置x轴和y轴的限制</span>
<span class="n">xlim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">f200w_ap_matched</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.25</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">f200w_ap_matched</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.25</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.35</span> 
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.35</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="c1"># 设置坐标轴的刻度</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f200w_ap_matched</span><span class="p">,</span> <span class="n">diff_f200w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">zp_f200w</span><span class="p">,</span> <span class="n">zp_f200w</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制零点线</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39; Zeropoint = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zp_f200w</span><span class="p">,</span> <span class="n">zp_sigma_f200w</span><span class="p">),</span> 
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 添加文本注释</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图间距</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id14">
<h2>导入输入目录<a class="headerlink" href="#id14" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  <span class="c1"># 导入os模块，用于文件和目录操作</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>  <span class="c1"># 导入urllib.request模块，用于下载文件</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>  <span class="c1"># 导入pandas库，用于数据处理</span>

<span class="c1"># 检查当前目录下是否存在&#39;pointsource.cat&#39;文件</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;./pointsource.cat&#39;</span><span class="p">):</span>
    <span class="n">input_cat</span> <span class="o">=</span> <span class="s1">&#39;./pointsource.cat&#39;</span>  <span class="c1"># 如果文件存在，设置输入目录为该文件</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading input pointsource catalog&quot;</span><span class="p">)</span>  <span class="c1"># 如果文件不存在，打印下载信息</span>

    <span class="c1"># 定义要下载的文件链接</span>
    <span class="n">boxlink_input_cat</span> <span class="o">=</span> <span class="s1">&#39;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/pointsource.cat&#39;</span>
    <span class="n">boxfile_input_cat</span> <span class="o">=</span> <span class="s1">&#39;./pointsource.cat&#39;</span>  <span class="c1"># 定义下载后保存的文件名</span>

    <span class="c1"># 下载文件并保存到指定路径</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_input_cat</span><span class="p">,</span> <span class="n">boxfile_input_cat</span><span class="p">)</span>
    <span class="n">input_cat</span> <span class="o">=</span> <span class="s1">&#39;./pointsource.cat&#39;</span>  <span class="c1"># 设置输入目录为下载的文件</span>

<span class="c1"># 读取输入的点源目录文件，指定列名和数据格式</span>
<span class="n">cat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_cat</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ra_in&#39;</span><span class="p">,</span> <span class="s1">&#39;dec_in&#39;</span><span class="p">,</span> <span class="s1">&#39;f070w_in&#39;</span><span class="p">,</span> <span class="s1">&#39;f115w_in&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;f200w_in&#39;</span><span class="p">,</span> <span class="s1">&#39;f277w_in&#39;</span><span class="p">,</span> <span class="s1">&#39;f356w_in&#39;</span><span class="p">,</span> <span class="s1">&#39;f444w_in&#39;</span><span class="p">],</span>
                  <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># 显示数据框的前几行</span>
<span class="n">cat</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>  <span class="c1"># 输出数据框的前5行</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 计算给定探测器和滤波器的最小和最大RA值</span>
<span class="n">lim_ra_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>  <span class="c1"># 最小RA值</span>
<span class="n">lim_ra_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>  <span class="c1"># 最大RA值</span>

<span class="c1"># 计算给定探测器和滤波器的最小和最大DEC值</span>
<span class="n">lim_dec_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>  <span class="c1"># 最小DEC值</span>
<span class="n">lim_dec_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">&#39;final aperture phot table&#39;</span><span class="p">][</span><span class="s1">&#39;radec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>  <span class="c1"># 最大DEC值</span>

<span class="c1"># 根据RA和DEC的限制条件选择分类目录中的对象</span>
<span class="n">cat_sel</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;ra_in&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lim_ra_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;ra_in&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lim_ra_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;dec_in&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lim_dec_min</span><span class="p">)</span>  <span class="c1"># RA范围条件</span>
              <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">&#39;dec_in&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lim_dec_max</span><span class="p">)]</span>  <span class="c1"># DEC范围条件</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id15">
<h2>校准的颜色-星等图<a class="headerlink" href="#id15" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>  <span class="c1"># 创建一个12x14英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清空当前图形</span>

<span class="n">font2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="s1">&#39;30&#39;</span><span class="p">}</span>  <span class="c1"># 设置字体大小为30</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建1行2列的子图，选择第一个子图</span>

<span class="n">mag1_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;f115w_in&#39;</span><span class="p">])</span>  <span class="c1"># 从cat_sel中获取f115w_in数据并转换为numpy数组</span>
<span class="n">mag2_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;f200w_in&#39;</span><span class="p">])</span>  <span class="c1"># 从cat_sel中获取f200w_in数据并转换为numpy数组</span>
<span class="n">diff_in</span> <span class="o">=</span> <span class="n">mag1_in</span> <span class="o">-</span> <span class="n">mag2_in</span>  <span class="c1"># 计算f115w和f200w之间的差值</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span>  <span class="c1"># 设置x轴下限</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mf">1.75</span>   <span class="c1"># 设置x轴上限</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="mi">25</span>     <span class="c1"># 设置y轴下限</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">15</span>     <span class="c1"># 设置y轴上限</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 应用x轴限制</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>   <span class="c1"># 应用y轴限制</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag1_in</span> <span class="o">-</span> <span class="n">mag2_in</span><span class="p">,</span> <span class="n">mag1_in</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图，x为差值，y为f115w的值</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">15.5</span><span class="p">,</span> <span class="s2">&quot;Input&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 在图中添加文本“Input”</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建1行2列的子图，选择第二个子图</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 应用x轴限制</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>   <span class="c1"># 应用y轴限制</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置x轴次刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴主刻度定位器</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 设置y轴次刻度定位器</span>

<span class="n">f115w</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zp_f115w</span>  <span class="c1"># 计算f115w的值</span>
<span class="n">f200w</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">zp_f200w</span>  <span class="c1"># 计算f200w的值</span>

<span class="n">maglim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个从18到25的范围，步长为1</span>
<span class="n">mags</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化mags列表</span>
<span class="n">errs_mag</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化errs_mag列表</span>
<span class="n">errs_col</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 初始化errs_col列表</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">maglim</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># 遍历maglim的每个区间</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># 计算当前区间的中值</span>
    <span class="n">err_mag1</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][(</span><span class="n">f115w</span> <span class="o">&gt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f115w</span> <span class="o">&lt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])]</span>  <span class="c1"># 获取f115w在当前区间的误差</span>
    <span class="n">err_mag2</span> <span class="o">=</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;e&#39;</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39;_inst&#39;</span><span class="p">][(</span><span class="n">f115w</span> <span class="o">&gt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f115w</span> <span class="o">&lt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])]</span>  <span class="c1"># 获取f200w在当前区间的误差</span>
    <span class="n">err_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">err_mag1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 计算f115w的平均误差</span>
    <span class="n">err_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err_mag1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">err_mag2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 计算误差的平方和的平方根</span>
    <span class="n">err_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">err_temp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># 计算颜色的平均误差</span>

    <span class="n">errs_mag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_mag</span><span class="p">)</span>  <span class="c1"># 将当前误差添加到errs_mag列表</span>
    <span class="n">errs_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_col</span><span class="p">)</span>  <span class="c1"># 将当前颜色误差添加到errs_col列表</span>
    <span class="n">mags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span>  <span class="c1"># 将当前中值添加到mags列表</span>

<span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">maglim</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 初始化颜色列表，长度为maglim的长度减1</span>

<span class="c1"># ax2.errorbar(col, mags, yerr=errs_mag, xerr=errs_col, fmt=&#39;o&#39;, color = &#39;k&#39;)  # 绘制误差条（已注释）</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w</span> <span class="o">-</span> <span class="n">f200w</span><span class="p">,</span> <span class="n">f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图，x为f115w和f200w的差值，y为f115w的值</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">15.5</span><span class="p">,</span> <span class="s2">&quot;Output&quot;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 在图中添加文本“Output”</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 自动调整子图参数，使之填充整个图像区域</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id16">
<h2>输入与输出光度的比较<a class="headerlink" href="#id16" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>  <span class="c1"># 创建一个14x8英寸的图形</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># 清除当前图形中的所有内容</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 创建一个2行1列的子图，选择第一个子图</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为filt1</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\Delta$ Mag&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为Δ Mag</span>

<span class="n">radec_input</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;ra_in&#39;</span><span class="p">],</span> <span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;dec_in&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>  <span class="c1"># 创建SkyCoord对象，包含输入的RA和DEC坐标</span>

<span class="n">idx_f115w_cfr</span><span class="p">,</span> <span class="n">d2d_f115w_cfr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">radec_input</span><span class="p">,</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">])</span>  <span class="c1"># 匹配输入坐标与已匹配源的坐标</span>

<span class="n">sep_f115w_cfr</span> <span class="o">=</span> <span class="n">d2d_f115w_cfr</span> <span class="o">&lt;</span> <span class="n">max_sep</span>  <span class="c1"># 计算匹配源与输入源之间的距离，筛选出小于最大分离的源</span>

<span class="n">f115w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;f115w_in&#39;</span><span class="p">][</span><span class="n">sep_f115w_cfr</span><span class="p">])</span>  <span class="c1"># 获取输入的f115w数据</span>
<span class="n">f115w_ap_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f115w</span><span class="p">[</span><span class="n">idx_f115w_cfr</span><span class="p">[</span><span class="n">sep_f115w_cfr</span><span class="p">]])</span>  <span class="c1"># 获取匹配的f115w数据</span>

<span class="n">diff_f115w_cfr</span> <span class="o">=</span> <span class="n">f115w_inp_cfr</span> <span class="o">-</span> <span class="n">f115w_ap_cfr</span>  <span class="c1"># 计算输入和匹配的f115w数据之间的差异</span>
<span class="n">diff_f115w_cfr_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">f115w_inp_cfr</span> <span class="o">-</span> <span class="n">f115w_ap_cfr</span><span class="p">)[(</span><span class="n">f115w_ap_cfr</span> <span class="o">&gt;</span> <span class="mf">17.75</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f115w_ap_cfr</span> <span class="o">&lt;</span> <span class="mf">21.5</span><span class="p">)]</span>  <span class="c1"># 筛选出特定范围内的差异</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diff_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f115w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f115w_cfr_sel</span><span class="p">)</span>  <span class="c1"># 计算中位数和标准差</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># 设置x轴下限</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">24</span>  <span class="c1"># 设置x轴上限</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w_cfr</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>  <span class="c1"># 设置y轴下限</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w_cfr</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># 设置y轴上限</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 自动选择x轴主刻度</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 自动选择x轴次刻度</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 自动选择y轴主刻度</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 自动选择y轴次刻度</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_ap_cfr</span><span class="p">,</span> <span class="n">diff_f115w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图，显示f115w匹配数据与差异</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制红色虚线，表示0差异线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">17.75</span><span class="p">,</span> <span class="mf">17.75</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制f115w下限虚线</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">21.5</span><span class="p">,</span> <span class="mf">21.5</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制f115w上限虚线</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">&#39; $\Delta$ Mag = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">&#39;</span>  <span class="c1"># 在图中添加文本，显示filt1的差异统计</span>
         <span class="o">%</span> <span class="p">(</span><span class="n">med_diff_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f115w_cfr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 创建第二个子图</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置x轴标签为filt2</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\Delta$ Mag&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>  <span class="c1"># 设置y轴标签为Δ Mag</span>

<span class="n">idx_f200w_cfr</span><span class="p">,</span> <span class="n">d2d_f200w_cfr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">radec_input</span><span class="p">,</span> <span class="n">matched_sources</span><span class="p">[</span><span class="s1">&#39;radec&#39;</span><span class="p">])</span>  <span class="c1"># 匹配输入坐标与已匹配源的坐标</span>

<span class="n">sep_f200w_cfr</span> <span class="o">=</span> <span class="n">d2d_f200w_cfr</span> <span class="o">&lt;</span> <span class="n">max_sep</span>  <span class="c1"># 计算匹配源与输入源之间的距离，筛选出小于最大分离的源</span>

<span class="n">f200w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">&#39;f200w_in&#39;</span><span class="p">][</span><span class="n">sep_f200w_cfr</span><span class="p">])</span>  <span class="c1"># 获取输入的f200w数据</span>
<span class="n">f200w_ap_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f200w</span><span class="p">[</span><span class="n">idx_f200w_cfr</span><span class="p">[</span><span class="n">sep_f200w_cfr</span><span class="p">]])</span>  <span class="c1"># 获取匹配的f200w数据</span>

<span class="n">diff_f200w_cfr</span> <span class="o">=</span> <span class="n">f200w_inp_cfr</span> <span class="o">-</span> <span class="n">f200w_ap_cfr</span>  <span class="c1"># 计算输入和匹配的f200w数据之间的差异</span>
<span class="n">diff_f200w_cfr_sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">f200w_inp_cfr</span> <span class="o">-</span> <span class="n">f200w_ap_cfr</span><span class="p">)[(</span><span class="n">f200w_ap_cfr</span> <span class="o">&gt;</span> <span class="mf">16.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f200w_ap_cfr</span> <span class="o">&lt;</span> <span class="mf">20.5</span><span class="p">)]</span>  <span class="c1"># 筛选出特定范围内的差异</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diff_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f200w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f200w_cfr_sel</span><span class="p">)</span>  <span class="c1"># 计算中位数和标准差</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># 设置x轴下限</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">24</span>  <span class="c1"># 设置x轴上限</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w_cfr</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>  <span class="c1"># 设置y轴下限</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w_cfr</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>  <span class="c1"># 设置y轴上限</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>  <span class="c1"># 设置x轴范围</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>  <span class="c1"># 设置y轴范围</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 自动选择x轴主刻度</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 自动选择x轴次刻度</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>  <span class="c1"># 自动选择y轴主刻度</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>  <span class="c1"># 自动选择y轴次刻度</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f200w_ap_cfr</span><span class="p">,</span> <span class="n">diff_f200w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># 绘制散点图，显示f200w匹配数据与差异</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制红色虚线，表示0差异线</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">16.5</span><span class="p">,</span> <span class="mf">16.5</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制f200w下限虚线</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">20.5</span><span class="p">,</span> <span class="mf">20.5</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># 绘制f200w上限虚线</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">&#39; $\Delta$ Mag = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">&#39;</span>  <span class="c1"># 在图中添加文本，显示filt2的差异统计</span>
         <span class="o">%</span> <span class="p">(</span><span class="n">med_diff_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f200w_cfr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># 调整子图间距，使其更美观</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id17">
<h2>关于此笔记本<a class="headerlink" href="#id17" title="Link to this heading">#</a></h2>
<p><strong>作者</strong>: Matteo Correnti, JWST/NIRCam STScI 科学家 II \</p>
<p><strong>更新时间</strong>: 2021-01-15</p>
<p><a class="reference internal" href="#top"><span class="xref myst">页面顶部</span></a></p>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="空间望远镜标志" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" />
</a>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/NIRCam/aperture_photometry"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../../MIRI/MIRI_LRS_spectral_extraction/miri_lrs_advanced_extraction_part1_cn.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">MIRI LRS 窄缝光谱学：使用 JWST 管道进行光谱提取</p>
      </div>
    </a>
    <a class="right-next"
       href="../NIRCam_photometry/NIRCam_multiband_photometry_cn.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">扩展孔径光度测量</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">导入函数</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">导入绘图函数</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">加载图像并创建一些有用的字典</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">选择用于分析的探测器和/或滤光片</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">显示图像</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aperture-photometry">光圈光度法 (Aperture Photometry)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">1. 寻找源</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">2. 光圈光度法 (Aperture Photometry)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">3. 包含星等和位置的表格</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">匹配源表</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">仪器颜色-星等图及误差</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#photometric-zeropoints">光度零点 (Photometric Zeropoints)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">加载孔径校正表</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-cmd">1a. 使用CMD作为参考进行子采样</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">明亮孤立星的光圈光度测量</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#zeropoints">推导零点 (Zeropoints)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">导入输入目录</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">校准的颜色-星等图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">输入与输出光度的比较</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">关于此笔记本</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>